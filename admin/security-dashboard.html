<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Security Dashboard - Ignite Fitness</title>
    <link rel="stylesheet" href="../styles/main.css" />
    <link rel="stylesheet" href="../styles/mobile-first.css" />
    <link rel="stylesheet" href="../styles/admin.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      .security-dashboard {
        padding: 20px;
        max-width: 1400px;
        margin: 0 auto;
      }

      .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 2px solid var(--color-border);
      }

      .dashboard-title {
        font-size: 2rem;
        font-weight: bold;
        color: var(--color-text);
      }

      .dashboard-status {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .status-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 500;
      }

      .status-secure {
        background: #d1fae5;
        color: #065f46;
      }

      .status-warning {
        background: #fef3c7;
        color: #92400e;
      }

      .status-critical {
        background: #fee2e2;
        color: #991b1b;
      }

      .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .metric-card {
        background: var(--color-surface);
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border: 1px solid var(--color-border);
      }

      .metric-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .metric-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--color-text);
      }

      .metric-value {
        font-size: 2rem;
        font-weight: bold;
        color: var(--color-primary);
      }

      .metric-change {
        font-size: 0.9rem;
        padding: 4px 8px;
        border-radius: 12px;
        font-weight: 500;
      }

      .change-positive {
        background: #d1fae5;
        color: #065f46;
      }

      .change-negative {
        background: #fee2e2;
        color: #991b1b;
      }

      .change-neutral {
        background: #f3f4f6;
        color: #374151;
      }

      .chart-container {
        background: var(--color-surface);
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border: 1px solid var(--color-border);
        margin-bottom: 20px;
      }

      .chart-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 20px;
        color: var(--color-text);
      }

      .events-table {
        background: var(--color-surface);
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border: 1px solid var(--color-border);
      }

      .table-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .table-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--color-text);
      }

      .table-filters {
        display: flex;
        gap: 10px;
      }

      .filter-select {
        padding: 8px 12px;
        border: 1px solid var(--color-border);
        border-radius: 6px;
        background: var(--color-surface);
        color: var(--color-text);
      }

      .events-list {
        max-height: 400px;
        overflow-y: auto;
      }

      .event-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid var(--color-border);
      }

      .event-item:last-child {
        border-bottom: none;
      }

      .event-info {
        flex: 1;
      }

      .event-type {
        font-weight: 600;
        color: var(--color-text);
      }

      .event-details {
        font-size: 0.9rem;
        color: var(--color-text-secondary);
        margin-top: 4px;
      }

      .event-time {
        font-size: 0.8rem;
        color: var(--color-text-secondary);
      }

      .event-severity {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 500;
      }

      .severity-critical {
        background: #fee2e2;
        color: #991b1b;
      }

      .severity-high {
        background: #fed7aa;
        color: #9a3412;
      }

      .severity-medium {
        background: #fef3c7;
        color: #92400e;
      }

      .severity-low {
        background: #d1fae5;
        color: #065f46;
      }

      .compliance-section {
        background: var(--color-surface);
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border: 1px solid var(--color-border);
        margin-bottom: 20px;
      }

      .compliance-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
        margin-top: 20px;
      }

      .compliance-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid var(--color-border);
      }

      .compliance-icon {
        font-size: 1.5rem;
      }

      .compliance-pass {
        background: #d1fae5;
        border-color: #10b981;
      }

      .compliance-fail {
        background: #fee2e2;
        border-color: #ef4444;
      }

      .compliance-warning {
        background: #fef3c7;
        border-color: #f59e0b;
      }

      .refresh-btn {
        background: var(--color-primary);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
      }

      .refresh-btn:hover {
        background: var(--color-primary-dark);
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: var(--color-text-secondary);
      }

      @media (max-width: 768px) {
        .dashboard-header {
          flex-direction: column;
          gap: 15px;
          align-items: flex-start;
        }

        .metrics-grid {
          grid-template-columns: 1fr;
        }

        .table-filters {
          flex-direction: column;
        }
      }
    </style>
  </head>
  <body>
    <div class="security-dashboard">
      <div class="dashboard-header">
        <h1 class="dashboard-title">Security Dashboard</h1>
        <div class="dashboard-status">
          <div class="status-indicator" id="overall-status">
            <span class="status-icon">üîí</span>
            <span class="status-text">Loading...</span>
          </div>
          <button class="refresh-btn" onclick="refreshDashboard()">Refresh</button>
        </div>
      </div>

      <div class="metrics-grid">
        <div class="metric-card">
          <div class="metric-header">
            <div class="metric-title">Failed Logins (24h)</div>
            <div class="metric-change" id="failed-logins-change">+0%</div>
          </div>
          <div class="metric-value" id="failed-logins-count">0</div>
        </div>

        <div class="metric-card">
          <div class="metric-header">
            <div class="metric-title">Security Events (24h)</div>
            <div class="metric-change" id="security-events-change">+0%</div>
          </div>
          <div class="metric-value" id="security-events-count">0</div>
        </div>

        <div class="metric-card">
          <div class="metric-header">
            <div class="metric-title">Active Threats</div>
            <div class="metric-change" id="active-threats-change">+0%</div>
          </div>
          <div class="metric-value" id="active-threats-count">0</div>
        </div>

        <div class="metric-card">
          <div class="metric-header">
            <div class="metric-title">Compliance Score</div>
            <div class="metric-change" id="compliance-score-change">+0%</div>
          </div>
          <div class="metric-value" id="compliance-score">0%</div>
        </div>
      </div>

      <div class="chart-container">
        <div class="chart-title">Security Events Over Time</div>
        <canvas id="security-events-chart" width="400" height="200"></canvas>
      </div>

      <div class="chart-container">
        <div class="chart-title">Failed Login Attempts by IP</div>
        <canvas id="failed-logins-chart" width="400" height="200"></canvas>
      </div>

      <div class="compliance-section">
        <div class="chart-title">Compliance Status</div>
        <div class="compliance-grid" id="compliance-grid">
          <div class="loading">Loading compliance data...</div>
        </div>
      </div>

      <div class="events-table">
        <div class="table-header">
          <div class="table-title">Recent Security Events</div>
          <div class="table-filters">
            <select class="filter-select" id="severity-filter">
              <option value="all">All Severities</option>
              <option value="critical">Critical</option>
              <option value="high">High</option>
              <option value="medium">Medium</option>
              <option value="low">Low</option>
            </select>
            <select class="filter-select" id="type-filter">
              <option value="all">All Types</option>
              <option value="failed_login">Failed Login</option>
              <option value="suspicious_activity">Suspicious Activity</option>
              <option value="data_access">Data Access</option>
              <option value="admin_action">Admin Action</option>
            </select>
          </div>
        </div>
        <div class="events-list" id="events-list">
          <div class="loading">Loading security events...</div>
        </div>
      </div>
    </div>

    <script>
      class SecurityDashboard {
        constructor() {
          this.charts = {};
          this.refreshInterval = null;
          this.init();
        }

        async init() {
          await this.loadDashboardData();
          this.setupCharts();
          this.setupEventListeners();
          this.startAutoRefresh();
        }

        async loadDashboardData() {
          try {
            const [metrics, events, compliance] = await Promise.all([
              this.fetchSecurityMetrics(),
              this.fetchSecurityEvents(),
              this.fetchComplianceStatus(),
            ]);

            this.updateMetrics(metrics);
            this.updateEvents(events);
            this.updateCompliance(compliance);
            this.updateCharts(metrics, events);
          } catch (error) {
            console.error('Failed to load dashboard data:', error);
            this.showError('Failed to load dashboard data');
          }
        }

        async fetchSecurityMetrics() {
          const response = await fetch('/.netlify/functions/get-security-metrics');
          if (!response.ok) throw new Error('Failed to fetch metrics');
          return await response.json();
        }

        async fetchSecurityEvents() {
          const response = await fetch('/.netlify/functions/get-security-events');
          if (!response.ok) throw new Error('Failed to fetch events');
          return await response.json();
        }

        async fetchComplianceStatus() {
          const response = await fetch('/.netlify/functions/get-compliance-status');
          if (!response.ok) throw new Error('Failed to fetch compliance');
          return await response.json();
        }

        updateMetrics(metrics) {
          document.getElementById('failed-logins-count').textContent = metrics.failedLogins;
          document.getElementById('security-events-count').textContent = metrics.securityEvents;
          document.getElementById('active-threats-count').textContent = metrics.activeThreats;
          document.getElementById('compliance-score').textContent = metrics.complianceScore + '%';

          // Update change indicators
          this.updateChangeIndicator('failed-logins-change', metrics.failedLoginsChange);
          this.updateChangeIndicator('security-events-change', metrics.securityEventsChange);
          this.updateChangeIndicator('active-threats-change', metrics.activeThreatsChange);
          this.updateChangeIndicator('compliance-score-change', metrics.complianceScoreChange);

          // Update overall status
          this.updateOverallStatus(metrics);
        }

        updateChangeIndicator(elementId, change) {
          const element = document.getElementById(elementId);
          element.textContent = (change >= 0 ? '+' : '') + change + '%';

          element.className = 'metric-change ';
          if (change > 0) {
            element.className += 'change-negative';
          } else if (change < 0) {
            element.className += 'change-positive';
          } else {
            element.className += 'change-neutral';
          }
        }

        updateOverallStatus(metrics) {
          const statusElement = document.getElementById('overall-status');
          const statusText = statusElement.querySelector('.status-text');
          const statusIcon = statusElement.querySelector('.status-icon');

          let status, icon, className;

          if (metrics.activeThreats > 0 || metrics.complianceScore < 80) {
            status = 'Critical';
            icon = 'üö®';
            className = 'status-critical';
          } else if (metrics.failedLogins > 10 || metrics.complianceScore < 90) {
            status = 'Warning';
            icon = '‚ö†Ô∏è';
            className = 'status-warning';
          } else {
            status = 'Secure';
            icon = 'üîí';
            className = 'status-secure';
          }

          statusText.textContent = status;
          statusIcon.textContent = icon;
          statusElement.className = 'status-indicator ' + className;
        }

        updateEvents(events) {
          const eventsList = document.getElementById('events-list');
          eventsList.innerHTML = '';

          if (events.length === 0) {
            eventsList.innerHTML = '<div class="loading">No recent security events</div>';
            return;
          }

          events.forEach(event => {
            const eventElement = this.createEventElement(event);
            eventsList.appendChild(eventElement);
          });
        }

        createEventElement(event) {
          const eventDiv = document.createElement('div');
          eventDiv.className = 'event-item';

          eventDiv.innerHTML = `
                    <div class="event-info">
                        <div class="event-type">${this.formatEventType(event.type)}</div>
                        <div class="event-details">${event.details}</div>
                    </div>
                    <div class="event-time">${this.formatTime(event.timestamp)}</div>
                    <div class="event-severity severity-${event.severity}">${event.severity}</div>
                `;

          return eventDiv;
        }

        updateCompliance(compliance) {
          const complianceGrid = document.getElementById('compliance-grid');
          complianceGrid.innerHTML = '';

          compliance.checks.forEach(check => {
            const checkElement = this.createComplianceElement(check);
            complianceGrid.appendChild(checkElement);
          });
        }

        createComplianceElement(check) {
          const checkDiv = document.createElement('div');
          checkDiv.className = 'compliance-item';

          let icon, className;
          if (check.status === 'pass') {
            icon = '‚úÖ';
            className = 'compliance-pass';
          } else if (check.status === 'fail') {
            icon = '‚ùå';
            className = 'compliance-fail';
          } else {
            icon = '‚ö†Ô∏è';
            className = 'compliance-warning';
          }

          checkDiv.className += ' ' + className;

          checkDiv.innerHTML = `
                    <div class="compliance-icon">${icon}</div>
                    <div>
                        <div style="font-weight: 600;">${check.name}</div>
                        <div style="font-size: 0.9rem; color: var(--color-text-secondary);">${check.description}</div>
                    </div>
                `;

          return checkDiv;
        }

        setupCharts() {
          // Security Events Chart
          const eventsCtx = document.getElementById('security-events-chart').getContext('2d');
          this.charts.events = new Chart(eventsCtx, {
            type: 'line',
            data: {
              labels: [],
              datasets: [
                {
                  label: 'Security Events',
                  data: [],
                  borderColor: '#ef4444',
                  backgroundColor: 'rgba(239, 68, 68, 0.1)',
                  tension: 0.4,
                },
              ],
            },
            options: {
              responsive: true,
              scales: {
                y: {
                  beginAtZero: true,
                },
              },
            },
          });

          // Failed Logins Chart
          const loginsCtx = document.getElementById('failed-logins-chart').getContext('2d');
          this.charts.logins = new Chart(loginsCtx, {
            type: 'bar',
            data: {
              labels: [],
              datasets: [
                {
                  label: 'Failed Logins',
                  data: [],
                  backgroundColor: '#f59e0b',
                  borderColor: '#d97706',
                  borderWidth: 1,
                },
              ],
            },
            options: {
              responsive: true,
              scales: {
                y: {
                  beginAtZero: true,
                },
              },
            },
          });
        }

        updateCharts(metrics, events) {
          // Update security events chart
          const eventData = this.processEventData(events);
          this.charts.events.data.labels = eventData.labels;
          this.charts.events.data.datasets[0].data = eventData.values;
          this.charts.events.update();

          // Update failed logins chart
          const loginData = this.processLoginData(events);
          this.charts.logins.data.labels = loginData.labels;
          this.charts.logins.data.datasets[0].data = loginData.values;
          this.charts.logins.update();
        }

        processEventData(events) {
          const hours = 24;
          const labels = [];
          const values = [];

          for (let i = hours - 1; i >= 0; i--) {
            const hour = new Date(Date.now() - i * 60 * 60 * 1000);
            labels.push(hour.getHours() + ':00');

            const hourEvents = events.filter(event => {
              const eventTime = new Date(event.timestamp);
              return (
                eventTime.getHours() === hour.getHours() && eventTime.getDate() === hour.getDate()
              );
            });

            values.push(hourEvents.length);
          }

          return { labels, values };
        }

        processLoginData(events) {
          const loginEvents = events.filter(event => event.type === 'failed_login');
          const ipCounts = {};

          loginEvents.forEach(event => {
            const ip = event.details.ip || 'unknown';
            ipCounts[ip] = (ipCounts[ip] || 0) + 1;
          });

          const sortedIPs = Object.entries(ipCounts)
            .sort(([, a], [, b]) => b - a)
            .slice(0, 10);

          return {
            labels: sortedIPs.map(([ip]) => ip),
            values: sortedIPs.map(([, count]) => count),
          };
        }

        setupEventListeners() {
          document.getElementById('severity-filter').addEventListener('change', () => {
            this.filterEvents();
          });

          document.getElementById('type-filter').addEventListener('change', () => {
            this.filterEvents();
          });
        }

        filterEvents() {
          const severityFilter = document.getElementById('severity-filter').value;
          const typeFilter = document.getElementById('type-filter').value;

          // This would filter the events list based on selected filters
          // Implementation depends on how events are stored and displayed
        }

        startAutoRefresh() {
          this.refreshInterval = setInterval(() => {
            this.loadDashboardData();
          }, 30000); // Refresh every 30 seconds
        }

        stopAutoRefresh() {
          if (this.refreshInterval) {
            clearInterval(this.refreshInterval);
            this.refreshInterval = null;
          }
        }

        formatEventType(type) {
          return type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        formatTime(timestamp) {
          const date = new Date(timestamp);
          return date.toLocaleString();
        }

        showError(message) {
          console.error(message);
          // Could show a toast notification or error banner
        }
      }

      // Global functions
      function refreshDashboard() {
        if (window.dashboard) {
          window.dashboard.loadDashboardData();
        }
      }

      // Initialize dashboard when page loads
      document.addEventListener('DOMContentLoaded', () => {
        window.dashboard = new SecurityDashboard();
      });

      // Cleanup on page unload
      window.addEventListener('beforeunload', () => {
        if (window.dashboard) {
          window.dashboard.stopAutoRefresh();
        }
      });
    </script>
  </body>
</html>
