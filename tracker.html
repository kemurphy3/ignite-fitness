<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IgniteFitness - Multi-User Tracker</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#1a1a1a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="IgniteFitness">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="msapplication-TileColor" content="#1a1a1a">
    <meta name="msapplication-tap-highlight" content="no">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- iOS Icons -->
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="apple-touch-icon" sizes="192x192" href="icon-192.png">
    <link rel="apple-touch-icon" sizes="512x512" href="icon-512.png">
    
    <!-- Android Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #1a1a1a;
            color: #ffffff;
            line-height: 1.6;
            padding: 10px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #2d3748, #4a5568);
            border-radius: 10px;
        }

        .header h1 {
            color: #68d391;
            font-size: 24px;
            margin-bottom: 5px;
        }

        .tab-container {
            display: flex;
            margin-bottom: 20px;
            background-color: #2d3748;
            border-radius: 10px;
            overflow: hidden;
            flex-wrap: wrap;
        }
        
        /* Mobile layout - force stacking for all mobile devices */
        @media (max-width: 768px) {
            .tab-container {
                display: grid !important;
                grid-template-columns: 1fr 1fr 1fr 1fr !important;
                gap: 6px !important;
                padding: 8px !important;
                flex-wrap: nowrap !important;
            }
            
            /* Row 1: Log Workout, Soccer, Analysis, Recovery */
            .tab:nth-child(-n+4) {
                width: 100% !important;
                flex: none !important;
            }
            
            /* Row 2: History, Summary, Export, Personal Data */
            .tab:nth-child(5) {
                grid-column: 1 / 2 !important;
                width: 100% !important;
                flex: none !important;
            }
            
            .tab:nth-child(6) {
                grid-column: 2 / 3 !important;
                width: 100% !important;
                flex: none !important;
            }
            
            .tab:nth-child(7) {
                grid-column: 3 / 4 !important;
                width: 100% !important;
                flex: none !important;
            }
            
            .tab:nth-child(8) {
                grid-column: 4 / 5 !important;
                width: 100% !important;
                flex: none !important;
            }
        }
        
        /* Tablet layout */
        @media (min-width: 481px) and (max-width: 768px) {
            .tab-container {
                flex-wrap: wrap;
                gap: 4px;
                padding: 6px;
            }
            
            .tab:nth-child(-n+4) {
                flex: 1;
                min-width: calc(50% - 2px);
            }
            
            .tab:nth-child(n+5) {
                flex: 1;
                min-width: calc(33.333% - 3px);
            }
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background-color: #2d3748;
            color: #a0aec0;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        @media (max-width: 768px) {
            .tab {
                padding: 10px 6px !important;
                font-size: 12px !important;
                border-radius: 6px !important;
                line-height: 1.1 !important;
                font-weight: 600 !important;
                min-height: 44px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
            }
        }
        
        @media (min-width: 481px) and (max-width: 768px) {
            .tab {
                padding: 10px 8px;
                font-size: 14px;
                border-radius: 6px;
                line-height: 1.2;
            }
        }

        .tab.active {
            background-color: #68d391;
            color: #1a1a1a;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-section {
            background-color: #2d3748;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #e2e8f0;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #4a5568;
            border-radius: 8px;
            background-color: #1a1a1a;
            color: #ffffff;
            font-size: 16px;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #68d391;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .slider {
            flex: 1;
            height: 8px;
            border-radius: 5px;
            background: #4a5568;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #68d391;
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #68d391;
            cursor: pointer;
            border: none;
        }

        .slider-value {
            min-width: 30px;
            text-align: center;
            font-weight: bold;
            color: #68d391;
        }

        .btn {
            background-color: #68d391;
            color: #1a1a1a;
            border: none;
            padding: 15px 25px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin: 10px 0;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background-color: #9ae6b4;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: #4a5568;
            color: #ffffff;
        }

        .btn-secondary:hover {
            background-color: #718096;
        }

        .exercise-card {
            background-color: #2d3748;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #68d391;
        }

        .exercise-card.pr {
            border-left-color: #68d391;
        }

        .exercise-card.match {
            border-left-color: #fbd38d;
        }

        .exercise-card.miss {
            border-left-color: #fc8181;
        }

        .exercise-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .exercise-name {
            font-weight: 600;
            font-size: 18px;
            color: #e2e8f0;
        }

        .exercise-date {
            color: #a0aec0;
            font-size: 14px;
        }

        .exercise-details {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        .exercise-detail {
            text-align: center;
        }

        .exercise-detail-label {
            font-size: 12px;
            color: #a0aec0;
            margin-bottom: 2px;
        }

        .exercise-detail-value {
            font-weight: 600;
            color: #e2e8f0;
        }

        .exercise-notes {
            color: #a0aec0;
            font-style: italic;
            font-size: 14px;
        }

        .session-card {
            background-color: #2d3748;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .session-type {
            background-color: #68d391;
            color: #1a1a1a;
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: 600;
            font-size: 14px;
        }

        .session-date {
            color: #a0aec0;
            font-size: 14px;
        }

        .session-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
        }

        .session-stat {
            text-align: center;
        }

        .session-stat-label {
            font-size: 12px;
            color: #a0aec0;
            margin-bottom: 2px;
        }

        .session-stat-value {
            font-weight: 600;
            color: #e2e8f0;
        }

        .workout-toggle {
            background: none;
            border: none;
            color: #68d391;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }

        .workout-exercises {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #4a5568;
        }

        .summary-card {
            background-color: #2d3748;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .summary-title {
            font-size: 20px;
            font-weight: 600;
            color: #68d391;
            margin-bottom: 15px;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .summary-stat {
            text-align: center;
            padding: 10px;
            background-color: #1a1a1a;
            border-radius: 8px;
        }

        .summary-stat-label {
            font-size: 12px;
            color: #a0aec0;
            margin-bottom: 5px;
        }

        .summary-stat-value {
            font-size: 18px;
            font-weight: 600;
            color: #e2e8f0;
        }

        .progression-list {
            list-style: none;
        }

        .progression-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: #1a1a1a;
            border-radius: 5px;
            margin-bottom: 5px;
        }

        .progression-exercise {
            font-weight: 500;
        }

        .progression-value {
            color: #68d391;
            font-weight: 600;
        }

        .export-section {
            background-color: #2d3748;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .export-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .hidden {
            display: none;
        }

        .other-exercise-input {
            margin-top: 10px;
        }

        .planned-workout {
            background-color: #1a1a1a;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border: 2px solid #4a5568;
        }

        .planned-exercise {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #2d3748;
            border-radius: 5px;
            border-left: 4px solid #68d391;
        }

        .planned-exercise-info {
            flex: 1;
        }

        .planned-exercise-name {
            font-weight: 600;
            color: #e2e8f0;
            margin-bottom: 2px;
        }

        .planned-exercise-target {
            font-size: 14px;
            color: #a0aec0;
        }

        .planned-exercise-input {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .planned-exercise-input input {
            width: 60px;
            padding: 5px;
            border: 1px solid #4a5568;
            border-radius: 4px;
            background-color: #1a1a1a;
            color: #ffffff;
            text-align: center;
        }

        .planned-exercise-input input::placeholder {
            color: #a0aec0;
        }

        .planned-exercise-input textarea {
            width: 120px;
            padding: 5px;
            border: 1px solid #4a5568;
            border-radius: 4px;
            background-color: #1a1a1a;
            color: #ffffff;
            font-size: 12px;
            resize: none;
        }

        .planned-exercise-input textarea::placeholder {
            color: #a0aec0;
        }

        .set-entry-example {
            font-size: 11px;
            color: #a0aec0;
            margin-top: 2px;
        }

        .add-exercise-section {
            background-color: #2d3748;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border: 2px dashed #4a5568;
        }

        .quick-add-form {
            display: grid;
            grid-template-columns: 1fr 80px 80px auto;
            gap: 10px;
            align-items: end;
        }

        @media (max-width: 480px) {
            .quick-add-form {
                grid-template-columns: 1fr;
            }
            
            .planned-exercise {
                flex-direction: column;
                align-items: stretch;
            }
            
            .planned-exercise-input {
                justify-content: space-between;
                margin-top: 10px;
            }
        }

        @media (max-width: 480px) {
            .exercise-details {
                grid-template-columns: 1fr 1fr;
            }
            
            .summary-stats {
                grid-template-columns: 1fr;
            }
            
            .export-buttons {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>IgniteFitness</h1>
            <p>Multi-User Performance Tracking</p>
        </div>

        <!-- Login Form -->
        <div id="loginForm" class="form-section" style="background: #2d3748; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
            <h3>Login to IgniteFitness</h3>
            <div class="form-group">
                <label for="loginUsername">Username</label>
                <input type="text" id="loginUsername" class="form-input" placeholder="Enter username">
            </div>
            <div class="form-group">
                <label for="loginPassword">Password</label>
                <input type="password" id="loginPassword" class="form-input" placeholder="Enter password">
            </div>
            <button class="btn" onclick="login()">Login</button>
            <button class="btn" onclick="showRegisterForm()" style="background: #718096; margin-left: 10px;">Register New Athlete</button>
            <div id="loginError" style="color: #fc8181; margin-top: 10px; display: none;"></div>
        </div>

        <!-- Register Form (hidden by default) -->
        <div id="registerForm" class="form-section hidden" style="background: #2d3748; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
            <h3>Register New Athlete</h3>
            <div class="form-group">
                <label for="regUsername">Username</label>
                <input type="text" id="regUsername" class="form-input" placeholder="Choose username">
            </div>
            <div class="form-group">
                <label for="regPassword">Password</label>
                <input type="password" id="regPassword" class="form-input" placeholder="Choose password">
            </div>
            <div class="form-group">
                <label for="regConfirmPassword">Confirm Password</label>
                <input type="password" id="regConfirmPassword" class="form-input" placeholder="Confirm password">
            </div>
            <div class="form-group">
                <label for="regAthleteName">Athlete Name</label>
                <input type="text" id="regAthleteName" class="form-input" placeholder="Full name">
            </div>
            <button class="btn" onclick="register()">Register Athlete</button>
            <button class="btn" onclick="hideRegisterForm()" style="background: #718096; margin-left: 10px;">Cancel</button>
            <div id="registerError" style="color: #fc8181; margin-top: 10px; display: none;"></div>
        </div>

        <!-- User Dashboard (hidden until logged in) -->
        <div id="userDashboard" class="hidden">
            <div class="form-section" style="background: #2d3748; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                <h3>Welcome, <span id="currentAthleteName"></span></h3>
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button class="btn" onclick="showPersonalDataForm()">Edit Profile</button>
                    <button class="btn" onclick="showWearableSetup()">Setup Wearables</button>
                    <button class="btn" onclick="logout()" style="background: #fc8181;">Logout</button>
                </div>
            </div>
        </div>

        <!-- Add User Form (hidden by default) -->
        <div id="addUserForm" class="form-section hidden" style="background: #2d3748; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
            <h3>Add New User</h3>
            <div class="form-group">
                <label for="newUserName">Name</label>
                <input type="text" id="newUserName" class="form-input" placeholder="Enter user name">
            </div>
            <button class="btn" onclick="addNewUser()">Create User</button>
            <button class="btn" onclick="hideAddUserForm()" style="background: #718096; margin-left: 10px;">Cancel</button>
        </div>

        <div class="tab-container">
            <button class="tab active" onclick="switchTab('log')">Log Workout</button>
            <button class="tab" onclick="switchTab('soccer')">Soccer</button>
            <button class="tab" onclick="switchTab('analysis')">Analysis</button>
            <button class="tab" onclick="switchTab('recovery')">Recovery</button>
            <button class="tab" onclick="switchTab('history')">History</button>
            <button class="tab" onclick="switchTab('summary')">Summary</button>
            <button class="tab" onclick="switchTab('export')">Export</button>
            <button class="tab" onclick="switchTab('personal')">Personal Data</button>
        </div>

        <!-- Log Workout Tab -->
        <div id="log" class="tab-content active">
            <div class="form-section">
                <h3>Session Details</h3>
                <div class="form-group">
                    <label for="sessionDate">Date</label>
                    <input type="date" id="sessionDate" class="form-input">
                </div>
                <div class="form-group">
                    <label for="sessionStartTime">Start Time</label>
                    <input type="time" id="sessionStartTime" class="form-input">
                </div>
                <div class="form-group">
                    <label for="sessionType">Session Type</label>
                    <select id="sessionType" class="form-select" onchange="loadDailyPlan()">
                        <option value="">Select Session Type</option>
                        <option value="Upper A">Upper A</option>
                        <option value="Upper B">Upper B</option>
                        <option value="Lower A">Lower A</option>
                        <option value="Lower B">Lower B</option>
                        <option value="Soccer (Indoor)">Soccer (Indoor)</option>
                <option value="Soccer (Outdoor)">Soccer (Outdoor)</option>
                        <option value="Indoor Climbing">Indoor Climbing</option>
                        <option value="Outdoor Climbing">Outdoor Climbing</option>
                        <option value="Recovery">Recovery</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="sessionEnergy">Overall Energy (1-10)</label>
                    <div class="slider-container">
                        <input type="range" id="sessionEnergy" class="slider" min="1" max="10" value="7">
                        <span class="slider-value" id="sessionEnergyValue">7</span>
                    </div>
                </div>
                
                <!-- Climbing Fields (hidden by default) -->
                <div class="form-group" id="climbingIntensityGroup" style="display: none;">
                    <label for="climbingIntensity">Climbing Intensity (1-10)</label>
                    <div class="slider-container">
                        <input type="range" id="climbingIntensity" class="slider" min="1" max="10" value="5">
                        <span class="slider-value" id="climbingIntensityValue">5</span>
                    </div>
                    <small style="color: #a0aec0; font-size: 12px;">
                        1-3: Easy climbing, 4-6: Moderate, 7-8: Hard, 9-10: Maximum effort<br>
                        <strong style="color: #68d391;">🧗‍♂️ Note: Climbing is primarily pull movements + core work</strong>
                    </small>
                </div>
                
                <div class="form-group" id="climbingRoutesGroup" style="display: none;">
                    <label for="climbingRoutes">Number of Routes</label>
                    <input type="number" id="climbingRoutes" class="form-input" min="1" max="50" placeholder="e.g., 12">
                    <small style="color: #a0aec0; font-size: 12px;">
                        Total routes climbed (including warm-up and cool-down)
                    </small>
                </div>
                
                <div class="form-group" id="climbingDurationGroup" style="display: none;">
                    <label for="climbingDuration">Session Duration (minutes)</label>
                    <input type="number" id="climbingDuration" class="form-input" min="30" max="480" placeholder="e.g., 120">
                    <small style="color: #a0aec0; font-size: 12px;">
                        Total time including belaying, waiting, and social breaks
                    </small>
                </div>
                
                <div class="form-group">
                    <label for="sessionNotes">Session Notes</label>
                    <textarea id="sessionNotes" class="form-input" rows="3" placeholder="How did the session feel overall? Any modifications needed?"></textarea>
                </div>
            </div>

            <div class="form-section">
                <h3>Today's Planned Workout</h3>
                <div id="plannedWorkout" class="planned-workout">
                    <p style="color: #a0aec0; text-align: center; padding: 20px;">Select a session type to load today's plan</p>
                </div>
                <button class="btn btn-secondary" onclick="clearPlan()">Clear Plan</button>
            </div>

            <div class="add-exercise-section">
                <h3>Quick Add Extra Exercise</h3>
                <p style="color: #a0aec0; font-size: 14px; margin-bottom: 15px;">Add any extra exercises or modifications to your plan</p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; align-items: start;">
                    <div>
                        <select id="extraExerciseName" class="form-select">
                            <option value="Bench Press">Bench Press</option>
                            <option value="Squat">Squat</option>
                            <option value="Deadlift">Deadlift</option>
                            <option value="RDL">RDL</option>
                            <option value="Pull-ups">Pull-ups</option>
                            <option value="Shoulder Press">Shoulder Press</option>
                            <option value="Rows">Rows</option>
                            <option value="Lat Pulldown">Lat Pulldown</option>
                            <option value="Incline DB Press">Incline DB Press</option>
                            <option value="Lateral Raises">Lateral Raises</option>
                            <option value="Face Pulls">Face Pulls</option>
                            <option value="Nordic Curls">Nordic Curls</option>
                            <option value="Single Leg RDLs">Single Leg RDLs</option>
                            <option value="Bulgarian Split Squats">Bulgarian Split Squats</option>
                            <option value="Goblet Squat">Goblet Squat</option>
                            <option value="Lateral Lunges">Lateral Lunges</option>
                            <option value="Box Jumps">Box Jumps</option>
                            <option value="Single Leg Box Jump">Single Leg Box Jump</option>
                            <option value="Walking Lunges">Walking Lunges</option>
                            <option value="Copenhagen Planks">Copenhagen Planks</option>
                            <option value="Other">Other</option>
                        </select>
                        <div id="otherExtraExerciseGroup" class="form-group hidden" style="margin-top: 10px;">
                            <input type="text" id="otherExtraExerciseName" class="form-input" placeholder="Enter exercise name">
                        </div>
                    </div>
                    <div>
                        <textarea id="extraSetsReps" class="form-input" placeholder="Sets & Weights&#10;Example: 40x12, 45x10, 50x6&#10;or: 3x5 @ 40" rows="3" style="resize: none;"></textarea>
                        <button class="btn" onclick="addExtraExercise()" style="margin-top: 10px; width: 100%;">Add Exercise</button>
                    </div>
                </div>
                <div class="set-entry-example" style="margin-top: 10px;">
                    <strong>Flexible formats:</strong> "40x12, 45x10, 50x6" | "3x5 @ 40" | "12, 10, 6" | "40x12 45x10 50x6"
                </div>
            </div>

            <div id="currentSession" class="form-section">
                <h3>Current Session</h3>
                <div id="currentExercises"></div>
                <button class="btn" onclick="saveSession()" style="margin-top: 15px;">✅ Complete Workout</button>
                <div id="sessionSavedMessage" style="display: none; background: #68d391; color: #1a1a1a; padding: 10px; border-radius: 8px; margin-top: 10px; text-align: center; font-weight: 600;">
                    🎉 Workout completed and saved!
                </div>
            </div>
        </div>

        <!-- History Tab -->
        <div id="history" class="tab-content">
            <div id="workoutHistory"></div>
        </div>

        <!-- Summary Tab -->
        <div id="summary" class="tab-content">
            <div class="summary-card">
                <div class="summary-title">This Week's Summary</div>
                <div class="summary-stats">
                    <div class="summary-stat">
                        <div class="summary-stat-label">Sessions</div>
                        <div class="summary-stat-value" id="weeklySessions">0</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-label">Avg Energy</div>
                        <div class="summary-stat-value" id="weeklyEnergy">0/10</div>
                    </div>
                </div>
                <h4>Main Lift Progressions</h4>
                <ul class="progression-list" id="progressionList"></ul>
                
                <h4>4-Week Progression Targets</h4>
                <div id="progressionTargets"></div>
                
                <h4>Recovery Metrics</h4>
                <div class="summary-stats">
                    <div class="summary-stat">
                        <div class="summary-stat-label">Avg Sleep</div>
                        <div class="summary-stat-value" id="avgSleep">0h</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-label">Yoga Days</div>
                        <div class="summary-stat-value" id="yogaDays">0/7</div>
                    </div>
                </div>
                
                <h4>Soccer Performance</h4>
                <div class="summary-stats">
                    <div class="summary-stat">
                        <div class="summary-stat-label">Avg Performance</div>
                        <div class="summary-stat-value" id="avgSoccerPerformance">0/10</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-label">ACL Warmups</div>
                        <div class="summary-stat-value" id="aclWarmupCompliance">0/0</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Soccer Tab -->
        <div id="soccer" class="tab-content">
            <div class="form-section">
                <h3>Soccer Performance Tracking</h3>
                <div class="form-group">
                    <label for="soccerDate">Date</label>
                    <input type="date" id="soccerDate" class="form-input">
                </div>
                <div class="form-group">
                    <label for="soccerType">Session Type</label>
                    <select id="soccerType" class="form-select">
                        <option value="Indoor Soccer">Indoor Soccer</option>
                        <option value="Soccer Practice">Soccer Practice</option>
                        <option value="Outdoor Match">Outdoor Match</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="soccerEnergy">Pre-Game Energy (1-10)</label>
                    <div class="slider-container">
                        <input type="range" id="soccerEnergy" class="slider" min="1" max="10" value="7">
                        <span class="slider-value" id="soccerEnergyValue">7</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="soccerPerformance">Performance Rating (1-10)</label>
                    <div class="slider-container">
                        <input type="range" id="soccerPerformance" class="slider" min="1" max="10" value="7">
                        <span class="slider-value" id="soccerPerformanceValue">7</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="soccerSharpness">Sharpness (1-10)</label>
                    <div class="slider-container">
                        <input type="range" id="soccerSharpness" class="slider" min="1" max="10" value="7">
                        <span class="slider-value" id="soccerSharpnessValue">7</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="preGameFuel">Pre-Game Fuel</label>
                    <input type="text" id="preGameFuel" class="form-input" placeholder="e.g., Apples/grapes + goldfish">
                </div>
                <div class="form-group">
                    <label for="aclWarmupCompleted">ACL Warmup Completed</label>
                    <select id="aclWarmupCompleted" class="form-select">
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="soccerNotes">Notable Observations</label>
                    <textarea id="soccerNotes" class="form-input" rows="3" placeholder="How did soccer feel? Any improvements or struggles?"></textarea>
                </div>
                <button class="btn" onclick="saveSoccerSession()">Save Soccer Session</button>
            </div>
            
            <div id="soccerHistory" class="form-section">
                <h3>Recent Soccer Sessions</h3>
                <div id="soccerSessionsList"></div>
            </div>
        </div>

        <!-- Analysis Tab -->
        <div id="analysis" class="tab-content">
            <div class="form-section">
                <h3>Daily Analysis Dashboard</h3>
                <div class="form-group">
                    <label for="analysisDate">Analysis Date</label>
                    <input type="date" id="analysisDate" class="form-input">
                </div>
                
                <h4>Strava Integration</h4>
                <div style="background: #2d3748; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <p style="color: #a0aec0; margin-bottom: 10px;">
                        <strong>Setup:</strong> Edit <code>config.js</code> with your Strava tokens from your .env file
                    </p>
                    <div style="font-size: 12px; color: #a0aec0;">
                        <strong>Current Status:</strong> <span id="tokenStatus">Loading...</span>
                    </div>
                </div>
                <div class="wearable-sync-buttons" style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn" id="syncStravaBtn" onclick="syncStravaData()" style="display: none;">🔄 Sync Strava</button>
                    <button class="btn" id="syncWhoopBtn" onclick="syncWhoopData()" style="display: none;">🔄 Sync Whoop</button>
                    <button class="btn" id="syncAppleBtn" onclick="syncAppleHealthData()" style="display: none;">🔄 Generate Demo Data</button>
                    <button class="btn" id="syncGarminBtn" onclick="syncGarminData()" style="display: none;">🔄 Sync Garmin</button>
                </div>
                <div id="wearableSyncStatus" style="margin-top: 10px; color: #a0aec0;"></div>
            </div>

            <div id="dailyAnalysis" class="form-section">
                <h4>Today's Training Analysis</h4>
                <div id="analysisResults"></div>
            </div>

            <div class="form-section">
                <h3>Sleep Data</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="form-group">
                        <label for="sleepDate">Sleep Date</label>
                        <input type="date" id="sleepDate" class="form-input">
                    </div>
                    <div class="form-group">
                        <label for="totalSleep">Total Sleep (hours)</label>
                        <input type="number" id="totalSleep" class="form-input" step="0.1" placeholder="7.5">
                    </div>
                    <div class="form-group">
                        <label for="deepSleep">Deep Sleep (hours)</label>
                        <input type="number" id="deepSleep" class="form-input" step="0.1" placeholder="1.8">
                    </div>
                    <div class="form-group">
                        <label for="remSleep">REM Sleep (hours)</label>
                        <input type="number" id="remSleep" class="form-input" step="0.1" placeholder="1.5">
                    </div>
                    <div class="form-group">
                        <label for="lightSleep">Light Sleep (hours)</label>
                        <input type="number" id="lightSleep" class="form-input" step="0.1" placeholder="4.2">
                    </div>
                    <div class="form-group">
                        <label for="sleepScore">Sleep Score (1-100)</label>
                        <input type="number" id="sleepScore" class="form-input" min="1" max="100" placeholder="85">
                    </div>
                </div>
                <button class="btn" onclick="saveSleepData()">Save Sleep Data</button>
            </div>

            <div id="sleepHistory" class="form-section">
                <h3>Recent Sleep Data</h3>
                <div id="sleepDataList"></div>
            </div>
        </div>

        <!-- Recovery Tab -->
        <div id="recovery" class="tab-content">
            <div class="form-section">
                <h3>Daily Recovery Tracking</h3>
                <div class="form-group">
                    <label for="recoveryDate">Date</label>
                    <input type="date" id="recoveryDate" class="form-input">
                </div>
                <div class="form-group">
                    <label for="sleepHours">Sleep Hours</label>
                    <input type="number" id="sleepHours" class="form-input" min="0" max="12" step="0.5" placeholder="8.0">
                    <small style="color: #a0aec0; font-size: 12px;">
                        Auto-populated from wearable data if available
                    </small>
                </div>
                <div class="form-group">
                    <label for="sorenessLevel">Soreness Level (1-10)</label>
                    <div class="slider-container">
                        <input type="range" id="sorenessLevel" class="slider" min="1" max="10" value="3">
                        <span class="slider-value" id="sorenessLevelValue">3</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="achillesTightness">Achilles Tightness (1-10)</label>
                    <div class="slider-container">
                        <input type="range" id="achillesTightness" class="slider" min="1" max="10" value="3">
                        <span class="slider-value" id="achillesTightnessValue">3</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="hipTightness">Hip Tightness (1-10)</label>
                    <div class="slider-container">
                        <input type="range" id="hipTightness" class="slider" min="1" max="10" value="3">
                        <span class="slider-value" id="hipTightnessValue">3</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="overallEnergy">Overall Energy (1-10)</label>
                    <div class="slider-container">
                        <input type="range" id="overallEnergy" class="slider" min="1" max="10" value="7">
                        <span class="slider-value" id="overallEnergyValue">7</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="moodLevel">Mood (1-10)</label>
                    <div class="slider-container">
                        <input type="range" id="moodLevel" class="slider" min="1" max="10" value="7">
                        <span class="slider-value" id="moodLevelValue">7</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="yogaCompleted">Yoga Completed</label>
                    <select id="yogaCompleted" class="form-select">
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="mobilityWorkCompleted">Mobility Work Completed</label>
                    <select id="mobilityWorkCompleted" class="form-select">
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                    </select>
                    <small style="color: #a0aec0; font-size: 12px;">
                        Hip circles, calf raises, ankle mobility, dynamic stretches, foam rolling
                    </small>
                </div>
                <div class="form-group">
                    <label for="dailyCalories">Daily Calories</label>
                    <input type="number" id="dailyCalories" class="form-input" placeholder="2200">
                </div>
                <div class="form-group">
                    <label for="proteinTargetHit">Protein Target Hit (130-140g)</label>
                    <select id="proteinTargetHit" class="form-select">
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="hydrationStatus">Hydration Status</label>
                    <select id="hydrationStatus" class="form-select">
                        <option value="Good">Good (4L+)</option>
                        <option value="Fair">Fair (3L)</option>
                        <option value="Poor">Poor (<3L)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="recoveryNotes">Recovery Notes</label>
                    <textarea id="recoveryNotes" class="form-input" rows="3" placeholder="Any observations about recovery, energy, or body signals"></textarea>
                </div>
                <button class="btn" onclick="saveRecoveryData()">Save Recovery Data</button>
            </div>
            
            <div id="recoveryHistory" class="form-section">
                <h3>Recent Recovery Data</h3>
                <div id="recoveryDataList"></div>
            </div>
        </div>

        <!-- Personal Data Tab -->
        <div id="personal" class="tab-content">
            <div class="form-section">
                <h3>Personal Information</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="userAge">Age</label>
                        <input type="number" id="userAge" class="form-input" min="13" max="100" placeholder="25">
                    </div>
                    <div class="form-group">
                        <label for="userWeight">Weight (lbs)</label>
                        <input type="number" id="userWeight" class="form-input" min="80" max="300" placeholder="140">
                    </div>
                    <div class="form-group">
                        <label for="userHeight">Height (inches)</label>
                        <input type="number" id="userHeight" class="form-input" min="48" max="84" placeholder="65">
                    </div>
                    <div class="form-group">
                        <label for="userSex">Sex</label>
                        <select id="userSex" class="form-select">
                            <option value="">Select...</option>
                            <option value="female">Female</option>
                            <option value="male">Male</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>
                <button class="btn" onclick="savePersonalInfo()">Save Personal Info</button>
            </div>

            <div class="form-section">
                <h3>Baseline Strength</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="baselineBench">Bench Press (lbs)</label>
                        <input type="number" id="baselineBench" class="form-input" min="0" placeholder="65">
                    </div>
                    <div class="form-group">
                        <label for="baselineSquat">Squat (lbs)</label>
                        <input type="number" id="baselineSquat" class="form-input" min="0" placeholder="95">
                    </div>
                    <div class="form-group">
                        <label for="baselineDeadlift">Deadlift (lbs)</label>
                        <input type="number" id="baselineDeadlift" class="form-input" min="0" placeholder="115">
                    </div>
                    <div class="form-group">
                        <label for="baselinePullups">Pull-ups (reps)</label>
                        <input type="number" id="baselinePullups" class="form-input" min="0" placeholder="3">
                    </div>
                </div>
                <button class="btn" onclick="saveBaselineStrength()">Save Baseline Strength</button>
            </div>

            <div class="form-section">
                <h3>Goals & Priorities</h3>
                <div class="form-group">
                    <label>Primary Goal</label>
                    <select id="primaryGoal" class="form-select">
                        <option value="">Select primary goal...</option>
                        <option value="lose_weight">Lose Weight</option>
                        <option value="gain_weight">Gain Weight</option>
                        <option value="maintain_weight">Maintain Weight</option>
                        <option value="drop_fat">Drop Body Fat</option>
                        <option value="grow_muscle">Grow Muscle</option>
                        <option value="improve_speed">Improve Speed</option>
                        <option value="improve_endurance">Improve Endurance</option>
                        <option value="improve_agility">Improve Agility</option>
                        <option value="acl_prevention">ACL Prevention</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Secondary Goals (select all that apply)</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                        <label><input type="checkbox" value="soccer_performance"> Soccer Performance</label>
                        <label><input type="checkbox" value="injury_prevention"> Injury Prevention</label>
                        <label><input type="checkbox" value="strength_gain"> Strength Gain</label>
                        <label><input type="checkbox" value="speed_improvement"> Speed Improvement</label>
                        <label><input type="checkbox" value="endurance_building"> Endurance Building</label>
                        <label><input type="checkbox" value="agility_training"> Agility Training</label>
                        <label><input type="checkbox" value="acl_support"> ACL Support</label>
                        <label><input type="checkbox" value="core_stability"> Core Stability</label>
                    </div>
                </div>
                
                <button class="btn" onclick="saveGoals()">Save Goals</button>
            </div>

            <div class="form-section">
                <h3>Wearable Device Integration</h3>
                <p style="color: #a0aec0; margin-bottom: 15px;">Connect your wearable devices to automatically pull performance data and enhance AI insights.</p>
                
                <div class="form-group">
                    <label>Select Wearable Devices (choose all that apply)</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                        <label><input type="checkbox" id="enableStrava" onchange="toggleDeviceFields()"> Strava</label>
                        <label><input type="checkbox" id="enableWhoop" onchange="toggleDeviceFields()"> Whoop</label>
                        <label><input type="checkbox" id="enableAppleWatch" onchange="toggleDeviceFields()"> Apple Watch</label>
                        <label><input type="checkbox" id="enableGarmin" onchange="toggleDeviceFields()"> Garmin</label>
                    </div>
                </div>

                <!-- Strava Fields -->
                <div id="stravaFields" class="device-fields" style="display: none;">
                    <h4>Strava Integration</h4>
                    <p style="color: #a0aec0; font-size: 14px; margin-bottom: 15px;">
                        Get your Strava API tokens from: <a href="https://www.strava.com/settings/api" target="_blank" style="color: #68d391;">strava.com/settings/api</a>
                    </p>
                    <div class="form-group">
                        <label for="stravaClientId">Client ID</label>
                        <input type="text" id="stravaClientId" class="form-input" placeholder="Your Strava Client ID">
                    </div>
                    <div class="form-group">
                        <label for="stravaClientSecret">Client Secret</label>
                        <input type="password" id="stravaClientSecret" class="form-input" placeholder="Your Strava Client Secret">
                    </div>
                    <div class="form-group">
                        <label for="stravaAccessToken">Access Token</label>
                        <input type="password" id="stravaAccessToken" class="form-input" placeholder="Your Strava Access Token">
                    </div>
                    <div class="form-group">
                        <label for="stravaRefreshToken">Refresh Token</label>
                        <input type="password" id="stravaRefreshToken" class="form-input" placeholder="Your Strava Refresh Token">
                    </div>
                    <button class="btn" onclick="testStravaConnection()">Test Connection</button>
                    <div id="stravaTestResult" style="margin-top: 10px;"></div>
                </div>

                <!-- Whoop Fields -->
                <div id="whoopFields" class="device-fields" style="display: none;">
                    <h4>Whoop Integration</h4>
                    <p style="color: #a0aec0; font-size: 14px; margin-bottom: 15px;">
                        Get your Whoop API token from your Whoop account settings.
                    </p>
                    <div class="form-group">
                        <label for="whoopToken">Whoop API Token</label>
                        <input type="password" id="whoopToken" class="form-input" placeholder="Your Whoop API Token">
                    </div>
                    <button class="btn" onclick="testWhoopConnection()">Test Connection</button>
                    <div id="whoopTestResult" style="margin-top: 10px;"></div>
                </div>

                <!-- Apple Watch Fields -->
                <div id="appleWatchFields" class="device-fields" style="display: none;">
                    <h4>Apple Watch & Health App Integration</h4>
                    <p style="color: #a0aec0; font-size: 14px; margin-bottom: 15px;">
                        Access comprehensive health and fitness data from Apple HealthKit.
                    </p>
                    <div style="background: #2d3748; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                        <p style="color: #fbd38d; font-size: 12px; margin: 0;">
                            <strong>⚠️ Important:</strong> HealthKit requires a native iOS app. This web app uses comprehensive demo data that mimics real Apple Health data patterns. For actual HealthKit integration, a native iOS app would be needed.
                        </p>
                    </div>
                    <div style="background: #2d3748; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                        <p style="color: #68d391; font-size: 12px; margin: 0;">
                            <strong>✅ Available Data:</strong> Steps, Heart Rate, Sleep, VO2 Max, Body Mass, Exercise Minutes, 
                            Stand Hours, Mindful Sessions, Active Energy, Resting Heart Rate, Walking Heart Rate
                        </p>
                    </div>
                    <div class="form-group">
                        <label for="appleHealthKit">HealthKit Access</label>
                        <select id="appleHealthKit" class="form-select">
                            <option value="enabled">Enabled</option>
                            <option value="disabled">Disabled</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Data Categories</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                            <div style="background: #1a1a1a; padding: 10px; border-radius: 5px;">
                                <h5 style="color: #68d391; margin: 0 0 8px 0; font-size: 14px;">Activity Data</h5>
                                <label><input type="checkbox" checked disabled> Steps & Distance</label><br>
                                <label><input type="checkbox" checked disabled> Active Energy</label><br>
                                <label><input type="checkbox" checked disabled> Exercise Minutes</label><br>
                                <label><input type="checkbox" checked disabled> Stand Hours</label>
                            </div>
                            <div style="background: #1a1a1a; padding: 10px; border-radius: 5px;">
                                <h5 style="color: #68d391; margin: 0 0 8px 0; font-size: 14px;">Biometric Data</h5>
                                <label><input type="checkbox" checked disabled> Heart Rate</label><br>
                                <label><input type="checkbox" checked disabled> Resting HR</label><br>
                                <label><input type="checkbox" checked disabled> VO2 Max</label><br>
                                <label><input type="checkbox" checked disabled> Body Mass</label>
                            </div>
                            <div style="background: #1a1a1a; padding: 10px; border-radius: 5px;">
                                <h5 style="color: #68d391; margin: 0 0 8px 0; font-size: 14px;">Sleep & Recovery</h5>
                                <label><input type="checkbox" checked disabled> Sleep Analysis</label><br>
                                <label><input type="checkbox" checked disabled> Bedtime/Wake</label><br>
                                <label><input type="checkbox" checked disabled> Sleep Stages</label>
                            </div>
                            <div style="background: #1a1a1a; padding: 10px; border-radius: 5px;">
                                <h5 style="color: #68d391; margin: 0 0 8px 0; font-size: 14px;">Mindfulness</h5>
                                <label><input type="checkbox" checked disabled> Mindful Sessions</label><br>
                                <label><input type="checkbox" checked disabled> Breathing Rate</label>
                            </div>
                        </div>
                    </div>
                    <button class="btn" onclick="testAppleHealthConnection()">Test Connection</button>
                    <div id="appleTestResult" style="margin-top: 10px;"></div>
                </div>

                <!-- Garmin Fields -->
                <div id="garminFields" class="device-fields" style="display: none;">
                    <h4>Garmin Integration</h4>
                    <p style="color: #a0aec0; font-size: 14px; margin-bottom: 15px;">
                        Connect your Garmin Connect account for comprehensive activity tracking.
                    </p>
                    <div style="background: #2d3748; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                        <p style="color: #fbd38d; font-size: 12px; margin: 0;">
                            <strong>⚠️ Note:</strong> Garmin Connect doesn't have a public API. This integration uses mock data for demonstration. 
                            For real integration, consider using Garmin's Connect IQ or partner API programs.
                        </p>
                    </div>
                    <div class="form-group">
                        <label for="garminUsername">Garmin Connect Username</label>
                        <input type="text" id="garminUsername" class="form-input" placeholder="Your Garmin Connect username">
                    </div>
                    <div class="form-group">
                        <label for="garminPassword">Garmin Connect Password</label>
                        <input type="password" id="garminPassword" class="form-input" placeholder="Your Garmin Connect password">
                    </div>
                    <button class="btn" onclick="testGarminConnection()">Test Connection (Demo)</button>
                    <div id="garminTestResult" style="margin-top: 10px;"></div>
                </div>

                <div style="margin-top: 20px; padding: 15px; background: #1a1a1a; border-radius: 8px;">
                    <h4 style="color: #68d391; margin-bottom: 10px;">Data Sync Schedule</h4>
                    <div class="form-group">
                        <label for="syncFrequency">Sync Frequency</label>
                        <select id="syncFrequency" class="form-select">
                            <option value="manual">Manual Only</option>
                            <option value="daily">Daily</option>
                            <option value="twice_daily">Twice Daily</option>
                            <option value="hourly">Hourly</option>
                        </select>
                    </div>
                    <p style="color: #a0aec0; font-size: 12px; margin-top: 10px;">
                        Automatic sync helps maintain up-to-date data for better AI insights and trend analysis.
                    </p>
                </div>

                <button class="btn" onclick="saveDeviceSettings()" style="margin-top: 20px;">Save Device Settings</button>
            </div>

            <div class="form-section">
                <h3>Workout Schedule Planning</h3>
                <p style="color: #a0aec0; margin-bottom: 15px;">Tell us about your schedule so we can create a personalized workout plan that fits your life.</p>
                
                <div class="form-group">
                    <label>When do you have soccer games?</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                        <div style="background: #1a1a1a; padding: 10px; border-radius: 5px;" data-section="indoor-games">
                            <h5 style="color: #68d391; margin: 0 0 8px 0; font-size: 14px;">Indoor Games</h5>
                            <label><input type="checkbox" value="monday"> Monday</label><br>
                            <label><input type="checkbox" value="tuesday"> Tuesday</label><br>
                            <label><input type="checkbox" value="wednesday"> Wednesday</label><br>
                            <label><input type="checkbox" value="thursday"> Thursday</label><br>
                            <label><input type="checkbox" value="friday"> Friday</label><br>
                            <label><input type="checkbox" value="saturday"> Saturday</label><br>
                            <label><input type="checkbox" value="sunday"> Sunday</label>
                        </div>
                        <div style="background: #1a1a1a; padding: 10px; border-radius: 5px;" data-section="outdoor-games">
                            <h5 style="color: #68d391; margin: 0 0 8px 0; font-size: 14px;">Outdoor Games</h5>
                            <label><input type="checkbox" value="monday"> Monday</label><br>
                            <label><input type="checkbox" value="tuesday"> Tuesday</label><br>
                            <label><input type="checkbox" value="wednesday"> Wednesday</label><br>
                            <label><input type="checkbox" value="thursday"> Thursday</label><br>
                            <label><input type="checkbox" value="friday"> Friday</label><br>
                            <label><input type="checkbox" value="saturday"> Saturday</label><br>
                            <label><input type="checkbox" value="sunday"> Sunday</label>
                        </div>
                    </div>
                </div>

                <div class="form-group" data-section="practices">
                    <label>When do you have soccer practices?</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                        <label><input type="checkbox" value="monday"> Monday</label>
                        <label><input type="checkbox" value="tuesday"> Tuesday</label>
                        <label><input type="checkbox" value="wednesday"> Wednesday</label>
                        <label><input type="checkbox" value="thursday"> Thursday</label>
                        <label><input type="checkbox" value="friday"> Friday</label>
                        <label><input type="checkbox" value="saturday"> Saturday</label>
                        <label><input type="checkbox" value="sunday"> Sunday</label>
                    </div>
                </div>

                <div class="form-group">
                    <label>How many times per week do you want to lift weights?</label>
                    <select id="liftingFrequency" class="form-select">
                        <option value="0">No weightlifting</option>
                        <option value="2">2 times per week</option>
                        <option value="3">3 times per week</option>
                        <option value="4">4 times per week</option>
                        <option value="5">5 times per week</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Preferred workout time of day</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                        <label><input type="radio" name="workoutTime" value="morning"> 🌅 Morning (6AM-12PM)</label>
                        <label><input type="radio" name="workoutTime" value="afternoon"> ☀️ Afternoon (12PM-6PM)</label>
                        <label><input type="radio" name="workoutTime" value="evening"> 🌆 Evening (6PM-10PM)</label>
                        <label><input type="radio" name="workoutTime" value="flexible"> 🔄 Flexible</label>
                    </div>
                </div>

                <div class="form-group">
                    <label>Weightlifting focus preference:</label>
                    <select id="liftingFocus" class="form-select">
                        <option value="balanced">Balanced (upper/lower split)</option>
                        <option value="upper_focused">Upper body focused</option>
                        <option value="lower_focused">Lower body focused</option>
                        <option value="full_body">Full body workouts</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Preferred lifting intensity:</label>
                    <select id="liftingIntensity" class="form-select">
                        <option value="light">Light (focus on form, 60-70% max)</option>
                        <option value="moderate">Moderate (70-80% max)</option>
                        <option value="high">High intensity (80-90% max)</option>
                        <option value="mixed">Mixed (varies by day)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Recovery work frequency:</label>
                    <select id="recoveryFrequency" class="form-select">
                        <option value="0">No dedicated recovery</option>
                        <option value="1">1 time per week</option>
                        <option value="2">2 times per week</option>
                        <option value="3">3 times per week</option>
                        <option value="daily">Daily (light recovery)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Cardio activities (select all that apply):</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                        <label><input type="checkbox" value="running"> Running</label>
                        <label><input type="checkbox" value="cycling"> Cycling</label>
                        <label><input type="checkbox" value="swimming"> Swimming</label>
                        <label><input type="checkbox" value="rowing"> Rowing</label>
                        <label><input type="checkbox" value="hiking"> Hiking</label>
                        <label><input type="checkbox" value="dance"> Dance/Classes</label>
                    </div>
                </div>

                <div class="form-group">
                    <label>Cardio frequency per week:</label>
                    <select id="cardioFrequency" class="form-select">
                        <option value="0">No dedicated cardio</option>
                        <option value="1">1 time per week</option>
                        <option value="2">2 times per week</option>
                        <option value="3">3 times per week</option>
                        <option value="4">4+ times per week</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Preferred workout days (optional - leave blank for auto-scheduling):</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                        <label><input type="checkbox" value="monday"> Monday</label>
                        <label><input type="checkbox" value="tuesday"> Tuesday</label>
                        <label><input type="checkbox" value="wednesday"> Wednesday</label>
                        <label><input type="checkbox" value="thursday"> Thursday</label>
                        <label><input type="checkbox" value="friday"> Friday</label>
                        <label><input type="checkbox" value="saturday"> Saturday</label>
                        <label><input type="checkbox" value="sunday"> Sunday</label>
                    </div>
                </div>

                <div class="form-group">
                    <button class="btn" onclick="saveSchedulePreferences()" style="background: #68d391; margin-right: 10px; margin-bottom: 10px;">
                        💾 Save Schedule Preferences
                    </button>
                </div>
                
                <div class="form-group">
                    <button class="btn" onclick="generateSmartSchedule()" style="background: #4299e1; margin-right: 10px;">
                        🤖 Generate Smart Schedule
                    </button>
                    <button class="btn" onclick="saveWorkoutSchedule()">
                        💾 Save Schedule
                    </button>
                </div>
            </div>

            <div class="form-section">
                <h3>Generated Workout Plan</h3>
                <div id="workoutPlanDisplay" style="background: #1a1a1a; padding: 15px; border-radius: 8px; margin-top: 10px;">
                    <p style="color: #a0aec0;">Complete your schedule planning to generate a personalized 4-week workout plan.</p>
                </div>
                <button class="btn" onclick="generateWorkoutPlan()" style="margin-top: 15px;">🎯 Generate Workout Plan</button>
            </div>
        </div>

        <!-- Export Tab -->
        <div id="export" class="tab-content">
            <div class="export-section">
                <h3>Export Data</h3>
                <div class="export-buttons">
                    <button class="btn" onclick="copyFormattedData()">Copy Formatted Text</button>
                    <button class="btn btn-secondary" onclick="downloadCSV()">Download CSV</button>
                </div>
                <div class="form-group">
                    <label for="exportText">Formatted Data Preview</label>
                    <textarea id="exportText" class="form-input" rows="10" readonly></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- Load configuration -->
    <script src="config.js"></script>
    <script>
        // Register Service Worker for PWA functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then((registration) => {
                        console.log('SW registered: ', registration);
                    })
                    .catch((registrationError) => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
    </script>
    <script>
        let currentSession = {
            date: '',
            type: '',
            energy: 7,
            notes: '',
            exercises: []
        };

        // Multi-user system variables
        let currentUser = null;
        let users = {};
        let isLoggedIn = false;

        // Authentication Functions
        function login() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');

            if (!username || !password) {
                showError(errorDiv, 'Please enter both username and password');
                return;
            }

            // Load users from localStorage
            const savedUsers = localStorage.getItem('ignitefitness_users');
            if (savedUsers) {
                users = JSON.parse(savedUsers);
            }

            // Simple password check (in production, use proper hashing)
            if (users[username] && users[username].password === password) {
                currentUser = username;
                isLoggedIn = true;
                localStorage.setItem('ignitefitness_last_user', username);
                showUserDashboard();
                hideLoginForm();
                loadUserData();
            } else {
                showError(errorDiv, 'Invalid username or password');
            }
        }

        function register() {
            const username = document.getElementById('regUsername').value;
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('regConfirmPassword').value;
            const athleteName = document.getElementById('regAthleteName').value;
            const errorDiv = document.getElementById('registerError');

            if (!username || !password || !athleteName) {
                showError(errorDiv, 'Please fill in all fields');
                return;
            }

            if (password !== confirmPassword) {
                showError(errorDiv, 'Passwords do not match');
                return;
            }

            // Load existing users
            const savedUsers = localStorage.getItem('ignitefitness_users');
            if (savedUsers) {
                users = JSON.parse(savedUsers);
            }

            if (users[username]) {
                showError(errorDiv, 'Username already exists');
                return;
            }

            // Create new user
            users[username] = {
                password: password,
                athleteName: athleteName,
                personalData: {},
                goals: {},
                wearableSettings: {},
                workoutPlan: null,
                data: {
                    workouts: [],
                    soccerSessions: [],
                    recoveryData: [],
                    stravaData: [],
                    sleepData: []
                }
            };

            // Save users
            localStorage.setItem('ignitefitness_users', JSON.stringify(users));
            
            // Auto-login
            currentUser = username;
            isLoggedIn = true;
            localStorage.setItem('ignitefitness_last_user', username);
            showUserDashboard();
            hideRegisterForm();
            hideLoginForm();
            loadUserData();
        }

        function logout() {
            currentUser = null;
            isLoggedIn = false;
            localStorage.removeItem('ignitefitness_last_user');
            hideUserDashboard();
            showLoginForm();
            clearUserData();
        }

        function showLoginForm() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
        }

        function showRegisterForm() {
            document.getElementById('registerForm').classList.remove('hidden');
            document.getElementById('loginForm').classList.add('hidden');
        }

        function hideLoginForm() {
            document.getElementById('loginForm').classList.add('hidden');
        }

        function hideRegisterForm() {
            document.getElementById('registerForm').classList.add('hidden');
        }

        function hideUserDashboard() {
            document.getElementById('userDashboard').classList.add('hidden');
            document.querySelector('.tab-container').classList.add('hidden');
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
        }

        function showUserDashboard() {
            document.getElementById('userDashboard').classList.remove('hidden');
            document.querySelector('.tab-container').classList.remove('hidden');
            document.getElementById('currentAthleteName').textContent = users[currentUser].athleteName;
        }

        function showError(errorDiv, message) {
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // User Data Management Functions
        async function loadUserData() {
            if (!currentUser || !isLoggedIn) {
                console.log('Cannot load user data - currentUser:', currentUser, 'isLoggedIn:', isLoggedIn);
                return;
            }

            console.log('Loading user data for:', currentUser);
            console.log('Users object:', users);

            try {
                // Try to load from centralized storage first
                const response = await fetch(`/.netlify/functions/get-user-data?userId=${currentUser}`);
                
                if (response.ok) {
                    const result = await response.json();
                    const user = result.data;
                    
                    if (user) {
                        // Load user's data into global variables
                        soccerSessions = user.sessions?.filter(s => s.type === 'soccer') || [];
                        recoveryData = user.sessions?.filter(s => s.type === 'recovery') || [];
                        stravaData = user.stravaActivities || [];
                        sleepData = user.sleepSessions || [];
                        
                        // Convert database format to frontend format
                        const frontendUser = {
                            personalData: {
                                age: user.preferences?.age || null,
                                weight: user.preferences?.weight || null,
                                height: user.preferences?.height || null,
                                sex: user.preferences?.sex || null,
                                baselineStrength: user.preferences?.baseline_lifts || {}
                            },
                            goals: user.preferences?.goals ? {
                                primary: user.preferences.goals[0] || null,
                                secondary: user.preferences.goals[1] || null
                            } : {},
                            workoutSchedule: user.preferences?.workout_schedule || {},
                            email: user.email || null
                        };
                        
                        // Update local users object
                        users[currentUser] = frontendUser;
                    } else {
                        // User not found in database, fallback to local storage
                        console.log('User not found in database, loading from local storage');
                        loadUserDataFromLocal();
                    }
                } else {
                    // Fallback to local storage
                    loadUserDataFromLocal();
                }
            } catch (error) {
                console.log('Centralized storage not available, using local storage:', error);
                loadUserDataFromLocal();
            }
        }

        function loadUserDataFromLocal() {
            // Try both case variations
            let user = users[currentUser];
            if (!user) {
                // Try lowercase version
                user = users[currentUser.toLowerCase()];
                if (user) {
                    console.log('Found user with lowercase key:', currentUser.toLowerCase());
                }
            }
            
            if (!user) {
                console.log('No user found for currentUser:', currentUser);
                console.log('Available users:', Object.keys(users));
                return;
            }

            console.log('Loading user data from localStorage for:', currentUser, user);

            // Load user's data into global variables
            soccerSessions = user.data?.soccerSessions || [];
            recoveryData = user.data?.recoveryData || [];
            stravaData = user.data?.stravaData || [];
            sleepData = user.data?.sleepData || [];

            // Load personal data into form fields
            if (user.personalData) {
                document.getElementById('userAge').value = user.personalData.age || '';
                document.getElementById('userWeight').value = user.personalData.weight || '';
                document.getElementById('userHeight').value = user.personalData.height || '';
                document.getElementById('userSex').value = user.personalData.sex || '';
            }

            // Load baseline strength
            if (user.personalData && user.personalData.baselineStrength) {
                document.getElementById('baselineBench').value = user.personalData.baselineStrength.bench || '';
                document.getElementById('baselineSquat').value = user.personalData.baselineStrength.squat || '';
                document.getElementById('baselineDeadlift').value = user.personalData.baselineStrength.deadlift || '';
                document.getElementById('baselinePullups').value = user.personalData.baselineStrength.pullups || '';
            }

            // Load goals
            if (user.goals) {
                document.getElementById('primaryGoal').value = user.goals.primary || '';
                // Load secondary goals checkboxes
                if (user.goals.secondary) {
                    user.goals.secondary.forEach(goal => {
                        const checkbox = document.querySelector(`input[value="${goal}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                }
            }

            // Load wearable settings
            if (user.wearableSettings) {
                // Set checkboxes based on configured devices
                document.getElementById('enableStrava').checked = !!(user.wearableSettings.strava);
                document.getElementById('enableWhoop').checked = !!(user.wearableSettings.whoop);
                document.getElementById('enableAppleWatch').checked = !!(user.wearableSettings.appleWatch);
                document.getElementById('enableGarmin').checked = !!(user.wearableSettings.garmin);
                
                toggleDeviceFields();
                
                if (user.wearableSettings.strava) {
                    document.getElementById('stravaClientId').value = user.wearableSettings.strava.clientId || '';
                    document.getElementById('stravaClientSecret').value = user.wearableSettings.strava.clientSecret || '';
                    document.getElementById('stravaAccessToken').value = user.wearableSettings.strava.accessToken || '';
                    document.getElementById('stravaRefreshToken').value = user.wearableSettings.strava.refreshToken || '';
                }
                
                if (user.wearableSettings.whoop) {
                    document.getElementById('whoopToken').value = user.wearableSettings.whoop.token || '';
                }
                
                if (user.wearableSettings.appleWatch) {
                    document.getElementById('appleHealthKit').value = user.wearableSettings.appleWatch.healthKitEnabled ? 'enabled' : 'disabled';
                }
                
                if (user.wearableSettings.garmin) {
                    document.getElementById('garminUsername').value = user.wearableSettings.garmin.username || '';
                    document.getElementById('garminPassword').value = user.wearableSettings.garmin.password || '';
                }
                
                document.getElementById('syncFrequency').value = user.wearableSettings.syncFrequency || 'daily';
            }

           // Load workout schedule
           if (user.workoutSchedule) {
               loadWorkoutSchedule(user.workoutSchedule);
            }

            // Load workout plan
            if (user.workoutPlan) {
                displayWorkoutPlan(user.workoutPlan);
            }

            // Initialize sliders
            initializeSliders();
            
            // Update wearable sync buttons
            updateWearableSyncButtons();

            // Update displays
            updateHistory();
            updateSummary();
            updateAnalysis();
        }

        async function saveUserData() {
            if (!currentUser || !isLoggedIn) return;

            const user = users[currentUser];
            if (!user) return;

            // Prepare data for centralized storage
            const userData = {
                userId: currentUser,
                soccerSessions: soccerSessions,
                recoveryData: recoveryData,
                stravaData: stravaData,
                sleepData: sleepData,
                personalData: user.personalData,
                goals: user.goals,
                wearableSettings: user.wearableSettings,
                workoutPlan: user.workoutPlan,
                workoutSchedule: user.workoutSchedule
            };

            try {
                // Save to centralized storage
                const response = await fetch('/.netlify/functions/save-user-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: currentUser,
                        dataType: 'all',
                        data: {
                            username: currentUser,
                            email: user.email || null,
                            preferences: {
                                age: user.personalData?.age || null,
                                weight: user.personalData?.weight || null,
                                height: user.personalData?.height || null,
                                sex: user.personalData?.sex || null,
                                goals: user.goals ? [user.goals.primary, user.goals.secondary].filter(Boolean) : null,
                                baselineLifts: user.personalData?.baselineStrength || null,
                                workoutSchedule: user.workoutSchedule || null
                            }
                        }
                    })
                });

                if (response.ok) {
                    console.log('Data saved to centralized storage');
                } else {
                    throw new Error('Failed to save to centralized storage');
                }
            } catch (error) {
                console.log('Centralized storage failed, saving locally:', error);
                
                // Fallback to local storage
                user.data = user.data || {};
                user.data.soccerSessions = soccerSessions;
                user.data.recoveryData = recoveryData;
                user.data.stravaData = stravaData;
                user.data.sleepData = sleepData;
                
                localStorage.setItem('ignitefitness_users', JSON.stringify(users));
            }
        }

        function clearUserData() {
            soccerSessions = [];
            recoveryData = [];
            stravaData = [];
            sleepData = [];
        }

        // Helper functions for Personal Data tab
        function showPersonalDataForm() {
            switchTab('personal');
        }

        function showWearableSetup() {
            switchTab('personal');
            // Scroll to wearable section
            setTimeout(() => {
                const wearableSection = document.querySelector('#personal .form-section:nth-child(4)');
                if (wearableSection) {
                    wearableSection.scrollIntoView({ behavior: 'smooth' });
                }
            }, 100);
        }

        // Personal Data Functions
        async function savePersonalInfo() {
            if (!currentUser || !isLoggedIn) return;

            const user = users[currentUser];
            if (!user.personalData) user.personalData = {};

            user.personalData.age = document.getElementById('userAge').value;
            user.personalData.weight = document.getElementById('userWeight').value;
            user.personalData.height = document.getElementById('userHeight').value;
            user.personalData.sex = document.getElementById('userSex').value;

            localStorage.setItem('ignitefitness_users', JSON.stringify(users));
            
            // Also save to database
            try {
                await saveUserData();
                alert('Personal information saved to database!');
            } catch (error) {
                console.log('Database save failed, but local save succeeded:', error);
                alert('Personal information saved locally!');
            }
            
            // Refresh the form fields to show the saved data
            loadPersonalDataToForm();
        }

        async function saveBaselineStrength() {
            if (!currentUser || !isLoggedIn) return;

            const user = users[currentUser];
            if (!user.personalData) user.personalData = {};
            if (!user.personalData.baselineStrength) user.personalData.baselineStrength = {};

            user.personalData.baselineStrength.bench = document.getElementById('baselineBench').value;
            user.personalData.baselineStrength.squat = document.getElementById('baselineSquat').value;
            user.personalData.baselineStrength.deadlift = document.getElementById('baselineDeadlift').value;
            user.personalData.baselineStrength.pullups = document.getElementById('baselinePullups').value;

            localStorage.setItem('ignitefitness_users', JSON.stringify(users));
            
            // Also save to database
            try {
                await saveUserData();
                alert('Baseline strength saved to database!');
            } catch (error) {
                console.log('Database save failed, but local save succeeded:', error);
                alert('Baseline strength saved locally!');
            }
            
            // Refresh the form fields to show the saved data
            loadPersonalDataToForm();
        }

        async function saveGoals() {
            if (!currentUser || !isLoggedIn) return;

            const user = users[currentUser];
            if (!user.goals) user.goals = {};

            user.goals.primary = document.getElementById('primaryGoal').value;
            
            // Get secondary goals
            const secondaryGoals = [];
            document.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
                if (checkbox.value !== '') {
                    secondaryGoals.push(checkbox.value);
                }
            });
            user.goals.secondary = secondaryGoals;

            localStorage.setItem('ignitefitness_users', JSON.stringify(users));
            
            // Also save to database
            try {
                await saveUserData();
                alert('Goals saved to database!');
            } catch (error) {
                console.log('Database save failed, but local save succeeded:', error);
                alert('Goals saved locally!');
            }
            
            // Refresh the form fields to show the saved data
            loadPersonalDataToForm();
        }

        function loadPersonalDataToForm() {
            if (!currentUser || !isLoggedIn) return;
            
            const user = users[currentUser];
            if (!user) return;

            // Load personal data into form fields
            if (user.personalData) {
                document.getElementById('userAge').value = user.personalData.age || '';
                document.getElementById('userWeight').value = user.personalData.weight || '';
                document.getElementById('userHeight').value = user.personalData.height || '';
                document.getElementById('userSex').value = user.personalData.sex || '';
            }

            // Load baseline strength
            if (user.personalData && user.personalData.baselineStrength) {
                document.getElementById('baselineBench').value = user.personalData.baselineStrength.bench || '';
                document.getElementById('baselineSquat').value = user.personalData.baselineStrength.squat || '';
                document.getElementById('baselineDeadlift').value = user.personalData.baselineStrength.deadlift || '';
                document.getElementById('baselinePullups').value = user.personalData.baselineStrength.pullups || '';
            }

            // Load goals
            if (user.goals) {
                document.getElementById('primaryGoal').value = user.goals.primary || '';
                
                // Check secondary goals checkboxes
                document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = user.goals.secondary && user.goals.secondary.includes(checkbox.value);
                });
            }
        }

        function saveSchedulePreferences() {
            if (!currentUser || !isLoggedIn) return;

            const user = users[currentUser];
            if (!user.workoutSchedule) user.workoutSchedule = {};

            // Get indoor game days using data-section attribute
            const indoorGameDays = [];
            const indoorGamesSection = document.querySelector('[data-section="indoor-games"]');
            if (indoorGamesSection) {
                indoorGamesSection.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
                    indoorGameDays.push(checkbox.value);
                });
            }

            // Get outdoor game days using data-section attribute
            const outdoorGameDays = [];
            const outdoorGamesSection = document.querySelector('[data-section="outdoor-games"]');
            if (outdoorGamesSection) {
                outdoorGamesSection.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
                    outdoorGameDays.push(checkbox.value);
                });
            }

            // Get practice days using data-section attribute
            const practiceDays = [];
            const practiceSection = document.querySelector('[data-section="practices"]');
            if (practiceSection) {
                practiceSection.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
                    practiceDays.push(checkbox.value);
                });
            }

            // Get other preferences
            const liftingFrequency = document.getElementById('liftingFrequency').value;
            const liftingFocus = document.getElementById('liftingFocus').value;
            const workoutTime = document.querySelector('input[name="workoutTime"]:checked')?.value || 'flexible';

            // Update user's workout schedule
            user.workoutSchedule.indoorGameDays = indoorGameDays;
            user.workoutSchedule.outdoorGameDays = outdoorGameDays;
            user.workoutSchedule.practiceDays = practiceDays;
            user.workoutSchedule.liftingFrequency = liftingFrequency;
            user.workoutSchedule.liftingFocus = liftingFocus;
            user.workoutSchedule.workoutTime = workoutTime;

            // Save to localStorage
            localStorage.setItem('ignitefitness_users', JSON.stringify(users));

            // Also save to database
            try {
                saveUserData();
                alert('✅ Schedule preferences saved to database!');
            } catch (error) {
                console.log('Database save failed, but local save succeeded:', error);
                alert('✅ Schedule preferences saved locally!');
            }

            console.log('Schedule preferences saved:', user.workoutSchedule);
        }

        function loadGoalsToForm() {
            if (!currentUser || !isLoggedIn) return;
            
            const user = users[currentUser];
            if (!user) return;

            // Load goals
            if (user.goals) {
                document.getElementById('primaryGoal').value = user.goals.primary || '';
                
                // Check secondary goals checkboxes
                document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    if (checkbox.name && checkbox.name.includes('secondary')) {
                        checkbox.checked = user.goals.secondary && user.goals.secondary.includes(checkbox.value);
                    }
                });
            }
        }

        function loadWearableSettingsToForm() {
            if (!currentUser || !isLoggedIn) return;
            
            const user = users[currentUser];
            if (!user || !user.wearableSettings) return;

            // Load sync frequency
            if (user.wearableSettings.syncFrequency) {
                document.getElementById('syncFrequency').value = user.wearableSettings.syncFrequency;
            }

            // Load Strava settings
            if (user.wearableSettings.strava) {
                document.getElementById('enableStrava').checked = true;
                document.getElementById('stravaClientId').value = user.wearableSettings.strava.clientId || '';
                document.getElementById('stravaClientSecret').value = user.wearableSettings.strava.clientSecret || '';
                document.getElementById('stravaAccessToken').value = user.wearableSettings.strava.accessToken || '';
                document.getElementById('stravaRefreshToken').value = user.wearableSettings.strava.refreshToken || '';
            }

            // Load other wearable settings
            if (user.wearableSettings.whoop) {
                document.getElementById('enableWhoop').checked = true;
                document.getElementById('whoopToken').value = user.wearableSettings.whoop.token || '';
            }

            if (user.wearableSettings.appleWatch) {
                document.getElementById('enableAppleWatch').checked = true;
                document.getElementById('appleHealthKit').value = user.wearableSettings.appleWatch.healthKitEnabled ? 'enabled' : 'disabled';
            }

            if (user.wearableSettings.garmin) {
                document.getElementById('enableGarmin').checked = true;
                document.getElementById('garminUsername').value = user.wearableSettings.garmin.username || '';
                document.getElementById('garminPassword').value = user.wearableSettings.garmin.password || '';
            }
        }

        function generateSmartSchedule() {
            console.log('🤖 generateSmartSchedule called');
            
            if (!currentUser || !isLoggedIn) {
                console.log('❌ User not logged in:', { currentUser, isLoggedIn });
                return;
            }

            const user = users[currentUser];
            console.log('👤 User found:', user);
            
            if (!user.goals || !user.goals.primary) {
                console.log('❌ No goals set:', user.goals);
                alert('Please set your goals first in the Goals & Priorities section');
                return;
            }
            
            console.log('✅ Goals found, proceeding...');

            // Get data from saved user preferences instead of form
            const indoorGameDays = user.workoutSchedule?.indoorGameDays || [];
            const outdoorGameDays = user.workoutSchedule?.outdoorGameDays || [];
            const practiceDays = user.workoutSchedule?.practiceDays || [];
            const liftingFrequency = parseInt(user.workoutSchedule?.liftingFrequency) || 3;
            const liftingFocus = user.workoutSchedule?.liftingFocus || 'balanced';
            const workoutTime = user.workoutSchedule?.workoutTime || 'flexible';
            
            console.log('📊 Form data collected:', {
                indoorGameDays,
                outdoorGameDays,
                practiceDays,
                liftingFrequency,
                liftingFocus,
                workoutTime
            });

            // Generate smart schedule based on soccer and goals
            const smartSchedule = createSmartSchedule({
                indoorGameDays,
                outdoorGameDays,
                practiceDays,
                liftingFrequency,
                liftingFocus,
                workoutTime,
                goals: user.goals
            });

            // Store the generated schedule globally for later use
            window.lastGeneratedSchedule = smartSchedule;
            
            // Display the generated schedule
            console.log('🎯 Calling displayGeneratedSchedule with:', smartSchedule);
            displayGeneratedSchedule(smartSchedule);
        }

        function createSmartSchedule(preferences) {
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            const schedule = {};
            
            // Get all soccer days
            const soccerDays = [
                ...preferences.indoorGameDays,
                ...preferences.outdoorGameDays,
                ...preferences.practiceDays
            ];

            console.log('⚽ Soccer days found:', soccerDays);
            console.log('🏋️ Lifting frequency:', preferences.liftingFrequency);

            // Generate optimal workout days based on soccer schedule
            const workoutDays = generateOptimalWorkoutDays(days, soccerDays, preferences.liftingFrequency);
            console.log('📅 Generated workout days:', workoutDays);

            // Create schedule for each day
            days.forEach(day => {
                const daySchedule = {
                    sessionType: 'Rest Day',
                    timeSlot: 'Not set',
                    duration: 'Not set',
                    notes: ''
                };

                console.log(`📝 Processing ${day}:`, {
                    isWorkoutDay: workoutDays.includes(day),
                    isIndoorGame: preferences.indoorGameDays.includes(day),
                    isOutdoorGame: preferences.outdoorGameDays.includes(day),
                    isPractice: preferences.practiceDays.includes(day)
                });

                // Check for soccer activities
                if (preferences.indoorGameDays.includes(day)) {
                    daySchedule.sessionType = 'Soccer (Indoor)';
                    daySchedule.timeSlot = getTimeSlot(preferences.workoutTime, 'evening');
                    daySchedule.duration = '90 minutes';
                    daySchedule.notes = 'Indoor soccer game - focus on recovery and hydration';
                    console.log(`⚽ ${day}: Indoor soccer`);
                } else if (preferences.outdoorGameDays.includes(day)) {
                    daySchedule.sessionType = 'Soccer (Outdoor)';
                    daySchedule.timeSlot = getTimeSlot(preferences.workoutTime, 'afternoon');
                    daySchedule.duration = '90 minutes';
                    daySchedule.notes = 'Outdoor soccer game - consider weather conditions';
                    console.log(`⚽ ${day}: Outdoor soccer`);
                } else if (preferences.practiceDays.includes(day)) {
                    daySchedule.sessionType = 'Soccer Practice';
                    daySchedule.timeSlot = getTimeSlot(preferences.workoutTime, 'evening');
                    daySchedule.duration = '60 minutes';
                    daySchedule.notes = 'Soccer practice - lighter gym work if any';
                    console.log(`⚽ ${day}: Soccer practice`);
                } else if (workoutDays.includes(day)) {
                    // Generate gym workout
                    const workoutType = generateWorkoutType(day, soccerDays, preferences);
                    daySchedule.sessionType = workoutType;
                    daySchedule.timeSlot = getTimeSlot(preferences.workoutTime);
                    daySchedule.duration = getWorkoutDuration(workoutType);
                    daySchedule.notes = generateWorkoutNotes(workoutType, day, soccerDays);
                    console.log(`🏋️ ${day}: ${workoutType}`);
                } else {
                    console.log(`😴 ${day}: Rest day`);
                }

                schedule[day] = daySchedule;
            });

            return {
                ...preferences,
                schedule,
                generatedAt: new Date().toISOString()
            };
        }

        function generateOptimalWorkoutDays(days, soccerDays, liftingFrequency) {
            const workoutDays = [];
            
            // Your preferred schedule: Tue (Upper), Wed (Lower Heavy), Fri (Upper), Sat (Lower Light)
            const preferredDays = ['tuesday', 'wednesday', 'friday', 'saturday'];
            
            // Filter out soccer days from preferred days
            const availableDays = preferredDays.filter(day => !soccerDays.includes(day));
            
            // Add available days up to desired frequency
            for (let i = 0; i < Math.min(liftingFrequency, availableDays.length); i++) {
                workoutDays.push(availableDays[i]);
            }
            
            // If we need more days, add others
            if (workoutDays.length < liftingFrequency) {
                const remainingDays = days.filter(day => 
                    !soccerDays.includes(day) && 
                    !workoutDays.includes(day) && 
                    day !== 'sunday' // Avoid Sunday workouts
                );
                
                for (let i = 0; i < Math.min(liftingFrequency - workoutDays.length, remainingDays.length); i++) {
                    workoutDays.push(remainingDays[i]);
                }
            }
            
            return workoutDays;
        }

        function generateWorkoutType(day, soccerDays, preferences) {
            // Check if there's a Sunday game
            const hasSundayGame = soccerDays.includes('sunday');
            
            // Your preferred schedule
            if (day === 'tuesday') {
                return 'Upper Body';
            } else if (day === 'wednesday') {
                return 'Lower Body (Heavy)';
            } else if (day === 'friday') {
                return 'Upper Body';
            } else if (day === 'saturday' && hasSundayGame) {
                return 'Lower Body (Light)';
            } else if (day === 'saturday' && !hasSundayGame) {
                return 'Lower Body';
            }
            
            // Fallback based on lifting focus
            if (preferences.liftingFocus === 'upper_focused') {
                return 'Upper Body';
            } else if (preferences.liftingFocus === 'lower_focused') {
                return 'Lower Body';
            } else {
                return 'Full Body';
            }
        }

        function getTimeSlot(preferredTime, override = null) {
            const time = override || preferredTime;
            
            switch (time) {
                case 'morning':
                    return '8:00 AM';
                case 'afternoon':
                    return '2:00 PM';
                case 'evening':
                    return '7:00 PM';
                case 'flexible':
                default:
                    return 'Flexible';
            }
        }

        function getWorkoutDuration(workoutType) {
            if (workoutType.includes('Heavy')) {
                return '75-90 minutes';
            } else if (workoutType.includes('Light')) {
                return '45-60 minutes';
            } else if (workoutType.includes('Full Body')) {
                return '60-75 minutes';
            } else {
                return '60 minutes';
            }
        }

        function generateWorkoutNotes(workoutType, day, soccerDays) {
            const notes = [];
            
            if (workoutType.includes('Heavy')) {
                notes.push('Focus on progressive overload');
                notes.push('Rest 2-3 minutes between sets');
            } else if (workoutType.includes('Light')) {
                notes.push('Keep intensity moderate');
                notes.push('Focus on movement quality');
            }
            
            // Check proximity to soccer
            const dayIndex = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'].indexOf(day);
            const hasSundayGame = soccerDays.includes('sunday');
            
            if (hasSundayGame && day === 'saturday') {
                notes.push('Light session before Sunday game');
            } else if (hasSundayGame && dayIndex >= 3) {
                notes.push('Good recovery time before Sunday game');
            }
            
            return notes.join(' | ');
        }

        function displayGeneratedSchedule(smartSchedule) {
            console.log('📋 displayGeneratedSchedule called with:', smartSchedule);
            
            let scheduleHtml = `
                <div style="background: #1a1a1a; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h3 style="color: #68d391; margin-top: 0;">🤖 Generated Smart Schedule</h3>
                    <p style="color: #a0aec0; margin-bottom: 20px;">Based on your soccer schedule and lifting preferences:</p>
                    
                    <div style="background: #2d3748; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="color: #fbd38d; margin: 0 0 10px 0;">⚽ Your Soccer Schedule</h4>
                        <p style="color: #a0aec0; margin: 5px 0;"><strong>Indoor Games:</strong> ${smartSchedule.indoorGameDays.length > 0 ? smartSchedule.indoorGameDays.join(', ') : 'None'}</p>
                        <p style="color: #a0aec0; margin: 5px 0;"><strong>Outdoor Games:</strong> ${smartSchedule.outdoorGameDays.length > 0 ? smartSchedule.outdoorGameDays.join(', ') : 'None'}</p>
                        <p style="color: #a0aec0; margin: 5px 0;"><strong>Practices:</strong> ${smartSchedule.practiceDays.length > 0 ? smartSchedule.practiceDays.join(', ') : 'None'}</p>
                        <p style="color: #a0aec0; margin: 5px 0;"><strong>Lifting Frequency:</strong> ${smartSchedule.liftingFrequency} times per week</p>
                        <p style="color: #a0aec0; margin: 5px 0;"><strong>Preferred Time:</strong> ${smartSchedule.workoutTime}</p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
            `;
            
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            days.forEach(day => {
                const daySchedule = smartSchedule.schedule[day.toLowerCase()];
                const sessions = daySchedule?.sessions || [{
                    sessionType: daySchedule?.sessionType || 'Rest Day',
                    timeSlot: daySchedule?.timeSlot || 'Not set',
                    duration: daySchedule?.duration || 'Not set',
                    notes: daySchedule?.notes || ''
                }];
                
                scheduleHtml += `
                    <div style="background: #2d3748; padding: 15px; border-radius: 8px; border-left: 4px solid ${getSessionColor(sessions[0].sessionType)};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <h4 style="color: #68d391; margin: 0;">${day} ${sessions.length > 1 ? `(${sessions.length} sessions)` : ''}</h4>
                            <div style="display: flex; gap: 5px;">
                                <button onclick="editScheduleDay('${day.toLowerCase()}')" style="background: #4299e1; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer;">✏️ Edit</button>
                            </div>
                        </div>
                        ${sessions.map((session, index) => `
                            <div style="margin-bottom: ${index < sessions.length - 1 ? '10px' : '0'}; padding: ${index < sessions.length - 1 ? '10px' : '0'}; background: ${index < sessions.length - 1 ? '#1a1a1a' : 'transparent'}; border-radius: ${index < sessions.length - 1 ? '5px' : '0'};">
                                <p style="color: #fbd38d; margin: 4px 0; font-weight: 600;">${sessions.length > 1 ? `Session ${index + 1}: ` : ''}${session.sessionType}</p>
                                <p style="color: #a0aec0; margin: 2px 0; font-size: 12px;">Time: ${session.timeSlot}</p>
                                <p style="color: #a0aec0; margin: 2px 0; font-size: 12px;">Duration: ${session.duration}</p>
                                ${session.notes ? `<p style="color: #a0aec0; margin: 2px 0; font-size: 11px; font-style: italic;">${session.notes}</p>` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            });
            
            scheduleHtml += `
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button onclick="acceptGeneratedSchedule()" class="btn" style="background: #68d391; color: #1a1a1a; font-weight: 600;">
                            ✅ Accept This Schedule
                        </button>
                        <button onclick="regenerateSchedule()" class="btn" style="background: #4299e1; color: white;">
                            🔄 Regenerate
                        </button>
                        <button onclick="cancelScheduleGeneration()" class="btn" style="background: #718096; color: white;">
                            ❌ Cancel
                        </button>
                    </div>
                </div>
            `;
            
            // Display in the workout plan section instead
            const planDiv = document.getElementById('workoutPlanDisplay');
            console.log('🎨 Looking for workout plan display:', planDiv);
            
            if (planDiv) {
                console.log('✅ Found workout plan display, inserting HTML');
                planDiv.innerHTML = scheduleHtml;
            } else {
                console.log('❌ Workout plan display not found! Trying alternative...');
                // Fallback: try to find any form section that's not hidden
                const visibleFormSection = document.querySelector('.form-section:not(.hidden)');
                if (visibleFormSection) {
                    console.log('✅ Found visible form section, inserting HTML');
                    visibleFormSection.insertAdjacentHTML('beforeend', scheduleHtml);
                } else {
                    console.log('❌ No suitable section found!');
                }
            }
        }

        function acceptGeneratedSchedule() {
            if (!currentUser || !isLoggedIn) return;
            
            const user = users[currentUser];
            
            // Get the generated schedule from the display
            const generatedSchedule = window.lastGeneratedSchedule;
            if (generatedSchedule && generatedSchedule.schedule) {
                // Convert the generated schedule to the format expected by the app
                user.workoutSchedule = {
                    indoorGameDays: generatedSchedule.indoorGameDays,
                    outdoorGameDays: generatedSchedule.outdoorGameDays,
                    practiceDays: generatedSchedule.practiceDays,
                    liftingFrequency: generatedSchedule.liftingFrequency,
                    liftingFocus: generatedSchedule.liftingFocus,
                    workoutTime: generatedSchedule.workoutTime,
                    // Add the detailed schedule
                    detailedSchedule: generatedSchedule.schedule
                };
                
                localStorage.setItem('ignitefitness_users', JSON.stringify(users));
                alert('✅ Schedule accepted and saved! You can now generate your workout plan.');
            } else {
                alert('❌ No generated schedule found. Please generate a schedule first.');
            }
        }

        function regenerateSchedule() {
            generateSmartSchedule();
        }

        function cancelScheduleGeneration() {
            // Remove the generated schedule display
            const generatedSchedule = document.querySelector('[style*="Generated Smart Schedule"]');
            if (generatedSchedule) {
                generatedSchedule.remove();
            }
        }

        function editScheduleDay(day) {
            if (!window.lastGeneratedSchedule) {
                alert('No generated schedule found. Please generate a schedule first.');
                return;
            }

            const daySchedule = window.lastGeneratedSchedule.schedule[day];
            
            // Create a modal for editing
            const modalHtml = `
                <div id="editDayModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; justify-content: center; align-items: center;">
                    <div style="background: #1a1a1a; padding: 30px; border-radius: 10px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                        <h3 style="color: #68d391; margin-top: 0;">Edit ${day.charAt(0).toUpperCase() + day.slice(1)}</h3>
                        
                        <div id="sessionsContainer">
                            ${renderSessionsForDay(day, daySchedule)}
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <button onclick="addSessionToDay('${day}')" style="background: #4299e1; color: white; border: none; padding: 8px 16px; border-radius: 5px; margin-right: 10px; cursor: pointer;">
                                ➕ Add Session
                            </button>
                            <button onclick="saveDaySchedule('${day}')" style="background: #68d391; color: #1a1a1a; border: none; padding: 8px 16px; border-radius: 5px; margin-right: 10px; cursor: pointer;">
                                💾 Save
                            </button>
                            <button onclick="closeEditModal()" style="background: #718096; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer;">
                                ❌ Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function renderSessionsForDay(day, daySchedule) {
            const sessions = daySchedule.sessions || [{
                sessionType: daySchedule.sessionType || 'Rest Day',
                timeSlot: daySchedule.timeSlot || 'Flexible',
                duration: daySchedule.duration || '60 minutes',
                notes: daySchedule.notes || ''
            }];

            let html = '';
            sessions.forEach((session, index) => {
                html += `
                    <div style="background: #2d3748; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid ${getSessionColor(session.sessionType)};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h4 style="color: #68d391; margin: 0;">Session ${index + 1}</h4>
                            ${sessions.length > 1 ? `<button onclick="removeSessionFromDay('${day}', ${index})" style="background: #e53e3e; color: white; border: none; padding: 4px 8px; border-radius: 3px; font-size: 12px; cursor: pointer;">Remove</button>` : ''}
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                            <div>
                                <label style="color: #a0aec0; font-size: 12px; display: block; margin-bottom: 5px;">Session Type</label>
                                <select id="sessionType_${day}_${index}" style="width: 100%; padding: 8px; background: #1a1a1a; color: white; border: 1px solid #4a5568; border-radius: 4px;">
                                    <option value="Rest Day" ${session.sessionType === 'Rest Day' ? 'selected' : ''}>Rest Day</option>
                                    <option value="Upper Body" ${session.sessionType === 'Upper Body' ? 'selected' : ''}>Upper Body</option>
                                    <option value="Upper Body (Light)" ${session.sessionType === 'Upper Body (Light)' ? 'selected' : ''}>Upper Body (Light)</option>
                                    <option value="Upper Body (Heavy)" ${session.sessionType === 'Upper Body (Heavy)' ? 'selected' : ''}>Upper Body (Heavy)</option>
                                    <option value="Lower Body" ${session.sessionType === 'Lower Body' ? 'selected' : ''}>Lower Body</option>
                                    <option value="Lower Body (Light)" ${session.sessionType === 'Lower Body (Light)' ? 'selected' : ''}>Lower Body (Light)</option>
                                    <option value="Lower Body (Heavy)" ${session.sessionType === 'Lower Body (Heavy)' ? 'selected' : ''}>Lower Body (Heavy)</option>
                                    <option value="Full Body" ${session.sessionType === 'Full Body' ? 'selected' : ''}>Full Body</option>
                                    <option value="Soccer (Indoor)" ${session.sessionType === 'Soccer (Indoor)' ? 'selected' : ''}>Soccer (Indoor)</option>
                                    <option value="Soccer (Outdoor)" ${session.sessionType === 'Soccer (Outdoor)' ? 'selected' : ''}>Soccer (Outdoor)</option>
                                    <option value="Soccer Practice" ${session.sessionType === 'Soccer Practice' ? 'selected' : ''}>Soccer Practice</option>
                                    <option value="Recovery & Mobility" ${session.sessionType === 'Recovery & Mobility' ? 'selected' : ''}>Recovery & Mobility</option>
                                    <option value="Cardio" ${session.sessionType === 'Cardio' ? 'selected' : ''}>Cardio</option>
                                    <option value="Yoga" ${session.sessionType === 'Yoga' ? 'selected' : ''}>Yoga</option>
                                </select>
                            </div>
                            <div>
                                <label style="color: #a0aec0; font-size: 12px; display: block; margin-bottom: 5px;">Time</label>
                                <select id="timeSlot_${day}_${index}" style="width: 100%; padding: 8px; background: #1a1a1a; color: white; border: 1px solid #4a5568; border-radius: 4px;">
                                    <option value="Flexible" ${session.timeSlot === 'Flexible' ? 'selected' : ''}>Flexible</option>
                                    <option value="6:00 AM" ${session.timeSlot === '6:00 AM' ? 'selected' : ''}>6:00 AM</option>
                                    <option value="7:00 AM" ${session.timeSlot === '7:00 AM' ? 'selected' : ''}>7:00 AM</option>
                                    <option value="8:00 AM" ${session.timeSlot === '8:00 AM' ? 'selected' : ''}>8:00 AM</option>
                                    <option value="9:00 AM" ${session.timeSlot === '9:00 AM' ? 'selected' : ''}>9:00 AM</option>
                                    <option value="10:00 AM" ${session.timeSlot === '10:00 AM' ? 'selected' : ''}>10:00 AM</option>
                                    <option value="11:00 AM" ${session.timeSlot === '11:00 AM' ? 'selected' : ''}>11:00 AM</option>
                                    <option value="12:00 PM" ${session.timeSlot === '12:00 PM' ? 'selected' : ''}>12:00 PM</option>
                                    <option value="1:00 PM" ${session.timeSlot === '1:00 PM' ? 'selected' : ''}>1:00 PM</option>
                                    <option value="2:00 PM" ${session.timeSlot === '2:00 PM' ? 'selected' : ''}>2:00 PM</option>
                                    <option value="3:00 PM" ${session.timeSlot === '3:00 PM' ? 'selected' : ''}>3:00 PM</option>
                                    <option value="4:00 PM" ${session.timeSlot === '4:00 PM' ? 'selected' : ''}>4:00 PM</option>
                                    <option value="5:00 PM" ${session.timeSlot === '5:00 PM' ? 'selected' : ''}>5:00 PM</option>
                                    <option value="6:00 PM" ${session.timeSlot === '6:00 PM' ? 'selected' : ''}>6:00 PM</option>
                                    <option value="7:00 PM" ${session.timeSlot === '7:00 PM' ? 'selected' : ''}>7:00 PM</option>
                                    <option value="8:00 PM" ${session.timeSlot === '8:00 PM' ? 'selected' : ''}>8:00 PM</option>
                                    <option value="9:00 PM" ${session.timeSlot === '9:00 PM' ? 'selected' : ''}>9:00 PM</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div>
                                <label style="color: #a0aec0; font-size: 12px; display: block; margin-bottom: 5px;">Duration</label>
                                <select id="duration_${day}_${index}" style="width: 100%; padding: 8px; background: #1a1a1a; color: white; border: 1px solid #4a5568; border-radius: 4px;">
                                    <option value="30 minutes" ${session.duration === '30 minutes' ? 'selected' : ''}>30 minutes</option>
                                    <option value="45 minutes" ${session.duration === '45 minutes' ? 'selected' : ''}>45 minutes</option>
                                    <option value="60 minutes" ${session.duration === '60 minutes' ? 'selected' : ''}>60 minutes</option>
                                    <option value="75 minutes" ${session.duration === '75 minutes' ? 'selected' : ''}>75 minutes</option>
                                    <option value="90 minutes" ${session.duration === '90 minutes' ? 'selected' : ''}>90 minutes</option>
                                    <option value="120 minutes" ${session.duration === '120 minutes' ? 'selected' : ''}>120 minutes</option>
                                </select>
                            </div>
                            <div>
                                <label style="color: #a0aec0; font-size: 12px; display: block; margin-bottom: 5px;">Notes</label>
                                <input type="text" id="notes_${day}_${index}" value="${session.notes || ''}" placeholder="Optional notes..." style="width: 100%; padding: 8px; background: #1a1a1a; color: white; border: 1px solid #4a5568; border-radius: 4px;">
                            </div>
                        </div>
                    </div>
                `;
            });
            
            return html;
        }

        function addSessionToDay(day) {
            const container = document.getElementById('sessionsContainer');
            const sessionCount = container.children.length;
            
            const newSessionHtml = `
                <div style="background: #2d3748; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #4299e1;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="color: #68d391; margin: 0;">Session ${sessionCount + 1}</h4>
                        <button onclick="removeSessionFromDay('${day}', ${sessionCount})" style="background: #e53e3e; color: white; border: none; padding: 4px 8px; border-radius: 3px; font-size: 12px; cursor: pointer;">Remove</button>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                        <div>
                            <label style="color: #a0aec0; font-size: 12px; display: block; margin-bottom: 5px;">Session Type</label>
                            <select id="sessionType_${day}_${sessionCount}" style="width: 100%; padding: 8px; background: #1a1a1a; color: white; border: 1px solid #4a5568; border-radius: 4px;">
                                <option value="Rest Day">Rest Day</option>
                                <option value="Upper Body">Upper Body</option>
                                <option value="Upper Body (Light)">Upper Body (Light)</option>
                                <option value="Upper Body (Heavy)">Upper Body (Heavy)</option>
                                <option value="Lower Body">Lower Body</option>
                                <option value="Lower Body (Light)">Lower Body (Light)</option>
                                <option value="Lower Body (Heavy)">Lower Body (Heavy)</option>
                                <option value="Full Body">Full Body</option>
                                <option value="Soccer (Indoor)">Soccer (Indoor)</option>
                                <option value="Soccer (Outdoor)">Soccer (Outdoor)</option>
                                <option value="Soccer Practice">Soccer Practice</option>
                                <option value="Recovery & Mobility">Recovery & Mobility</option>
                                <option value="Cardio">Cardio</option>
                                <option value="Yoga">Yoga</option>
                            </select>
                        </div>
                        <div>
                            <label style="color: #a0aec0; font-size: 12px; display: block; margin-bottom: 5px;">Time</label>
                            <select id="timeSlot_${day}_${sessionCount}" style="width: 100%; padding: 8px; background: #1a1a1a; color: white; border: 1px solid #4a5568; border-radius: 4px;">
                                <option value="Flexible">Flexible</option>
                                <option value="6:00 AM">6:00 AM</option>
                                <option value="7:00 AM">7:00 AM</option>
                                <option value="8:00 AM">8:00 AM</option>
                                <option value="9:00 AM">9:00 AM</option>
                                <option value="10:00 AM">10:00 AM</option>
                                <option value="11:00 AM">11:00 AM</option>
                                <option value="12:00 PM">12:00 PM</option>
                                <option value="1:00 PM">1:00 PM</option>
                                <option value="2:00 PM">2:00 PM</option>
                                <option value="3:00 PM">3:00 PM</option>
                                <option value="4:00 PM">4:00 PM</option>
                                <option value="5:00 PM">5:00 PM</option>
                                <option value="6:00 PM">6:00 PM</option>
                                <option value="7:00 PM">7:00 PM</option>
                                <option value="8:00 PM">8:00 PM</option>
                                <option value="9:00 PM">9:00 PM</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <label style="color: #a0aec0; font-size: 12px; display: block; margin-bottom: 5px;">Duration</label>
                            <select id="duration_${day}_${sessionCount}" style="width: 100%; padding: 8px; background: #1a1a1a; color: white; border: 1px solid #4a5568; border-radius: 4px;">
                                <option value="30 minutes">30 minutes</option>
                                <option value="45 minutes">45 minutes</option>
                                <option value="60 minutes">60 minutes</option>
                                <option value="75 minutes">75 minutes</option>
                                <option value="90 minutes">90 minutes</option>
                                <option value="120 minutes">120 minutes</option>
                            </select>
                        </div>
                        <div>
                            <label style="color: #a0aec0; font-size: 12px; display: block; margin-bottom: 5px;">Notes</label>
                            <input type="text" id="notes_${day}_${sessionCount}" placeholder="Optional notes..." style="width: 100%; padding: 8px; background: #1a1a1a; color: white; border: 1px solid #4a5568; border-radius: 4px;">
                        </div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', newSessionHtml);
        }

        function removeSessionFromDay(day, sessionIndex) {
            const container = document.getElementById('sessionsContainer');
            const sessions = container.children;
            
            if (sessions.length > 1) {
                sessions[sessionIndex].remove();
                // Renumber remaining sessions
                for (let i = 0; i < sessions.length; i++) {
                    const sessionTitle = sessions[i].querySelector('h4');
                    if (sessionTitle) {
                        sessionTitle.textContent = `Session ${i + 1}`;
                    }
                }
            } else {
                alert('You must have at least one session per day. Change it to "Rest Day" instead.');
            }
        }

        function saveDaySchedule(day) {
            const container = document.getElementById('sessionsContainer');
            const sessions = [];
            
            for (let i = 0; i < container.children.length; i++) {
                const sessionDiv = container.children[i];
                const sessionType = sessionDiv.querySelector(`#sessionType_${day}_${i}`).value;
                const timeSlot = sessionDiv.querySelector(`#timeSlot_${day}_${i}`).value;
                const duration = sessionDiv.querySelector(`#duration_${day}_${i}`).value;
                const notes = sessionDiv.querySelector(`#notes_${day}_${i}`).value;
                
                sessions.push({
                    sessionType,
                    timeSlot,
                    duration,
                    notes
                });
            }
            
            // Update the schedule
            window.lastGeneratedSchedule.schedule[day] = {
                sessions: sessions,
                sessionType: sessions[0].sessionType, // Keep for backward compatibility
                timeSlot: sessions[0].timeSlot,
                duration: sessions[0].duration,
                notes: sessions[0].notes
            };
            
            // Close modal and refresh display
            closeEditModal();
            displayGeneratedSchedule(window.lastGeneratedSchedule);
            
            alert(`✅ ${day.charAt(0).toUpperCase() + day.slice(1)} updated with ${sessions.length} session(s)!`);
        }

        function closeEditModal() {
            const modal = document.getElementById('editDayModal');
            if (modal) {
                modal.remove();
            }
        }

        function saveWorkoutSchedule() {
            if (!currentUser || !isLoggedIn) return;

            const user = users[currentUser];
            if (!user.workoutSchedule) user.workoutSchedule = {};

            // Get soccer schedule - improved selectors
            const indoorGameDays = [];
            const outdoorGameDays = [];
            const practiceDays = [];
            
            // Get indoor games using data attribute
            const indoorGamesSection = document.querySelector('[data-section="indoor-games"]');
            if (indoorGamesSection) {
                indoorGamesSection.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
                    indoorGameDays.push(checkbox.value);
                });
            }
            
            // Get outdoor games using data attribute
            const outdoorGamesSection = document.querySelector('[data-section="outdoor-games"]');
            if (outdoorGamesSection) {
                outdoorGamesSection.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
                    outdoorGameDays.push(checkbox.value);
                });
            }
            
            // Get practice days using data attribute
            const practiceSection = document.querySelector('[data-section="practices"]');
            if (practiceSection) {
                practiceSection.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
                    practiceDays.push(checkbox.value);
                });
            }
            
            // Debug logging
            console.log('Soccer Schedule Data:', {
                indoorGameDays,
                outdoorGameDays,
                practiceDays,
                liftingFrequency: document.getElementById('liftingFrequency')?.value
            });
            
            // Additional debugging - check if elements exist
            console.log('Element checks:', {
                indoorSection: document.querySelector('[data-section="indoor-games"]'),
                outdoorSection: document.querySelector('[data-section="outdoor-games"]'),
                practiceSection: document.querySelector('[data-section="practices"]'),
                liftingFreqElement: document.getElementById('liftingFrequency')
            });

            user.workoutSchedule = {
                indoorGameDays: indoorGameDays,
                outdoorGameDays: outdoorGameDays,
                practiceDays: practiceDays,
                liftingFrequency: document.getElementById('liftingFrequency').value,
                liftingFocus: document.getElementById('liftingFocus').value,
                liftingIntensity: document.getElementById('liftingIntensity').value,
                recoveryFrequency: document.getElementById('recoveryFrequency').value,
                cardioActivities: getSelectedCardioActivities(),
                cardioFrequency: document.getElementById('cardioFrequency').value,
                preferredWorkoutDays: getPreferredWorkoutDays(),
                workoutTime: document.querySelector('input[name="workoutTime"]:checked')?.value || 'flexible'
            };

            localStorage.setItem('ignitefitness_users', JSON.stringify(users));
            
            // Show what was actually saved
            console.log('Saved workout schedule:', user.workoutSchedule);
            
            alert(`Workout schedule saved! 
Indoor Games: ${indoorGameDays.length} days
Outdoor Games: ${outdoorGameDays.length} days  
Practices: ${practiceDays.length} days
Lifting Frequency: ${user.workoutSchedule.liftingFrequency || 'Not set'} times per week

You can now generate a personalized plan.`);
        }

        function getSelectedCardioActivities() {
            const activities = [];
            // Find cardio activities section by looking for the label text
            const labels = document.querySelectorAll('label');
            let cardioSection = null;
            
            for (let label of labels) {
                if (label.textContent.includes('Cardio activities')) {
                    cardioSection = label.closest('.form-group');
                    break;
                }
            }
            
            if (cardioSection) {
                cardioSection.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
                    activities.push(checkbox.value);
                });
            }
            
            return activities;
        }

        function getPreferredWorkoutDays() {
            const days = [];
            // Find preferred workout days section by looking for the label text
            const labels = document.querySelectorAll('label');
            let workoutDaysSection = null;
            
            for (let label of labels) {
                if (label.textContent.includes('Preferred workout days')) {
                    workoutDaysSection = label.closest('.form-group');
                    break;
                }
            }
            
            if (workoutDaysSection) {
                workoutDaysSection.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
                    days.push(checkbox.value);
                });
            }
            
            return days;
        }

        function loadWorkoutSchedule(schedule) {
            // Load indoor games
            if (schedule.indoorGameDays) {
                schedule.indoorGameDays.forEach(day => {
                    const checkbox = document.querySelector(`[data-section="indoor-games"] input[value="${day}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }
            
            // Load outdoor games
            if (schedule.outdoorGameDays) {
                schedule.outdoorGameDays.forEach(day => {
                    const checkbox = document.querySelector(`[data-section="outdoor-games"] input[value="${day}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }
            
            // Load practices
            if (schedule.practiceDays) {
                schedule.practiceDays.forEach(day => {
                    const checkbox = document.querySelector(`[data-section="practices"] input[value="${day}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }
            
            // Load lifting frequency
            if (schedule.liftingFrequency) {
                const liftingFreqSelect = document.getElementById('liftingFrequency');
                if (liftingFreqSelect) {
                    liftingFreqSelect.value = schedule.liftingFrequency;
                }
            }
            
            console.log('Loaded workout schedule:', schedule);
        }

        // Wearable Integration Functions
        function toggleDeviceFields() {
            // Show/hide device fields based on checkboxes
            document.getElementById('stravaFields').style.display = 
                document.getElementById('enableStrava').checked ? 'block' : 'none';
            
            document.getElementById('whoopFields').style.display = 
                document.getElementById('enableWhoop').checked ? 'block' : 'none';
            
            document.getElementById('appleWatchFields').style.display = 
                document.getElementById('enableAppleWatch').checked ? 'block' : 'none';
            
            document.getElementById('garminFields').style.display = 
                document.getElementById('enableGarmin').checked ? 'block' : 'none';
        }

        async function saveDeviceSettings() {
            if (!currentUser || !isLoggedIn) return;

            const user = users[currentUser];
            if (!user.wearableSettings) user.wearableSettings = {};

            user.wearableSettings.syncFrequency = document.getElementById('syncFrequency').value;

            // Save Strava settings if enabled
            if (document.getElementById('enableStrava').checked) {
                user.wearableSettings.strava = {
                    clientId: document.getElementById('stravaClientId').value,
                    clientSecret: document.getElementById('stravaClientSecret').value,
                    accessToken: document.getElementById('stravaAccessToken').value,
                    refreshToken: document.getElementById('stravaRefreshToken').value
                };
            }

            // Save Whoop settings if enabled
            if (document.getElementById('enableWhoop').checked) {
                user.wearableSettings.whoop = {
                    token: document.getElementById('whoopToken').value
                };
            }

            // Save Apple Watch settings if enabled
            if (document.getElementById('enableAppleWatch').checked) {
                user.wearableSettings.appleWatch = {
                    healthKitEnabled: document.getElementById('appleHealthKit').value === 'enabled'
                };
            }

            // Save Garmin settings if enabled
            if (document.getElementById('enableGarmin').checked) {
                user.wearableSettings.garmin = {
                    username: document.getElementById('garminUsername').value,
                    password: document.getElementById('garminPassword').value
                };
            }

            localStorage.setItem('ignitefitness_users', JSON.stringify(users));
            
            // Also save to database
            try {
                await saveUserData();
                alert('✅ Device settings saved to database!');
            } catch (error) {
                console.log('Database save failed, but local save succeeded:', error);
                alert('✅ Device settings saved locally!');
            }
            
            // Update sync buttons
            updateWearableSyncButtons();
        }

        async function testStravaConnection() {
            const resultDiv = document.getElementById('stravaTestResult');
            resultDiv.innerHTML = '🔄 Testing Strava connection...';

            try {
                const accessToken = document.getElementById('stravaAccessToken').value;
                if (!accessToken) {
                    throw new Error('Please enter your Strava access token');
                }

                const response = await fetch('https://www.strava.com/api/v3/athlete', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                if (response.ok) {
                    const athlete = await response.json();
                    resultDiv.innerHTML = `✅ Connected successfully! Welcome ${athlete.firstname} ${athlete.lastname}`;
                    resultDiv.style.color = '#68d391';
                } else {
                    throw new Error('Failed to connect to Strava');
                }
            } catch (error) {
                resultDiv.innerHTML = `❌ Connection failed: ${error.message}`;
                resultDiv.style.color = '#fc8181';
            }
        }

        async function testWhoopConnection() {
            const resultDiv = document.getElementById('whoopTestResult');
            resultDiv.innerHTML = '🔄 Testing Whoop connection...';

            try {
                const token = document.getElementById('whoopToken').value;
                if (!token) {
                    throw new Error('Please enter your Whoop token');
                }

                // Note: Whoop API endpoints would need to be implemented
                resultDiv.innerHTML = '✅ Whoop connection test completed (API integration pending)';
                resultDiv.style.color = '#68d391';
            } catch (error) {
                resultDiv.innerHTML = `❌ Connection failed: ${error.message}`;
                resultDiv.style.color = '#fc8181';
            }
        }

        function testAppleHealthConnection() {
            const resultDiv = document.getElementById('appleTestResult');
            resultDiv.innerHTML = '🔄 Testing Apple Health connection...';

            try {
                // Check if we're on iOS
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                
                if (isIOS) {
                    resultDiv.innerHTML = '📱 iOS device detected. HealthKit requires a native app - using realistic demo data instead.';
                    resultDiv.style.color = '#fbd38d';
                } else {
                    resultDiv.innerHTML = '💻 Desktop/Android device detected. Using comprehensive demo data that mimics Apple Health patterns.';
                    resultDiv.style.color = '#fbd38d';
                }
                
                // Show what data will be available
                setTimeout(() => {
                    resultDiv.innerHTML += '<br><br><strong>Demo data includes:</strong><br>• Steps: 8,500-12,500 daily<br>• Heart Rate: Realistic ranges<br>• Sleep: 7-9 hours with stages<br>• Exercise: Various activities<br>• VO2 Max: Fitness-based values';
                }, 1000);
                
            } catch (error) {
                resultDiv.innerHTML = `❌ Connection test failed: ${error.message}`;
                resultDiv.style.color = '#fc8181';
            }
        }

        function testGarminConnection() {
            const resultDiv = document.getElementById('garminTestResult');
            resultDiv.innerHTML = '🔄 Testing Garmin connection...';

            try {
                const username = document.getElementById('garminUsername').value;
                const password = document.getElementById('garminPassword').value;
                
                if (!username || !password) {
                    throw new Error('Please enter Garmin username and password');
                }

                // Simulate connection test
                setTimeout(() => {
                    resultDiv.innerHTML = '✅ Garmin demo connection successful (using mock data)';
                resultDiv.style.color = '#68d391';
                }, 1500);
                
            } catch (error) {
                resultDiv.innerHTML = `❌ Connection failed: ${error.message}`;
                resultDiv.style.color = '#fc8181';
            }
        }

        // Personalized Workout Plan Generation
        function generateWorkoutPlan() {
            if (!currentUser || !isLoggedIn) return;

            const user = users[currentUser];
            if (!user.goals || !user.goals.primary) {
                alert('Please set your goals first in the Goals & Priorities section');
                return;
            }

            if (!user.workoutSchedule) {
                alert('Please complete your workout schedule planning first');
                return;
            }

            // Check if user has a detailed schedule from smart generation
            if (user.workoutSchedule.detailedSchedule) {
                // Use the detailed schedule for plan generation
                generatePlanFromDetailedSchedule(user);
            } else {
                // Show schedule confirmation before generating plan
                showScheduleConfirmation(user);
            }
        }

        function generatePlanFromDetailedSchedule(user) {
            // Convert detailed schedule to the format expected by generateDetailedWorkoutPlan
            const detailedSchedule = user.workoutSchedule.detailedSchedule;
            
            // Create a mock schedule object that generateDetailedWorkoutPlan expects
            const mockSchedule = {
                indoorGameDays: user.workoutSchedule.indoorGameDays || [],
                outdoorGameDays: user.workoutSchedule.outdoorGameDays || [],
                practiceDays: user.workoutSchedule.practiceDays || [],
                liftingFrequency: user.workoutSchedule.liftingFrequency || '3'
            };

            // Generate the workout plan using the detailed schedule
            const plan = generateDetailedWorkoutPlanFromSchedule(user, detailedSchedule);
            user.workoutPlan = plan;
            
            localStorage.setItem('ignitefitness_users', JSON.stringify(users));
            displayDetailedWorkoutPlan(plan);
            
            alert('✅ 4-week workout plan generated from your accepted schedule!');
        }

        function generateDetailedWorkoutPlanFromSchedule(user, detailedSchedule) {
            const goals = user.goals;
            const baseline = user.personalData?.baselineStrength || {};
            
            // Create 4-week plan based on the detailed schedule
            const plan = {
                title: 'Personalized 4-Week Workout Plan',
                description: 'Generated from your accepted schedule',
                notes: ['Based on your soccer schedule and lifting preferences'],
                weeks: []
            };

            // Generate 4 weeks
            for (let week = 1; week <= 4; week++) {
                const weekPlan = {
                    week: week,
                    days: []
                };

                const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
                days.forEach((day, index) => {
                    const daySchedule = detailedSchedule[day];
                    const sessions = daySchedule?.sessions || [{
                        sessionType: daySchedule?.sessionType || 'Rest Day',
                        timeSlot: daySchedule?.timeSlot || 'Flexible',
                        duration: daySchedule?.duration || '60 minutes',
                        notes: daySchedule?.notes || ''
                    }];

                    const dayPlan = {
                        day: day,
                        dayNumber: index + 1,
                        sessions: sessions.map(session => ({
                            sessionType: session.sessionType,
                            timeSlot: session.timeSlot,
                            duration: session.duration,
                            exercises: [],
                            notes: session.notes
                        })),
                        session: sessions[0].sessionType, // Keep for backward compatibility
                        exercises: [],
                        notes: sessions[0].notes
                    };

                    // Generate exercises for workout sessions
                    dayPlan.sessions.forEach(session => {
                        if (session.sessionType && !session.sessionType.includes('Rest') && !session.sessionType.includes('Soccer')) {
                            session.exercises = getGoalOrientedExercises(session.sessionType, goals, baseline, week);
                        }
                    });

                    // For backward compatibility, use first session's exercises
                    if (dayPlan.sessions.length > 0 && dayPlan.sessions[0].exercises) {
                        dayPlan.exercises = dayPlan.sessions[0].exercises;
                    }

                    weekPlan.days.push(dayPlan);
                });

                plan.weeks.push(weekPlan);
            }

            return plan;
        }

        function showScheduleConfirmation(user) {
            const schedule = user.workoutSchedule;
            const goals = user.goals;
            
            let scheduleHtml = `
                <div style="background: #1a1a1a; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h3 style="color: #68d391; margin-top: 0;">📅 Confirm Your Workout Schedule</h3>
                    <p style="color: #a0aec0; margin-bottom: 20px;">Please review your schedule before generating your 4-week workout plan:</p>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
            `;
            
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            days.forEach(day => {
                const daySchedule = schedule[day.toLowerCase()];
                const sessionType = daySchedule?.sessionType || 'Rest Day';
                const timeSlot = daySchedule?.timeSlot || 'Not set';
                const duration = daySchedule?.duration || 'Not set';
                
                scheduleHtml += `
                    <div style="background: #2d3748; padding: 15px; border-radius: 8px; border-left: 4px solid ${getSessionColor(sessionType)};">
                        <h4 style="color: #68d391; margin: 0 0 8px 0;">${day}</h4>
                        <p style="color: #fbd38d; margin: 4px 0; font-weight: 600;">${sessionType}</p>
                        <p style="color: #a0aec0; margin: 2px 0; font-size: 12px;">Time: ${timeSlot}</p>
                        <p style="color: #a0aec0; margin: 2px 0; font-size: 12px;">Duration: ${duration}</p>
                    </div>
                `;
            });
            
            scheduleHtml += `
                    </div>
                    
                    <div style="background: #2d3748; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="color: #fbd38d; margin: 0 0 10px 0;">🎯 Your Goals</h4>
                        <p style="color: #a0aec0; margin: 5px 0;"><strong>Primary:</strong> ${goals.primary}</p>
                        <p style="color: #a0aec0; margin: 5px 0;"><strong>Secondary:</strong> ${goals.secondary || 'Not set'}</p>
                        <p style="color: #a0aec0; margin: 5px 0;"><strong>Timeline:</strong> ${goals.timeline || 'Not set'}</p>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button onclick="confirmScheduleAndGenerate()" class="btn" style="background: #68d391; color: #1a1a1a; font-weight: 600;">
                            ✅ Confirm & Generate Plan
                        </button>
                        <button onclick="editScheduleBeforeGenerate()" class="btn" style="background: #4299e1; color: white;">
                            ✏️ Edit Schedule
                        </button>
                        <button onclick="cancelPlanGeneration()" class="btn" style="background: #718096; color: white;">
                            ❌ Cancel
                        </button>
                    </div>
                </div>
            `;
            
            // Display the confirmation in the workout plan section
            const planDiv = document.getElementById('workoutPlanDisplay');
            planDiv.innerHTML = scheduleHtml;
        }

        function confirmScheduleAndGenerate() {
            if (!currentUser || !isLoggedIn) return;
            
            const user = users[currentUser];
            
            // Generate a detailed 4-week workout plan with specific exercises
            const plan = generateDetailedWorkoutPlan(user);
            user.workoutPlan = plan;
            
            localStorage.setItem('ignitefitness_users', JSON.stringify(users));
            displayDetailedWorkoutPlan(plan);
            
            alert('✅ 4-week workout plan generated successfully based on your confirmed schedule!');
        }

        function editScheduleBeforeGenerate() {
            // Switch to the schedule tab so user can edit
            const tabs = document.querySelectorAll('.tab-content');
            if (tabs.length > 0) {
                tabs.forEach(tab => tab.classList.add('hidden'));
            }
            
            const scheduleTab = document.getElementById('schedule');
            if (scheduleTab) {
                scheduleTab.classList.remove('hidden');
                // Also update the tab buttons
                const tabButtons = document.querySelectorAll('.tab-button');
                tabButtons.forEach(btn => btn.classList.remove('active'));
                const scheduleButton = document.querySelector('.tab-button[onclick*="schedule"]');
                if (scheduleButton) {
                    scheduleButton.classList.add('active');
                }
                // Scroll to schedule section
                scheduleTab.scrollIntoView({ behavior: 'smooth' });
            } else {
                // Fallback: just show an alert
                alert('Please go to the Schedule tab to edit your workout schedule');
            }
        }

        function cancelPlanGeneration() {
            // Reset to default message
            const planDiv = document.getElementById('workoutPlanDisplay');
            planDiv.innerHTML = '<p style="color: #a0aec0;">Complete your schedule planning to generate a personalized 4-week workout plan.</p>';
        }

        function generateDetailedWorkoutPlan(user) {
            const schedule = user.workoutSchedule;
            const goals = user.goals;
            const baseline = user.personalData?.baselineStrength || {};
            
            // Create 4-week plan with specific daily workouts
            const weeks = [];
            
            for (let week = 1; week <= 4; week++) {
                const weekPlan = {
                    week: week,
                    days: generateWeekSchedule(schedule, goals, baseline, week)
                };
                weeks.push(weekPlan);
            }
            
            return {
                title: `${goals.primary.replace('_', ' ')} - 4 Week Plan`,
                description: `Personalized plan based on your soccer schedule and goals`,
                weeks: weeks,
                notes: generatePlanNotes(schedule, goals)
            };
        }

        function generateWeekSchedule(schedule, goals, baseline, weekNum) {
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            const weekSchedule = [];
            const liftingFrequency = parseInt(schedule.liftingFrequency) || 3; // Default to 3 if not set
            
            // First, identify all soccer days
            const soccerDays = [
                ...(schedule.indoorGameDays || []),
                ...(schedule.outdoorGameDays || []),
                ...(schedule.practiceDays || [])
            ];
            
            // Create optimal workout schedule based on soccer days and desired frequency
            const workoutDays = createOptimalWorkoutSchedule(days, soccerDays, liftingFrequency);
            
            days.forEach((day, index) => {
                const dayPlan = {
                    day: day,
                    dayNumber: index + 1,
                    session: null,
                    exercises: [],
                    notes: ''
                };
                
                // Check for soccer games/practices
                if (schedule.indoorGameDays?.includes(day)) {
                    dayPlan.session = 'Soccer (Indoor)';
                    dayPlan.notes = 'Indoor soccer game - focus on recovery and hydration';
                } else if (schedule.outdoorGameDays?.includes(day)) {
                    dayPlan.session = 'Soccer (Outdoor)';
                    dayPlan.notes = 'Outdoor soccer game - consider weather conditions';
                } else if (schedule.practiceDays?.includes(day)) {
                    dayPlan.session = 'Soccer Practice';
                    dayPlan.notes = 'Soccer practice - lighter gym work if any';
                } else if (workoutDays.includes(day)) {
                    // Only schedule gym workouts on designated workout days
                    dayPlan.session = generateGymWorkout(day, schedule, goals, baseline, weekNum);
                    dayPlan.exercises = getGoalOrientedExercises(dayPlan.session, goals, baseline, weekNum);
                    dayPlan.notes = generateWorkoutNotes(dayPlan.session, day, schedule);
                } else {
                    // Rest day
                    dayPlan.session = 'Rest Day';
                    dayPlan.notes = 'Recovery day - light activity, mobility work, or complete rest';
                }
                
                weekSchedule.push(dayPlan);
            });
            
            return weekSchedule;
        }

        function createOptimalWorkoutSchedule(days, soccerDays, targetFrequency) {
            const workoutDays = [];
            
            // Strategy: Place workouts to avoid soccer days and ensure recovery
            const availableDays = days.filter(day => !soccerDays.includes(day));
            
            if (targetFrequency >= 4) {
                // 4 workouts: 2 Upper Body + 2 Lower Body
                // Your schedule: Mon (soccer), Tue, Wed, Thu, Fri, Sat, Sun (soccer)
                // Optimal: Tue (upper), Wed (lower heavy), Fri (upper), Sat (lower light)
                if (soccerDays.includes('monday') && soccerDays.includes('sunday')) {
                    workoutDays.push('tuesday', 'wednesday', 'friday', 'saturday');
                } else {
                    // General 4-day split: Upper, Lower Heavy, Upper, Lower Light
                    workoutDays.push('tuesday', 'wednesday', 'friday', 'saturday');
                }
            } else if (targetFrequency === 3) {
                // 3 workouts: 2 Upper + 1 Lower Heavy (mid-week)
                if (soccerDays.includes('monday') && soccerDays.includes('sunday')) {
                    workoutDays.push('tuesday', 'wednesday', 'friday');
                } else {
                    workoutDays.push('tuesday', 'thursday', 'saturday');
                }
            } else if (targetFrequency === 2) {
                // 2 workouts: 1 Upper + 1 Lower Heavy
                workoutDays.push('tuesday', 'wednesday');
            } else if (targetFrequency === 1) {
                // 1 workout: Full body or Upper (depending on goals)
                workoutDays.push('wednesday');
            }
            
            return workoutDays.slice(0, targetFrequency); // Ensure we don't exceed target
        }

        function generateGymWorkout(day, schedule, goals, baseline, weekNum) {
            // Your specific preferences: 2 Upper Body (medium to hard) + 2 Lower Body (1 heavy mid-week, 1 light activator)
            const soccerDays = [
                ...(schedule.indoorGameDays || []),
                ...(schedule.outdoorGameDays || []),
                ...(schedule.practiceDays || [])
            ];
            
            const dayIndex = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'].indexOf(day);
            
            // Check if there's a soccer game on Sunday
            const hasSundayGame = soccerDays.includes('sunday');
            
            // Your preferred schedule: Tue (Upper), Wed (Lower Heavy), Fri (Upper), Sat (Lower Light)
            if (day === 'tuesday') {
                return 'Upper Body'; // Medium to hard intensity
            } else if (day === 'wednesday') {
                return 'Lower Body (Heavy)'; // Mid-week heavy session
            } else if (day === 'friday') {
                return 'Upper Body'; // Second upper body session
            } else if (day === 'saturday' && hasSundayGame) {
                return 'Lower Body (Light)'; // Light activator before Sunday game
            } else if (day === 'saturday' && !hasSundayGame) {
                return 'Lower Body'; // Regular lower body if no Sunday game
            }
            
            // Fallback logic for other days
            if (soccerDays.includes('sunday')) {
                // If Sunday game, Saturday should be light lower body
                if (day === 'saturday') return 'Lower Body (Light)';
                
                // Check proximity to soccer
                const daysUntilSoccer = 7 - dayIndex; // Days until Sunday
                if (daysUntilSoccer === 1) {
                    return 'Lower Body (Light)'; // Day before soccer
                } else if (daysUntilSoccer === 2) {
                    return 'Upper Body'; // Two days before soccer
                } else if (daysUntilSoccer >= 3) {
                    return dayIndex % 2 === 0 ? 'Upper Body' : 'Lower Body (Heavy)';
                }
            }
            
            // Default rotation for other scenarios
            return dayIndex % 2 === 0 ? 'Upper Body' : 'Lower Body';
        }

        function getGoalOrientedExercises(sessionType, goals, baseline, weekNum) {
            const primaryGoal = goals.primary;
            const secondaryGoals = goals.secondary || [];
            
            // Get base exercises for session type
            let exercises = getSpecificExercises(sessionType, goals, baseline, weekNum);
            
            // Apply session-specific intensity adjustments first
            exercises = adjustForUpperBodyIntensity(exercises, sessionType);
            exercises = createLightActivator(exercises, sessionType);
            
            // Modify exercises based on goals
            if (primaryGoal === 'acl_prevention' || secondaryGoals.includes('acl_support')) {
                exercises = addACLExercises(exercises, sessionType);
            }
            
            if (primaryGoal === 'grow_muscle' || secondaryGoals.includes('strength_gain')) {
                exercises = adjustForStrength(exercises, weekNum);
            }
            
            if (primaryGoal === 'improve_speed' || secondaryGoals.includes('speed_improvement')) {
                exercises = addSpeedWork(exercises, sessionType);
            }
            
            if (secondaryGoals.includes('core_stability')) {
                exercises = addCoreWork(exercises, sessionType);
            }
            
            return exercises;
        }

        function addACLExercises(exercises, sessionType) {
            const aclExercises = [
                { name: 'Single-Leg Glute Bridges', sets: '3', reps: '10 each leg', weight: 'Bodyweight', notes: 'Focus on hip stability' },
                { name: 'Clamshells', sets: '2', reps: '15 each side', weight: 'Bodyweight', notes: 'Slow and controlled' },
                { name: 'Monster Walks', sets: '2', reps: '10 each direction', weight: 'Resistance band', notes: 'Keep knees over toes' },
                { name: 'Single-Leg RDLs', sets: '3', reps: '8 each leg', weight: 'Bodyweight', notes: 'Focus on balance and control' },
                { name: 'Lateral Lunges', sets: '2', reps: '10 each side', weight: 'Bodyweight', notes: 'Controlled movement' }
            ];
            
            // Add ACL exercises to appropriate sessions
            if (sessionType.includes('Lower Body') || sessionType.includes('Full Body')) {
                exercises = exercises.concat(aclExercises.slice(0, 3));
            } else if (sessionType.includes('Upper Body')) {
                exercises = exercises.concat(aclExercises.slice(3, 5));
            }
            
            return exercises;
        }

        function addCoreWork(exercises, sessionType) {
            const coreExercises = [
                { name: 'Plank', sets: '3', reps: '30-60 seconds', weight: 'Bodyweight', notes: 'Keep straight line' },
                { name: 'Dead Bug', sets: '3', reps: '10 each side', weight: 'Bodyweight', notes: 'Slow and controlled' },
                { name: 'Bird Dog', sets: '3', reps: '10 each side', weight: 'Bodyweight', notes: 'Hold for 2 seconds' },
                { name: 'Russian Twists', sets: '3', reps: '20 total', weight: 'Bodyweight', notes: 'Keep core engaged' },
                { name: 'Mountain Climbers', sets: '3', reps: '20 total', weight: 'Bodyweight', notes: 'Fast pace' }
            ];
            
            // Add core work to most sessions
            if (!sessionType.includes('Rest')) {
                exercises = exercises.concat(coreExercises.slice(0, 2));
            }
            
            return exercises;
        }

        function getWarmupRoutine(sessionType) {
            if (sessionType.includes('Soccer')) {
                return `• Light jogging (3-5 minutes)<br>
                • High knees, butt kicks, side shuffles<br>
                • Dynamic leg swings (front/back, side to side)<br>
                • Hip circles and ankle rolls<br>
                • Light passing or ball touches`;
            } else if (sessionType.includes('Upper Body')) {
                return `• Arm circles (forward/backward)<br>
                • Shoulder rolls and shrugs<br>
                • Light band pull-aparts<br>
                • Cat-cow stretches<br>
                • Light resistance band rows`;
            } else if (sessionType.includes('Lower Body')) {
                return `• Light stationary bike or walking (3-5 minutes)<br>
                • Bodyweight squats (10-15 reps)<br>
                • Walking lunges<br>
                • Leg swings and hip circles<br>
                • Calf raises and ankle rolls`;
            } else if (sessionType.includes('Climbing')) {
                return `• Light cardio (3-5 minutes)<br>
                • Shoulder and wrist mobility<br>
                • Finger and grip warm-up<br>
                • Light hangs on easy holds<br>
                • Dynamic stretching for shoulders`;
            } else if (sessionType.includes('Recovery') || sessionType.includes('Mobility')) {
                return `• Light walking or gentle movement<br>
                • Joint mobility (ankles, hips, shoulders)<br>
                • Gentle dynamic stretching<br>
                • Deep breathing exercises<br>
                • Body awareness check-in`;
            } else if (sessionType.includes('ACL')) {
                return `• Light stationary bike (5 minutes)<br>
                • Ankle circles and calf raises<br>
                • Hip mobility exercises<br>
                • Light bodyweight squats<br>
                • Single-leg balance practice`;
            } else {
                return `• Light cardio (3-5 minutes)<br>
                • Full-body dynamic stretches<br>
                • Joint mobility exercises<br>
                • Light movement preparation<br>
                • Mental preparation`;
            }
        }

        function getCooldownRoutine(sessionType) {
            if (sessionType.includes('Soccer')) {
                return `• Light walking/jogging (3-5 minutes)<br>
                • Static quad, hamstring, and calf stretches<br>
                • Hip flexor stretches<br>
                • IT band and glute stretches<br>
                • Deep breathing and hydration`;
            } else if (sessionType.includes('Upper Body')) {
                return `• Light arm swings and circles<br>
                • Chest and shoulder stretches<br>
                • Tricep and bicep stretches<br>
                • Neck and upper back mobility<br>
                • Deep breathing exercises`;
            } else if (sessionType.includes('Lower Body')) {
                return `• Light walking or stationary bike<br>
                • Quad, hamstring, and calf stretches<br>
                • Hip flexor and glute stretches<br>
                • IT band and adductor stretches<br>
                • Ankle mobility work`;
            } else if (sessionType.includes('Climbing')) {
                return `• Light hanging on easy holds<br>
                • Forearm and finger stretches<br>
                • Shoulder and chest stretches<br>
                • Wrist and elbow mobility<br>
                • Deep breathing and relaxation`;
            } else if (sessionType.includes('Recovery') || sessionType.includes('Mobility')) {
                return `• Extended stretching session<br>
                • Foam rolling or self-massage<br>
                • Breathing and meditation<br>
                • Gentle movement flows<br>
                • Gratitude and reflection`;
            } else if (sessionType.includes('ACL')) {
                return `• Light stationary bike (5 minutes)<br>
                • ACL-specific stretches<br>
                • Hip and glute stretches<br>
                • Ankle and calf mobility<br>
                • Balance and stability exercises`;
            } else {
                return `• Light walking (3-5 minutes)<br>
                • Full-body static stretches<br>
                • Deep breathing exercises<br>
                • Hydration and nutrition<br>
                • Mental recovery`;
            }
        }

        function generateSessionNotes(sessionType, goals) {
            const notes = [];
            
            if (sessionType.includes('Soccer')) {
                notes.push('Focus on proper form and technique');
                notes.push('Stay hydrated throughout');
                notes.push('Listen to your body for fatigue signals');
            }
            
            if (goals.primary === 'acl_prevention' || goals.secondary?.includes('acl_support')) {
                notes.push('ACL prevention exercises included');
                notes.push('Focus on proper landing mechanics');
                notes.push('Stop if you feel any knee discomfort');
            }
            
            if (goals.primary === 'grow_muscle' || goals.secondary?.includes('strength_gain')) {
                notes.push('Progressive overload focus');
                notes.push('Maintain proper form over weight');
                notes.push('Rest 2-3 minutes between sets');
            }
            
            if (sessionType.includes('Recovery')) {
                notes.push('This is active recovery - keep intensity low');
                notes.push('Focus on mobility and flexibility');
                notes.push('Listen to your body');
            }
            
            return notes.join('\n');
        }

        function adjustForStrength(exercises, weekNum) {
            // Increase sets and focus on progressive overload
            return exercises.map(exercise => ({
                ...exercise,
                sets: exercise.sets && exercise.sets.toString().includes('3') ? '4' : exercise.sets,
                notes: (exercise.notes || '') + ' Focus on progressive overload'
            }));
        }

        function adjustForUpperBodyIntensity(exercises, sessionType) {
            // Make upper body sessions medium to hard intensity
            if (sessionType.includes('Upper Body') && !sessionType.includes('Light')) {
                return exercises.map(exercise => ({
                    ...exercise,
                    sets: exercise.sets && exercise.sets.toString().includes('3') ? '4' : exercise.sets,
                    notes: (exercise.notes || '') + ' | Medium-Hard intensity - challenge yourself'
                }));
            }
            return exercises;
        }

        function createLightActivator(exercises, sessionType) {
            // Light activator session for Saturday before Sunday games
            if (sessionType === 'Lower Body (Light)') {
                return exercises.map(exercise => ({
                    ...exercise,
                    sets: '2', // Reduce sets
                    reps: exercise.reps.replace(/\d+/g, match => Math.max(8, parseInt(match) - 3)), // Reduce reps
                    notes: (exercise.notes || '') + ' | Light activator - focus on movement quality'
                }));
            }
            return exercises;
        }

        function addSpeedWork(exercises, sessionType) {
            const speedExercises = [
                { name: 'Agility Ladder', sets: '3', reps: '30 seconds', weight: 'Bodyweight', notes: 'Fast feet, light touches' },
                { name: 'Sprint Intervals', sets: '4', reps: '20-30 seconds', weight: 'Bodyweight', notes: 'Max effort, full recovery' },
                { name: 'Lateral Bounds', sets: '3', reps: '8 each side', weight: 'Bodyweight', notes: 'Explosive movement' },
                { name: 'Box Jumps', sets: '3', reps: '8', weight: 'Bodyweight', notes: 'Land softly, reset between jumps' }
            ];
            
            if (sessionType.includes('Lower Body') || sessionType.includes('Full Body')) {
                exercises = exercises.concat(speedExercises.slice(0, 2));
            }
            
            return exercises;
        }

        function getSpecificExercises(sessionType, goals, baseline, weekNum) {
            const exercises = [];
            const progression = Math.min(weekNum * 0.025, 0.1); // 2.5% progression per week, max 10% (much more conservative)
            
            // Helper function to calculate realistic gym weights based on exercise type
            function calculateRealisticWeight(baseWeight, intensity, exerciseType) {
                const targetWeight = baseWeight * intensity;
                
                if (exerciseType === 'squat' || exerciseType === 'deadlift') {
                    // Squats and deadlifts: must work with 45 lb bar + equal plates on both sides
                    // Valid weights: 45, 55, 65, 75, 85, 95, 105, 115, 125, 135, etc.
                    // Avoid weights that need 2.5 lb plates (like 80, 90, 100)
                    let rounded = Math.round(targetWeight / 10) * 10;
                    
                    // Ensure it's achievable with standard plates without 2.5s
                    const weightPerSide = (rounded - 45) / 2;
                    
                    if (weightPerSide > 0) {
                        // Only use weights that can be made with 5, 10, 25, 35, 45 lb plates (no 2.5s)
                        if (weightPerSide % 5 !== 0) {
                            // If it would need 2.5s, round up to next 5 lb increment
                            rounded += 5;
                        }
                    }
                    
                    return rounded;
                } else if (exerciseType === 'legpress') {
                    // Leg press: conservative progression with 5 lb increments (okay with smaller plates)
                    // Cap the progression to avoid doubling weight in 4 weeks
                    const conservativeWeight = Math.min(targetWeight, baseWeight * 1.3); // Max 30% increase
                    return Math.round(conservativeWeight / 5) * 5; // 5 lb increments
                } else {
                    // Bench press and other upper body: must work with 45 lb bar + equal plates on each side
                    // Valid weights: 45 (bar), 50 (bar + 2.5 each side), 55 (bar + 5 each side), 60 (bar + 7.5 each side), etc.
                    // Round to nearest 5 lbs, but ensure it's achievable with standard plates
                    let rounded = Math.round(targetWeight / 5) * 5;
                    
                    // Ensure it's achievable with standard plates (2.5, 5, 10, 25, 35, 45 lb plates)
                    // The weight per side should be achievable with standard plate combinations
                    const weightPerSide = (rounded - 45) / 2; // Subtract bar weight, divide by 2
                    
                    if (weightPerSide > 0) {
                        // Round to nearest 2.5 for realistic plate combinations
                        const platesPerSide = Math.round(weightPerSide / 2.5) * 2.5;
                        rounded = 45 + (platesPerSide * 2);
                    }
                    
                    return rounded;
                }
            }
            
            // Check if user can do pull-ups
            const canDoPullups = (baseline.pullups || 0) > 0;
            const pullupAlternative = canDoPullups ? 'Pull-ups' : 'Lat Pulldowns';
            const pullupReps = canDoPullups ? '3-8' : '8-12';
            const pullupWeight = canDoPullups ? 'Bodyweight' : `${calculateRealisticWeight(baseline.bench || 65, 0.8, 'bench')} lbs`;
            
            switch (sessionType) {
                case 'Upper Body (Light)':
                    exercises.push(
                        { name: 'Bench Press', sets: 3, reps: '8-10', weight: `${calculateRealisticWeight(baseline.bench || 65, 0.7 + progression, 'bench')} lbs`, notes: 'Light intensity before soccer' },
                        { name: pullupAlternative, sets: 3, reps: pullupReps, weight: pullupWeight, notes: canDoPullups ? 'Focus on form' : 'Build to pull-ups' },
                        { name: 'Overhead Press', sets: 3, reps: '8-10', weight: `${calculateRealisticWeight(baseline.bench || 65, 0.6 + progression, 'bench')} lbs`, notes: 'Light weight' },
                        { name: 'Rows', sets: 3, reps: '10-12', weight: `${calculateRealisticWeight(baseline.bench || 65, 0.8 + progression, 'bench')} lbs`, notes: 'Moderate intensity' }
                    );
                    break;
                    
                case 'Upper Body':
                    exercises.push(
                        { name: 'Bench Press', sets: 4, reps: '5-6', weight: `${calculateRealisticWeight(baseline.bench || 65, 0.85 + progression, 'bench')} lbs`, notes: 'Main lift' },
                        { name: pullupAlternative, sets: 3, reps: pullupReps, weight: pullupWeight, notes: canDoPullups ? 'Add weight if needed' : 'Progressive overload' },
                        { name: 'Overhead Press', sets: 3, reps: '6-8', weight: `${calculateRealisticWeight(baseline.bench || 65, 0.7 + progression, 'bench')} lbs`, notes: 'Secondary press' },
                        { name: 'Rows', sets: 3, reps: '8-10', weight: `${calculateRealisticWeight(baseline.bench || 65, 0.9 + progression, 'bench')} lbs`, notes: 'Heavy pulling' },
                        { name: 'Bicep Curls', sets: 3, reps: '10-12', weight: `${calculateRealisticWeight(baseline.bench || 65, 0.3, 'bench')} lbs`, notes: 'Accessory work' }
                    );
                    break;
                    
                case 'Lower Body (Heavy)':
                    exercises.push(
                        { name: 'Squat', sets: 4, reps: '5-6', weight: `${calculateRealisticWeight(baseline.squat || 95, 0.9 + progression, 'squat')} lbs`, notes: 'Heavy squats' },
                        { name: 'Deadlift', sets: 4, reps: '5-6', weight: `${calculateRealisticWeight(baseline.deadlift || 115, 0.9 + progression, 'deadlift')} lbs`, notes: 'Heavy deadlifts' },
                        { name: 'Bulgarian Split Squats', sets: 3, reps: '8-10 each', weight: 'Bodyweight', notes: 'Unilateral work' },
                        { name: 'Calf Raises', sets: 4, reps: '15-20', weight: 'Bodyweight + 25 lbs', notes: 'Soccer-specific' }
                    );
                    break;
                    
                case 'Lower Body':
                    exercises.push(
                        { name: 'Squat', sets: 4, reps: '6-8', weight: `${calculateRealisticWeight(baseline.squat || 95, 0.8 + progression, 'squat')} lbs`, notes: 'Main lift' },
                        { name: 'Romanian Deadlift', sets: 3, reps: '8-10', weight: `${calculateRealisticWeight(baseline.deadlift || 115, 0.8 + progression, 'deadlift')} lbs`, notes: 'Hamstring focus' },
                        { name: 'Lunges', sets: 3, reps: '10 each', weight: 'Bodyweight', notes: 'Functional movement' },
                        { name: 'Leg Press', sets: 3, reps: '12-15', weight: `${calculateRealisticWeight(baseline.squat || 95, 1.5, 'legpress')} lbs`, notes: 'Accessory work' },
                        { name: 'Calf Raises', sets: 3, reps: '15-20', weight: 'Bodyweight + 20 lbs', notes: 'Soccer-specific' }
                    );
                    break;
            }
            
            return exercises;
        }

        function generateWorkoutNotes(sessionType, day, schedule) {
            const notes = [];
            
            if (sessionType.includes('Light')) {
                notes.push('• Light intensity to avoid fatigue for soccer');
                notes.push('• Focus on movement quality over weight');
            }
            
            if (sessionType.includes('Heavy')) {
                notes.push('• Heavy session - ensure 48+ hours before next soccer');
                notes.push('• Focus on progressive overload');
            }
            
            if (day === 'friday') {
                notes.push('• End of week - moderate intensity');
            }
            
            if (day === 'saturday') {
                notes.push('• Weekend session - can go harder');
            }
            
            return notes.join('\n');
        }

        function generatePlanNotes(schedule, goals) {
            const indoorGames = schedule.indoorGameDays || [];
            const outdoorGames = schedule.outdoorGameDays || [];
            const totalSoccerGames = indoorGames.length + outdoorGames.length;
            const liftingFrequency = schedule.liftingFrequency || 'Not set';
            
            const notes = [
                '📋 **Plan Overview:**',
                `• Primary Goal: ${goals.primary.replace('_', ' ')}`,
                `• Soccer Games: ${totalSoccerGames} per week (${indoorGames.length} indoor, ${outdoorGames.length} outdoor)`,
                `• Lifting Frequency: ${liftingFrequency} times per week`,
                `• Workout Days: Optimally spaced around your soccer schedule`,
                '',
                '⚡ **Realistic Progression:**',
                '• Week 1-2: Focus on form and establishing baseline',
                '• Week 3-4: Small, sustainable increases',
                '• 2.5% progression per week on main lifts (very conservative)',
                '• Pull-ups: Lat pulldowns if you can\'t do pull-ups yet',
                '',
                '⚽ **Soccer Integration:**',
                '• Workouts scheduled to avoid interference with soccer',
                '• Rest days before and after games when possible',
                '• Recovery focus on game days',
                '',
                '🎯 **Personalized Approach:**',
                '• Based on your actual baseline strength numbers',
                '• Realistic rep ranges and weights',
                '• Focus on building strength gradually',
                '• Track RPE to monitor fatigue levels'
            ];
            
            return notes;
        }

        function createPersonalizedPlan(user) {
            const primaryGoal = user.goals.primary;
            const secondaryGoals = user.goals.secondary || [];
            const baseline = user.personalData?.baselineStrength || {};
            const personalData = user.personalData || {};

            // Base plan structure
            let plan = {
                goal: primaryGoal,
                duration: '4 weeks',
                focus: [],
                sessions: {
                    'Week 1': [],
                    'Week 2': [],
                    'Week 3': [],
                    'Week 4': []
                },
                progression: {},
                recommendations: []
            };

            // Soccer-focused base (since target is women soccer players)
            const soccerBase = [
                { name: 'Dynamic Warmup', target: '10 min', focus: 'Movement prep' },
                { name: 'ACL Prevention', target: '15 min', focus: 'Injury prevention' },
                { name: 'Core Stability', target: '10 min', focus: 'Core strength' }
            ];

            // Goal-specific modifications
            if (primaryGoal === 'improve_speed') {
                plan.focus.push('Speed Development', 'Power Training', 'Agility');
                plan.sessions['Week 1'] = [
                    ...soccerBase,
                    { name: 'Sprint Training', target: '20 min', focus: 'Speed' },
                    { name: 'Plyometrics', target: '15 min', focus: 'Power' }
                ];
            } else if (primaryGoal === 'improve_endurance') {
                plan.focus.push('Cardiovascular Fitness', 'Aerobic Capacity');
                plan.sessions['Week 1'] = [
                    ...soccerBase,
                    { name: 'Interval Training', target: '25 min', focus: 'Endurance' },
                    { name: 'Tempo Runs', target: '20 min', focus: 'Aerobic base' }
                ];
            } else if (primaryGoal === 'grow_muscle') {
                plan.focus.push('Strength Building', 'Muscle Development');
                plan.sessions['Week 1'] = [
                    ...soccerBase,
                    { name: 'Upper Body Strength', target: '30 min', focus: 'Muscle building' },
                    { name: 'Lower Body Strength', target: '30 min', focus: 'Leg development' }
                ];
            } else if (primaryGoal === 'acl_prevention') {
                plan.focus.push('Injury Prevention', 'Stability Training');
                plan.sessions['Week 1'] = [
                    ...soccerBase,
                    { name: 'Single Leg Training', target: '20 min', focus: 'Stability' },
                    { name: 'Hip Strengthening', target: '15 min', focus: 'ACL support' }
                ];
            } else {
                // Default soccer performance plan
                plan.focus.push('Soccer Performance', 'Overall Fitness');
                plan.sessions['Week 1'] = [
                    ...soccerBase,
                    { name: 'Soccer Skills', target: '30 min', focus: 'Technical' },
                    { name: 'Conditioning', target: '20 min', focus: 'Fitness' }
                ];
            }

            // Add secondary goal modifications
            if (secondaryGoals.includes('strength_gain')) {
                plan.sessions['Week 1'].push({ name: 'Strength Training', target: '25 min', focus: 'Strength' });
            }
            if (secondaryGoals.includes('agility_training')) {
                plan.sessions['Week 1'].push({ name: 'Agility Drills', target: '15 min', focus: 'Agility' });
            }

            // Set progression based on baseline
            if (baseline.bench) {
                plan.progression.bench = {
                    week1: baseline.bench * 0.8,
                    week2: baseline.bench * 0.85,
                    week3: baseline.bench * 0.9,
                    week4: baseline.bench * 0.95
                };
            }

            // Add personalized recommendations
            if (personalData.sex === 'female') {
                plan.recommendations.push('Focus on hip and knee stability for ACL prevention');
                plan.recommendations.push('Include glute strengthening exercises');
            }
            
            if (personalData.age && personalData.age < 18) {
                plan.recommendations.push('Emphasize proper form and technique');
                plan.recommendations.push('Include recovery days between intense sessions');
            }

            return plan;
        }

        function displayDetailedWorkoutPlan(plan) {
            const planDiv = document.getElementById('workoutPlanDisplay');
            if (!plan) {
                planDiv.innerHTML = '<p style="color: #a0aec0;">Complete your schedule planning to generate a personalized 4-week workout plan.</p>';
                return;
            }

            let html = `<h4 style="color: #68d391;">${plan.title}</h4>`;
            html += `<p style="color: #a0aec0;">${plan.description}</p>`;
            
            // Add plan notes at the top
            if (plan.notes) {
                html += `<div style="margin: 15px 0; padding: 15px; background: #2d3748; border-radius: 8px; border-left: 4px solid #68d391;">`;
                html += `<h5 style="color: #68d391; margin-top: 0;">Plan Overview</h5>`;
                plan.notes.forEach(note => {
                    html += `<p style="margin: 5px 0; color: #a0aec0;">${note}</p>`;
                });
                html += `</div>`;
            }
            
            // Add customization controls
            html += `<div style="margin: 15px 0; padding: 15px; background: #2d3748; border-radius: 8px; border-left: 4px solid #fbd38d;">`;
            html += `<h5 style="color: #fbd38d; margin-top: 0;">🎛️ Customize Your Plan</h5>`;
            html += `<p style="color: #a0aec0; margin: 5px 0;">Click on any session type to change it, or add additional sessions to any day. Each session includes warm-ups, main exercises, and cool-downs tailored to your goals.</p>`;
            html += `<button class="btn" onclick="regeneratePlanWithCurrentSettings()" style="margin-top: 10px;">🔄 Regenerate Plan</button>`;
            html += `</div>`;
            
            if (plan.weeks) {
                plan.weeks.forEach((week, weekIndex) => {
                    html += `<div style="margin: 15px 0; padding: 15px; background: #2d3748; border-radius: 8px;">`;
                    html += `<h5 style="color: #68d391;">Week ${week.week}</h5>`;
                    
                    if (week.days) {
                        week.days.forEach((day, dayIndex) => {
                            const dayId = `week${weekIndex}_day${dayIndex}`;
                            html += `<div style="margin: 10px 0; padding: 15px; background: #1a1a1a; border-radius: 5px;">`;
                            html += `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">`;
                            html += `<h6 style="color: #68d391; margin: 0;">${day.day.charAt(0).toUpperCase() + day.day.slice(1)}</h6>`;
                            
                            // Make session type clickable/changeable
                            html += `<div style="display: flex; align-items: center; gap: 10px;">`;
                            html += `<select id="${dayId}_session" onchange="updateSessionType('${dayId}', this.value, ${weekIndex}, ${dayIndex})" style="background: ${getSessionColor(day.session)}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; border: none;">`;
                            html += getSessionTypeOptions(day.session);
                            html += `</select>`;
                            html += `<button onclick="addAdditionalSession('${dayId}', ${weekIndex}, ${dayIndex})" style="background: #4299e1; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer;">+ Add Session</button>`;
                            html += `</div>`;
                            html += `</div>`;
                            
                            // Display warm-up, exercises, and cool-down
                            html += displaySessionDetails(day, dayId);
                            
                            html += `</div>`;
                        });
                    }
                    
                    html += `</div>`;
                });
            }
            
            planDiv.innerHTML = html;
        }

        function getSessionTypeOptions(currentSession) {
            const options = [
                'Rest Day',
                'Upper Body',
                'Upper Body (Light)',
                'Lower Body',
                'Lower Body (Heavy)',
                'Full Body',
                'Soccer (Indoor)',
                'Soccer (Outdoor)',
                'Soccer Practice',
                'Recovery & Mobility',
                'ACL Strengthening',
                'Core Focus',
                'Cardio',
                'Yoga',
                'Indoor Climbing',
                'Outdoor Climbing'
            ];
            
            let html = '';
            options.forEach(option => {
                const selected = option === currentSession ? 'selected' : '';
                html += `<option value="${option}" ${selected}>${option}</option>`;
            });
            return html;
        }

        function updateSessionType(dayId, newSessionType, weekIndex, dayIndex) {
            if (!currentUser || !isLoggedIn) return;
            
            const user = users[currentUser];
            if (!user.workoutPlan || !user.workoutPlan.weeks) return;
            
            // Update the session type
            user.workoutPlan.weeks[weekIndex].days[dayIndex].session = newSessionType;
            
            // Regenerate exercises for this session based on goals
            const goals = user.goals;
            const baseline = user.personalData?.baselineStrength || {};
            const weekNum = weekIndex + 1;
            
            // Get new exercises based on session type and goals
            const newExercises = getGoalOrientedExercises(newSessionType, goals, baseline, weekNum);
            user.workoutPlan.weeks[weekIndex].days[dayIndex].exercises = newExercises;
            
            // Update notes
            user.workoutPlan.weeks[weekIndex].days[dayIndex].notes = generateSessionNotes(newSessionType, goals);
            
            // Save the updated plan
            localStorage.setItem('ignitefitness_users', JSON.stringify(users));
            
            // Refresh the display
            displayDetailedWorkoutPlan(user.workoutPlan);
        }

        function addAdditionalSession(dayId, weekIndex, dayIndex) {
            if (!currentUser || !isLoggedIn) return;
            
            const user = users[currentUser];
            if (!user.workoutPlan || !user.workoutPlan.weeks) return;
            
            // Show session type selection dialog
            const sessionTypes = [
                'Upper Body (Light)',
                'Upper Body (Heavy)',
                'Lower Body (Light)',
                'Lower Body (Heavy)',
                'Full Body',
                'Cardio',
                'Soccer Training',
                'Recovery/Stretching'
            ];
            
            const sessionType = prompt(`Add additional session to ${user.workoutPlan.weeks[weekIndex].days[dayIndex].day}:\n\nAvailable types:\n${sessionTypes.join('\n')}\n\nEnter session type:`, 'Upper Body (Heavy)');
            
            if (!sessionType || !sessionTypes.includes(sessionType)) {
                return;
            }
            
            const day = user.workoutPlan.weeks[weekIndex].days[dayIndex];
            const goals = user.goals;
            const baseline = user.personalData?.baselineStrength || {};
            const weekNum = weekIndex + 1;
            
            // Initialize additionalSessions array if it doesn't exist
            if (!day.additionalSessions) {
                day.additionalSessions = [];
            }
            
            // Add the new session
            const newSession = {
                session: sessionType,
                exercises: getGoalOrientedExercises(sessionType, goals, baseline, weekNum),
                notes: `Additional ${sessionType} session added to ${day.day}`
            };
            
            day.additionalSessions.push(newSession);
            
            // Save the updated plan
            localStorage.setItem('ignitefitness_users', JSON.stringify(users));
            
            // Refresh the display
            displayDetailedWorkoutPlan(user.workoutPlan);
            
            alert(`Added ${sessionType} session to ${day.day}!`);
        }

        function removeAdditionalSession(dayId, sessionIndex) {
            if (!currentUser || !isLoggedIn) return;
            
            const user = users[currentUser];
            if (!user.workoutPlan || !user.workoutPlan.weeks) return;
            
            // Parse dayId to get week and day indices
            const parts = dayId.split('_');
            const weekIndex = parseInt(parts[0].replace('week', ''));
            const dayIndex = parseInt(parts[1].replace('day', ''));
            
            const day = user.workoutPlan.weeks[weekIndex].days[dayIndex];
            
            if (day.additionalSessions && day.additionalSessions.length > sessionIndex) {
                const removedSession = day.additionalSessions[sessionIndex];
                day.additionalSessions.splice(sessionIndex, 1);
                
                // Save the updated plan
                localStorage.setItem('ignitefitness_users', JSON.stringify(users));
                
                // Refresh the display
                displayDetailedWorkoutPlan(user.workoutPlan);
                
                alert(`Removed ${removedSession.session} from ${day.day}`);
            }
        }

        function displaySessionDetails(day, dayId) {
            let html = '';
            
            // Warm-up section
            if (day.session && !day.session.includes('Rest')) {
                html += `<div style="margin: 10px 0;">`;
                html += `<h6 style="color: #68d391; margin: 0 0 8px 0;">🔥 Warm-up (5-10 minutes)</h6>`;
                html += `<div style="background: #2d3748; padding: 10px; border-radius: 5px; margin-bottom: 10px;">`;
                html += getWarmupRoutine(day.session);
                html += `</div>`;
                html += `</div>`;
            }
            
            // Main exercises
            if (day.exercises && day.exercises.length > 0) {
                html += `<div style="margin: 10px 0;">`;
                html += `<h6 style="color: #fbd38d; margin: 0 0 8px 0;">💪 Main Exercises</h6>`;
                day.exercises.forEach(exercise => {
                    html += `<div style="display: flex; justify-content: space-between; align-items: center; margin: 5px 0; padding: 8px; background: #2d3748; border-radius: 4px;">`;
                    html += `<div>`;
                    html += `<strong style="color: #68d391;">${exercise.name}</strong><br>`;
                    html += `<small style="color: #a0aec0;">${exercise.sets} sets × ${exercise.reps} reps</small>`;
                    if (exercise.notes) {
                        html += `<br><small style="color: #fbd38d; font-style: italic;">${exercise.notes}</small>`;
                    }
                    html += `</div>`;
                    html += `<div style="text-align: right;">`;
                    html += `<strong style="color: #68d391; font-size: 16px;">${exercise.weight}</strong>`;
                    html += `</div>`;
                    html += `</div>`;
                });
                html += `</div>`;
            }
            
            // Cool-down section
            if (day.session && !day.session.includes('Rest')) {
                html += `<div style="margin: 10px 0;">`;
                html += `<h6 style="color: #68d391; margin: 0 0 8px 0;">🧘‍♀️ Cool-down (5-10 minutes)</h6>`;
                html += `<div style="background: #2d3748; padding: 10px; border-radius: 5px;">`;
                html += getCooldownRoutine(day.session);
                html += `</div>`;
                html += `</div>`;
            }
            
            // Session notes
            if (day.notes) {
                html += `<div style="margin-top: 10px; padding: 8px; background: #2d3748; border-radius: 4px;">`;
                html += `<small style="color: #a0aec0;">${day.notes.replace(/\n/g, '<br>')}</small>`;
                html += `</div>`;
            }

            // Additional sessions
            if (day.additionalSessions && day.additionalSessions.length > 0) {
                html += `<div style="margin-top: 15px; padding: 10px; background: #1a1a1a; border-radius: 5px; border-left: 3px solid #4299e1;">`;
                html += `<h6 style="color: #4299e1; margin: 0 0 10px 0;">➕ Additional Sessions</h6>`;
                
                day.additionalSessions.forEach((additionalSession, index) => {
                    html += `<div style="margin: 8px 0; padding: 8px; background: #2d3748; border-radius: 4px;">`;
                    html += `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">`;
                    html += `<h7 style="color: #68d391; margin: 0;">${additionalSession.session}</h7>`;
                    html += `<button onclick="removeAdditionalSession('${dayId}', ${index})" style="background: #e53e3e; color: white; border: none; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer;">Remove</button>`;
                    html += `</div>`;
                    
                    if (additionalSession.exercises && additionalSession.exercises.length > 0) {
                        additionalSession.exercises.forEach(exercise => {
                            html += `<div style="display: flex; justify-content: space-between; align-items: center; margin: 3px 0; padding: 6px; background: #1a1a1a; border-radius: 3px;">`;
                            html += `<div>`;
                            html += `<strong style="color: #68d391; font-size: 12px;">${exercise.name}</strong><br>`;
                            html += `<small style="color: #a0aec0; font-size: 10px;">${exercise.sets} sets × ${exercise.reps} reps</small>`;
                            if (exercise.notes) {
                                html += `<br><small style="color: #fbd38d; font-style: italic; font-size: 10px;">${exercise.notes}</small>`;
                            }
                            html += `</div>`;
                            html += `<div style="text-align: right;">`;
                            html += `<strong style="color: #68d391; font-size: 12px;">${exercise.weight}</strong>`;
                            html += `</div>`;
                            html += `</div>`;
                        });
                    }
                    
                    if (additionalSession.notes) {
                        html += `<small style="color: #a0aec0; font-size: 10px; font-style: italic;">${additionalSession.notes}</small>`;
                    }
                    
                    html += `</div>`;
                });
                
                html += `</div>`;
            }
            
            return html;
        }

        function regeneratePlanWithCurrentSettings() {
            if (!currentUser || !isLoggedIn) return;
            
            const user = users[currentUser];
            if (!user.workoutSchedule) {
                alert('Please save your workout schedule first');
                return;
            }
            
            // Regenerate the entire plan
            const newPlan = generateDetailedWorkoutPlan(user);
            user.workoutPlan = newPlan;
            localStorage.setItem('ignitefitness_users', JSON.stringify(users));
            
            // Refresh the display
            displayDetailedWorkoutPlan(user.workoutPlan);
        }

        function getSessionColor(session) {
            if (!session) return '#718096'; // Rest day
            if (session.includes('Soccer')) return '#fc8181'; // Soccer - red
            if (session.includes('Upper Body (Light)')) return '#fbd38d'; // Light upper - yellow
            if (session.includes('Upper Body')) return '#68d391'; // Upper body - green
            if (session.includes('Lower Body (Heavy)')) return '#e53e3e'; // Heavy lower - dark red
            if (session.includes('Lower Body')) return '#4299e1'; // Lower body - blue
            return '#718096'; // Default
        }

        function displayWorkoutPlan(plan) {
            // Legacy function for backward compatibility
            displayDetailedWorkoutPlan(plan);
        }

        // AI Weekly Updates
        function generateWeeklyUpdate() {
            if (!currentUser || !isLoggedIn) return;

            const user = users[currentUser];
            const workouts = user.data.workouts || [];
            const recentWorkouts = workouts.slice(-7); // Last 7 workouts
            
            if (recentWorkouts.length === 0) {
                alert('No recent workouts found for analysis');
                return;
            }

            const insights = analyzeWeeklyProgress(user, recentWorkouts);
            const updatedPlan = updatePlanBasedOnProgress(user.workoutPlan, insights);
            
            // Save updated plan
            user.workoutPlan = updatedPlan;
            localStorage.setItem('ignitefitness_users', JSON.stringify(users));
            
            displayWeeklyUpdate(insights, updatedPlan);
        }

        function analyzeWeeklyProgress(user, workouts) {
            const insights = {
                consistency: calculateConsistency(workouts),
                performance: analyzePerformance(workouts),
                recovery: analyzeRecovery(user),
                recommendations: []
            };

            // Generate insights based on data
            if (insights.consistency < 70) {
                insights.recommendations.push('Consider adjusting your schedule to improve consistency');
            }
            
            if (insights.performance.trend === 'declining') {
                insights.recommendations.push('Focus on recovery and consider lighter training loads');
            }
            
            if (insights.recovery.avgSleep < 7) {
                insights.recommendations.push('Prioritize sleep for better performance and recovery');
            }

            return insights;
        }

        function calculateConsistency(workouts) {
            const days = workouts.length;
            return Math.min(100, (days / 7) * 100);
        }

        function analyzePerformance(workouts) {
            if (workouts.length < 3) return { trend: 'insufficient_data' };
            
            const recentEnergy = workouts.slice(-3).map(w => w.energy || 5);
            const avgEnergy = recentEnergy.reduce((a, b) => a + b, 0) / recentEnergy.length;
            
            return {
                trend: avgEnergy > 6 ? 'improving' : 'declining',
                avgEnergy: avgEnergy
            };
        }

        function analyzeRecovery(user) {
            const sleepData = user.data.sleepData || [];
            const recentSleep = sleepData.slice(-7);
            
            const avgSleep = recentSleep.length > 0 
                ? recentSleep.reduce((sum, day) => sum + (day.totalSleep || 7), 0) / recentSleep.length
                : 7;

            return { avgSleep };
        }

        function updatePlanBasedOnProgress(plan, insights) {
            if (!plan) return plan;

            // Adjust plan based on insights
            if (insights.consistency < 70) {
                // Reduce intensity for better consistency
                plan.recommendations.push('Reduced session intensity to improve consistency');
            }
            
            if (insights.performance.trend === 'declining') {
                // Add recovery focus
                plan.recommendations.push('Increased recovery emphasis based on performance data');
            }

            return plan;
        }

        function displayWeeklyUpdate(insights, updatedPlan) {
            const updateHtml = `
                <div style="background: #2d3748; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h3 style="color: #68d391; margin-bottom: 15px;">📊 Weekly AI Update</h3>
                    
                    <div style="margin-bottom: 15px;">
                        <h4>Performance Analysis:</h4>
                        <ul>
                            <li><strong>Consistency:</strong> ${insights.consistency.toFixed(1)}%</li>
                            <li><strong>Performance Trend:</strong> ${insights.performance.trend}</li>
                            <li><strong>Average Sleep:</strong> ${insights.recovery.avgSleep.toFixed(1)} hours</li>
                        </ul>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <h4>AI Recommendations:</h4>
                        <ul>
                            ${insights.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                        </ul>
                    </div>
                    
                    <div style="background: #1a1a1a; padding: 15px; border-radius: 5px;">
                        <strong>🎯 Plan Updated:</strong> Your workout plan has been adjusted based on this week's performance data.
                    </div>
                </div>
            `;
            
            // Add to analysis tab or create popup
            const analysisTab = document.getElementById('analysis');
            const existingUpdate = analysisTab.querySelector('.weekly-update');
            if (existingUpdate) {
                existingUpdate.remove();
            }
            
            const updateDiv = document.createElement('div');
            updateDiv.className = 'weekly-update';
            updateDiv.innerHTML = updateHtml;
            analysisTab.insertBefore(updateDiv, analysisTab.firstChild);
        }

        // Multiple Wearable Sync Functions
        function updateWearableSyncButtons() {
            if (!currentUser || !isLoggedIn) return;
            
            const user = users[currentUser];
            
            // Hide all buttons first
            document.getElementById('syncStravaBtn').style.display = 'none';
            document.getElementById('syncWhoopBtn').style.display = 'none';
            document.getElementById('syncAppleBtn').style.display = 'none';
            document.getElementById('syncGarminBtn').style.display = 'none';
            
            if (!user.wearableSettings) return;
            
            // Show buttons for configured devices
            if (user.wearableSettings.strava && user.wearableSettings.strava.accessToken) {
                document.getElementById('syncStravaBtn').style.display = 'inline-block';
            }
            
            if (user.wearableSettings.whoop && user.wearableSettings.whoop.token) {
                document.getElementById('syncWhoopBtn').style.display = 'inline-block';
            }
            
            if (user.wearableSettings.appleWatch && user.wearableSettings.appleWatch.healthKitEnabled) {
                document.getElementById('syncAppleBtn').style.display = 'inline-block';
            }
            
            if (user.wearableSettings.garmin && user.wearableSettings.garmin.username) {
                document.getElementById('syncGarminBtn').style.display = 'inline-block';
            }
        }

        async function syncStravaData() {
            if (!currentUser || !isLoggedIn) return;
            
            const user = users[currentUser];
            const statusDiv = document.getElementById('wearableSyncStatus');
            
            if (!user.wearableSettings?.strava?.accessToken) {
                statusDiv.innerHTML = '❌ Strava credentials not configured';
                statusDiv.style.color = '#fc8181';
                return;
            }
            
            statusDiv.innerHTML = '🔄 Syncing Strava data...';
            statusDiv.style.color = '#fbd38d';
            
            try {
                const activities = await fetchStravaActivities(user.wearableSettings.strava.accessToken);
                user.data.stravaData = activities;
                localStorage.setItem('ignitefitness_users', JSON.stringify(users));
                
                statusDiv.innerHTML = '✅ Strava data synced successfully!';
                statusDiv.style.color = '#68d391';
                
                // Auto-populate recovery data if available
                await autoPopulateRecoveryData(user);
                
            } catch (error) {
                statusDiv.innerHTML = `❌ Strava sync failed: ${error.message}`;
                statusDiv.style.color = '#fc8181';
            }
        }

        async function syncWhoopData() {
            if (!currentUser || !isLoggedIn) return;
            
            const statusDiv = document.getElementById('wearableSyncStatus');
            statusDiv.innerHTML = '🔄 Syncing Whoop data...';
            statusDiv.style.color = '#fbd38d';
            
            try {
                // Placeholder for Whoop API integration
                await new Promise(resolve => setTimeout(resolve, 2000)); // Simulate API call
                throw new Error('Whoop API integration coming soon');
                
            } catch (error) {
                statusDiv.innerHTML = `❌ Whoop sync failed: ${error.message}`;
                statusDiv.style.color = '#fc8181';
            }
        }

        async function syncAppleHealthData() {
            if (!currentUser || !isLoggedIn) return;
            
            const user = users[currentUser];
            const statusDiv = document.getElementById('wearableSyncStatus');
            statusDiv.innerHTML = '🔄 Generating Apple Health demo data...';
            statusDiv.style.color = '#fbd38d';
            
            try {
                // Generate realistic demo data that mimics Apple Health patterns
                const healthData = await fetchAppleHealthData();
                user.data.appleHealthData = healthData;
                localStorage.setItem('ignitefitness_users', JSON.stringify(users));
                
                statusDiv.innerHTML = '✅ Apple Health demo data generated successfully!<br><small>Note: This is realistic demo data since HealthKit requires a native iOS app.</small>';
                statusDiv.style.color = '#68d391';
                
                // Auto-populate recovery data if available
                await autoPopulateRecoveryData(user);
                
            } catch (error) {
                statusDiv.innerHTML = `❌ Apple Health demo data generation failed: ${error.message}`;
                statusDiv.style.color = '#fc8181';
            }
        }

        async function fetchAppleHealthData() {
            // Check if we're on iOS and HealthKit is available
            if (!window.HealthKit || !navigator.userAgent.includes('iPhone') && !navigator.userAgent.includes('iPad')) {
                // HealthKit not available - return empty data structure
                return {
                    activities: [],
                    biometrics: [],
                    sleep: [],
                    health: []
                };
            }
            
            try {
                // Real Apple HealthKit integration
                const healthData = {
                    activities: [],
                    biometrics: [],
                    sleep: [],
                    health: []
                };
                
                // Request permissions for different data types
                const permissions = {
                    read: [
                        'HKQuantityTypeIdentifierStepCount',
                        'HKQuantityTypeIdentifierActiveEnergyBurned',
                        'HKQuantityTypeIdentifierHeartRate',
                        'HKCategoryTypeIdentifierSleepAnalysis',
                        'HKQuantityTypeIdentifierBodyMass',
                        'HKQuantityTypeIdentifierHeight',
                        'HKQuantityTypeIdentifierVO2Max',
                        'HKQuantityTypeIdentifierRestingHeartRate',
                        'HKQuantityTypeIdentifierWalkingHeartRateAverage',
                        'HKCategoryTypeIdentifierMindfulSession'
                    ]
                };
                
                // Request authorization
                const authResult = await window.HealthKit.requestAuthorization(permissions);
                
                if (authResult.authorized) {
                    // Fetch today's data
                    const today = new Date();
                    const startOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                    const endOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 23, 59, 59);
                    
                    // Fetch steps
                    const steps = await window.HealthKit.querySampleType({
                        startDate: startOfDay,
                        endDate: endOfDay,
                        sampleType: 'HKQuantityTypeIdentifierStepCount',
                        limit: 1
                    });
                    
                    // Fetch active energy
                    const activeEnergy = await window.HealthKit.querySampleType({
                        startDate: startOfDay,
                        endDate: endOfDay,
                        sampleType: 'HKQuantityTypeIdentifierActiveEnergyBurned',
                        limit: 1
                    });
                    
                    // Fetch heart rate
                    const heartRate = await window.HealthKit.querySampleType({
                        startDate: startOfDay,
                        endDate: endOfDay,
                        sampleType: 'HKQuantityTypeIdentifierHeartRate',
                        limit: 10
                    });
                    
                    // Fetch sleep data
                    const sleep = await window.HealthKit.querySampleType({
                        startDate: startOfDay,
                        endDate: endOfDay,
                        sampleType: 'HKCategoryTypeIdentifierSleepAnalysis',
                        limit: 1
                    });
                    
                    // Process and return data
                    healthData.health.push({
                        date: today.toISOString().split('T')[0],
                        steps: steps.length > 0 ? steps[0].quantity : 0,
                        activeEnergy: activeEnergy.length > 0 ? activeEnergy[0].quantity : 0,
                        avgHeartRate: heartRate.length > 0 ? 
                            heartRate.reduce((sum, hr) => sum + hr.quantity, 0) / heartRate.length : 0
                    });
                    
                    if (sleep.length > 0) {
                        healthData.sleep.push({
                            date: today.toISOString().split('T')[0],
                            totalSleep: sleep[0].value, // This would need proper sleep duration calculation
                            sleepScore: 80 // Apple doesn't provide sleep score, this would be calculated
                        });
                    }
                }
                
                return healthData;
                
            } catch (error) {
                // HealthKit failed - return empty data structure
                console.log('HealthKit not available:', error);
                return {
                    activities: [],
                    biometrics: [],
                    sleep: [],
                    health: []
                };
            }
        }

        async function syncGarminData() {
            if (!currentUser || !isLoggedIn) return;
            
            const user = users[currentUser];
            const statusDiv = document.getElementById('wearableSyncStatus');
            
            if (!user.wearableSettings?.garmin?.username) {
                statusDiv.innerHTML = '❌ Garmin credentials not configured';
                statusDiv.style.color = '#fc8181';
                return;
            }
            
            statusDiv.innerHTML = '🔄 Syncing Garmin data...';
            statusDiv.style.color = '#fbd38d';
            
            try {
                // Garmin Connect API integration
                const garminData = await fetchGarminData(user.wearableSettings.garmin);
                user.data.garminData = garminData;
                localStorage.setItem('ignitefitness_users', JSON.stringify(users));
                
                statusDiv.innerHTML = '✅ Garmin data synced successfully!';
                statusDiv.style.color = '#68d391';
                
                // Auto-populate recovery data if available
                await autoPopulateRecoveryData(user);
                
            } catch (error) {
                statusDiv.innerHTML = `❌ Garmin sync failed: ${error.message}`;
                statusDiv.style.color = '#fc8181';
            }
        }

        async function fetchGarminData(credentials) {
            // Note: Garmin Connect doesn't have a public API, so this is a simplified implementation
            // In a real implementation, you'd need to use Garmin's Connect IQ or partner API
            
            try {
                // Simulate fetching data from Garmin Connect
                // This would typically require web scraping or using Garmin's Connect IQ API
                const mockGarminData = {
                    activities: [
                        {
                            date: new Date().toISOString().split('T')[0],
                            type: 'Running',
                            duration: 1800, // 30 minutes
                            distance: 5000, // 5km
                            calories: 300,
                            avgHeartRate: 150
                        }
                    ],
                    sleep: [
                        {
                            date: new Date().toISOString().split('T')[0],
                            totalSleep: 7.5,
                            deepSleep: 1.2,
                            remSleep: 1.8,
                            lightSleep: 4.5,
                            sleepScore: 85
                        }
                    ],
                    health: [
                        {
                            date: new Date().toISOString().split('T')[0],
                            steps: 8500,
                            activeMinutes: 45,
                            stressLevel: 25,
                            bodyBattery: 85
                        }
                    ]
                };
                
                // For now, return mock data
                // In production, this would make actual API calls to Garmin Connect
                return mockGarminData;
                
            } catch (error) {
                throw new Error('Garmin Connect API access requires special authentication. Please use Garmin\'s official Connect IQ app or partner API.');
            }
        }

        async         function autoPopulateRecoveryData(user) {
            // Auto-populate sleep data using source-agnostic approach
            const today = new Date().toISOString().split('T')[0];
            const existingRecovery = user.data.recoveryData?.find(r => r.date === today);
            
            if (!existingRecovery) {
                // Get all sleep sessions for today from all sources
                const allSleepSessions = getAllSleepSessionsForDate(user, today);
                
                if (allSleepSessions.length > 0) {
                    // Prioritize by data source quality
                    const prioritizedSession = prioritizeSleepData(allSleepSessions)[0];
                    
                    // Populate form with best available data
                    document.getElementById('sleepHours').value = prioritizedSession.totalSleep || '';
                    
                    // Show user which data source is active
                    const statusDiv = document.getElementById('wearableSyncStatus');
                    if (statusDiv) {
                        statusDiv.innerHTML = `✅ Using ${prioritizedSession.source} data`;
                        statusDiv.style.color = '#68d391';
                    }
                    
                    console.log(`Using ${prioritizedSession.source} data for sleep tracking`);
                }
            }
        }

        function getAllSleepSessionsForDate(user, date) {
            const sessions = [];
            
            // Manual sleep data (highest priority for user control)
            if (user.data.sleepData) {
                user.data.sleepData.forEach(sleep => {
                    if (sleep.date === date) {
                        sessions.push({
                            ...sleep,
                            source: 'manual',
                            sourceId: sleep.id || Date.now().toString(),
                            totalSleep: sleep.totalSleep || sleep.sleepHours
                        });
                    }
                });
            }
            
            // Apple Health data
            if (user.data.appleHealthData?.sleep) {
                user.data.appleHealthData.sleep.forEach(sleep => {
                    if (sleep.date === date) {
                        sessions.push({
                            ...sleep,
                            source: 'appleHealth',
                            sourceId: sleep.sourceId || 'apple_' + Date.now(),
                            totalSleep: sleep.totalSleep
                        });
                    }
                });
            }
            
            // Garmin data
            if (user.data.garminData?.sleep) {
                user.data.garminData.sleep.forEach(sleep => {
                    if (sleep.date === date) {
                        sessions.push({
                            ...sleep,
                            source: 'garmin',
                            sourceId: sleep.sourceId || 'garmin_' + Date.now(),
                            totalSleep: sleep.totalSleep
                        });
                    }
                });
            }
            
            // Whoop data
            if (user.data.whoopData?.sleep) {
                user.data.whoopData.sleep.forEach(sleep => {
                    if (sleep.date === date) {
                        sessions.push({
                            ...sleep,
                            source: 'whoop',
                            sourceId: sleep.sourceId || 'whoop_' + Date.now(),
                            totalSleep: sleep.totalSleep
                        });
                    }
                });
            }
            
            return sessions;
        }

        function prioritizeSleepData(sessions) {
            // Priority order: Manual (user control) > Real wearable data
            const priorityOrder = ['manual', 'appleHealth', 'garmin', 'whoop'];
            
            return sessions.sort((a, b) => {
                const aPriority = priorityOrder.indexOf(a.source);
                const bPriority = priorityOrder.indexOf(b.source);
                
                // If same priority, prefer more recent data
                if (aPriority === bPriority) {
                    return new Date(b.createdAt || b.date) - new Date(a.createdAt || a.date);
                }
                
                return aPriority - bPriority;
            });
        }

        function resolveSleepConflicts(user) {
            // Check for overlapping sleep sessions from different sources
            const today = new Date().toISOString().split('T')[0];
            const sessions = getAllSleepSessionsForDate(user, today);
            
            if (sessions.length > 1) {
                const conflicts = [];
                const prioritized = prioritizeSleepData(sessions);
                
                // Show user the conflict and let them choose
                if (prioritized.length > 1) {
                    const primary = prioritized[0];
                    const secondary = prioritized[1];
                    
                    const conflictMessage = `Multiple sleep data sources detected:\n\n` +
                        `Primary: ${primary.source} - ${primary.totalSleep} hours\n` +
                        `Secondary: ${secondary.source} - ${secondary.totalSleep} hours\n\n` +
                        `Using ${primary.source} data. You can manually adjust if needed.`;
                    
                    console.log(conflictMessage);
                    
                    // Could show a notification to user
                    return { primary, secondary, conflicts: true };
                }
            }
            
            return { primary: sessions[0], conflicts: false };
        }
        

        let soccerSessions = [];
        let recoveryData = [];
        let stravaData = [];
        let sleepData = [];
        
        // Strava API configuration
        const STRAVA_CONFIG = {
            clientId: '', // You'll need to get this from Strava
            redirectUri: window.location.origin + '/strava-callback.html',
            scope: 'read,activity:read_all,profile:read_all'
        };
        
        // 4-Week Progression Targets
        const progressionTargets = {
            1: { bench: 40, squat: 75, pullups: -60, description: 'Gentle Return' },
            2: { bench: 45, squat: 80, pullups: -55, description: 'Full Intensity' },
            3: { bench: 47.5, squat: 85, pullups: -50, description: 'Building' },
            4: { bench: 50, squat: 95, pullups: -45, description: 'Peak' }
        };

        // Daily workout plans based on your master plan
        const dailyPlans = {
            'Upper A': [
                { name: 'Bench Press', target: '3×5 @ 40 lbs', rest: '2 min' },
                { name: 'Lat Pulldown', target: '3×8', rest: '90 sec' },
                { name: 'DB Shoulder Press', target: '3×8 @ 15 lbs', rest: '90 sec' },
                { name: 'Cable Row', target: '3×10', rest: '60 sec' }
            ],
            'Upper B': [
                { name: 'Incline DB Press', target: '3×8 @ 15 lbs', rest: '90 sec' },
                { name: 'Pull-ups', target: '3×5 @ -60 assist', rest: '2 min' },
                { name: 'Lateral Raises', target: '3×12 @ 8 lbs', rest: '60 sec' },
                { name: 'Face Pulls', target: '3×15', rest: '60 sec' }
            ],
            'Lower A': [
                { name: 'Back Squat', target: '3×5 @ 75 lbs', rest: '2.5 min' },
                { name: 'Nordic Curls', target: '3×6-8', rest: '90 sec' },
                { name: 'RDL', target: '3×8 @ 65 lbs', rest: '2 min' },
                { name: 'Single Leg RDLs', target: '3×8 each side', rest: '90 sec' },
                { name: 'Goblet Squat', target: '3×10 @ 25 lbs', rest: '90 sec' }
            ],
            'Lower B': [
                { name: 'Squat', target: '4×5 @ 80 lbs', rest: '2.5 min' },
                { name: 'RDL', target: '3×8 @ 70 lbs', rest: '2 min' },
                { name: 'Bulgarian Split Squats', target: '3×8/leg @ 15 lbs', rest: '90 sec' },
                { name: 'Single Leg Box Jump', target: '3×3/leg', rest: '90 sec' }
            ],
            'Soccer': [
                { name: 'Dynamic Warmup', target: '10 min', rest: '' },
                { name: 'ACL Prevention', target: '15 min', rest: '' },
                { name: 'Soccer Practice/Match', target: '90 min', rest: '' }
            ],
            'Indoor Climbing': [
                { name: 'Warm-up Routes', target: '3-4 easy routes (V0-V2)', rest: '2 min between' },
                { name: 'Main Climbing', target: '6-8 routes (V2-V5)', rest: '3-5 min between' },
                { name: 'Cool-down', target: '2 easy routes (V0-V1)', rest: '2 min between' },
                { name: 'Session Notes', target: '~12 routes, ~90-120 min total', rest: '' }
            ],
            'Outdoor Climbing': [
                { name: 'Approach & Setup', target: '15-30 min', rest: '' },
                { name: 'Warm-up Routes', target: '2-3 easy pitches (5.6-5.8)', rest: '5-10 min between' },
                { name: 'Main Climbing', target: '3-5 routes (5.9-6.2)', rest: '5-15 min between' },
                { name: 'Descent & Cleanup', target: '15-30 min', rest: '' },
                { name: 'Session Notes', target: '~5-8 routes, ~3-6 hours total', rest: '' }
            ],
            'Recovery': [
                { name: 'Yoga with Adriene', target: '30-45 min', rest: '' },
                { name: 'Hip/Achilles Work', target: '10 min', rest: '' },
                { name: 'Foam Rolling', target: '10 min', rest: '' }
            ]
        };

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize the app - show login form by default
            showLoginForm();
            hideUserDashboard();
            
            // Load users from localStorage
            const savedUsers = localStorage.getItem('ignitefitness_users');
            if (savedUsers) {
                users = JSON.parse(savedUsers);
            }
            
            // Check if user was previously logged in (simple session persistence)
            const lastUser = localStorage.getItem('ignitefitness_last_user');
            if (lastUser && users[lastUser]) {
                currentUser = lastUser;
                isLoggedIn = true;
                showUserDashboard();
                hideLoginForm();
                loadUserData();
                
                // Load personal data into form fields after a short delay to ensure DOM is ready
                setTimeout(() => {
                    loadPersonalDataToForm();
                    loadGoalsToForm();
                    loadWearableSettingsToForm();
                }, 100);
                
                // Initialize displays only if logged in
                updateCurrentSessionDisplay();
                updateHistory();
                updateSummary();
            }
                
            // Set today's date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('sessionDate').value = today;
            
            // Initialize sliders
            initializeSliders();
            
            // Add event listeners
            const extraExerciseSelect = document.getElementById('extraExerciseName');
            if (extraExerciseSelect) {
                extraExerciseSelect.addEventListener('change', toggleOtherExercise);
            }
            
            // Session type change listener for climbing intensity
            const sessionTypeSelect = document.getElementById('sessionType');
            if (sessionTypeSelect) {
                sessionTypeSelect.addEventListener('change', toggleClimbingIntensity);
            }
            
            // Load daily plan if session type is already selected
            loadDailyPlan();
            
           // Load data
           loadData();
           
           // Check for missed workouts and auto-adapt if needed
           setTimeout(() => {
               autoAdaptPlanForMissedWorkouts();
           }, 2000); // Wait 2 seconds for data to load
       });

        function initializeSliders() {
            // Session energy slider
            const sessionEnergySlider = document.getElementById('sessionEnergy');
            const sessionEnergyValue = document.getElementById('sessionEnergyValue');
            if (sessionEnergySlider && sessionEnergyValue) {
                sessionEnergySlider.addEventListener('input', function() {
                    sessionEnergyValue.textContent = this.value;
                    currentSession.energy = parseInt(this.value);
                });
            }

            // Exercise RPE slider
            const exerciseRpeSlider = document.getElementById('exerciseRpe');
            const exerciseRpeValue = document.getElementById('exerciseRpeValue');
            if (exerciseRpeSlider && exerciseRpeValue) {
                exerciseRpeSlider.addEventListener('input', function() {
                    exerciseRpeValue.textContent = this.value;
                });
            }

            // Soccer sliders
            initializeSlider('soccerEnergy', 'soccerEnergyValue');
            initializeSlider('soccerPerformance', 'soccerPerformanceValue');
            initializeSlider('soccerSharpness', 'soccerSharpnessValue');

            // Recovery sliders
            initializeSlider('sorenessLevel', 'sorenessLevelValue');
            initializeSlider('achillesTightness', 'achillesTightnessValue');
            initializeSlider('hipTightness', 'hipTightnessValue');
            initializeSlider('overallEnergy', 'overallEnergyValue');
            initializeSlider('moodLevel', 'moodLevelValue');
            
            // Climbing intensity slider
            initializeSlider('climbingIntensity', 'climbingIntensityValue');
        }

        function initializeSlider(sliderId, valueId) {
            const slider = document.getElementById(sliderId);
            const value = document.getElementById(valueId);
            if (slider && value) {
                slider.addEventListener('input', function() {
                    value.textContent = this.value;
                });
            }
        }

        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
            
            // Update content when switching tabs
            if (tabName === 'history') {
                updateHistory();
            } else if (tabName === 'summary') {
                updateSummary();
            } else if (tabName === 'export') {
                updateExportPreview();
            } else if (tabName === 'soccer') {
                updateSoccerHistory();
            } else if (tabName === 'recovery') {
                updateRecoveryHistory();
            } else if (tabName === 'analysis') {
                updateAnalysis();
                updateSleepHistory();
            }
        }

        function loadDailyPlan() {
            const sessionType = document.getElementById('sessionType').value;
            const plannedWorkoutDiv = document.getElementById('plannedWorkout');
            
            if (!dailyPlans[sessionType]) {
                plannedWorkoutDiv.innerHTML = '<p style="color: #a0aec0; text-align: center; padding: 20px;">No plan available for this session type</p>';
                return;
            }
            
            const plan = dailyPlans[sessionType];
            let html = '<h4 style="color: #68d391; margin-bottom: 15px;">Planned Exercises:</h4>';
            
            plan.forEach((exercise, index) => {
                html += `
                    <div class="planned-exercise" data-exercise="${exercise.name}">
                        <div class="planned-exercise-info">
                            <div class="planned-exercise-name">${exercise.name}</div>
                            <div class="planned-exercise-target">Target: ${exercise.target} ${exercise.rest ? `(Rest: ${exercise.rest})` : ''}</div>
                            <div class="set-entry-example">Example: "40x12, 45x10, 50x6" or "3x5 @ 40"</div>
                        </div>
                        <div class="planned-exercise-input">
                            <textarea placeholder="Sets & Weights&#10;40x12, 45x10, 50x6" class="planned-sets-reps" data-exercise="${exercise.name}" rows="2"></textarea>
                            <button class="btn" style="padding: 5px 10px; font-size: 12px;" onclick="addPlannedExercise('${exercise.name}')">Add</button>
                        </div>
                    </div>
                `;
            });
            
            plannedWorkoutDiv.innerHTML = html;
        }

        function clearPlan() {
            document.getElementById('plannedWorkout').innerHTML = '<p style="color: #a0aec0; text-align: center; padding: 20px;">Select a session type to load today\'s plan</p>';
        }

        function addPlannedExercise(exerciseName) {
            const setsRepsInput = document.querySelector(`textarea[data-exercise="${exerciseName}"].planned-sets-reps`);
            const setsReps = setsRepsInput.value.trim();
            
            if (!setsReps) {
                alert('Please enter your sets and weights');
                return;
            }
            
            // Parse the flexible input format
            const parsedSets = parseSetsInput(setsReps);
            
            const exercise = {
                name: exerciseName,
                weight: parsedSets.averageWeight || 0, // Store average weight for sorting/display
                setsReps: setsReps, // Store the full input as entered
                parsedSets: parsedSets.sets, // Store parsed individual sets
                rpe: 7, // Default RPE
                notes: '',
                timestamp: new Date().toISOString()
            };
            
            currentSession.exercises.push(exercise);
            
            // Clear input
            setsRepsInput.value = '';
            
            updateCurrentSessionDisplay();
        }

        function parseSetsInput(input) {
            const sets = [];
            let totalWeight = 0;
            let totalSets = 0;
            
            // Handle different formats:
            // "40x12, 45x10, 50x6" - different weights per set
            // "3x5 @ 40" - same weight for all sets
            // "12, 10, 6" - reps only (no weights specified)
            // "40x12 45x10 50x6" - spaces instead of commas
            
            const cleanInput = input.replace(/\s+/g, ' ').trim();
            
            // Check if it's in "weightxreps" format
            if (cleanInput.includes('x') || cleanInput.includes('×')) {
                const parts = cleanInput.split(/[,\s]+/);
                
                for (const part of parts) {
                    if (part.includes('x') || part.includes('×')) {
                        const [weight, reps] = part.split(/[x×]/);
                        const weightNum = parseFloat(weight);
                        const repsNum = parseInt(reps);
                        
                        if (!isNaN(weightNum) && !isNaN(repsNum)) {
                            sets.push({ weight: weightNum, reps: repsNum });
                            totalWeight += weightNum * repsNum;
                            totalSets += 1;
                        }
                    }
                }
            }
            // Check if it's in "setsxreps @ weight" format
            else if (cleanInput.includes('@')) {
                const parts = cleanInput.split('@');
                if (parts.length === 2) {
                    const setsReps = parts[0].trim();
                    const weight = parseFloat(parts[1].trim());
                    
                    if (setsReps.includes('x') || setsReps.includes('×')) {
                        const [setCount, reps] = setsReps.split(/[x×]/);
                        const setCountNum = parseInt(setCount);
                        const repsNum = parseInt(reps);
                        
                        if (!isNaN(setCountNum) && !isNaN(repsNum) && !isNaN(weight)) {
                            for (let i = 0; i < setCountNum; i++) {
                                sets.push({ weight: weight, reps: repsNum });
                                totalWeight += weight * repsNum;
                                totalSets += 1;
                            }
                        }
                    }
                }
            }
            // Handle just reps (no weights)
            else {
                const parts = cleanInput.split(/[,\s]+/);
                for (const part of parts) {
                    const reps = parseInt(part);
                    if (!isNaN(reps)) {
                        sets.push({ weight: 0, reps: reps }); // No weight specified
                        totalSets += 1;
                    }
                }
            }
            
            return {
                sets: sets,
                averageWeight: totalSets > 0 ? totalWeight / totalSets : 0
            };
        }

        function addExtraExercise() {
            const exerciseName = document.getElementById('extraExerciseName').value;
            const otherExerciseName = document.getElementById('otherExtraExerciseName').value;
            const setsReps = document.getElementById('extraSetsReps').value.trim();

            if (!setsReps) {
                alert('Please enter your sets and weights');
                return;
            }

            const finalExerciseName = exerciseName === 'Other' ? otherExerciseName : exerciseName;
            
            if (!finalExerciseName) {
                alert('Please enter an exercise name');
                return;
            }

            // Parse the flexible input format
            const parsedSets = parseSetsInput(setsReps);

            const exercise = {
                name: finalExerciseName,
                weight: parsedSets.averageWeight || 0, // Store average weight for sorting/display
                setsReps: setsReps, // Store the full input as entered
                parsedSets: parsedSets.sets, // Store parsed individual sets
                rpe: 7, // Default RPE
                notes: '',
                timestamp: new Date().toISOString()
            };

            currentSession.exercises.push(exercise);
            
            // Clear form
            document.getElementById('extraSetsReps').value = '';
            document.getElementById('otherExtraExerciseName').value = '';
            document.getElementById('otherExtraExerciseGroup').classList.add('hidden');
            
            updateCurrentSessionDisplay();
        }

        function toggleOtherExercise() {
            const exerciseSelect = document.getElementById('extraExerciseName');
            const otherGroup = document.getElementById('otherExtraExerciseGroup');
            
            if (exerciseSelect.value === 'Other') {
                otherGroup.classList.remove('hidden');
            } else {
                otherGroup.classList.add('hidden');
            }
        }

        function toggleClimbingIntensity() {
            const sessionType = document.getElementById('sessionType');
            const climbingIntensityGroup = document.getElementById('climbingIntensityGroup');
            const climbingRoutesGroup = document.getElementById('climbingRoutesGroup');
            const climbingDurationGroup = document.getElementById('climbingDurationGroup');
            
            if (sessionType.value === 'Indoor Climbing' || sessionType.value === 'Outdoor Climbing') {
                climbingIntensityGroup.style.display = 'block';
                climbingRoutesGroup.style.display = 'block';
                climbingDurationGroup.style.display = 'block';
            } else {
                climbingIntensityGroup.style.display = 'none';
                climbingRoutesGroup.style.display = 'none';
                climbingDurationGroup.style.display = 'none';
            }
        }

        function addExercise() {
            const exerciseName = document.getElementById('exerciseName').value;
            const otherExerciseName = document.getElementById('otherExerciseName').value;
            const weight = parseFloat(document.getElementById('weight').value) || 0;
            const setsReps = document.getElementById('setsReps').value;
            const rpe = parseInt(document.getElementById('exerciseRpe').value);
            const notes = document.getElementById('exerciseNotes').value;

            if (!exerciseName || !setsReps) {
                alert('Please fill in exercise name and sets/reps');
                return;
            }

            const finalExerciseName = exerciseName === 'Other' ? otherExerciseName : exerciseName;

            const exercise = {
                name: finalExerciseName,
                weight: weight,
                setsReps: setsReps,
                rpe: rpe,
                notes: notes,
                timestamp: new Date().toISOString()
            };

            currentSession.exercises.push(exercise);
            
            // Clear form
            document.getElementById('weight').value = '';
            document.getElementById('setsReps').value = '';
            document.getElementById('exerciseRpe').value = '7';
            document.getElementById('exerciseRpeValue').textContent = '7';
            document.getElementById('exerciseNotes').value = '';
            
            updateCurrentSessionDisplay();
        }

        function updateCurrentSessionDisplay() {
            const container = document.getElementById('currentExercises');
            const sessionDiv = document.getElementById('currentSession');
            
            if (currentSession.exercises.length === 0) {
                sessionDiv.classList.add('hidden');
                return;
            }
            
            sessionDiv.classList.remove('hidden');
            
            container.innerHTML = '';
            currentSession.exercises.forEach((exercise, index) => {
                const exerciseDiv = document.createElement('div');
                exerciseDiv.className = 'exercise-card';
                // Create detailed set breakdown if parsed sets are available
                let setBreakdown = '';
                if (exercise.parsedSets && exercise.parsedSets.length > 0) {
                    setBreakdown = '<div style="margin-top: 10px; font-size: 14px;"><strong>Set Breakdown:</strong><br>';
                    exercise.parsedSets.forEach((set, setIndex) => {
                        const weightText = set.weight > 0 ? `${set.weight}lbs` : 'BW';
                        setBreakdown += `Set ${setIndex + 1}: ${set.reps} reps @ ${weightText}<br>`;
                    });
                    setBreakdown += '</div>';
                }

                exerciseDiv.innerHTML = `
                    <div class="exercise-header">
                        <span class="exercise-name">${exercise.name}</span>
                        <button onclick="removeExercise(${index})" style="background: none; border: none; color: #fc8181; cursor: pointer;">×</button>
                    </div>
                    <div class="exercise-details">
                        <div class="exercise-detail">
                            <div class="exercise-detail-label">Weight</div>
                            <div class="exercise-detail-value">${exercise.weight > 0 ? exercise.weight + ' lbs' : 'Body Weight'}</div>
                        </div>
                        <div class="exercise-detail">
                            <div class="exercise-detail-label">Sets × Reps</div>
                            <div class="exercise-detail-value">${exercise.setsReps}</div>
                        </div>
                        <div class="exercise-detail">
                            <div class="exercise-detail-label">RPE</div>
                            <div class="exercise-detail-value">${exercise.rpe}/10</div>
                        </div>
                    </div>
                    ${setBreakdown}
                    ${exercise.notes ? `<div class="exercise-notes">${exercise.notes}</div>` : ''}
                `;
                container.appendChild(exerciseDiv);
            });
        }

        function removeExercise(index) {
            currentSession.exercises.splice(index, 1);
            updateCurrentSessionDisplay();
        }

        function saveSession() {
            // Update session details
            currentSession.date = document.getElementById('sessionDate').value;
            currentSession.startTime = document.getElementById('sessionStartTime').value;
            currentSession.type = document.getElementById('sessionType').value;
            currentSession.notes = document.getElementById('sessionNotes').value;
            
            // Add climbing data if climbing session
            const sessionType = document.getElementById('sessionType').value;
            if (sessionType === 'Indoor Climbing' || sessionType === 'Outdoor Climbing') {
                currentSession.climbingIntensity = parseInt(document.getElementById('climbingIntensity').value);
                currentSession.climbingRoutes = parseInt(document.getElementById('climbingRoutes').value) || 0;
                currentSession.climbingDuration = parseInt(document.getElementById('climbingDuration').value) || 0;
            }
            
            if (!currentSession.date || currentSession.exercises.length === 0) {
                alert('Please fill in date and add at least one exercise');
                return;
            }

            // Save to user-specific storage
            if (!currentUser || !isLoggedIn) {
                alert('Please log in to save workouts');
                return;
            }
            
            const user = users[currentUser];
            if (!user.data.workouts) user.data.workouts = [];
            
            currentSession.id = Date.now();
            user.data.workouts.push({...currentSession});
            localStorage.setItem('ignitefitness_users', JSON.stringify(users));
            
            // Reset current session
            currentSession = {
                date: '',
                type: '',
                energy: 7,
                notes: '',
                exercises: []
            };
            
            // Reset form
            document.getElementById('sessionDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('sessionType').value = 'Upper A';
            document.getElementById('sessionEnergy').value = '7';
            document.getElementById('sessionEnergyValue').textContent = '7';
            document.getElementById('sessionNotes').value = '';
            
            // Reset climbing fields
            document.getElementById('climbingIntensity').value = '5';
            document.getElementById('climbingIntensityValue').textContent = '5';
            document.getElementById('climbingRoutes').value = '';
            document.getElementById('climbingDuration').value = '';
            
            // Hide climbing fields
            toggleClimbingIntensity();
            
            // Show completion message
            const messageDiv = document.getElementById('sessionSavedMessage');
            messageDiv.style.display = 'block';
            
            // Hide message after 3 seconds
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 3000);
            
            updateCurrentSessionDisplay();
            updateHistory();
            updateSummary();
            
            // Scroll to top to show completion message
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function getWorkouts() {
            if (!currentUser || !isLoggedIn) return [];
            const user = users[currentUser];
            if (!user) return [];
            
            // Return sessions that are workouts
            return user.data?.sessions?.filter(s => s.type === 'workout') || [];
        }

        function updateHistory() {
            const workouts = getWorkouts();
            const container = document.getElementById('workoutHistory');
            
            if (workouts.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #a0aec0; padding: 20px;">No workouts logged yet</p>';
                return;
            }
            
            // Show last 5 workouts
            const recentWorkouts = workouts.slice(-5).reverse();
            
            container.innerHTML = '';
            recentWorkouts.forEach(workout => {
                const workoutDiv = document.createElement('div');
                workoutDiv.className = 'session-card';
                workoutDiv.innerHTML = `
                    <div class="session-header">
                        <span class="session-type">${workout.type}${(workout.type === 'Indoor Climbing' || workout.type === 'Outdoor Climbing') ? ' 🧗‍♂️' : ''}</span>
                        <span class="session-date">${new Date(workout.date).toLocaleDateString()}</span>
                    </div>
                    <div class="session-stats">
                        <div class="session-stat">
                            <div class="session-stat-label">Exercises</div>
                            <div class="session-stat-value">${workout.exercises.length}</div>
                        </div>
                        <div class="session-stat">
                            <div class="session-stat-label">Energy</div>
                            <div class="session-stat-value">${workout.energy}/10</div>
                        </div>
                        ${(workout.type === 'Indoor Climbing' || workout.type === 'Outdoor Climbing') ? `
                        ${workout.climbingIntensity ? `
                        <div class="session-stat">
                            <div class="session-stat-label">Intensity</div>
                            <div class="session-stat-value">${workout.climbingIntensity}/10</div>
                        </div>
                        ` : ''}
                        ${workout.climbingRoutes ? `
                        <div class="session-stat">
                            <div class="session-stat-label">Routes</div>
                            <div class="session-stat-value">${workout.climbingRoutes}</div>
                        </div>
                        ` : ''}
                        ${workout.climbingDuration ? `
                        <div class="session-stat">
                            <div class="session-stat-label">Duration</div>
                            <div class="session-stat-value">${workout.climbingDuration}min</div>
                        </div>
                        ` : ''}
                        ` : ''}
                    </div>
                    ${workout.notes ? `<div style="color: #a0aec0; font-size: 14px; margin-bottom: 10px;">${workout.notes}</div>` : ''}
                    <button class="workout-toggle" onclick="toggleWorkoutDetails(${workout.id})">Show/Hide Exercises</button>
                    <div id="workout-${workout.id}" class="workout-exercises hidden">
                        ${workout.exercises.map(exercise => `
                            <div class="exercise-card">
                                <div class="exercise-header">
                                    <span class="exercise-name">${exercise.name}</span>
                                </div>
                                <div class="exercise-details">
                                    <div class="exercise-detail">
                                        <div class="exercise-detail-label">Weight</div>
                                        <div class="exercise-detail-value">${exercise.weight} lbs</div>
                                    </div>
                                    <div class="exercise-detail">
                                        <div class="exercise-detail-label">Sets × Reps</div>
                                        <div class="exercise-detail-value">${exercise.setsReps}</div>
                                    </div>
                                    <div class="exercise-detail">
                                        <div class="exercise-detail-label">RPE</div>
                                        <div class="exercise-detail-value">${exercise.rpe}/10</div>
                                    </div>
                                </div>
                                ${exercise.notes ? `<div class="exercise-notes">${exercise.notes}</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
                container.appendChild(workoutDiv);
            });
        }

        function toggleWorkoutDetails(workoutId) {
            const detailsDiv = document.getElementById(`workout-${workoutId}`);
            detailsDiv.classList.toggle('hidden');
        }

        function updateSummary() {
            const workouts = getWorkouts();
            const now = new Date();
            const weekStart = new Date(now.setDate(now.getDate() - now.getDay()));
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            
            const weeklyWorkouts = workouts.filter(workout => {
                const workoutDate = new Date(workout.date);
                return workoutDate >= weekStart && workoutDate <= weekEnd;
            });
            
            // Update weekly stats
            document.getElementById('weeklySessions').textContent = weeklyWorkouts.length;
            
            if (weeklyWorkouts.length > 0) {
                const avgEnergy = Math.round(weeklyWorkouts.reduce((sum, w) => sum + w.energy, 0) / weeklyWorkouts.length);
                document.getElementById('weeklyEnergy').textContent = `${avgEnergy}/10`;
            } else {
                document.getElementById('weeklyEnergy').textContent = '0/10';
            }
            
            // Update progression list
            const progressionList = document.getElementById('progressionList');
            progressionList.innerHTML = '';
            
            const mainLifts = ['Bench Press', 'Squat', 'Deadlift'];
            mainLifts.forEach(lift => {
                const liftWorkouts = weeklyWorkouts.flatMap(w => w.exercises.filter(e => e.name === lift));
                if (liftWorkouts.length > 0) {
                    const latest = liftWorkouts[liftWorkouts.length - 1];
                    const li = document.createElement('li');
                    li.className = 'progression-item';
                    li.innerHTML = `
                        <span class="progression-exercise">${lift}</span>
                        <span class="progression-value">${latest.weight}×${latest.setsReps}</span>
                    `;
                    progressionList.appendChild(li);
                }
            });

            // Update 4-week progression targets
            updateProgressionTargets();
            
            // Update recovery metrics
            updateRecoveryMetrics();
            
            // Update soccer metrics
            updateSoccerMetrics();
        }

        function updateProgressionTargets() {
            const container = document.getElementById('progressionTargets');
            container.innerHTML = '';
            
            // Determine current week (simplified - you could make this more sophisticated)
            const currentWeek = Math.min(4, Math.ceil((new Date() - new Date('2024-09-22')) / (7 * 24 * 60 * 60 * 1000)) + 1);
            
            Object.entries(progressionTargets).forEach(([week, targets]) => {
                const weekDiv = document.createElement('div');
                weekDiv.className = 'session-card';
                if (parseInt(week) === currentWeek) {
                    weekDiv.style.borderLeft = '4px solid #68d391';
                }
                weekDiv.innerHTML = `
                    <div class="session-header">
                        <span class="session-type">Week ${week}: ${targets.description}</span>
                        ${parseInt(week) === currentWeek ? '<span style="color: #68d391;">Current</span>' : ''}
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: #a0aec0;">Bench</div>
                            <div style="font-weight: 600;">${targets.bench} lbs</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: #a0aec0;">Squat</div>
                            <div style="font-weight: 600;">${targets.squat} lbs</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: #a0aec0;">Pull-ups</div>
                            <div style="font-weight: 600;">${targets.pullups} assist</div>
                        </div>
                    </div>
                `;
                container.appendChild(weekDiv);
            });
        }

        function updateRecoveryMetrics() {
            const weeklyRecoveryData = recoveryData.filter(recovery => {
                const recoveryDate = new Date(recovery.date);
                const now = new Date();
                const weekStart = new Date(now.setDate(now.getDate() - now.getDay()));
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);
                return recoveryDate >= weekStart && recoveryDate <= weekEnd;
            });
            
            if (weeklyRecoveryData.length > 0) {
                const avgSleep = (weeklyRecoveryData.reduce((sum, r) => sum + r.sleepHours, 0) / weeklyRecoveryData.length).toFixed(1);
                const yogaDays = weeklyRecoveryData.filter(r => r.yogaCompleted === 'Yes').length;
                
                document.getElementById('avgSleep').textContent = `${avgSleep}h`;
                document.getElementById('yogaDays').textContent = `${yogaDays}/7`;
            } else {
                document.getElementById('avgSleep').textContent = '0h';
                document.getElementById('yogaDays').textContent = '0/7';
            }
        }

        function updateSoccerMetrics() {
            const weeklySoccerData = soccerSessions.filter(soccer => {
                const soccerDate = new Date(soccer.date);
                const now = new Date();
                const weekStart = new Date(now.setDate(now.getDate() - now.getDay()));
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);
                return soccerDate >= weekStart && soccerDate <= weekEnd;
            });
            
            if (weeklySoccerData.length > 0) {
                const avgPerformance = Math.round(weeklySoccerData.reduce((sum, s) => sum + s.performance, 0) / weeklySoccerData.length);
                const aclWarmups = weeklySoccerData.filter(s => s.aclWarmupCompleted === 'Yes').length;
                
                document.getElementById('avgSoccerPerformance').textContent = `${avgPerformance}/10`;
                document.getElementById('aclWarmupCompliance').textContent = `${aclWarmups}/${weeklySoccerData.length}`;
            } else {
                document.getElementById('avgSoccerPerformance').textContent = '0/10';
                document.getElementById('aclWarmupCompliance').textContent = '0/0';
            }
        }

        function updateExportPreview() {
            const workouts = getWorkouts();
            const exportText = document.getElementById('exportText');
            
            if (workouts.length === 0 && soccerSessions.length === 0 && recoveryData.length === 0) {
                exportText.value = 'No data to export';
                return;
            }
            
            let formattedText = 'MURPHFITNESS COMPREHENSIVE TRAINING LOG\n';
            formattedText += '=' .repeat(40) + '\n\n';
            
            // Workout sessions
            if (workouts.length > 0) {
                formattedText += 'GYM SESSIONS:\n';
                formattedText += '-' .repeat(20) + '\n';
                workouts.forEach((workout, index) => {
                    formattedText += `Session ${index + 1}: ${workout.type} - ${new Date(workout.date).toLocaleDateString()}`;
                    if (workout.startTime) {
                        formattedText += ` (Started: ${workout.startTime})`;
                    }
                    formattedText += `\nEnergy: ${workout.energy}/10\n`;
                    if (workout.notes) {
                        formattedText += `Notes: ${workout.notes}\n`;
                    }
                    formattedText += 'Exercises:\n';
                    
                    workout.exercises.forEach(exercise => {
                        formattedText += `  • ${exercise.name}: ${exercise.weight}lbs × ${exercise.setsReps} @ RPE ${exercise.rpe}`;
                        if (exercise.notes) {
                            formattedText += ` (${exercise.notes})`;
                        }
                        formattedText += '\n';
                    });
                    
                    formattedText += '\n';
                });
            }
            
            // Soccer sessions
            if (soccerSessions.length > 0) {
                formattedText += 'SOCCER SESSIONS:\n';
                formattedText += '-' .repeat(20) + '\n';
                soccerSessions.forEach((session, index) => {
                    formattedText += `Soccer ${index + 1}: ${session.type} - ${new Date(session.date).toLocaleDateString()}\n`;
                    formattedText += `Energy: ${session.energy}/10 | Performance: ${session.performance}/10 | Sharpness: ${session.sharpness}/10\n`;
                    if (session.preGameFuel) {
                        formattedText += `Pre-game fuel: ${session.preGameFuel}\n`;
                    }
                    if (session.aclWarmupCompleted === 'Yes') {
                        formattedText += `✓ ACL warmup completed\n`;
                    }
                    if (session.notes) {
                        formattedText += `Notes: ${session.notes}\n`;
                    }
                    formattedText += '\n';
                });
            }
            
            // Recovery data
            if (recoveryData.length > 0) {
                formattedText += 'RECOVERY DATA:\n';
                formattedText += '-' .repeat(20) + '\n';
                recoveryData.forEach((recovery, index) => {
                    formattedText += `Day ${index + 1}: ${new Date(recovery.date).toLocaleDateString()}\n`;
                    formattedText += `Sleep: ${recovery.sleepHours}h | Energy: ${recovery.overallEnergy}/10 | Soreness: ${recovery.sorenessLevel}/10\n`;
                    formattedText += `Achilles: ${recovery.achillesTightness}/10 | Hip: ${recovery.hipTightness}/10 | Mood: ${recovery.moodLevel}/10\n`;
                    if (recovery.yogaCompleted === 'Yes') formattedText += `✓ Yoga completed\n`;
                    if (recovery.mobilityWorkCompleted === 'Yes') formattedText += `✓ Mobility work completed\n`;
                    formattedText += `Hydration: ${recovery.hydrationStatus} | Protein: ${recovery.proteinTargetHit}\n`;
                    if (recovery.notes) {
                        formattedText += `Notes: ${recovery.notes}\n`;
                    }
                    formattedText += '\n';
                });
            }
            
            exportText.value = formattedText;
        }

        function copyFormattedData() {
            const exportText = document.getElementById('exportText');
            exportText.select();
            document.execCommand('copy');
            alert('Formatted data copied to clipboard!');
        }

        function downloadCSV() {
            const workouts = getWorkouts();
            if (workouts.length === 0 && soccerSessions.length === 0 && recoveryData.length === 0) {
                alert('No data to export');
                return;
            }
            
            let csv = 'Data Type,Date,Start Time,Type,Energy,Performance,Sharpness,Sleep Hours,Soreness,Achilles Tightness,Hip Tightness,Mood,Notes\n';
            
            // Workout data
            workouts.forEach(workout => {
                workout.exercises.forEach(exercise => {
                    csv += `"Workout","${workout.date}","${workout.startTime || ''}","${workout.type}","${workout.energy}","","","","","","","","${exercise.name}: ${exercise.weight}lbs × ${exercise.setsReps} @ RPE ${exercise.rpe}"\n`;
                });
            });
            
            // Soccer data
            soccerSessions.forEach(session => {
                csv += `"Soccer","${session.date}","","${session.type}","${session.energy}","${session.performance}","${session.sharpness}","","","","","","${session.notes}"\n`;
            });
            
            // Recovery data
            recoveryData.forEach(recovery => {
                csv += `"Recovery","${recovery.date}","","Daily","${recovery.overallEnergy}","","","${recovery.sleepHours}","${recovery.sorenessLevel}","${recovery.achillesTightness}","${recovery.hipTightness}","${recovery.moodLevel}","${recovery.notes}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `murphfitness_complete_data_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function saveSoccerSession() {
            const soccerData = {
                date: document.getElementById('soccerDate').value,
                type: document.getElementById('soccerType').value,
                energy: parseInt(document.getElementById('soccerEnergy').value),
                performance: parseInt(document.getElementById('soccerPerformance').value),
                sharpness: parseInt(document.getElementById('soccerSharpness').value),
                preGameFuel: document.getElementById('preGameFuel').value,
                aclWarmupCompleted: document.getElementById('aclWarmupCompleted').value,
                notes: document.getElementById('soccerNotes').value,
                timestamp: new Date().toISOString()
            };

            if (!soccerData.date) {
                alert('Please select a date');
                return;
            }

            soccerSessions.push(soccerData);
            localStorage.setItem('soccerSessions', JSON.stringify(soccerSessions));
            
            // Clear form
            document.getElementById('soccerDate').value = '';
            document.getElementById('soccerNotes').value = '';
            document.getElementById('preGameFuel').value = '';
            
            updateSoccerHistory();
            alert('Soccer session saved!');
        }

        function saveRecoveryData() {
            const recovery = {
                date: document.getElementById('recoveryDate').value,
                sleepHours: parseFloat(document.getElementById('sleepHours').value) || 0,
                sorenessLevel: parseInt(document.getElementById('sorenessLevel').value),
                achillesTightness: parseInt(document.getElementById('achillesTightness').value),
                hipTightness: parseInt(document.getElementById('hipTightness').value),
                overallEnergy: parseInt(document.getElementById('overallEnergy').value),
                moodLevel: parseInt(document.getElementById('moodLevel').value),
                yogaCompleted: document.getElementById('yogaCompleted').value,
                mobilityWorkCompleted: document.getElementById('mobilityWorkCompleted').value,
                dailyCalories: parseInt(document.getElementById('dailyCalories').value) || 0,
                proteinTargetHit: document.getElementById('proteinTargetHit').value,
                hydrationStatus: document.getElementById('hydrationStatus').value,
                notes: document.getElementById('recoveryNotes').value,
                timestamp: new Date().toISOString()
            };

            if (!recovery.date) {
                alert('Please select a date');
                return;
            }

            recoveryData.push(recovery);
            localStorage.setItem('recoveryData', JSON.stringify(recoveryData));
            
            // Clear form
            document.getElementById('recoveryDate').value = '';
            document.getElementById('recoveryNotes').value = '';
            
            updateRecoveryHistory();
            alert('Recovery data saved!');
        }

        function updateSoccerHistory() {
            const container = document.getElementById('soccerSessionsList');
            
            if (soccerSessions.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #a0aec0; padding: 20px;">No soccer sessions logged yet</p>';
                return;
            }
            
            const recentSessions = soccerSessions.slice(-5).reverse();
            container.innerHTML = '';
            
            recentSessions.forEach(session => {
                const sessionDiv = document.createElement('div');
                sessionDiv.className = 'session-card';
                sessionDiv.innerHTML = `
                    <div class="session-header">
                        <span class="session-type">${session.type}</span>
                        <span class="session-date">${new Date(session.date).toLocaleDateString()}</span>
                    </div>
                    <div class="session-stats">
                        <div class="session-stat">
                            <div class="session-stat-label">Energy</div>
                            <div class="session-stat-value">${session.energy}/10</div>
                        </div>
                        <div class="session-stat">
                            <div class="session-stat-label">Performance</div>
                            <div class="session-stat-value">${session.performance}/10</div>
                        </div>
                        <div class="session-stat">
                            <div class="session-stat-label">Sharpness</div>
                            <div class="session-stat-value">${session.sharpness}/10</div>
                        </div>
                    </div>
                    ${session.preGameFuel ? `<div style="color: #a0aec0; font-size: 14px; margin-bottom: 10px;"><strong>Fuel:</strong> ${session.preGameFuel}</div>` : ''}
                    ${session.aclWarmupCompleted === 'Yes' ? '<div style="color: #68d391; font-size: 14px; margin-bottom: 10px;">✓ ACL Warmup Completed</div>' : ''}
                    ${session.notes ? `<div style="color: #a0aec0; font-size: 14px; margin-bottom: 10px;">${session.notes}</div>` : ''}
                `;
                container.appendChild(sessionDiv);
            });
        }

        function updateRecoveryHistory() {
            const container = document.getElementById('recoveryDataList');
            
            if (recoveryData.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #a0aec0; padding: 20px;">No recovery data logged yet</p>';
                return;
            }
            
            const recentData = recoveryData.slice(-7).reverse();
            container.innerHTML = '';
            
            recentData.forEach(day => {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'session-card';
                dayDiv.innerHTML = `
                    <div class="session-header">
                        <span class="session-type">Recovery Data</span>
                        <span class="session-date">${new Date(day.date).toLocaleDateString()}</span>
                    </div>
                    <div class="session-stats">
                        <div class="session-stat">
                            <div class="session-stat-label">Sleep</div>
                            <div class="session-stat-value">${day.sleepHours}h</div>
                        </div>
                        <div class="session-stat">
                            <div class="session-stat-label">Energy</div>
                            <div class="session-stat-value">${day.overallEnergy}/10</div>
                        </div>
                        <div class="session-stat">
                            <div class="session-stat-label">Soreness</div>
                            <div class="session-stat-value">${day.sorenessLevel}/10</div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: #a0aec0;">Achilles</div>
                            <div style="font-weight: 600;">${day.achillesTightness}/10</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: #a0aec0;">Hip</div>
                            <div style="font-weight: 600;">${day.hipTightness}/10</div>
                        </div>
                    </div>
                    ${day.yogaCompleted === 'Yes' ? '<div style="color: #68d391; font-size: 14px; margin-bottom: 5px;">✓ Yoga Completed</div>' : ''}
                    ${day.mobilityWorkCompleted === 'Yes' ? '<div style="color: #68d391; font-size: 14px; margin-bottom: 5px;">✓ Mobility Work Completed</div>' : ''}
                    <div style="color: #a0aec0; font-size: 14px; margin-bottom: 5px;"><strong>Hydration:</strong> ${day.hydrationStatus}</div>
                    <div style="color: #a0aec0; font-size: 14px; margin-bottom: 5px;"><strong>Protein:</strong> ${day.proteinTargetHit}</div>
                    ${day.notes ? `<div style="color: #a0aec0; font-size: 14px; margin-bottom: 10px;">${day.notes}</div>` : ''}
                `;
                container.appendChild(dayDiv);
            });
        }

        // Strava Integration Functions
        function authenticateStrava() {
            const authUrl = `https://www.strava.com/oauth/authorize?client_id=${STRAVA_CONFIG.clientId}&redirect_uri=${STRAVA_CONFIG.redirectUri}&response_type=code&scope=${STRAVA_CONFIG.scope}`;
            window.open(authUrl, '_blank');
        }

        async function refreshStravaToken() {
            if (!currentUser || !isLoggedIn) {
                throw new Error('User not logged in');
            }
            
            const user = users[currentUser];
            if (!user.wearableSettings || !user.wearableSettings.strava) {
                throw new Error('No Strava settings found for user');
            }
            
            const stravaSettings = user.wearableSettings.strava;
            if (!stravaSettings.refreshToken || stravaSettings.refreshToken === 'your_refresh_token_here') {
                throw new Error('No refresh token available');
            }
            
            const response = await fetch('https://www.strava.com/oauth/token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    'client_id': stravaSettings.clientId || STRAVA_TOKENS.clientId,
                    'client_secret': stravaSettings.clientSecret || STRAVA_TOKENS.clientSecret,
                    'refresh_token': stravaSettings.refreshToken,
                    'grant_type': 'refresh_token'
                })
            });
            
            if (!response.ok) {
                throw new Error('Failed to refresh token');
            }
            
            const tokenData = await response.json();
            
            // Update user's tokens in memory and localStorage
            user.wearableSettings.strava.accessToken = tokenData.access_token;
            user.wearableSettings.strava.refreshToken = tokenData.refresh_token;
            
            // Save updated user data
            localStorage.setItem('ignitefitness_users', JSON.stringify(users));
            
            // Also try to save to centralized storage
            try {
                await saveUserData();
            } catch (error) {
                console.log('Could not save to centralized storage, using local storage only');
            }
            
            return tokenData.access_token;
        }

        async function fetchStravaData() {
            if (!currentUser || !isLoggedIn) {
                alert('Please log in to sync Strava data');
                return;
            }
            
            const user = users[currentUser];
            if (!user.wearableSettings || !user.wearableSettings.strava) {
                alert('Please configure your Strava settings first');
                return;
            }
            
            const statusDiv = document.getElementById('stravaStatus');
            statusDiv.innerHTML = '🔄 Fetching Strava data...';
            
            try {
                // Get access token from user settings
                let accessToken = user.wearableSettings.strava.accessToken;
                if (!accessToken || accessToken === 'your_access_token_here') {
                    statusDiv.innerHTML = '❌ Please configure your Strava access token in settings';
                    return;
                }

                // Fetch recent activities
                let response = await fetch('https://www.strava.com/api/v3/athlete/activities?per_page=10', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                // If unauthorized, try to refresh the token
                if (response.status === 401) {
                    statusDiv.innerHTML = '🔄 Token expired, refreshing...';
                    try {
                        accessToken = await refreshStravaToken();
                        // Retry with new token
                        response = await fetch('https://www.strava.com/api/v3/athlete/activities?per_page=10', {
                            headers: {
                                'Authorization': `Bearer ${accessToken}`
                            }
                        });
                    } catch (refreshError) {
                        statusDiv.innerHTML = '❌ Token refresh failed. Please get new tokens from Strava.';
                        console.error('Token refresh error:', refreshError);
                        return;
                    }
                }

                if (!response.ok) {
                    throw new Error(`Failed to fetch Strava data: ${response.status}`);
                }

                const activities = await response.json();
                stravaData = activities;
                localStorage.setItem('stravaData', JSON.stringify(stravaData));
                
                statusDiv.innerHTML = '✅ Strava data synced successfully!';
                updateAnalysis();
                
            } catch (error) {
                console.error('Error fetching Strava data:', error);
                statusDiv.innerHTML = '❌ Error syncing Strava data. Check console for details.';
            }
        }

        // Sleep Data Functions
        function saveSleepData() {
            const sleep = {
                date: document.getElementById('sleepDate').value,
                totalSleep: parseFloat(document.getElementById('totalSleep').value) || 0,
                deepSleep: parseFloat(document.getElementById('deepSleep').value) || 0,
                remSleep: parseFloat(document.getElementById('remSleep').value) || 0,
                lightSleep: parseFloat(document.getElementById('lightSleep').value) || 0,
                sleepScore: parseInt(document.getElementById('sleepScore').value) || 0,
                timestamp: new Date().toISOString()
            };

            if (!sleep.date) {
                alert('Please select a date');
                return;
            }

            sleepData.push(sleep);
            localStorage.setItem('sleepData', JSON.stringify(sleepData));
            
            // Clear form
            document.getElementById('sleepDate').value = '';
            document.getElementById('totalSleep').value = '';
            document.getElementById('deepSleep').value = '';
            document.getElementById('remSleep').value = '';
            document.getElementById('lightSleep').value = '';
            document.getElementById('sleepScore').value = '';
            
            updateSleepHistory();
            alert('Sleep data saved!');
        }

        function updateSleepHistory() {
            const container = document.getElementById('sleepDataList');
            
            if (sleepData.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #a0aec0; padding: 20px;">No sleep data logged yet</p>';
                return;
            }
            
            const recentData = sleepData.slice(-7).reverse();
            container.innerHTML = '';
            
            recentData.forEach(day => {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'session-card';
                dayDiv.innerHTML = `
                    <div class="session-header">
                        <span class="session-type">Sleep Data</span>
                        <span class="session-date">${new Date(day.date).toLocaleDateString()}</span>
                    </div>
                    <div class="session-stats">
                        <div class="session-stat">
                            <div class="session-stat-label">Total Sleep</div>
                            <div class="session-stat-value">${day.totalSleep}h</div>
                        </div>
                        <div class="session-stat">
                            <div class="session-stat-label">Sleep Score</div>
                            <div class="session-stat-value">${day.sleepScore}/100</div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 10px;">
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: #a0aec0;">Deep</div>
                            <div style="font-weight: 600;">${day.deepSleep}h</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: #a0aec0;">REM</div>
                            <div style="font-weight: 600;">${day.remSleep}h</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: #a0aec0;">Light</div>
                            <div style="font-weight: 600;">${day.lightSleep}h</div>
                        </div>
                    </div>
                `;
                container.appendChild(dayDiv);
            });
        }

        // Analysis Functions
        function updateAnalysis() {
            const analysisDate = document.getElementById('analysisDate').value || new Date().toISOString().split('T')[0];
            const container = document.getElementById('analysisResults');
            
            // Get workout data for the day
            const dayWorkouts = getWorkouts().filter(workout => workout.date === analysisDate);
            const daySleep = sleepData.find(sleep => sleep.date === analysisDate);
            const dayStrava = stravaData.filter(activity => {
                const activityDate = new Date(activity.start_date).toISOString().split('T')[0];
                return activityDate === analysisDate;
            });
            
            let analysisHtml = '<div class="analysis-section">';
            
            // Workout Analysis
            if (dayWorkouts.length > 0) {
                analysisHtml += '<h5 style="color: #68d391;">💪 Workout Analysis</h5>';
                dayWorkouts.forEach(workout => {
                    analysisHtml += `
                        <div style="background: #2d3748; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                            <strong>${workout.type}</strong> - Energy: ${workout.energy}/10<br>
                            ${workout.exercises.length} exercises completed
                        </div>
                    `;
                });
            }
            
            // Sleep Analysis
            if (daySleep) {
                analysisHtml += '<h5 style="color: #68d391;">😴 Sleep Analysis</h5>';
                const sleepQuality = daySleep.sleepScore >= 80 ? 'Excellent' : 
                                   daySleep.sleepScore >= 60 ? 'Good' : 'Poor';
                analysisHtml += `
                    <div style="background: #2d3748; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                        <strong>Sleep Quality:</strong> ${sleepQuality} (${daySleep.sleepScore}/100)<br>
                        <strong>Total Sleep:</strong> ${daySleep.totalSleep}h<br>
                        <strong>Deep Sleep:</strong> ${daySleep.deepSleep}h (${(daySleep.deepSleep/daySleep.totalSleep*100).toFixed(1)}%)<br>
                        <strong>REM Sleep:</strong> ${daySleep.remSleep}h (${(daySleep.remSleep/daySleep.totalSleep*100).toFixed(1)}%)
                    </div>
                `;
            }
            
            // Strava Analysis
            if (dayStrava.length > 0) {
                analysisHtml += '<h5 style="color: #68d391;">🏃 Strava Activities</h5>';
                dayStrava.forEach(activity => {
                    const duration = Math.round(activity.moving_time / 60); // minutes
                    analysisHtml += `
                        <div style="background: #2d3748; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                            <strong>${activity.type}</strong> - ${duration} min<br>
                            Distance: ${(activity.distance/1000).toFixed(2)}km<br>
                            Average Heart Rate: ${activity.average_heartrate || 'N/A'} bpm
                        </div>
                    `;
                });
            }
            
            // AI Insights
            if (dayWorkouts.length > 0 || daySleep || dayStrava.length > 0) {
                analysisHtml += '<h5 style="color: #68d391;">🤖 AI Insights</h5>';
                analysisHtml += generateAIInsights(dayWorkouts, daySleep, dayStrava);
            }
            
            analysisHtml += '</div>';
            container.innerHTML = analysisHtml;
        }

        function categorizeWorkoutType(sessionType) {
            if (sessionType.includes('Upper')) {
                return 'upper';
            } else if (sessionType.includes('Lower')) {
                return 'lower';
            } else if (sessionType === 'Indoor Climbing' || sessionType === 'Outdoor Climbing') {
                return 'pull-core'; // Climbing is primarily pull movements + core
            } else if (sessionType === 'Soccer (Indoor)' || sessionType === 'Soccer (Outdoor)') {
                return 'cardio';
            } else if (sessionType === 'Recovery') {
                return 'recovery';
            }
            return 'other';
        }

        function categorizeMovementType(sessionType) {
            if (sessionType.includes('Upper')) {
                return 'mixed'; // Upper A/B includes both push and pull
            } else if (sessionType === 'Indoor Climbing' || sessionType === 'Outdoor Climbing') {
                return 'pull'; // Primarily pulling movements
            } else if (sessionType.includes('Lower')) {
                return 'legs'; // Lower body focused
            }
            return 'other';
        }

        function generateAIInsights(workouts, sleep, stravaActivities) {
            let insights = '';
            
            // Get comprehensive data for analysis
            const allWorkouts = getWorkouts();
            const recentWorkouts = allWorkouts.slice(-14); // Last 2 weeks
            const user = users[currentUser];
            
            // MULTI-DISCIPLINARY AI ANALYSIS
            insights += generateMultiDisciplinaryAnalysis(user, workouts, sleep, stravaActivities, recentWorkouts);
            
            return insights;
        }

        function generateMultiDisciplinaryAnalysis(user, workouts, sleep, stravaActivities, recentWorkouts) {
            let insights = '';
            
            // Create tabs for each discipline
            insights += '<div style="background: #1a1a1a; padding: 15px; border-radius: 5px; margin-bottom: 15px;">';
            insights += '<h4 style="color: #68d391; margin-bottom: 15px;">🎯 Multi-Disciplinary Performance Analysis</h4>';
            insights += '<div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">';
            insights += '<button class="btn" onclick="showDisciplineAnalysis(\'trainer\')" style="background: #4299e1;">💪 Personal Trainer</button>';
            insights += '<button class="btn" onclick="showDisciplineAnalysis(\'soccer\')" style="background: #48bb78;">⚽ Soccer S&C Coach</button>';
            insights += '<button class="btn" onclick="showDisciplineAnalysis(\'elite\')" style="background: #ed8936;">🏆 Elite Soccer Coach</button>';
            insights += '<button class="btn" onclick="showDisciplineAnalysis(\'therapy\')" style="background: #9f7aea;">🩺 Physical Therapist</button>';
            insights += '</div>';
            
            // Default view - show integrated analysis
            insights += '<div id="integratedAnalysis">';
            insights += generateIntegratedAnalysis(user, workouts, sleep, stravaActivities, recentWorkouts);
            insights += '</div>';
            
            // Individual discipline analyses (hidden by default)
            insights += '<div id="trainerAnalysis" style="display: none;">';
            insights += generatePersonalTrainerAnalysis(user, recentWorkouts, sleep);
            insights += '</div>';
            
            insights += '<div id="soccerAnalysis" style="display: none;">';
            insights += generateSoccerSCAnalysis(user, recentWorkouts, stravaActivities);
            insights += '</div>';
            
            insights += '<div id="eliteAnalysis" style="display: none;">';
            insights += generateEliteSoccerAnalysis(user, recentWorkouts, stravaActivities);
            insights += '</div>';
            
            insights += '<div id="therapyAnalysis" style="display: none;">';
            insights += generatePhysicalTherapyAnalysis(user, recentWorkouts, sleep);
            insights += '</div>';
            
            insights += '</div>';
            
            return insights;
        }

        function showDisciplineAnalysis(discipline) {
            // Hide all analyses
            document.getElementById('integratedAnalysis').style.display = 'none';
            document.getElementById('trainerAnalysis').style.display = 'none';
            document.getElementById('soccerAnalysis').style.display = 'none';
            document.getElementById('eliteAnalysis').style.display = 'none';
            document.getElementById('therapyAnalysis').style.display = 'none';
            
            // Show selected analysis
            document.getElementById(discipline + 'Analysis').style.display = 'block';
            
            // Update button styles
            document.querySelectorAll('[onclick^="showDisciplineAnalysis"]').forEach(btn => {
                btn.style.background = '#718096';
            });
            event.target.style.background = event.target.style.background.includes('4299e1') ? '#4299e1' : 
                                           event.target.style.background.includes('48bb78') ? '#48bb78' :
                                           event.target.style.background.includes('ed8936') ? '#ed8936' : '#9f7aea';
        }

        function generateIntegratedAnalysis(user, workouts, sleep, stravaActivities, recentWorkouts) {
            let insights = '<div style="background: #2d3748; padding: 15px; border-radius: 8px; border-left: 4px solid #68d391;">';
            insights += '<h5 style="color: #68d391; margin-top: 0;">🔄 Integrated Performance Assessment</h5>';
            
            // Cross-disciplinary insights
            insights += generateCrossDisciplinaryInsights(user, recentWorkouts, sleep, stravaActivities);
            
            // Priority recommendations from all disciplines
            insights += generatePriorityRecommendations(user, recentWorkouts, sleep, stravaActivities);
            
            // Performance optimization strategies
            insights += generatePerformanceOptimization(user, recentWorkouts, sleep, stravaActivities);
            
            insights += '</div>';
            
            return insights;
        }

        function generateCrossDisciplinaryInsights(user, recentWorkouts, sleep, stravaActivities) {
            let insights = '';
            
            // Trainer + Soccer S&C perspective
            const strengthFrequency = recentWorkouts.filter(w => w.type.includes('Upper') || w.type.includes('Lower')).length;
            const soccerFrequency = recentWorkouts.filter(w => w.type.includes('Soccer')).length;
            
            if (strengthFrequency >= 3 && soccerFrequency >= 2) {
                insights += '✅ <strong>Trainer + S&C:</strong> Excellent strength-soccer balance. Your conditioning supports match performance.<br><br>';
            } else if (strengthFrequency < 2 && soccerFrequency >= 2) {
                insights += '⚠️ <strong>Trainer + S&C:</strong> High soccer load with minimal strength work. Risk of strength loss and injury.<br><br>';
            }
            
            // Elite Coach + Physical Therapist perspective
            const avgEnergy = recentWorkouts.map(w => w.energy).filter(e => e > 0);
            const avgEnergyValue = avgEnergy.length > 0 ? avgEnergy.reduce((sum, e) => sum + e, 0) / avgEnergy.length : 0;
            
            if (avgEnergyValue >= 7 && sleep && sleep.sleepScore >= 80) {
                insights += '🏆 <strong>Elite Coach + PT:</strong> Optimal performance state. Ready for high-intensity training and competitive play.<br><br>';
            } else if (avgEnergyValue < 6 || (sleep && sleep.sleepScore < 60)) {
                insights += '🩺 <strong>Elite Coach + PT:</strong> Performance compromised. Prioritize recovery before intensity.<br><br>';
            }
            
            // All-discipline consensus on ACL prevention
            if (user.goals?.primary === 'acl_prevention' || user.goals?.secondary?.includes('acl_support')) {
                const aclWork = recentWorkouts.filter(w => 
                    w.exercises?.some(e => 
                        e.name.toLowerCase().includes('single-leg') || 
                        e.name.toLowerCase().includes('lateral') ||
                        e.name.toLowerCase().includes('clamshell') ||
                        e.name.toLowerCase().includes('monster')
                    )
                ).length;
                
                if (aclWork >= 2) {
                    insights += '🛡️ <strong>All Disciplines:</strong> Strong ACL prevention protocol. Continue single-leg stability and lateral movement work.<br><br>';
                } else {
                    insights += '🚨 <strong>All Disciplines:</strong> ACL prevention needs attention. Add single-leg exercises and lateral movements.<br><br>';
                }
            }
            
            return insights;
        }

        function generatePriorityRecommendations(user, recentWorkouts, sleep, stravaActivities) {
            let insights = '<div style="background: #1a1a1a; padding: 15px; border-radius: 8px; margin-top: 15px;">';
            insights += '<h5 style="color: #fbd38d; margin-top: 0;">🎯 Priority Recommendations</h5>';
            
            const recommendations = [];
            
            // Trainer recommendations
            const trainerRecs = generateTrainerRecommendations(user, recentWorkouts);
            recommendations.push(...trainerRecs);
            
            // Soccer S&C recommendations
            const soccerRecs = generateSoccerSCRecommendations(user, recentWorkouts, stravaActivities);
            recommendations.push(...soccerRecs);
            
            // Elite coach recommendations
            const eliteRecs = generateEliteCoachRecommendations(user, recentWorkouts, stravaActivities);
            recommendations.push(...eliteRecs);
            
            // Physical therapy recommendations
            const therapyRecs = generatePTRecommendations(user, recentWorkouts, sleep);
            recommendations.push(...therapyRecs);
            
            // Sort by priority and display top 3
            const priorityRecs = recommendations
                .sort((a, b) => b.priority - a.priority)
                .slice(0, 3);
            
            priorityRecs.forEach((rec, index) => {
                insights += `<div style="margin: 10px 0; padding: 10px; background: #2d3748; border-radius: 5px; border-left: 3px solid ${rec.color};">`;
                insights += `<strong>${rec.discipline}:</strong> ${rec.recommendation}<br>`;
                insights += `<small style="color: #a0aec0;">${rec.rationale}</small>`;
                insights += '</div>';
            });
            
            insights += '</div>';
            
            return insights;
        }

        function generatePerformanceOptimization(user, recentWorkouts, sleep, stravaActivities) {
            let insights = '<div style="background: #1a1a1a; padding: 15px; border-radius: 8px; margin-top: 15px;">';
            insights += '<h5 style="color: #68d391; margin-top: 0;">🚀 Performance Optimization</h5>';
            
            // Timing optimization (Elite Coach perspective)
            if (stravaActivities.length > 0 && recentWorkouts.length > 0) {
                const hasMorningCardio = stravaActivities.some(activity => {
                    const activityTime = new Date(activity.start_date).getHours();
                    return activityTime < 8;
                });
                
                if (hasMorningCardio) {
                    insights += '⏰ <strong>Elite Coach:</strong> Morning cardio detected. Schedule strength training 2+ hours later for optimal power output.<br><br>';
                }
            }
            
            // Recovery optimization (PT + Trainer perspective)
            if (sleep && sleep.sleepScore >= 85) {
                insights += '💤 <strong>PT + Trainer:</strong> Excellent recovery state. This is your window for high-intensity training.<br><br>';
            } else if (sleep && sleep.sleepScore < 65) {
                insights += '🩺 <strong>PT + Trainer:</strong> Recovery compromised. Focus on movement quality over intensity.<br><br>';
            }
            
            // Soccer-specific optimization (S&C + Elite Coach)
            const soccerSessions = recentWorkouts.filter(w => w.type.includes('Soccer'));
            if (soccerSessions.length >= 3) {
                insights += '⚽ <strong>S&C + Elite Coach:</strong> High soccer frequency. Prioritize recovery and injury prevention exercises.<br><br>';
            }
            
            insights += '</div>';
            
            return insights;
        }

        // INDIVIDUAL DISCIPLINE ANALYSIS FUNCTIONS
        function generatePersonalTrainerAnalysis(user, recentWorkouts, sleep) {
            let insights = '<div style="background: #2d3748; padding: 15px; border-radius: 8px; border-left: 4px solid #4299e1;">';
            insights += '<h5 style="color: #4299e1; margin-top: 0;">💪 Personal Trainer Analysis</h5>';
            
            // Strength progression analysis
            const strengthSessions = recentWorkouts.filter(w => w.type.includes('Upper') || w.type.includes('Lower'));
            const avgEnergy = recentWorkouts.map(w => w.energy).filter(e => e > 0);
            const avgEnergyValue = avgEnergy.length > 0 ? avgEnergy.reduce((sum, e) => sum + e, 0) / avgEnergy.length : 0;
            
            if (strengthSessions.length >= 3) {
                insights += '✅ <strong>Training Frequency:</strong> Excellent strength training consistency. Maintain this schedule for optimal results.<br><br>';
            } else if (strengthSessions.length < 2) {
                insights += '⚠️ <strong>Training Frequency:</strong> Low strength training volume. Consider increasing to 3-4 sessions per week.<br><br>';
            }
            
            if (avgEnergyValue >= 7) {
                insights += '🔥 <strong>Training Intensity:</strong> High energy levels indicate good recovery. Perfect time to push progressive overload.<br><br>';
            } else if (avgEnergyValue < 6) {
                insights += '😴 <strong>Training Intensity:</strong> Low energy suggests fatigue. Focus on form and consider lighter loads.<br><br>';
            }
            
            // Goal-specific training analysis
            if (user.goals?.primary === 'grow_muscle' || user.goals?.secondary?.includes('strength_gain')) {
                insights += '💪 <strong>Muscle Growth Focus:</strong> Ensure 3-4 strength sessions per week with progressive overload. Target 6-12 reps for hypertrophy.<br><br>';
            }
            
            if (user.goals?.primary === 'improve_speed' || user.goals?.secondary?.includes('speed_improvement')) {
                insights += '🏃 <strong>Speed Development:</strong> Add explosive movements: box jumps, sprints, and plyometrics to your routine.<br><br>';
            }
            
            insights += '</div>';
            return insights;
        }

        function generateSoccerSCAnalysis(user, recentWorkouts, stravaActivities) {
            let insights = '<div style="background: #2d3748; padding: 15px; border-radius: 8px; border-left: 4px solid #48bb78;">';
            insights += '<h5 style="color: #48bb78; margin-top: 0;">⚽ Soccer Strength & Conditioning Analysis</h5>';
            
            // Soccer-specific conditioning analysis
            const soccerSessions = recentWorkouts.filter(w => w.type.includes('Soccer'));
            const strengthSessions = recentWorkouts.filter(w => w.type.includes('Upper') || w.type.includes('Lower'));
            
            if (soccerSessions.length >= 2 && strengthSessions.length >= 2) {
                insights += '✅ <strong>Sport-Specific Balance:</strong> Good ratio of soccer to strength work. This supports match performance.<br><br>';
            } else if (soccerSessions.length >= 3 && strengthSessions.length < 2) {
                insights += '⚠️ <strong>Sport-Specific Balance:</strong> High soccer volume with low strength work. Risk of strength loss and injury.<br><br>';
            }
            
            // ACL prevention for soccer players
            if (user.goals?.primary === 'acl_prevention' || user.goals?.secondary?.includes('acl_support')) {
                const aclWork = recentWorkouts.filter(w => 
                    w.exercises?.some(e => 
                        e.name.toLowerCase().includes('single-leg') || 
                        e.name.toLowerCase().includes('lateral') ||
                        e.name.toLowerCase().includes('clamshell')
                    )
                ).length;
                
                if (aclWork >= 2) {
                    insights += '🛡️ <strong>ACL Prevention:</strong> Excellent ACL injury prevention protocol. Continue single-leg stability work.<br><br>';
                } else {
                    insights += '🚨 <strong>ACL Prevention:</strong> Critical for soccer players. Add single-leg squats, lateral lunges, and clamshells.<br><br>';
                }
            }
            
            // Soccer-specific conditioning recommendations
            insights += '⚽ <strong>Soccer Conditioning:</strong> Include agility ladder, cone drills, and change-of-direction work in your routine.<br><br>';
            
            // Recovery between matches
            if (soccerSessions.length >= 2) {
                insights += '🔄 <strong>Match Recovery:</strong> With multiple soccer sessions, prioritize recovery: sleep, hydration, and light mobility work.<br><br>';
            }
            
            insights += '</div>';
            return insights;
        }

        function generateEliteSoccerAnalysis(user, recentWorkouts, stravaActivities) {
            let insights = '<div style="background: #2d3748; padding: 15px; border-radius: 8px; border-left: 4px solid #ed8936;">';
            insights += '<h5 style="color: #ed8936; margin-top: 0;">🏆 Elite Soccer Coach Analysis</h5>';
            
            // Performance readiness analysis
            const avgEnergy = recentWorkouts.map(w => w.energy).filter(e => e > 0);
            const avgEnergyValue = avgEnergy.length > 0 ? avgEnergy.reduce((sum, e) => sum + e, 0) / avgEnergy.length : 0;
            
            if (avgEnergyValue >= 8) {
                insights += '🚀 <strong>Performance Readiness:</strong> Excellent energy levels. Ready for high-intensity training and competitive play.<br><br>';
            } else if (avgEnergyValue >= 6 && avgEnergyValue < 8) {
                insights += '⚡ <strong>Performance Readiness:</strong> Good energy levels. Maintain current training load with focus on quality.<br><br>';
            } else {
                insights += '😴 <strong>Performance Readiness:</strong> Low energy indicates fatigue. Reduce intensity and prioritize recovery.<br><br>';
            }
            
            // Tactical fitness analysis
            const soccerSessions = recentWorkouts.filter(w => w.type.includes('Soccer'));
            if (soccerSessions.length >= 2) {
                insights += '⚽ <strong>Match Fitness:</strong> Good soccer frequency. Focus on maintaining sharpness between matches.<br><br>';
            }
            
            // Mental performance optimization
            insights += '🧠 <strong>Mental Performance:</strong> Elite performance requires mental preparation. Include visualization and breathing exercises.<br><br>';
            
            // Competition preparation
            if (soccerSessions.length >= 1) {
                insights += '🏆 <strong>Competition Prep:</strong> Taper training 2-3 days before important matches. Focus on technique and recovery.<br><br>';
            }
            
            // Technical skill maintenance
            insights += '⚽ <strong>Technical Maintenance:</strong> Regular ball work maintains touch and decision-making. Include technical drills in training.<br><br>';
            
            insights += '</div>';
            return insights;
        }

        function generatePhysicalTherapyAnalysis(user, recentWorkouts, sleep) {
            let insights = '<div style="background: #2d3748; padding: 15px; border-radius: 8px; border-left: 4px solid #9f7aea;">';
            insights += '<h5 style="color: #9f7aea; margin-top: 0;">🩺 Physical Therapist Analysis</h5>';
            
            // Injury risk assessment
            const avgEnergy = recentWorkouts.map(w => w.energy).filter(e => e > 0);
            const avgEnergyValue = avgEnergy.length > 0 ? avgEnergy.reduce((sum, e) => sum + e, 0) / avgEnergy.length : 0;
            
            if (avgEnergyValue < 6) {
                insights += '🚨 <strong>Injury Risk:</strong> Low energy levels increase injury risk. Prioritize recovery and movement quality.<br><br>';
            } else {
                insights += '✅ <strong>Injury Risk:</strong> Energy levels support safe training. Continue current approach with proper form.<br><br>';
            }
            
            // Sleep and recovery analysis
            if (sleep) {
                if (sleep.sleepScore >= 80) {
                    insights += '💤 <strong>Recovery Status:</strong> Excellent sleep quality supports tissue repair and injury prevention.<br><br>';
                } else if (sleep.sleepScore < 60) {
                    insights += '⚠️ <strong>Recovery Status:</strong> Poor sleep increases injury risk and impairs recovery. Prioritize sleep hygiene.<br><br>';
                }
            }
            
            // ACL prevention protocol
            if (user.goals?.primary === 'acl_prevention' || user.goals?.secondary?.includes('acl_support')) {
                insights += '🛡️ <strong>ACL Prevention Protocol:</strong> Essential for soccer players. Focus on single-leg stability, hip strength, and landing mechanics.<br><br>';
            }
            
            // Movement quality assessment
            const heavySessions = recentWorkouts.filter(w => w.type.includes('Heavy'));
            if (heavySessions.length >= 2) {
                insights += '💪 <strong>Movement Quality:</strong> Heavy training requires perfect form. Prioritize technique over weight.<br><br>';
            }
            
            // Recovery strategies
            insights += '🔄 <strong>Recovery Strategies:</strong> Include foam rolling, stretching, and mobility work. Listen to your body for early warning signs.<br><br>';
            
            // Injury prevention exercises
            insights += '🏥 <strong>Injury Prevention:</strong> Include glute activation, core stability, and dynamic warm-ups in every session.<br><br>';
            
            insights += '</div>';
            return insights;
        }

        // RECOMMENDATION GENERATION FUNCTIONS
        function generateTrainerRecommendations(user, recentWorkouts) {
            const recommendations = [];
            
            const strengthSessions = recentWorkouts.filter(w => w.type.includes('Upper') || w.type.includes('Lower'));
            if (strengthSessions.length < 3) {
                recommendations.push({
                    discipline: 'Personal Trainer',
                    recommendation: 'Increase strength training to 3-4 sessions per week',
                    rationale: 'Optimal muscle growth and strength development requires consistent stimulus',
                    priority: 8,
                    color: '#4299e1'
                });
            }
            
            const avgEnergy = recentWorkouts.map(w => w.energy).filter(e => e > 0);
            const avgEnergyValue = avgEnergy.length > 0 ? avgEnergy.reduce((sum, e) => sum + e, 0) / avgEnergy.length : 0;
            
            if (avgEnergyValue >= 7) {
                recommendations.push({
                    discipline: 'Personal Trainer',
                    recommendation: 'Push progressive overload - increase weight or reps',
                    rationale: 'High energy levels indicate readiness for increased training load',
                    priority: 7,
                    color: '#4299e1'
                });
            }
            
            return recommendations;
        }

        function generateSoccerSCRecommendations(user, recentWorkouts, stravaActivities) {
            const recommendations = [];
            
            const soccerSessions = recentWorkouts.filter(w => w.type.includes('Soccer'));
            const strengthSessions = recentWorkouts.filter(w => w.type.includes('Upper') || w.type.includes('Lower'));
            
            if (soccerSessions.length >= 3 && strengthSessions.length < 2) {
                recommendations.push({
                    discipline: 'Soccer S&C Coach',
                    recommendation: 'Add 2 strength sessions to prevent strength loss',
                    rationale: 'High soccer volume without strength work leads to performance decline',
                    priority: 9,
                    color: '#48bb78'
                });
            }
            
            if (user.goals?.primary === 'acl_prevention') {
                recommendations.push({
                    discipline: 'Soccer S&C Coach',
                    recommendation: 'Prioritize ACL prevention exercises in every session',
                    rationale: 'Critical for soccer players - highest injury risk in sport',
                    priority: 10,
                    color: '#48bb78'
                });
            }
            
            return recommendations;
        }

        function generateEliteCoachRecommendations(user, recentWorkouts, stravaActivities) {
            const recommendations = [];
            
            const avgEnergy = recentWorkouts.map(w => w.energy).filter(e => e > 0);
            const avgEnergyValue = avgEnergy.length > 0 ? avgEnergy.reduce((sum, e) => sum + e, 0) / avgEnergy.length : 0;
            
            if (avgEnergyValue < 6) {
                recommendations.push({
                    discipline: 'Elite Soccer Coach',
                    recommendation: 'Reduce training intensity and focus on recovery',
                    rationale: 'Low energy compromises technical execution and decision-making',
                    priority: 9,
                    color: '#ed8936'
                });
            }
            
            const soccerSessions = recentWorkouts.filter(w => w.type.includes('Soccer'));
            if (soccerSessions.length >= 2) {
                recommendations.push({
                    discipline: 'Elite Soccer Coach',
                    recommendation: 'Maintain technical sharpness with ball work between matches',
                    rationale: 'Touch and decision-making require consistent practice',
                    priority: 6,
                    color: '#ed8936'
                });
            }
            
            return recommendations;
        }

        function generatePTRecommendations(user, recentWorkouts, sleep) {
            const recommendations = [];
            
            if (sleep && sleep.sleepScore < 65) {
                recommendations.push({
                    discipline: 'Physical Therapist',
                    recommendation: 'Prioritize sleep hygiene for injury prevention',
                    rationale: 'Poor sleep increases injury risk by 40-60%',
                    priority: 10,
                    color: '#9f7aea'
                });
            }
            
            if (user.goals?.primary === 'acl_prevention') {
                recommendations.push({
                    discipline: 'Physical Therapist',
                    recommendation: 'Include single-leg stability exercises daily',
                    rationale: 'ACL prevention requires consistent neuromuscular training',
                    priority: 9,
                    color: '#9f7aea'
                });
            }
            
            return recommendations;
        }

        function analyzeMissedWorkouts(user, recentWorkouts) {
            if (!user.workoutPlan) return '';
            
            let insights = '';
            const plan = user.workoutPlan;
            const today = new Date().toISOString().split('T')[0];
            const dayOfWeek = new Date().getDay();
            const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            const currentDay = dayNames[dayOfWeek];
            
            // Check for missed workouts in the last 7 days
            const lastWeek = recentWorkouts.filter(w => {
                const workoutDate = new Date(w.date);
                const daysDiff = (new Date() - workoutDate) / (1000 * 60 * 60 * 24);
                return daysDiff <= 7;
            });
            
            const plannedWorkouts = plan.weeks?.[0]?.days?.filter(d => d.session && !d.session.includes('Rest')) || [];
            const completedWorkouts = lastWeek.length;
            const missedWorkouts = Math.max(0, plannedWorkouts.length - completedWorkouts);
            
            if (missedWorkouts > 0) {
                insights += '🚨 <strong>Missed Workout Alert:</strong> ' + missedWorkouts + ' planned session(s) missed this week.<br>';
                
                // Adaptive recommendations
                if (missedWorkouts === 1) {
                    insights += '💡 <strong>Adaptation Strategy:</strong> Consider combining today\'s session with tomorrow\'s lighter work, or extend today\'s session by 15-20 minutes.<br><br>';
                } else if (missedWorkouts === 2) {
                    insights += '💡 <strong>Adaptation Strategy:</strong> Focus on your 2 most important sessions this week. Skip the others to maintain quality over quantity.<br><br>';
                } else if (missedWorkouts >= 3) {
                    insights += '💡 <strong>Adaptation Strategy:</strong> Reset and focus on consistency. Consider reducing to 2-3 sessions per week until you can maintain that schedule.<br><br>';
                }
            } else {
                insights += '✅ <strong>Consistency Check:</strong> Great job staying on track with your planned sessions!<br><br>';
            }
            
            return insights;
        }

        function analyzeTrainingTrends(recentWorkouts, user) {
            if (recentWorkouts.length < 7) return '';
            
            let insights = '';
            
            // Energy trend analysis
            const energyData = recentWorkouts.map(w => w.energy).filter(e => e > 0);
            if (energyData.length >= 5) {
                const avgEnergy = energyData.reduce((sum, e) => sum + e, 0) / energyData.length;
                const recentEnergy = energyData.slice(-3).reduce((sum, e) => sum + e, 0) / 3;
                
                if (recentEnergy < avgEnergy - 1) {
                    insights += '📉 <strong>Energy Trend:</strong> Recent workouts show declining energy levels. Consider an extra rest day or lighter training load.<br><br>';
                } else if (recentEnergy > avgEnergy + 1) {
                    insights += '📈 <strong>Energy Trend:</strong> Energy levels are improving! This is a great time to push intensity slightly.<br><br>';
                }
            }
            
            // Session type frequency analysis
            const sessionTypes = recentWorkouts.map(w => w.type);
            const upperBodyCount = sessionTypes.filter(t => t.includes('Upper')).length;
            const lowerBodyCount = sessionTypes.filter(t => t.includes('Lower')).length;
            const soccerCount = sessionTypes.filter(t => t.includes('Soccer')).length;
            
            if (upperBodyCount > lowerBodyCount + 2) {
                insights += '⚖️ <strong>Training Balance:</strong> More upper body than lower body work recently. Consider prioritizing lower body strength this week.<br><br>';
            } else if (lowerBodyCount > upperBodyCount + 2) {
                insights += '⚖️ <strong>Training Balance:</strong> More lower body than upper body work recently. Consider adding upper body focus this week.<br><br>';
            }
            
            // Soccer frequency vs gym work
            if (soccerCount >= 3 && (upperBodyCount + lowerBodyCount) < 2) {
                insights += '⚽ <strong>Soccer vs Gym Balance:</strong> High soccer frequency with low gym work. Consider adding 1-2 gym sessions for strength maintenance.<br><br>';
            }
            
            return insights;
        }

        function analyzeRecoveryPerformance(workouts, sleep, stravaActivities, recentWorkouts) {
            let insights = '';
            
            // Sleep + Workout correlation
            if (sleep && workouts.length > 0) {
                const avgEnergy = workouts.reduce((sum, w) => sum + w.energy, 0) / workouts.length;
                if (sleep.sleepScore >= 80 && avgEnergy >= 7) {
                    insights += '✅ <strong>Sleep-Performance Link:</strong> Excellent sleep quality correlates with high workout energy. Keep this routine!<br><br>';
                } else if (sleep.sleepScore < 60 && avgEnergy < 6) {
                    insights += '⚠️ <strong>Sleep-Performance Link:</strong> Poor sleep may be impacting performance. Consider sleep optimization strategies.<br><br>';
                }
            }
            
            // Recovery recommendations
            if (sleep && sleep.deepSleep < 1.5) {
                insights += '💤 <strong>Deep Sleep Alert:</strong> Low deep sleep detected. Try: cooler room (65-68°F), no screens 1hr before bed, consistent sleep schedule.<br><br>';
            }
            
            // Training load analysis
            if (stravaActivities.length > 0) {
                const totalMinutes = stravaActivities.reduce((sum, activity) => sum + activity.moving_time / 60, 0);
                if (totalMinutes > 120) {
                    insights += '⚡ <strong>High Training Load:</strong> Significant cardio volume today. Monitor recovery and consider lighter gym work tomorrow.<br><br>';
                }
            }
            
            // Climbing-specific insights
            const climbingSessions = workouts.filter(w => w.type === 'Indoor Climbing' || w.type === 'Outdoor Climbing');
            if (climbingSessions.length > 0) {
                const avgIntensity = climbingSessions.reduce((sum, w) => sum + (w.climbingIntensity || 0), 0) / climbingSessions.length;
                
                if (avgIntensity >= 7) {
                    insights += '🧗‍♂️ <strong>High-Intensity Climbing:</strong> Consider lighter pulling work tomorrow or focus on pushing movements.<br><br>';
                }
            }
            
            return insights;
        }

        function analyzeGoalProgress(user, recentWorkouts) {
            if (!user.goals) return '';
            
            let insights = '';
            const primaryGoal = user.goals.primary;
            const secondaryGoals = user.goals.secondary || [];
            
            // ACL Prevention Progress
            if (primaryGoal === 'acl_prevention' || secondaryGoals.includes('acl_support')) {
                const aclSessions = recentWorkouts.filter(w => 
                    w.type.includes('Lower Body') || w.exercises?.some(e => 
                        e.name.toLowerCase().includes('single-leg') || 
                        e.name.toLowerCase().includes('lateral') ||
                        e.name.toLowerCase().includes('clamshell')
                    )
                ).length;
                
                if (aclSessions >= 3) {
                    insights += '🛡️ <strong>ACL Prevention:</strong> Good consistency with ACL-focused exercises. Keep prioritizing single-leg stability work.<br><br>';
                } else {
                    insights += '🛡️ <strong>ACL Prevention:</strong> Consider adding more single-leg and lateral movement exercises to your routine.<br><br>';
                }
            }
            
            // Strength Progress
            if (primaryGoal === 'grow_muscle' || secondaryGoals.includes('strength_gain')) {
                const strengthSessions = recentWorkouts.filter(w => 
                    w.type.includes('Heavy') || w.type.includes('Upper Body') || w.type.includes('Lower Body')
                ).length;
                
                if (strengthSessions >= 3) {
                    insights += '💪 <strong>Strength Building:</strong> Good frequency for muscle growth. Focus on progressive overload and proper form.<br><br>';
                } else {
                    insights += '💪 <strong>Strength Building:</strong> Consider increasing strength training frequency to 3-4x per week for optimal muscle growth.<br><br>';
                }
            }
            
            return insights;
        }

        function analyzeInjuryRisk(user, recentWorkouts, sleep) {
            let insights = '';
            
            // Fatigue accumulation analysis
            const lastWeekEnergy = recentWorkouts.slice(-7).map(w => w.energy).filter(e => e > 0);
            if (lastWeekEnergy.length >= 5) {
                const avgEnergy = lastWeekEnergy.reduce((sum, e) => sum + e, 0) / lastWeekEnergy.length;
                
                if (avgEnergy < 6) {
                    insights += '⚠️ <strong>Fatigue Alert:</strong> Consistently low energy levels. Consider reducing training load or adding a rest day.<br><br>';
                }
            }
            
            // Sleep quality and injury risk
            if (sleep && sleep.sleepScore < 60) {
                insights += '🚨 <strong>Injury Risk:</strong> Poor sleep quality increases injury risk. Prioritize sleep for recovery and injury prevention.<br><br>';
            }
            
            // Training load spikes
            const weeklyVolumes = [];
            for (let i = 0; i < recentWorkouts.length - 6; i += 7) {
                const weekWorkouts = recentWorkouts.slice(i, i + 7);
                weeklyVolumes.push(weekWorkouts.length);
            }
            
            if (weeklyVolumes.length >= 2) {
                const recentVolume = weeklyVolumes[weeklyVolumes.length - 1];
                const previousVolume = weeklyVolumes[weeklyVolumes.length - 2];
                
                if (recentVolume > previousVolume + 2) {
                    insights += '📊 <strong>Volume Spike:</strong> Training volume increased significantly. Monitor for signs of overtraining.<br><br>';
                }
            }
            
            return insights;
        }

        function generateOptimizationRecommendations(user, recentWorkouts, sleep, stravaActivities) {
            let insights = '';
            
            // Timing optimization
            if (stravaActivities.length > 0 && recentWorkouts.length > 0) {
                const hasMorningCardio = stravaActivities.some(activity => {
                    const activityTime = new Date(activity.start_date).getHours();
                    return activityTime < 8;
                });
                
                if (hasMorningCardio) {
                    insights += '⏰ <strong>Timing Optimization:</strong> Morning cardio detected. Consider 2+ hour gap before strength training for optimal performance.<br><br>';
                }
            }
            
            // Goal-specific optimizations
            if (user.goals?.primary === 'improve_speed' || user.goals?.secondary?.includes('speed_improvement')) {
                const speedWork = recentWorkouts.filter(w => 
                    w.exercises?.some(e => 
                        e.name.toLowerCase().includes('sprint') || 
                        e.name.toLowerCase().includes('agility') ||
                        e.name.toLowerCase().includes('jump')
                    )
                ).length;
                
                if (speedWork < 2) {
                    insights += '🏃 <strong>Speed Training:</strong> Consider adding more sprint and agility work to your routine for speed development.<br><br>';
                }
            }
            
            // Recovery optimization
            if (sleep && sleep.sleepScore >= 80) {
                insights += '💡 <strong>Recovery Optimization:</strong> Excellent sleep quality! This is prime time to push training intensity.<br><br>';
            }
            
            return insights;
        }

        // AUTO-ADAPTATION FUNCTIONS
        function autoAdaptPlanForMissedWorkouts() {
            if (!currentUser || !isLoggedIn) return;
            
            const user = users[currentUser];
            if (!user.workoutPlan) return;
            
            const recentWorkouts = getWorkouts().slice(-7); // Last 7 days
            const plannedWorkouts = user.workoutPlan.weeks?.[0]?.days?.filter(d => d.session && !d.session.includes('Rest')) || [];
            const completedWorkouts = recentWorkouts.length;
            const missedWorkouts = Math.max(0, plannedWorkouts.length - completedWorkouts);
            
            if (missedWorkouts > 0) {
                const adaptation = generateMissedWorkoutAdaptation(user, missedWorkouts, recentWorkouts);
                if (adaptation) {
                    // Update the plan with adaptations
                    user.workoutPlan.adaptations = user.workoutPlan.adaptations || [];
                    user.workoutPlan.adaptations.push(adaptation);
                    localStorage.setItem('ignitefitness_users', JSON.stringify(users));
                    
                    // Show adaptation notification
                    showAdaptationNotification(adaptation);
                }
            }
        }

        function generateMissedWorkoutAdaptation(user, missedCount, recentWorkouts) {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            const currentDay = dayNames[dayOfWeek];
            
            const adaptation = {
                date: today.toISOString().split('T')[0],
                missedWorkouts: missedCount,
                recommendations: [],
                modifiedPlan: null
            };
            
            if (missedCount === 1) {
                // Single missed workout - suggest combination or extension
                adaptation.recommendations.push('Combine today\'s session with tomorrow\'s lighter work');
                adaptation.recommendations.push('Extend today\'s session by 15-20 minutes');
                adaptation.recommendations.push('Focus on your most important exercises');
            } else if (missedCount === 2) {
                // Two missed workouts - prioritize key sessions
                adaptation.recommendations.push('Focus on your 2 most important sessions this week');
                adaptation.recommendations.push('Skip less critical sessions to maintain quality');
                adaptation.recommendations.push('Consider reducing session length but maintaining frequency');
            } else if (missedCount >= 3) {
                // Multiple missed workouts - reset approach
                adaptation.recommendations.push('Reset and focus on consistency over intensity');
                adaptation.recommendations.push('Consider reducing to 2-3 sessions per week');
                adaptation.recommendations.push('Prioritize recovery and gradual rebuild');
                
                // Modify the plan to be more sustainable
                adaptation.modifiedPlan = createSustainablePlan(user);
            }
            
            return adaptation;
        }

        function createSustainablePlan(user) {
            // Create a more sustainable plan when user is struggling with consistency
            const sustainablePlan = {
                title: 'Sustainable Recovery Plan',
                description: 'Simplified plan focused on consistency and recovery',
                weeks: []
            };
            
            // Create a 2-week sustainable plan
            for (let week = 1; week <= 2; week++) {
                const weekPlan = {
                    week: week,
                    days: []
                };
                
                const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
                days.forEach((day, index) => {
                    const dayPlan = {
                        day: day,
                        dayNumber: index + 1,
                        session: null,
                        exercises: [],
                        notes: ''
                    };
                    
                    // Simple 3-day schedule: Tuesday, Thursday, Saturday
                    if (day === 'tuesday') {
                        dayPlan.session = 'Upper Body (Light)';
                        dayPlan.exercises = getGoalOrientedExercises('Upper Body (Light)', user.goals, user.personalData?.baselineStrength || {}, week);
                        dayPlan.notes = 'Focus on movement quality and consistency';
                    } else if (day === 'thursday') {
                        dayPlan.session = 'Lower Body (Light)';
                        dayPlan.exercises = getGoalOrientedExercises('Lower Body (Light)', user.goals, user.personalData?.baselineStrength || {}, week);
                        dayPlan.notes = 'Light activation work, focus on form';
                    } else if (day === 'saturday') {
                        dayPlan.session = 'Recovery & Mobility';
                        dayPlan.exercises = [];
                        dayPlan.notes = 'Active recovery and mobility work';
                    } else {
                        dayPlan.session = 'Rest Day';
                        dayPlan.notes = 'Complete rest or light activity';
                    }
                    
                    weekPlan.days.push(dayPlan);
                });
                
                sustainablePlan.weeks.push(weekPlan);
            }
            
            return sustainablePlan;
        }

        function showAdaptationNotification(adaptation) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #2d3748;
                border: 2px solid #fbd38d;
                border-radius: 10px;
                padding: 20px;
                max-width: 400px;
                z-index: 1000;
                color: white;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            `;
            
            let html = '<h4 style="color: #fbd38d; margin-top: 0;">🔄 Training Plan Adaptation</h4>';
            html += `<p><strong>Missed Workouts:</strong> ${adaptation.missedWorkouts}</p>`;
            html += '<h5>Recommendations:</h5><ul>';
            adaptation.recommendations.forEach(rec => {
                html += `<li>${rec}</li>`;
            });
            html += '</ul>';
            
            if (adaptation.modifiedPlan) {
                html += '<button class="btn" onclick="applySustainablePlan()" style="margin-top: 10px;">Apply Sustainable Plan</button>';
            }
            
            html += '<button class="btn" onclick="this.parentElement.remove()" style="margin-top: 10px; margin-left: 10px; background: #718096;">Dismiss</button>';
            
            notification.innerHTML = html;
            document.body.appendChild(notification);
            
            // Auto-remove after 30 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 30000);
        }

        function applySustainablePlan() {
            if (!currentUser || !isLoggedIn) return;
            
            const user = users[currentUser];
            const adaptation = user.workoutPlan?.adaptations?.[user.workoutPlan.adaptations.length - 1];
            
            if (adaptation?.modifiedPlan) {
                user.workoutPlan = adaptation.modifiedPlan;
                localStorage.setItem('ignitefitness_users', JSON.stringify(users));
                
                // Refresh the plan display
                displayDetailedWorkoutPlan(user.workoutPlan);
                
                // Remove notification
                const notification = document.querySelector('[style*="position: fixed"]');
                if (notification) notification.remove();
                
                alert('Sustainable plan applied! Focus on consistency and recovery.');
            }
        }

        function loadData() {
            // Load existing data from localStorage
            const savedSoccerSessions = localStorage.getItem('soccerSessions');
            if (savedSoccerSessions) {
                soccerSessions = JSON.parse(savedSoccerSessions);
            }
            
            const savedRecoveryData = localStorage.getItem('recoveryData');
            if (savedRecoveryData) {
                recoveryData = JSON.parse(savedRecoveryData);
            }
            
            const savedStravaData = localStorage.getItem('stravaData');
            if (savedStravaData) {
                stravaData = JSON.parse(savedStravaData);
            }
            
            const savedSleepData = localStorage.getItem('sleepData');
            if (savedSleepData) {
                sleepData = JSON.parse(savedSleepData);
            }
            
            // Check Strava token status (with delay to ensure config is loaded)
            setTimeout(checkStravaTokenStatus, 100);
            
            updateCurrentSessionDisplay();
        }

        function checkStravaTokenStatus() {
            const statusElement = document.getElementById('tokenStatus');
            
            if (!statusElement) {
                console.log('Status element not found, retrying...');
                setTimeout(checkStravaTokenStatus, 100);
                return;
            }
            
            console.log('Checking Strava tokens...', typeof STRAVA_TOKENS);
            
            if (typeof STRAVA_TOKENS === 'undefined') {
                statusElement.innerHTML = '❌ Config file not loaded';
                statusElement.style.color = '#fc8181';
                console.log('STRAVA_TOKENS is undefined');
                return;
            }

            const accessToken = STRAVA_TOKENS.accessToken;
            console.log('Access token:', accessToken ? 'Found' : 'Not found');
            
            if (!accessToken || accessToken === 'your_access_token_here') {
                statusElement.innerHTML = '⚠️ Please update tokens in config.js';
                statusElement.style.color = '#fbd38d';
            } else {
                statusElement.innerHTML = '✅ Tokens configured';
                statusElement.style.color = '#68d391';
            }
        }
    </script>
</body>
</html>

