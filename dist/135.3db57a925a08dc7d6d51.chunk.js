(self.webpackChunkignite_fitness=self.webpackChunkignite_fitness||[]).push([[135],{135:function(e){class t{constructor(){this.logger=window.SafeLogger||console,this.cache=new Map,this.pendingWrites=new Map,this.syncQueue=[],this.isOnline=navigator.onLine,this.conflictResolution="timestamp",this.cacheExpiry=3e5,this.maxCacheSize=1e3,window.addEventListener("online",()=>this.handleOnline()),window.addEventListener("offline",()=>this.handleOffline()),setInterval(()=>this.processSyncQueue(),3e4)}async get(e,t={}){const{useCache:s=!0,forceRefresh:a=!1}=t;if(s&&!a){const t=this.cache.get(e);if(t&&Date.now()-t.timestamp<this.cacheExpiry)return t.data}try{const t=await this.fetchFromSource(e);return this.cache.set(e,{data:t,timestamp:Date.now()}),t}catch(t){this.logger.error("Error fetching data",{key:e,error:t.message,stack:t.stack});const s=this.cache.get(e);if(s)return s.data;throw t}}async set(e,t,s={}){const{priority:a="local",conflictResolution:i=this.conflictResolution}=s,n=this.cache.get(e);if(n&&this.hasConflict(n.data,t)){t=this.resolveConflict(n.data,t,i)}this.cache.set(e,{data:t,timestamp:Date.now(),priority:a}),this.isOnline?this.syncQueue.push({key:e,data:t,timestamp:Date.now()}):this.pendingWrites.set(e,{data:t,timestamp:Date.now()}),this.saveToLocalStorage(e,t)}async fetchFromSource(e){const t=this.loadFromLocalStorage(e);if(t)return t;if(this.isOnline)try{return await this.fetchFromAPI(e)}catch(s){return this.logger.warn("API fetch failed, using local data",{key:e,error:s.message}),t}return t}loadFromLocalStorage(e){try{const t=localStorage.getItem(`ignitefitness_${e}`);return t?JSON.parse(t):null}catch(t){return this.logger.error("Error loading from localStorage",{key:e,error:t.message,stack:t.stack}),null}}saveToLocalStorage(e,t){try{localStorage.setItem(`ignitefitness_${e}`,JSON.stringify(t))}catch(t){this.logger.error("Error saving to localStorage",{key:e,error:t.message,stack:t.stack})}}async fetchFromAPI(e){const t={user_data:"/.netlify/functions/get-user-data",sessions:"/.netlify/functions/sessions-list",all_users:"/.netlify/functions/admin-get-all-users"}[e];if(!t)throw new Error(`No API endpoint for key: ${e}`);const s=await fetch(t,{method:"GET",headers:{"Content-Type":"application/json"}});if(!s.ok)throw new Error(`API request failed: ${s.status}`);return await s.json()}hasConflict(e,t){if(e.timestamp&&t.timestamp){return Math.abs(e.timestamp-t.timestamp)>1e3}return!1}resolveConflict(e,t,s){switch(s){case"local":return e;case"remote":return t;case"merge":return this.mergeData(e,t);default:return e.timestamp>t.timestamp?e:t}}mergeData(e,t){const s={...e};for(const a in t)void 0!==t[a]&&("object"!=typeof t[a]||Array.isArray(t[a])?s[a]=t[a]:s[a]=this.mergeData(e[a]||{},t[a]));return s}async processSyncQueue(){if(!this.isOnline||0===this.syncQueue.length)return;const e=this.syncQueue.splice(0,10);for(const t of e)try{await this.syncToAPI(t.key,t.data)}catch(e){this.logger.error("Sync failed",{key:t.key,error:e.message,stack:e.stack}),this.syncQueue.push(t)}}async syncToAPI(e,t){const s={user_data:"/.netlify/functions/save-user-data",sessions:"/.netlify/functions/sessions-create",preferences:"/.netlify/functions/save-user-data",goals:"/.netlify/functions/save-user-data",workout_schedule:"/.netlify/functions/save-user-data",strava_activities:"/.netlify/functions/save-user-data"}[e];if(!s)throw new Error(`No sync endpoint for key: ${e}`);let a;a="user_data"===e?{userId:this.currentUser,dataType:"all",data:t}:["preferences","goals","workout_schedule","strava_activities"].includes(e)?{userId:this.currentUser,dataType:e,data:t}:t;try{const t=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!t.ok){const e=await t.text();let s=`Sync failed: ${t.status}`;try{s+=` - ${JSON.parse(e).error||e}`}catch{s+=` - ${e}`}throw new Error(s)}const i=await t.json();return this.logger.info("Successfully synced to database",{key:e,result:i}),this.lastSyncTime=Date.now(),localStorage.setItem("ignitefitness_last_sync",this.lastSyncTime.toString()),i}catch(t){if(this.logger.error("Sync error",{key:e,error:t.message,stack:t.stack}),"TypeError"===t.name||t.message.includes("fetch"))throw new Error(`Network error: ${t.message}`);throw t}}handleOnline(){this.isOnline=!0,this.updateSyncStatus();for(const[e,t]of this.pendingWrites)this.syncQueue.push({key:e,data:t.data,timestamp:t.timestamp});this.pendingWrites.clear()}handleOffline(){this.isOnline=!1,this.updateSyncStatus()}updateSyncStatus(){const e=document.getElementById("sync-status");e&&(e.textContent=this.isOnline?"ðŸŸ¢ Online":"ðŸ”´ Offline",e.style.color=this.isOnline?"#68d391":"#fc8181")}clearCache(){this.cache.clear()}getCacheStats(){return{size:this.cache.size,maxSize:this.maxCacheSize,pendingWrites:this.pendingWrites.size,syncQueue:this.syncQueue.length,isOnline:this.isOnline}}}e.exports?e.exports={DataStore:t}:window.DataStore=t}}]);
//# sourceMappingURL=135.3db57a925a08dc7d6d51.chunk.js.map