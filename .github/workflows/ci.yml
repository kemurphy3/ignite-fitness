name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  NODE_VERSION: "18"
  CACHE_VERSION: v1

jobs:
  quality:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: |
          npm ci --prefer-offline --no-audit
          echo "âœ… Dependencies installed"

      - name: Check code formatting
        run: |
          echo "ğŸ¨ Checking code formatting..."
          npm run format:check || {
            echo "âŒ Code formatting issues found. Run 'npm run format' to fix.";
            exit 1;
          }

      - name: Run ESLint
        run: |
          echo "ğŸ” Running ESLint..."
          npm run lint:check || {
            echo "âŒ ESLint errors found. Run 'npm run lint:fix' to fix auto-fixable issues.";
            exit 1;
          }

      - name: Run TypeScript checks
        run: |
          echo "ğŸ“ Running TypeScript check..."
          npm run typecheck || {
            echo "âŒ TypeScript errors found. Check your type definitions.";
            exit 1;
          }

      - name: Validate imports
        run: |
          echo "ğŸ“¦ Validating import statements..."
          npm run test:imports || {
            echo "âŒ Import validation failed. Check for circular dependencies or missing imports.";
            exit 1;
          }

      - name: Check syntax
        run: |
          echo "ğŸ”¤ Checking JavaScript syntax..."
          npm run test:syntax || {
            echo "âŒ Syntax errors found. Fix syntax issues before proceeding.";
            exit 1;
          }

      - name: Check DOM safety (warning only)
        run: |
          echo "ğŸ›¡ï¸ Checking DOM safety..."
          npm run test:dom || {
            echo "âš ï¸ DOM safety check failed. Review for potential XSS vulnerabilities.";
            exit 0;
          }

  test:
    name: Tests
    runs-on: ubuntu-latest
    needs: quality

    strategy:
      matrix:
        test-type: [unit, integration]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Configure test environment
        run: |
          cp env.example .env.test
          echo "TEST_MODE=true" >> .env.test
          echo "NODE_ENV=test" >> .env.test
          echo "JWT_SECRET=test-jwt-secret-32-chars-minimum-length" >> .env.test

      - name: Run ${{ matrix.test-type }} tests
        run: |
          if [ "${{ matrix.test-type }}" = "unit" ]; then
            echo "ğŸ§ª Running unit tests...";
            npm run test:unit;
          else
            echo "ğŸ”— Running integration tests...";
            npm run test:integration;
          fi

      - name: Upload coverage to Codecov
        if: matrix.test-type == 'unit'
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  performance:
    name: Performance & Security
    runs-on: ubuntu-latest
    needs: quality

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Build application
        run: |
          echo "ğŸ—ï¸ Building application..."
          npm run build

      - name: Run performance tests (warning only)
        run: |
          echo "âš¡ Running performance tests..."
          npm run test:perf || {
            echo "âš ï¸ Performance tests failed. Review bundle size and load times.";
            exit 0;
          }

      - name: Security audit (warning only)
        run: |
          echo "ğŸ”’ Running security audit..."
          npm audit --audit-level=high || {
            echo "âš ï¸ Security vulnerabilities found. Review and update dependencies.";
            exit 0;
          }

      - name: Check for secrets
        run: |
          echo "ğŸ•µï¸ Checking for exposed secrets..."
          if grep -R "SUPABASE_SERVICE_ROLE_KEY\|JWT_SECRET" --exclude-dir=node_modules --include="*.js" --include="*.ts" .; then
            echo "âŒ Potential secrets found in source. Remove before committing.";
            exit 1;
          fi
          echo "âœ… No secrets detected in source code"

  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [quality, test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Setup E2E environment
        run: |
          cp env.example .env.test
          echo "DEMO_MODE=true" >> .env.test
          npm run demo:seed

      - name: Run E2E tests (optional)
        run: |
          echo "ğŸ­ Running E2E tests..."
          npm run test:e2e || {
            echo "âš ï¸ E2E tests not configured yet.";
            exit 0;
          }

      - name: Upload Playwright report on failure
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

  beta-validation:
    name: Beta Validation
    runs-on: ubuntu-latest
    needs: [quality, test]
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Run beta validation
        run: |
          echo "ğŸ§ª Running beta validation..."
          npm run beta:validate || {
            echo "âŒ Beta validation failed. Review docs/beta_checklist.md";
            exit 1;
          }

      - name: Comment PR with beta status
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const file = 'beta-results.json';
            let betaResults = { passed: false, message: 'Beta validation not run' };
            if (fs.existsSync(file)) {
              betaResults = JSON.parse(fs.readFileSync(file, 'utf8'));
            }
            const body = `## ğŸ§ª Beta Validation Results\n\n${betaResults.passed ? 'âœ…' : 'âŒ'} **Beta Ready**: ${betaResults.passed ? 'Yes' : 'No'}\n\n${betaResults.message}\n\nğŸ“– Full checklist: [docs/beta_checklist.md](./docs/beta_checklist.md)`;
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });

  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: [quality, test, performance]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit

      - name: Build for production
        run: |
          echo "ğŸ—ï¸ Building for production..."
          NODE_ENV=production npm run build

      - name: Deploy to Netlify
        uses: nwtgck/actions-netlify@v3.0
        with:
          publish-dir: "./dist"
          production-branch: main
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: "Deploy from GitHub Actions"
          enable-pull-request-comment: false
          enable-commit-comment: true
          overwrites-pull-request-comment: true
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

      - name: Deployment notification
        if: success()
        run: |
          echo "ğŸš€ Deployment successful!"
          echo "Production URL: https://your-app.netlify.app"
