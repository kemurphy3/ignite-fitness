<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IgniteFitness - Multi-User Tracker</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#1a1a1a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="IgniteFitness">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="msapplication-TileColor" content="#1a1a1a">
    <meta name="msapplication-tap-highlight" content="no">
    
    <!-- Accessibility Meta Tags -->
    <meta name="color-scheme" content="dark light">
    <meta name="prefers-color-scheme" content="dark">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- iOS Icons -->
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="apple-touch-icon" sizes="192x192" href="icon-192.png">
    <link rel="apple-touch-icon" sizes="512x512" href="icon-512.png">
    
    <!-- Android Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #1a1a1a;
            color: #ffffff;
            line-height: 1.6;
            padding: 10px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #2d3748, #4a5568);
            border-radius: 10px;
        }

        .header h1 {
            color: #68d391;
            font-size: 24px;
            margin-bottom: 5px;
        }

        .tab-container {
            display: flex;
            margin-bottom: 20px;
            background-color: #2d3748;
            border-radius: 10px;
            overflow: hidden;
            flex-wrap: wrap;
        }
        
        /* Mobile layout - force stacking for all mobile devices */
        @media (max-width: 768px) {
            .tab-container {
                display: grid !important;
                grid-template-columns: 1fr 1fr 1fr 1fr !important;
                gap: 6px !important;
                padding: 8px !important;
                flex-wrap: nowrap !important;
            }
            
            /* Row 1: Log Workout, Soccer, Analysis, Recovery */
            .tab:nth-child(-n+4) {
                width: 100% !important;
                flex: none !important;
            }
            
            /* Row 2: History, Summary, Export (centered) */
            .tab:nth-child(5) {
                grid-column: 2 / 3 !important;
                width: 100% !important;
                flex: none !important;
            }
            
            .tab:nth-child(6) {
                grid-column: 3 / 4 !important;
                width: 100% !important;
                flex: none !important;
            }
            
            .tab:nth-child(7) {
                grid-column: 4 / 5 !important;
                width: 100% !important;
                flex: none !important;
            }
        }
        
        /* Tablet layout */
        @media (min-width: 481px) and (max-width: 768px) {
            .tab-container {
                flex-wrap: wrap;
                gap: 4px;
                padding: 6px;
            }
            
            .tab:nth-child(-n+4) {
                flex: 1;
                min-width: calc(50% - 2px);
            }
            
            .tab:nth-child(n+5) {
                flex: 1;
                min-width: calc(33.333% - 3px);
            }
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background-color: #2d3748;
            color: #a0aec0;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        @media (max-width: 768px) {
            .tab {
                padding: 10px 6px !important;
                font-size: 12px !important;
                border-radius: 6px !important;
                line-height: 1.1 !important;
                font-weight: 600 !important;
                min-height: 44px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
            }
        }
        
        @media (min-width: 481px) and (max-width: 768px) {
            .tab {
                padding: 10px 8px;
                font-size: 14px;
                border-radius: 6px;
                line-height: 1.2;
            }
        }

        .tab.active {
            background-color: #68d391;
            color: #1a1a1a;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-section {
            background-color: #2d3748;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #e2e8f0;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #4a5568;
            border-radius: 8px;
            background-color: #1a1a1a;
            color: #ffffff;
            font-size: 16px;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #68d391;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .slider {
            flex: 1;
            height: 8px;
            border-radius: 5px;
            background: #4a5568;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #68d391;
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #68d391;
            cursor: pointer;
            border: none;
        }

        .slider-value {
            min-width: 30px;
            text-align: center;
            font-weight: bold;
            color: #68d391;
        }

        .btn {
            background-color: #68d391;
            color: #1a1a1a;
            border: none;
            padding: 15px 25px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin: 10px 0;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background-color: #9ae6b4;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: #4a5568;
            color: #ffffff;
        }

        .btn-secondary:hover {
            background-color: #718096;
        }

        .exercise-card {
            background-color: #2d3748;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #68d391;
        }

        .exercise-card.pr {
            border-left-color: #68d391;
        }

        .exercise-card.match {
            border-left-color: #fbd38d;
        }

        .exercise-card.miss {
            border-left-color: #fc8181;
        }

        .exercise-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .exercise-name {
            font-weight: 600;
            font-size: 18px;
            color: #e2e8f0;
        }

        .exercise-date {
            color: #a0aec0;
            font-size: 14px;
        }

        .exercise-details {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        .exercise-detail {
            text-align: center;
        }

        .exercise-detail-label {
            font-size: 12px;
            color: #a0aec0;
            margin-bottom: 2px;
        }

        .exercise-detail-value {
            font-weight: 600;
            color: #e2e8f0;
        }

        .exercise-notes {
            color: #a0aec0;
            font-style: italic;
            font-size: 14px;
        }

        .session-card {
            background-color: #2d3748;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .session-type {
            background-color: #68d391;
            color: #1a1a1a;
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: 600;
            font-size: 14px;
        }

        .session-date {
            color: #a0aec0;
            font-size: 14px;
        }

        .session-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
        }

        .session-stat {
            text-align: center;
        }

        .session-stat-label {
            font-size: 12px;
            color: #a0aec0;
            margin-bottom: 2px;
        }

        .session-stat-value {
            font-weight: 600;
            color: #e2e8f0;
        }

        .workout-toggle {
            background: none;
            border: none;
            color: #68d391;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }

        .workout-exercises {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #4a5568;
        }

        .summary-card {
            background-color: #2d3748;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .summary-title {
            font-size: 20px;
            font-weight: 600;
            color: #68d391;
            margin-bottom: 15px;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .summary-stat {
            text-align: center;
            padding: 10px;
            background-color: #1a1a1a;
            border-radius: 8px;
        }

        .summary-stat-label {
            font-size: 12px;
            color: #a0aec0;
            margin-bottom: 5px;
        }

        .summary-stat-value {
            font-size: 18px;
            font-weight: 600;
            color: #e2e8f0;
        }

        .progression-list {
            list-style: none;
        }

        .progression-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: #1a1a1a;
            border-radius: 5px;
            margin-bottom: 5px;
        }

        .progression-exercise {
            font-weight: 500;
        }

        .progression-value {
            color: #68d391;
            font-weight: 600;
        }

        .export-section {
            background-color: #2d3748;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .export-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .hidden {
            display: none;
        }

        .other-exercise-input {
            margin-top: 10px;
        }

        .planned-workout {
            background-color: #1a1a1a;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border: 2px solid #4a5568;
        }

        .planned-exercise {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #2d3748;
            border-radius: 5px;
            border-left: 4px solid #68d391;
        }

        .planned-exercise-info {
            flex: 1;
        }

        .planned-exercise-name {
            font-weight: 600;
            color: #e2e8f0;
            margin-bottom: 2px;
        }

        .planned-exercise-target {
            font-size: 14px;
            color: #a0aec0;
        }

        .planned-exercise-input {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .planned-exercise-input input {
            width: 60px;
            padding: 5px;
            border: 1px solid #4a5568;
            border-radius: 4px;
            background-color: #1a1a1a;
            color: #ffffff;
            text-align: center;
        }

        .planned-exercise-input input::placeholder {
            color: #a0aec0;
        }

        .planned-exercise-input textarea {
            width: 120px;
            padding: 5px;
            border: 1px solid #4a5568;
            border-radius: 4px;
            background-color: #1a1a1a;
            color: #ffffff;
            font-size: 12px;
            resize: none;
        }

        .planned-exercise-input textarea::placeholder {
            color: #a0aec0;
        }

        .set-entry-example {
            font-size: 11px;
            color: #a0aec0;
            margin-top: 2px;
        }

        .add-exercise-section {
            background-color: #2d3748;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border: 2px dashed #4a5568;
        }

        .quick-add-form {
            display: grid;
            grid-template-columns: 1fr 80px 80px auto;
            gap: 10px;
            align-items: end;
        }

        @media (max-width: 480px) {
            .quick-add-form {
                grid-template-columns: 1fr;
            }
            
            .planned-exercise {
                flex-direction: column;
                align-items: stretch;
            }
            
            .planned-exercise-input {
                justify-content: space-between;
                margin-top: 10px;
            }
        }

        @media (max-width: 480px) {
            .exercise-details {
                grid-template-columns: 1fr 1fr;
            }
            
            .summary-stats {
                grid-template-columns: 1fr;
            }
            
            .export-buttons {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>IgniteFitness</h1>
            <p>Multi-User Performance Tracking</p>
        </div>

        <!-- Login Form -->
        <div id="loginForm" class="form-section" style="background: #2d3748; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
            <h3>Login to IgniteFitness</h3>
            <div class="form-group">
                <label for="loginUsername">Username</label>
                <input type="text" id="loginUsername" class="form-input" placeholder="Enter username">
            </div>
            <div class="form-group">
                <label for="loginPassword">Password</label>
                <input type="password" id="loginPassword" class="form-input" placeholder="Enter password">
            </div>
            <button class="btn" onclick="login()">Login</button>
            <button class="btn" onclick="showRegisterForm()" style="background: #718096; margin-left: 10px;">Register New Athlete</button>
            <div id="loginError" style="color: #fc8181; margin-top: 10px; display: none;"></div>
        </div>

        <!-- Register Form (hidden by default) -->
        <div id="registerForm" class="form-section hidden" style="background: #2d3748; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
            <h3>Register New Athlete</h3>
            <div class="form-group">
                <label for="regUsername">Username</label>
                <input type="text" id="regUsername" class="form-input" placeholder="Choose username">
            </div>
            <div class="form-group">
                <label for="regPassword">Password</label>
                <input type="password" id="regPassword" class="form-input" placeholder="Choose password">
            </div>
            <div class="form-group">
                <label for="regConfirmPassword">Confirm Password</label>
                <input type="password" id="regConfirmPassword" class="form-input" placeholder="Confirm password">
            </div>
            <div class="form-group">
                <label for="regAthleteName">Athlete Name</label>
                <input type="text" id="regAthleteName" class="form-input" placeholder="Full name">
            </div>
            <button class="btn" onclick="register()">Register Athlete</button>
            <button class="btn" onclick="hideRegisterForm()" style="background: #718096; margin-left: 10px;">Cancel</button>
            <div id="registerError" style="color: #fc8181; margin-top: 10px; display: none;"></div>
        </div>

        <!-- User Dashboard (hidden until logged in) -->
        <div id="userDashboard" class="hidden">
            <div class="form-section" style="background: #2d3748; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                <h3>Welcome, <span id="currentAthleteName"></span></h3>
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button class="btn" onclick="showPersonalDataForm()">Edit Profile</button>
                    <button class="btn" onclick="showWearableSetup()">Setup Wearables</button>
                    <button class="btn" onclick="logout()" style="background: #fc8181;">Logout</button>
                </div>
            </div>
        </div>

        <!-- Add User Form (hidden by default) -->
        <div id="addUserForm" class="form-section hidden" style="background: #2d3748; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
            <h3>Add New User</h3>
            <div class="form-group">
                <label for="newUserName">Name</label>
                <input type="text" id="newUserName" class="form-input" placeholder="Enter user name">
            </div>
            <button class="btn" onclick="addNewUser()">Create User</button>
            <button class="btn" onclick="hideAddUserForm()" style="background: #718096; margin-left: 10px;">Cancel</button>
        </div>

        <div class="tab-container">
            <button class="tab active" onclick="switchTab('log')">Log Workout</button>
            <button class="tab" onclick="switchTab('soccer')">Soccer</button>
            <button class="tab" onclick="switchTab('analysis')">Analysis</button>
            <button class="tab" onclick="switchTab('recovery')">Recovery</button>
            <button class="tab" onclick="switchTab('history')">History</button>
            <button class="tab" onclick="switchTab('summary')">Summary</button>
            <button class="tab" onclick="switchTab('export')">Export</button>
            <button class="tab" onclick="switchTab('personal')">Personal Data</button>
        </div>

        <!-- Log Workout Tab -->
        <div id="log" class="tab-content active">
            <div class="form-section">
                <h3>Session Details</h3>
                <div class="form-group">
                    <label for="sessionDate">Date</label>
                    <input type="date" id="sessionDate" class="form-input">
                </div>
                <div class="form-group">
                    <label for="sessionStartTime">Start Time</label>
                    <input type="time" id="sessionStartTime" class="form-input">
                </div>
                <div class="form-group">
                    <label for="sessionType">Session Type</label>
                    <select id="sessionType" class="form-select" onchange="loadDailyPlan()">
                        <option value="">Select Session Type</option>
                        <option value="Upper A">Upper A</option>
                        <option value="Upper B">Upper B</option>
                        <option value="Lower A">Lower A</option>
                        <option value="Lower B">Lower B</option>
                        <option value="Soccer">Soccer</option>
                        <option value="Indoor Climbing">Indoor Climbing</option>
                        <option value="Outdoor Climbing">Outdoor Climbing</option>
                        <option value="Recovery">Recovery</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="sessionEnergy">Overall Energy (1-10)</label>
                    <div class="slider-container">
                        <input type="range" id="sessionEnergy" class="slider" min="1" max="10" value="7">
                        <span class="slider-value" id="sessionEnergyValue">7</span>
                    </div>
                </div>
                
                <!-- Climbing Fields (hidden by default) -->
                <div class="form-group" id="climbingIntensityGroup" style="display: none;">
                    <label for="climbingIntensity">Climbing Intensity (1-10)</label>
                    <div class="slider-container">
                        <input type="range" id="climbingIntensity" class="slider" min="1" max="10" value="5">
                        <span class="slider-value" id="climbingIntensityValue">5</span>
                    </div>
                    <small style="color: #a0aec0; font-size: 12px;">
                        1-3: Easy climbing, 4-6: Moderate, 7-8: Hard, 9-10: Maximum effort<br>
                        <strong style="color: #68d391;">üßó‚Äç‚ôÇÔ∏è Note: Climbing is primarily pull movements + core work</strong>
                    </small>
                </div>
                
                <div class="form-group" id="climbingRoutesGroup" style="display: none;">
                    <label for="climbingRoutes">Number of Routes</label>
                    <input type="number" id="climbingRoutes" class="form-input" min="1" max="50" placeholder="e.g., 12">
                    <small style="color: #a0aec0; font-size: 12px;">
                        Total routes climbed (including warm-up and cool-down)
                    </small>
                </div>
                
                <div class="form-group" id="climbingDurationGroup" style="display: none;">
                    <label for="climbingDuration">Session Duration (minutes)</label>
                    <input type="number" id="climbingDuration" class="form-input" min="30" max="480" placeholder="e.g., 120">
                    <small style="color: #a0aec0; font-size: 12px;">
                        Total time including belaying, waiting, and social breaks
                    </small>
                </div>
                
                <div class="form-group">
                    <label for="sessionNotes">Session Notes</label>
                    <textarea id="sessionNotes" class="form-input" rows="3" placeholder="How did the session feel overall? Any modifications needed?"></textarea>
                </div>
            </div>

            <div class="form-section">
                <h3>Today's Planned Workout</h3>
                <div id="plannedWorkout" class="planned-workout">
                    <p style="color: #a0aec0; text-align: center; padding: 20px;">Select a session type to load today's plan</p>
                </div>
                <button class="btn btn-secondary" onclick="clearPlan()">Clear Plan</button>
            </div>

            <div class="add-exercise-section">
                <h3>Quick Add Extra Exercise</h3>
                <p style="color: #a0aec0; font-size: 14px; margin-bottom: 15px;">Add any extra exercises or modifications to your plan</p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; align-items: start;">
                    <div>
                        <select id="extraExerciseName" class="form-select">
                            <option value="Bench Press">Bench Press</option>
                            <option value="Squat">Squat</option>
                            <option value="Deadlift">Deadlift</option>
                            <option value="RDL">RDL</option>
                            <option value="Pull-ups">Pull-ups</option>
                            <option value="Shoulder Press">Shoulder Press</option>
                            <option value="Rows">Rows</option>
                            <option value="Lat Pulldown">Lat Pulldown</option>
                            <option value="Incline DB Press">Incline DB Press</option>
                            <option value="Lateral Raises">Lateral Raises</option>
                            <option value="Face Pulls">Face Pulls</option>
                            <option value="Nordic Curls">Nordic Curls</option>
                            <option value="Single Leg RDLs">Single Leg RDLs</option>
                            <option value="Bulgarian Split Squats">Bulgarian Split Squats</option>
                            <option value="Goblet Squat">Goblet Squat</option>
                            <option value="Lateral Lunges">Lateral Lunges</option>
                            <option value="Box Jumps">Box Jumps</option>
                            <option value="Single Leg Box Jump">Single Leg Box Jump</option>
                            <option value="Walking Lunges">Walking Lunges</option>
                            <option value="Copenhagen Planks">Copenhagen Planks</option>
                            <option value="Other">Other</option>
                        </select>
                        <div id="otherExtraExerciseGroup" class="form-group hidden" style="margin-top: 10px;">
                            <input type="text" id="otherExtraExerciseName" class="form-input" placeholder="Enter exercise name">
                        </div>
                    </div>
                    <div>
                        <textarea id="extraSetsReps" class="form-input" placeholder="Sets & Weights&#10;Example: 40x12, 45x10, 50x6&#10;or: 3x5 @ 40" rows="3" style="resize: none;"></textarea>
                        <button class="btn" onclick="addExtraExercise()" style="margin-top: 10px; width: 100%;">Add Exercise</button>
                    </div>
                </div>
                <div class="set-entry-example" style="margin-top: 10px;">
                    <strong>Flexible formats:</strong> "40x12, 45x10, 50x6" | "3x5 @ 40" | "12, 10, 6" | "40x12 45x10 50x6"
                </div>
            </div>

            <div id="currentSession" class="form-section">
                <h3>Current Session</h3>
                <div id="currentExercises"></div>
                <button class="btn" onclick="saveSession()" style="margin-top: 15px;">‚úÖ Complete Workout</button>
                <div id="sessionSavedMessage" style="display: none; background: #68d391; color: #1a1a1a; padding: 10px; border-radius: 8px; margin-top: 10px; text-align: center; font-weight: 600;">
                    üéâ Workout completed and saved!
                </div>
            </div>
        </div>

        <!-- History Tab -->
        <div id="history" class="tab-content">
            <div id="workoutHistory"></div>
        </div>

        <!-- Summary Tab -->
        <div id="summary" class="tab-content">
            <div class="summary-card">
                <div class="summary-title">This Week's Summary</div>
                <div class="summary-stats">
                    <div class="summary-stat">
                        <div class="summary-stat-label">Sessions</div>
                        <div class="summary-stat-value" id="weeklySessions">0</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-label">Avg Energy</div>
                        <div class="summary-stat-value" id="weeklyEnergy">0/10</div>
                    </div>
                </div>
                <h4>Main Lift Progressions</h4>
                <ul class="progression-list" id="progressionList"></ul>
                
                <h4>4-Week Progression Targets</h4>
                <div id="progressionTargets"></div>
                
                <h4>Recovery Metrics</h4>
                <div class="summary-stats">
                    <div class="summary-stat">
                        <div class="summary-stat-label">Avg Sleep</div>
                        <div class="summary-stat-value" id="avgSleep">0h</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-label">Yoga Days</div>
                        <div class="summary-stat-value" id="yogaDays">0/7</div>
                    </div>
                </div>
                
                <h4>Soccer Performance</h4>
                <div class="summary-stats">
                    <div class="summary-stat">
                        <div class="summary-stat-label">Avg Performance</div>
                        <div class="summary-stat-value" id="avgSoccerPerformance">0/10</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-label">ACL Warmups</div>
                        <div class="summary-stat-value" id="aclWarmupCompliance">0/0</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Soccer Tab -->
        <div id="soccer" class="tab-content">
            <div class="form-section">
                <h3>Soccer Performance Tracking</h3>
                <div class="form-group">
                    <label for="soccerDate">Date</label>
                    <input type="date" id="soccerDate" class="form-input">
                </div>
                <div class="form-group">
                    <label for="soccerType">Session Type</label>
                    <select id="soccerType" class="form-select">
                        <option value="Indoor Soccer">Indoor Soccer</option>
                        <option value="Soccer Practice">Soccer Practice</option>
                        <option value="Outdoor Match">Outdoor Match</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="soccerEnergy">Pre-Game Energy (1-10)</label>
                    <div class="slider-container">
                        <input type="range" id="soccerEnergy" class="slider" min="1" max="10" value="7">
                        <span class="slider-value" id="soccerEnergyValue">7</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="soccerPerformance">Performance Rating (1-10)</label>
                    <div class="slider-container">
                        <input type="range" id="soccerPerformance" class="slider" min="1" max="10" value="7">
                        <span class="slider-value" id="soccerPerformanceValue">7</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="soccerSharpness">Sharpness (1-10)</label>
                    <div class="slider-container">
                        <input type="range" id="soccerSharpness" class="slider" min="1" max="10" value="7">
                        <span class="slider-value" id="soccerSharpnessValue">7</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="preGameFuel">Pre-Game Fuel</label>
                    <input type="text" id="preGameFuel" class="form-input" placeholder="e.g., Apples/grapes + goldfish">
                </div>
                <div class="form-group">
                    <label for="aclWarmupCompleted">ACL Warmup Completed</label>
                    <select id="aclWarmupCompleted" class="form-select">
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="soccerNotes">Notable Observations</label>
                    <textarea id="soccerNotes" class="form-input" rows="3" placeholder="How did soccer feel? Any improvements or struggles?"></textarea>
                </div>
                <button class="btn" onclick="saveSoccerSession()">Save Soccer Session</button>
            </div>
            
            <div id="soccerHistory" class="form-section">
                <h3>Recent Soccer Sessions</h3>
                <div id="soccerSessionsList"></div>
            </div>
        </div>

        <!-- Analysis Tab -->
        <div id="analysis" class="tab-content">
            <div class="form-section">
                <h3>Daily Analysis Dashboard</h3>
                <div class="form-group">
                    <label for="analysisDate">Analysis Date</label>
                    <input type="date" id="analysisDate" class="form-input">
                </div>
                
                <h4>Strava Integration</h4>
                <div style="background: #2d3748; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <p style="color: #a0aec0; margin-bottom: 10px;">
                        <strong>Setup:</strong> Strava integration is configured server-side. No client-side setup required.
                    </p>
                    <div style="font-size: 12px; color: #a0aec0;">
                        <strong>Current Status:</strong> <span id="tokenStatus">Loading...</span>
                    </div>
                </div>
                <button class="btn" onclick="fetchStravaData()">üîÑ Sync Strava Data</button>
                <div id="stravaStatus" style="margin-top: 10px; color: #a0aec0;"></div>
            </div>

            <div id="dailyAnalysis" class="form-section">
                <h4>Today's Training Analysis</h4>
                <div id="analysisResults"></div>
            </div>

            <div class="form-section">
                <h3>Garmin Sleep Data</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="form-group">
                        <label for="sleepDate">Sleep Date</label>
                        <input type="date" id="sleepDate" class="form-input">
                    </div>
                    <div class="form-group">
                        <label for="totalSleep">Total Sleep (hours)</label>
                        <input type="number" id="totalSleep" class="form-input" step="0.1" placeholder="7.5">
                    </div>
                    <div class="form-group">
                        <label for="deepSleep">Deep Sleep (hours)</label>
                        <input type="number" id="deepSleep" class="form-input" step="0.1" placeholder="1.8">
                    </div>
                    <div class="form-group">
                        <label for="remSleep">REM Sleep (hours)</label>
                        <input type="number" id="remSleep" class="form-input" step="0.1" placeholder="1.5">
                    </div>
                    <div class="form-group">
                        <label for="lightSleep">Light Sleep (hours)</label>
                        <input type="number" id="lightSleep" class="form-input" step="0.1" placeholder="4.2">
                    </div>
                    <div class="form-group">
                        <label for="sleepScore">Sleep Score (1-100)</label>
                        <input type="number" id="sleepScore" class="form-input" min="1" max="100" placeholder="85">
                    </div>
                </div>
                <button class="btn" onclick="saveSleepData()">Save Sleep Data</button>
            </div>

            <div id="sleepHistory" class="form-section">
                <h3>Recent Sleep Data</h3>
                <div id="sleepDataList"></div>
            </div>
        </div>

        <!-- Recovery Tab -->
        <div id="recovery" class="tab-content">
            <div class="form-section">
                <h3>Daily Recovery Tracking</h3>
                <div class="form-group">
                    <label for="recoveryDate">Date</label>
                    <input type="date" id="recoveryDate" class="form-input">
                </div>
                <div class="form-group">
                    <label for="sleepHours">Sleep Hours</label>
                    <input type="number" id="sleepHours" class="form-input" min="0" max="12" step="0.5" placeholder="8.0">
                </div>
                <div class="form-group">
                    <label for="sorenessLevel">Soreness Level (1-10)</label>
                    <div class="slider-container">
                        <input type="range" id="sorenessLevel" class="slider" min="1" max="10" value="3">
                        <span class="slider-value" id="sorenessLevelValue">3</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="achillesTightness">Achilles Tightness (1-10)</label>
                    <div class="slider-container">
                        <input type="range" id="achillesTightness" class="slider" min="1" max="10" value="3">
                        <span class="slider-value" id="achillesTightnessValue">3</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="hipTightness">Hip Tightness (1-10)</label>
                    <div class="slider-container">
                        <input type="range" id="hipTightness" class="slider" min="1" max="10" value="3">
                        <span class="slider-value" id="hipTightnessValue">3</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="overallEnergy">Overall Energy (1-10)</label>
                    <div class="slider-container">
                        <input type="range" id="overallEnergy" class="slider" min="1" max="10" value="7">
                        <span class="slider-value" id="overallEnergyValue">7</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="moodLevel">Mood (1-10)</label>
                    <div class="slider-container">
                        <input type="range" id="moodLevel" class="slider" min="1" max="10" value="7">
                        <span class="slider-value" id="moodLevelValue">7</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="yogaCompleted">Yoga Completed</label>
                    <select id="yogaCompleted" class="form-select">
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="mobilityWorkCompleted">Mobility Work Completed</label>
                    <select id="mobilityWorkCompleted" class="form-select">
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="dailyCalories">Daily Calories</label>
                    <input type="number" id="dailyCalories" class="form-input" placeholder="2200">
                </div>
                <div class="form-group">
                    <label for="proteinTargetHit">Protein Target Hit (130-140g)</label>
                    <select id="proteinTargetHit" class="form-select">
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="hydrationStatus">Hydration Status</label>
                    <select id="hydrationStatus" class="form-select">
                        <option value="Good">Good (4L+)</option>
                        <option value="Fair">Fair (3L)</option>
                        <option value="Poor">Poor (<3L)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="recoveryNotes">Recovery Notes</label>
                    <textarea id="recoveryNotes" class="form-input" rows="3" placeholder="Any observations about recovery, energy, or body signals"></textarea>
                </div>
                <button class="btn" onclick="saveRecoveryData()">Save Recovery Data</button>
            </div>
            
            <div id="recoveryHistory" class="form-section">
                <h3>Recent Recovery Data</h3>
                <div id="recoveryDataList"></div>
            </div>
        </div>

        <!-- Personal Data Tab -->
        <div id="personal" class="tab-content">
            <div class="form-section">
                <h3>Personal Information</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="userAge">Age</label>
                        <input type="number" id="userAge" class="form-input" min="13" max="100" placeholder="25">
                    </div>
                    <div class="form-group">
                        <label for="userWeight">Weight (lbs)</label>
                        <input type="number" id="userWeight" class="form-input" min="80" max="300" placeholder="140">
                    </div>
                    <div class="form-group">
                        <label for="userHeight">Height (inches)</label>
                        <input type="number" id="userHeight" class="form-input" min="48" max="84" placeholder="65">
                    </div>
                    <div class="form-group">
                        <label for="userSex">Sex</label>
                        <select id="userSex" class="form-select">
                            <option value="">Select...</option>
                            <option value="female">Female</option>
                            <option value="male">Male</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>
                <button class="btn" onclick="savePersonalInfo()">Save Personal Info</button>
            </div>

            <div class="form-section">
                <h3>Baseline Strength</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="baselineBench">Bench Press (lbs)</label>
                        <input type="number" id="baselineBench" class="form-input" min="0" placeholder="65">
                    </div>
                    <div class="form-group">
                        <label for="baselineSquat">Squat (lbs)</label>
                        <input type="number" id="baselineSquat" class="form-input" min="0" placeholder="95">
                    </div>
                    <div class="form-group">
                        <label for="baselineDeadlift">Deadlift (lbs)</label>
                        <input type="number" id="baselineDeadlift" class="form-input" min="0" placeholder="115">
                    </div>
                    <div class="form-group">
                        <label for="baselinePullups">Pull-ups (reps)</label>
                        <input type="number" id="baselinePullups" class="form-input" min="0" placeholder="3">
                    </div>
                </div>
                <button class="btn" onclick="saveBaselineStrength()">Save Baseline Strength</button>
            </div>

            <div class="form-section">
                <h3>Goals & Priorities</h3>
                <div class="form-group">
                    <label>Primary Goal</label>
                    <select id="primaryGoal" class="form-select">
                        <option value="">Select primary goal...</option>
                        <option value="lose_weight">Lose Weight</option>
                        <option value="gain_weight">Gain Weight</option>
                        <option value="maintain_weight">Maintain Weight</option>
                        <option value="drop_fat">Drop Body Fat</option>
                        <option value="grow_muscle">Grow Muscle</option>
                        <option value="improve_speed">Improve Speed</option>
                        <option value="improve_endurance">Improve Endurance</option>
                        <option value="improve_agility">Improve Agility</option>
                        <option value="acl_prevention">ACL Prevention</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Secondary Goals (select all that apply)</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                        <label><input type="checkbox" value="soccer_performance"> Soccer Performance</label>
                        <label><input type="checkbox" value="injury_prevention"> Injury Prevention</label>
                        <label><input type="checkbox" value="strength_gain"> Strength Gain</label>
                        <label><input type="checkbox" value="speed_improvement"> Speed Improvement</label>
                        <label><input type="checkbox" value="endurance_building"> Endurance Building</label>
                        <label><input type="checkbox" value="agility_training"> Agility Training</label>
                        <label><input type="checkbox" value="acl_support"> ACL Support</label>
                        <label><input type="checkbox" value="core_stability"> Core Stability</label>
                    </div>
                </div>
                
                <button class="btn" onclick="saveGoals()">Save Goals</button>
            </div>

            <div class="form-section">
                <h3>Wearable Device Integration</h3>
                <p style="color: #a0aec0; margin-bottom: 15px;">Connect your wearable devices to automatically pull performance data and enhance AI insights.</p>
                
                <div class="form-group">
                    <label>Primary Device</label>
                    <select id="primaryDevice" class="form-select" onchange="toggleDeviceFields()">
                        <option value="">Select device...</option>
                        <option value="strava">Strava</option>
                        <option value="whoop">Whoop</option>
                        <option value="apple_watch">Apple Watch</option>
                        <option value="garmin">Garmin</option>
                        <option value="none">None</option>
                    </select>
                </div>

                <!-- Strava Fields -->
                <div id="stravaFields" class="device-fields" style="display: none;">
                    <h4>Strava Integration</h4>
                    <p style="color: #a0aec0; font-size: 14px; margin-bottom: 15px;">
                        Get your Strava API tokens from: <a href="https://www.strava.com/settings/api" target="_blank" style="color: #68d391;">strava.com/settings/api</a>
                    </p>
                    <div class="form-group">
                        <label for="stravaClientId">Client ID</label>
                        <input type="text" id="stravaClientId" class="form-input" placeholder="Your Strava Client ID">
                    </div>
                    <div class="form-group">
                        <label for="stravaClientSecret">Client Secret</label>
                        <input type="password" id="stravaClientSecret" class="form-input" placeholder="Your Strava Client Secret">
                    </div>
                    <div class="form-group">
                        <label for="stravaAccessToken">Access Token</label>
                        <input type="password" id="stravaAccessToken" class="form-input" placeholder="Your Strava Access Token">
                    </div>
                    <div class="form-group">
                        <label for="stravaRefreshToken">Refresh Token</label>
                        <input type="password" id="stravaRefreshToken" class="form-input" placeholder="Your Strava Refresh Token">
                    </div>
                    <button class="btn" onclick="testStravaConnection()">Test Connection</button>
                    <div id="stravaTestResult" style="margin-top: 10px;"></div>
                </div>

                <!-- Whoop Fields -->
                <div id="whoopFields" class="device-fields" style="display: none;">
                    <h4>Whoop Integration</h4>
                    <p style="color: #a0aec0; font-size: 14px; margin-bottom: 15px;">
                        Get your Whoop API token from your Whoop account settings.
                    </p>
                    <div class="form-group">
                        <label for="whoopToken">Whoop API Token</label>
                        <input type="password" id="whoopToken" class="form-input" placeholder="Your Whoop API Token">
                    </div>
                    <button class="btn" onclick="testWhoopConnection()">Test Connection</button>
                    <div id="whoopTestResult" style="margin-top: 10px;"></div>
                </div>

                <!-- Apple Watch Fields -->
                <div id="appleWatchFields" class="device-fields" style="display: none;">
                    <h4>Apple Watch Integration</h4>
                    <p style="color: #a0aec0; font-size: 14px; margin-bottom: 15px;">
                        Apple HealthKit integration requires iOS device with Health app access.
                    </p>
                    <div class="form-group">
                        <label for="appleHealthKit">HealthKit Access</label>
                        <select id="appleHealthKit" class="form-select">
                            <option value="enabled">Enabled</option>
                            <option value="disabled">Disabled</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="appleHealthTypes">Data Types to Sync</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                            <label><input type="checkbox" value="heart_rate" checked> Heart Rate</label>
                            <label><input type="checkbox" value="steps" checked> Steps</label>
                            <label><input type="checkbox" value="active_energy" checked> Active Energy</label>
                            <label><input type="checkbox" value="sleep" checked> Sleep Data</label>
                            <label><input type="checkbox" value="workouts" checked> Workouts</label>
                            <label><input type="checkbox" value="vo2_max" checked> VO2 Max</label>
                        </div>
                    </div>
                    <button class="btn" onclick="testAppleHealthConnection()">Test Connection</button>
                    <div id="appleTestResult" style="margin-top: 10px;"></div>
                </div>

                <!-- Garmin Fields -->
                <div id="garminFields" class="device-fields" style="display: none;">
                    <h4>Garmin Integration</h4>
                    <p style="color: #a0aec0; font-size: 14px; margin-bottom: 15px;">
                        Connect your Garmin Connect account for comprehensive activity tracking.
                    </p>
                    <div class="form-group">
                        <label for="garminUsername">Garmin Connect Username</label>
                        <input type="text" id="garminUsername" class="form-input" placeholder="Your Garmin Connect username">
                    </div>
                    <div class="form-group">
                        <label for="garminPassword">Garmin Connect Password</label>
                        <input type="password" id="garminPassword" class="form-input" placeholder="Your Garmin Connect password">
                    </div>
                    <button class="btn" onclick="testGarminConnection()">Test Connection</button>
                    <div id="garminTestResult" style="margin-top: 10px;"></div>
                </div>

                <div style="margin-top: 20px; padding: 15px; background: #1a1a1a; border-radius: 8px;">
                    <h4 style="color: #68d391; margin-bottom: 10px;">Data Sync Schedule</h4>
                    <div class="form-group">
                        <label for="syncFrequency">Sync Frequency</label>
                        <select id="syncFrequency" class="form-select">
                            <option value="manual">Manual Only</option>
                            <option value="daily">Daily</option>
                            <option value="twice_daily">Twice Daily</option>
                            <option value="hourly">Hourly</option>
                        </select>
                    </div>
                    <p style="color: #a0aec0; font-size: 12px; margin-top: 10px;">
                        Automatic sync helps maintain up-to-date data for better AI insights and trend analysis.
                    </p>
                </div>

                <button class="btn" onclick="saveDeviceSettings()" style="margin-top: 20px;">Save Device Settings</button>
            </div>

            <div class="form-section">
                <h3>Generated Workout Plan</h3>
                <div id="workoutPlanDisplay" style="background: #1a1a1a; padding: 15px; border-radius: 8px; margin-top: 10px;">
                    <p style="color: #a0aec0;">Complete your goals assessment to generate a personalized 4-week workout plan.</p>
                </div>
                <button class="btn" onclick="generateWorkoutPlan()" style="margin-top: 15px;">Generate/Update Plan</button>
            </div>
        </div>

        <!-- Export Tab -->
        <div id="export" class="tab-content">
            <div class="export-section">
                <h3>Export Data</h3>
                <div class="export-buttons">
                    <button class="btn" onclick="copyFormattedData()">Copy Formatted Text</button>
                    <button class="btn btn-secondary" onclick="downloadCSV()">Download CSV</button>
                </div>
                <div class="form-group">
                    <label for="exportText">Formatted Data Preview</label>
                    <textarea id="exportText" class="form-input" rows="10" readonly></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- Load configuration -->
    <script src="config.js"></script>
    <script>
        // Register Service Worker for PWA functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then((registration) => {
                        console.log('SW registered: ', registration);
                    })
                    .catch((registrationError) => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
    </script>
    <script>
        let currentSession = {
            date: '',
            type: '',
            energy: 7,
            notes: '',
            exercises: []
        };

        // Multi-user system variables
        let currentUser = null;
        let users = {};
        let isLoggedIn = false;

        // Authentication Functions
        function login() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');

            if (!username || !password) {
                showError(errorDiv, 'Please enter both username and password');
                return;
            }

            // Load users from localStorage
            const savedUsers = localStorage.getItem('ignitefitness_users');
            if (savedUsers) {
                users = JSON.parse(savedUsers);
            }

            // Simple password check (in production, use proper hashing)
            if (users[username] && users[username].password === password) {
                currentUser = username;
                isLoggedIn = true;
                localStorage.setItem('ignitefitness_last_user', username);
                showUserDashboard();
                hideLoginForm();
                loadUserData();
            } else {
                showError(errorDiv, 'Invalid username or password');
            }
        }

        function register() {
            const username = document.getElementById('regUsername').value;
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('regConfirmPassword').value;
            const athleteName = document.getElementById('regAthleteName').value;
            const errorDiv = document.getElementById('registerError');

            if (!username || !password || !athleteName) {
                showError(errorDiv, 'Please fill in all fields');
                return;
            }

            if (password !== confirmPassword) {
                showError(errorDiv, 'Passwords do not match');
                return;
            }

            // Load existing users
            const savedUsers = localStorage.getItem('ignitefitness_users');
            if (savedUsers) {
                users = JSON.parse(savedUsers);
            }

            if (users[username]) {
                showError(errorDiv, 'Username already exists');
                return;
            }

            // Create new user
            users[username] = {
                password: password,
                athleteName: athleteName,
                personalData: {},
                goals: {},
                wearableSettings: {},
                workoutPlan: null,
                data: {
                    workouts: [],
                    soccerSessions: [],
                    recoveryData: [],
                    stravaData: [],
                    sleepData: []
                }
            };

            // Save users
            localStorage.setItem('ignitefitness_users', JSON.stringify(users));
            
            // Auto-login
            currentUser = username;
            isLoggedIn = true;
            localStorage.setItem('ignitefitness_last_user', username);
            showUserDashboard();
            hideRegisterForm();
            hideLoginForm();
            loadUserData();
        }

        function logout() {
            currentUser = null;
            isLoggedIn = false;
            localStorage.removeItem('ignitefitness_last_user');
            hideUserDashboard();
            showLoginForm();
            clearUserData();
        }

        function showLoginForm() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
        }

        function showRegisterForm() {
            document.getElementById('registerForm').classList.remove('hidden');
            document.getElementById('loginForm').classList.add('hidden');
        }

        function hideLoginForm() {
            document.getElementById('loginForm').classList.add('hidden');
        }

        function hideRegisterForm() {
            document.getElementById('registerForm').classList.add('hidden');
        }

        function hideUserDashboard() {
            document.getElementById('userDashboard').classList.add('hidden');
            document.querySelector('.tab-container').classList.add('hidden');
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
        }

        function showUserDashboard() {
            document.getElementById('userDashboard').classList.remove('hidden');
            document.querySelector('.tab-container').classList.remove('hidden');
            document.getElementById('currentAthleteName').textContent = users[currentUser].athleteName;
        }

        function showError(errorDiv, message) {
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // User Data Management Functions
        function loadUserData() {
            if (!currentUser || !isLoggedIn) return;

            const user = users[currentUser];
            if (!user) return;

            // Load user's data into global variables
            soccerSessions = user.data.soccerSessions || [];
            recoveryData = user.data.recoveryData || [];
            stravaData = user.data.stravaData || [];
            sleepData = user.data.sleepData || [];

            // Load personal data into form fields
            if (user.personalData) {
                document.getElementById('userAge').value = user.personalData.age || '';
                document.getElementById('userWeight').value = user.personalData.weight || '';
                document.getElementById('userHeight').value = user.personalData.height || '';
                document.getElementById('userSex').value = user.personalData.sex || '';
            }

            // Load baseline strength
            if (user.personalData && user.personalData.baselineStrength) {
                document.getElementById('baselineBench').value = user.personalData.baselineStrength.bench || '';
                document.getElementById('baselineSquat').value = user.personalData.baselineStrength.squat || '';
                document.getElementById('baselineDeadlift').value = user.personalData.baselineStrength.deadlift || '';
                document.getElementById('baselinePullups').value = user.personalData.baselineStrength.pullups || '';
            }

            // Load goals
            if (user.goals) {
                document.getElementById('primaryGoal').value = user.goals.primary || '';
                // Load secondary goals checkboxes
                if (user.goals.secondary) {
                    user.goals.secondary.forEach(goal => {
                        const checkbox = document.querySelector(`input[value="${goal}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                }
            }

            // Load wearable settings
            if (user.wearableSettings) {
                document.getElementById('primaryDevice').value = user.wearableSettings.primaryDevice || '';
                toggleDeviceFields();
                
                if (user.wearableSettings.strava) {
                    document.getElementById('stravaClientId').value = user.wearableSettings.strava.clientId || '';
                    document.getElementById('stravaClientSecret').value = user.wearableSettings.strava.clientSecret || '';
                    document.getElementById('stravaAccessToken').value = user.wearableSettings.strava.accessToken || '';
                    document.getElementById('stravaRefreshToken').value = user.wearableSettings.strava.refreshToken || '';
                }
                
                if (user.wearableSettings.whoop) {
                    document.getElementById('whoopToken').value = user.wearableSettings.whoop.token || '';
                }
                
                if (user.wearableSettings.garmin) {
                    document.getElementById('garminUsername').value = user.wearableSettings.garmin.username || '';
                    document.getElementById('garminPassword').value = user.wearableSettings.garmin.password || '';
                }
                
                document.getElementById('syncFrequency').value = user.wearableSettings.syncFrequency || 'daily';
            }

            // Load workout plan
            if (user.workoutPlan) {
                displayWorkoutPlan(user.workoutPlan);
            }

            // Update displays
            updateHistory();
            updateSummary();
            updateAnalysis();
        }

        function saveUserData() {
            if (!currentUser || !isLoggedIn) return;

            const user = users[currentUser];
            if (!user) return;

            // Save current data to user
            user.data.soccerSessions = soccerSessions;
            user.data.recoveryData = recoveryData;
            user.data.stravaData = stravaData;
            user.data.sleepData = sleepData;

            // Save to localStorage
            localStorage.setItem('ignitefitness_users', JSON.stringify(users));
        }

        function clearUserData() {
            soccerSessions = [];
            recoveryData = [];
            stravaData = [];
            sleepData = [];
        }

        // Helper functions for Personal Data tab
        function showPersonalDataForm() {
            switchTab('personal');
        }

        function showWearableSetup() {
            switchTab('personal');
            // Scroll to wearable section
            setTimeout(() => {
                const wearableSection = document.querySelector('#personal .form-section:nth-child(4)');
                if (wearableSection) {
                    wearableSection.scrollIntoView({ behavior: 'smooth' });
                }
            }, 100);
        }

        // Personal Data Functions
        function savePersonalInfo() {
            if (!currentUser || !isLoggedIn) return;

            const user = users[currentUser];
            if (!user.personalData) user.personalData = {};

            user.personalData.age = document.getElementById('userAge').value;
            user.personalData.weight = document.getElementById('userWeight').value;
            user.personalData.height = document.getElementById('userHeight').value;
            user.personalData.sex = document.getElementById('userSex').value;

            localStorage.setItem('ignitefitness_users', JSON.stringify(users));
            alert('Personal information saved!');
        }

        function saveBaselineStrength() {
            if (!currentUser || !isLoggedIn) return;

            const user = users[currentUser];
            if (!user.personalData) user.personalData = {};
            if (!user.personalData.baselineStrength) user.personalData.baselineStrength = {};

            user.personalData.baselineStrength.bench = document.getElementById('baselineBench').value;
            user.personalData.baselineStrength.squat = document.getElementById('baselineSquat').value;
            user.personalData.baselineStrength.deadlift = document.getElementById('baselineDeadlift').value;
            user.personalData.baselineStrength.pullups = document.getElementById('baselinePullups').value;

            localStorage.setItem('ignitefitness_users', JSON.stringify(users));
            alert('Baseline strength saved!');
        }

        function saveGoals() {
            if (!currentUser || !isLoggedIn) return;

            const user = users[currentUser];
            if (!user.goals) user.goals = {};

            user.goals.primary = document.getElementById('primaryGoal').value;
            
            // Get secondary goals
            const secondaryGoals = [];
            document.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
                if (checkbox.value !== '') {
                    secondaryGoals.push(checkbox.value);
                }
            });
            user.goals.secondary = secondaryGoals;

            localStorage.setItem('ignitefitness_users', JSON.stringify(users));
            alert('Goals saved!');
        }

        // Wearable Integration Functions
        function toggleDeviceFields() {
            const device = document.getElementById('primaryDevice').value;
            
            // Hide all device fields
            document.querySelectorAll('.device-fields').forEach(field => {
                field.style.display = 'none';
            });

            // Show selected device fields
            if (device === 'strava') {
                document.getElementById('stravaFields').style.display = 'block';
            } else if (device === 'whoop') {
                document.getElementById('whoopFields').style.display = 'block';
            } else if (device === 'apple_watch') {
                document.getElementById('appleWatchFields').style.display = 'block';
            } else if (device === 'garmin') {
                document.getElementById('garminFields').style.display = 'block';
            }
        }

        function saveDeviceSettings() {
            if (!currentUser || !isLoggedIn) return;

            const user = users[currentUser];
            if (!user.wearableSettings) user.wearableSettings = {};

            const primaryDevice = document.getElementById('primaryDevice').value;
            user.wearableSettings.primaryDevice = primaryDevice;
            user.wearableSettings.syncFrequency = document.getElementById('syncFrequency').value;

            if (primaryDevice === 'strava') {
                user.wearableSettings.strava = {
                    clientId: document.getElementById('stravaClientId').value,
                    clientSecret: document.getElementById('stravaClientSecret').value,
                    accessToken: document.getElementById('stravaAccessToken').value,
                    refreshToken: document.getElementById('stravaRefreshToken').value
                };
            } else if (primaryDevice === 'whoop') {
                user.wearableSettings.whoop = {
                    token: document.getElementById('whoopToken').value
                };
            } else if (primaryDevice === 'garmin') {
                user.wearableSettings.garmin = {
                    username: document.getElementById('garminUsername').value,
                    password: document.getElementById('garminPassword').value
                };
            }

            localStorage.setItem('ignitefitness_users', JSON.stringify(users));
            alert('Device settings saved!');
        }

        async function testStravaConnection() {
            const resultDiv = document.getElementById('stravaTestResult');
            resultDiv.innerHTML = 'üîÑ Testing Strava connection...';

            try {
                const accessToken = document.getElementById('stravaAccessToken').value;
                if (!accessToken) {
                    throw new Error('Please enter your Strava access token');
                }

                const response = await fetch('https://www.strava.com/api/v3/athlete', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                if (response.ok) {
                    const athlete = await response.json();
                    resultDiv.innerHTML = `‚úÖ Connected successfully! Welcome ${athlete.firstname} ${athlete.lastname}`;
                    resultDiv.style.color = '#68d391';
                } else {
                    throw new Error('Failed to connect to Strava');
                }
            } catch (error) {
                resultDiv.innerHTML = `‚ùå Connection failed: ${error.message}`;
                resultDiv.style.color = '#fc8181';
            }
        }

        async function testWhoopConnection() {
            const resultDiv = document.getElementById('whoopTestResult');
            resultDiv.innerHTML = 'üîÑ Testing Whoop connection...';

            try {
                const token = document.getElementById('whoopToken').value;
                if (!token) {
                    throw new Error('Please enter your Whoop token');
                }

                // Note: Whoop API endpoints would need to be implemented
                resultDiv.innerHTML = '‚úÖ Whoop connection test completed (API integration pending)';
                resultDiv.style.color = '#68d391';
            } catch (error) {
                resultDiv.innerHTML = `‚ùå Connection failed: ${error.message}`;
                resultDiv.style.color = '#fc8181';
            }
        }

        function testAppleHealthConnection() {
            const resultDiv = document.getElementById('appleTestResult');
            resultDiv.innerHTML = 'üîÑ Testing Apple Health connection...';

            try {
                // Check if HealthKit is available
                if (typeof HealthKit !== 'undefined') {
                    resultDiv.innerHTML = '‚úÖ Apple Health connection available';
                    resultDiv.style.color = '#68d391';
                } else {
                    resultDiv.innerHTML = '‚ö†Ô∏è Apple Health integration requires iOS device with Health app';
                    resultDiv.style.color = '#fbd38d';
                }
            } catch (error) {
                resultDiv.innerHTML = `‚ùå Connection failed: ${error.message}`;
                resultDiv.style.color = '#fc8181';
            }
        }

        function testGarminConnection() {
            const resultDiv = document.getElementById('garminTestResult');
            resultDiv.innerHTML = 'üîÑ Testing Garmin connection...';

            try {
                const username = document.getElementById('garminUsername').value;
                const password = document.getElementById('garminPassword').value;
                
                if (!username || !password) {
                    throw new Error('Please enter Garmin username and password');
                }

                // Note: Garmin API integration would need to be implemented
                resultDiv.innerHTML = '‚úÖ Garmin connection test completed (API integration pending)';
                resultDiv.style.color = '#68d391';
            } catch (error) {
                resultDiv.innerHTML = `‚ùå Connection failed: ${error.message}`;
                resultDiv.style.color = '#fc8181';
            }
        }

        // Personalized Workout Plan Generation
        function generateWorkoutPlan() {
            if (!currentUser || !isLoggedIn) return;

            const user = users[currentUser];
            if (!user.goals || !user.goals.primary) {
                alert('Please set your goals first in the Goals & Priorities section');
                return;
            }

            const plan = createPersonalizedPlan(user);
            user.workoutPlan = plan;
            
            localStorage.setItem('ignitefitness_users', JSON.stringify(users));
            displayWorkoutPlan(plan);
            
            alert('Personalized workout plan generated!');
        }

        function createPersonalizedPlan(user) {
            const primaryGoal = user.goals.primary;
            const secondaryGoals = user.goals.secondary || [];
            const baseline = user.personalData?.baselineStrength || {};
            const personalData = user.personalData || {};

            // Base plan structure
            let plan = {
                goal: primaryGoal,
                duration: '4 weeks',
                focus: [],
                sessions: {
                    'Week 1': [],
                    'Week 2': [],
                    'Week 3': [],
                    'Week 4': []
                },
                progression: {},
                recommendations: []
            };

            // Soccer-focused base (since target is women soccer players)
            const soccerBase = [
                { name: 'Dynamic Warmup', target: '10 min', focus: 'Movement prep' },
                { name: 'ACL Prevention', target: '15 min', focus: 'Injury prevention' },
                { name: 'Core Stability', target: '10 min', focus: 'Core strength' }
            ];

            // Goal-specific modifications
            if (primaryGoal === 'improve_speed') {
                plan.focus.push('Speed Development', 'Power Training', 'Agility');
                plan.sessions['Week 1'] = [
                    ...soccerBase,
                    { name: 'Sprint Training', target: '20 min', focus: 'Speed' },
                    { name: 'Plyometrics', target: '15 min', focus: 'Power' }
                ];
            } else if (primaryGoal === 'improve_endurance') {
                plan.focus.push('Cardiovascular Fitness', 'Aerobic Capacity');
                plan.sessions['Week 1'] = [
                    ...soccerBase,
                    { name: 'Interval Training', target: '25 min', focus: 'Endurance' },
                    { name: 'Tempo Runs', target: '20 min', focus: 'Aerobic base' }
                ];
            } else if (primaryGoal === 'grow_muscle') {
                plan.focus.push('Strength Building', 'Muscle Development');
                plan.sessions['Week 1'] = [
                    ...soccerBase,
                    { name: 'Upper Body Strength', target: '30 min', focus: 'Muscle building' },
                    { name: 'Lower Body Strength', target: '30 min', focus: 'Leg development' }
                ];
            } else if (primaryGoal === 'acl_prevention') {
                plan.focus.push('Injury Prevention', 'Stability Training');
                plan.sessions['Week 1'] = [
                    ...soccerBase,
                    { name: 'Single Leg Training', target: '20 min', focus: 'Stability' },
                    { name: 'Hip Strengthening', target: '15 min', focus: 'ACL support' }
                ];
            } else {
                // Default soccer performance plan
                plan.focus.push('Soccer Performance', 'Overall Fitness');
                plan.sessions['Week 1'] = [
                    ...soccerBase,
                    { name: 'Soccer Skills', target: '30 min', focus: 'Technical' },
                    { name: 'Conditioning', target: '20 min', focus: 'Fitness' }
                ];
            }

            // Add secondary goal modifications
            if (secondaryGoals.includes('strength_gain')) {
                plan.sessions['Week 1'].push({ name: 'Strength Training', target: '25 min', focus: 'Strength' });
            }
            if (secondaryGoals.includes('agility_training')) {
                plan.sessions['Week 1'].push({ name: 'Agility Drills', target: '15 min', focus: 'Agility' });
            }

            // Set progression based on baseline
            if (baseline.bench) {
                plan.progression.bench = {
                    week1: baseline.bench * 0.8,
                    week2: baseline.bench * 0.85,
                    week3: baseline.bench * 0.9,
                    week4: baseline.bench * 0.95
                };
            }

            // Add personalized recommendations
            if (personalData.sex === 'female') {
                plan.recommendations.push('Focus on hip and knee stability for ACL prevention');
                plan.recommendations.push('Include glute strengthening exercises');
            }
            
            if (personalData.age && personalData.age < 18) {
                plan.recommendations.push('Emphasize proper form and technique');
                plan.recommendations.push('Include recovery days between intense sessions');
            }

            return plan;
        }

        function displayWorkoutPlan(plan) {
            const displayDiv = document.getElementById('workoutPlanDisplay');
            
            let html = `
                <h4 style="color: #68d391; margin-bottom: 15px;">${plan.duration} Plan - ${plan.goal.replace('_', ' ').toUpperCase()}</h4>
                <div style="margin-bottom: 15px;">
                    <strong>Focus Areas:</strong> ${plan.focus.join(', ')}
                </div>
                <div style="margin-bottom: 15px;">
                    <strong>Week 1 Schedule:</strong>
                    <ul style="margin-top: 10px; padding-left: 20px;">
            `;
            
            plan.sessions['Week 1'].forEach(session => {
                html += `<li><strong>${session.name}:</strong> ${session.target} - ${session.focus}</li>`;
            });
            
            html += `
                    </ul>
                </div>
                <div style="margin-bottom: 15px;">
                    <strong>Recommendations:</strong>
                    <ul style="margin-top: 10px; padding-left: 20px;">
            `;
            
            plan.recommendations.forEach(rec => {
                html += `<li>${rec}</li>`;
            });
            
            html += `
                    </ul>
                </div>
                <div style="background: #2d3748; padding: 10px; border-radius: 5px; margin-top: 15px;">
                    <strong>üí° AI Insight:</strong> This plan is tailored to your goals and will be updated weekly based on your progress and performance data.
                </div>
            `;
            
            displayDiv.innerHTML = html;
        }

        // AI Weekly Updates
        function generateWeeklyUpdate() {
            if (!currentUser || !isLoggedIn) return;

            const user = users[currentUser];
            const workouts = user.data.workouts || [];
            const recentWorkouts = workouts.slice(-7); // Last 7 workouts
            
            if (recentWorkouts.length === 0) {
                alert('No recent workouts found for analysis');
                return;
            }

            const insights = analyzeWeeklyProgress(user, recentWorkouts);
            const updatedPlan = updatePlanBasedOnProgress(user.workoutPlan, insights);
            
            // Save updated plan
            user.workoutPlan = updatedPlan;
            localStorage.setItem('ignitefitness_users', JSON.stringify(users));
            
            displayWeeklyUpdate(insights, updatedPlan);
        }

        function analyzeWeeklyProgress(user, workouts) {
            const insights = {
                consistency: calculateConsistency(workouts),
                performance: analyzePerformance(workouts),
                recovery: analyzeRecovery(user),
                recommendations: []
            };

            // Generate insights based on data
            if (insights.consistency < 70) {
                insights.recommendations.push('Consider adjusting your schedule to improve consistency');
            }
            
            if (insights.performance.trend === 'declining') {
                insights.recommendations.push('Focus on recovery and consider lighter training loads');
            }
            
            if (insights.recovery.avgSleep < 7) {
                insights.recommendations.push('Prioritize sleep for better performance and recovery');
            }

            return insights;
        }

        function calculateConsistency(workouts) {
            const days = workouts.length;
            return Math.min(100, (days / 7) * 100);
        }

        function analyzePerformance(workouts) {
            if (workouts.length < 3) return { trend: 'insufficient_data' };
            
            const recentEnergy = workouts.slice(-3).map(w => w.energy || 5);
            const avgEnergy = recentEnergy.reduce((a, b) => a + b, 0) / recentEnergy.length;
            
            return {
                trend: avgEnergy > 6 ? 'improving' : 'declining',
                avgEnergy: avgEnergy
            };
        }

        function analyzeRecovery(user) {
            const sleepData = user.data.sleepData || [];
            const recentSleep = sleepData.slice(-7);
            
            const avgSleep = recentSleep.length > 0 
                ? recentSleep.reduce((sum, day) => sum + (day.totalSleep || 7), 0) / recentSleep.length
                : 7;

            return { avgSleep };
        }

        function updatePlanBasedOnProgress(plan, insights) {
            if (!plan) return plan;

            // Adjust plan based on insights
            if (insights.consistency < 70) {
                // Reduce intensity for better consistency
                plan.recommendations.push('Reduced session intensity to improve consistency');
            }
            
            if (insights.performance.trend === 'declining') {
                // Add recovery focus
                plan.recommendations.push('Increased recovery emphasis based on performance data');
            }

            return plan;
        }

        function displayWeeklyUpdate(insights, updatedPlan) {
            const updateHtml = `
                <div style="background: #2d3748; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h3 style="color: #68d391; margin-bottom: 15px;">üìä Weekly AI Update</h3>
                    
                    <div style="margin-bottom: 15px;">
                        <h4>Performance Analysis:</h4>
                        <ul>
                            <li><strong>Consistency:</strong> ${insights.consistency.toFixed(1)}%</li>
                            <li><strong>Performance Trend:</strong> ${insights.performance.trend}</li>
                            <li><strong>Average Sleep:</strong> ${insights.recovery.avgSleep.toFixed(1)} hours</li>
                        </ul>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <h4>AI Recommendations:</h4>
                        <ul>
                            ${insights.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                        </ul>
                    </div>
                    
                    <div style="background: #1a1a1a; padding: 15px; border-radius: 5px;">
                        <strong>üéØ Plan Updated:</strong> Your workout plan has been adjusted based on this week's performance data.
                    </div>
                </div>
            `;
            
            // Add to analysis tab or create popup
            const analysisTab = document.getElementById('analysis');
            const existingUpdate = analysisTab.querySelector('.weekly-update');
            if (existingUpdate) {
                existingUpdate.remove();
            }
            
            const updateDiv = document.createElement('div');
            updateDiv.className = 'weekly-update';
            updateDiv.innerHTML = updateHtml;
            analysisTab.insertBefore(updateDiv, analysisTab.firstChild);
        }

        let soccerSessions = [];
        let recoveryData = [];
        let stravaData = [];
        let sleepData = [];
        
        // 4-Week Progression Targets
        const progressionTargets = {
            1: { bench: 40, squat: 75, pullups: -60, description: 'Gentle Return' },
            2: { bench: 45, squat: 80, pullups: -55, description: 'Full Intensity' },
            3: { bench: 47.5, squat: 85, pullups: -50, description: 'Building' },
            4: { bench: 50, squat: 95, pullups: -45, description: 'Peak' }
        };

        // Daily workout plans based on your master plan
        const dailyPlans = {
            'Upper A': [
                { name: 'Bench Press', target: '3√ó5 @ 40 lbs', rest: '2 min' },
                { name: 'Lat Pulldown', target: '3√ó8', rest: '90 sec' },
                { name: 'DB Shoulder Press', target: '3√ó8 @ 15 lbs', rest: '90 sec' },
                { name: 'Cable Row', target: '3√ó10', rest: '60 sec' }
            ],
            'Upper B': [
                { name: 'Incline DB Press', target: '3√ó8 @ 15 lbs', rest: '90 sec' },
                { name: 'Pull-ups', target: '3√ó5 @ -60 assist', rest: '2 min' },
                { name: 'Lateral Raises', target: '3√ó12 @ 8 lbs', rest: '60 sec' },
                { name: 'Face Pulls', target: '3√ó15', rest: '60 sec' }
            ],
            'Lower A': [
                { name: 'Back Squat', target: '3√ó5 @ 75 lbs', rest: '2.5 min' },
                { name: 'Nordic Curls', target: '3√ó6-8', rest: '90 sec' },
                { name: 'RDL', target: '3√ó8 @ 65 lbs', rest: '2 min' },
                { name: 'Single Leg RDLs', target: '3√ó8 each side', rest: '90 sec' },
                { name: 'Goblet Squat', target: '3√ó10 @ 25 lbs', rest: '90 sec' }
            ],
            'Lower B': [
                { name: 'Squat', target: '4√ó5 @ 80 lbs', rest: '2.5 min' },
                { name: 'RDL', target: '3√ó8 @ 70 lbs', rest: '2 min' },
                { name: 'Bulgarian Split Squats', target: '3√ó8/leg @ 15 lbs', rest: '90 sec' },
                { name: 'Single Leg Box Jump', target: '3√ó3/leg', rest: '90 sec' }
            ],
            'Soccer': [
                { name: 'Dynamic Warmup', target: '10 min', rest: '' },
                { name: 'ACL Prevention', target: '15 min', rest: '' },
                { name: 'Soccer Practice/Match', target: '90 min', rest: '' }
            ],
            'Indoor Climbing': [
                { name: 'Warm-up Routes', target: '3-4 easy routes (V0-V2)', rest: '2 min between' },
                { name: 'Main Climbing', target: '6-8 routes (V2-V5)', rest: '3-5 min between' },
                { name: 'Cool-down', target: '2 easy routes (V0-V1)', rest: '2 min between' },
                { name: 'Session Notes', target: '~12 routes, ~90-120 min total', rest: '' }
            ],
            'Outdoor Climbing': [
                { name: 'Approach & Setup', target: '15-30 min', rest: '' },
                { name: 'Warm-up Routes', target: '2-3 easy pitches (5.6-5.8)', rest: '5-10 min between' },
                { name: 'Main Climbing', target: '3-5 routes (5.9-6.2)', rest: '5-15 min between' },
                { name: 'Descent & Cleanup', target: '15-30 min', rest: '' },
                { name: 'Session Notes', target: '~5-8 routes, ~3-6 hours total', rest: '' }
            ],
            'Recovery': [
                { name: 'Yoga with Adriene', target: '30-45 min', rest: '' },
                { name: 'Hip/Achilles Work', target: '10 min', rest: '' },
                { name: 'Foam Rolling', target: '10 min', rest: '' }
            ]
        };

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize the app - show login form by default
            showLoginForm();
            hideUserDashboard();
            
            // Load users from localStorage
            const savedUsers = localStorage.getItem('ignitefitness_users');
            if (savedUsers) {
                users = JSON.parse(savedUsers);
            }
            
            // Check if user was previously logged in (simple session persistence)
            const lastUser = localStorage.getItem('ignitefitness_last_user');
            if (lastUser && users[lastUser]) {
                currentUser = lastUser;
                isLoggedIn = true;
                showUserDashboard();
                hideLoginForm();
                loadUserData();
                
                // Initialize displays only if logged in
                updateCurrentSessionDisplay();
                updateHistory();
                updateSummary();
                
            // Set today's date
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('sessionDate').value = today;
            
            // Initialize sliders
            initializeSliders();
            
            // Add event listeners
            const extraExerciseSelect = document.getElementById('extraExerciseName');
            if (extraExerciseSelect) {
                extraExerciseSelect.addEventListener('change', toggleOtherExercise);
            }
            
            // Session type change listener for climbing intensity
            const sessionTypeSelect = document.getElementById('sessionType');
            if (sessionTypeSelect) {
                sessionTypeSelect.addEventListener('change', toggleClimbingIntensity);
            }
            
            // Load daily plan if session type is already selected
            loadDailyPlan();
            
            // Load data
            loadData();
            }
        });

        function initializeSliders() {
            // Session energy slider
            const sessionEnergySlider = document.getElementById('sessionEnergy');
            const sessionEnergyValue = document.getElementById('sessionEnergyValue');
            if (sessionEnergySlider && sessionEnergyValue) {
                sessionEnergySlider.addEventListener('input', function() {
                    sessionEnergyValue.textContent = this.value;
                    currentSession.energy = parseInt(this.value);
                });
            }

            // Exercise RPE slider
            const exerciseRpeSlider = document.getElementById('exerciseRpe');
            const exerciseRpeValue = document.getElementById('exerciseRpeValue');
            if (exerciseRpeSlider && exerciseRpeValue) {
                exerciseRpeSlider.addEventListener('input', function() {
                    exerciseRpeValue.textContent = this.value;
                });
            }

            // Soccer sliders
            initializeSlider('soccerEnergy', 'soccerEnergyValue');
            initializeSlider('soccerPerformance', 'soccerPerformanceValue');
            initializeSlider('soccerSharpness', 'soccerSharpnessValue');

            // Recovery sliders
            initializeSlider('sorenessLevel', 'sorenessLevelValue');
            initializeSlider('achillesTightness', 'achillesTightnessValue');
            initializeSlider('hipTightness', 'hipTightnessValue');
            initializeSlider('overallEnergy', 'overallEnergyValue');
            initializeSlider('moodLevel', 'moodLevelValue');
            
            // Climbing intensity slider
            initializeSlider('climbingIntensity', 'climbingIntensityValue');
        }

        function initializeSlider(sliderId, valueId) {
            const slider = document.getElementById(sliderId);
            const value = document.getElementById(valueId);
            if (slider && value) {
                slider.addEventListener('input', function() {
                    value.textContent = this.value;
                });
            }
        }

        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
            
            // Update content when switching tabs
            if (tabName === 'history') {
                updateHistory();
            } else if (tabName === 'summary') {
                updateSummary();
            } else if (tabName === 'export') {
                updateExportPreview();
            } else if (tabName === 'soccer') {
                updateSoccerHistory();
            } else if (tabName === 'recovery') {
                updateRecoveryHistory();
            } else if (tabName === 'analysis') {
                updateAnalysis();
                updateSleepHistory();
            }
        }

        function loadDailyPlan() {
            const sessionType = document.getElementById('sessionType').value;
            const plannedWorkoutDiv = document.getElementById('plannedWorkout');
            
            if (!dailyPlans[sessionType]) {
                plannedWorkoutDiv.innerHTML = '<p style="color: #a0aec0; text-align: center; padding: 20px;">No plan available for this session type</p>';
                return;
            }
            
            const plan = dailyPlans[sessionType];
            let html = '<h4 style="color: #68d391; margin-bottom: 15px;">Planned Exercises:</h4>';
            
            plan.forEach((exercise, index) => {
                html += `
                    <div class="planned-exercise" data-exercise="${exercise.name}">
                        <div class="planned-exercise-info">
                            <div class="planned-exercise-name">${exercise.name}</div>
                            <div class="planned-exercise-target">Target: ${exercise.target} ${exercise.rest ? `(Rest: ${exercise.rest})` : ''}</div>
                            <div class="set-entry-example">Example: "40x12, 45x10, 50x6" or "3x5 @ 40"</div>
                        </div>
                        <div class="planned-exercise-input">
                            <textarea placeholder="Sets & Weights&#10;40x12, 45x10, 50x6" class="planned-sets-reps" data-exercise="${exercise.name}" rows="2"></textarea>
                            <button class="btn" style="padding: 5px 10px; font-size: 12px;" onclick="addPlannedExercise('${exercise.name}')">Add</button>
                        </div>
                    </div>
                `;
            });
            
            plannedWorkoutDiv.innerHTML = html;
        }

        function clearPlan() {
            document.getElementById('plannedWorkout').innerHTML = '<p style="color: #a0aec0; text-align: center; padding: 20px;">Select a session type to load today\'s plan</p>';
        }

        function addPlannedExercise(exerciseName) {
            const setsRepsInput = document.querySelector(`textarea[data-exercise="${exerciseName}"].planned-sets-reps`);
            const setsReps = setsRepsInput.value.trim();
            
            if (!setsReps) {
                alert('Please enter your sets and weights');
                return;
            }
            
            // Parse the flexible input format
            const parsedSets = parseSetsInput(setsReps);
            
            const exercise = {
                name: exerciseName,
                weight: parsedSets.averageWeight || 0, // Store average weight for sorting/display
                setsReps: setsReps, // Store the full input as entered
                parsedSets: parsedSets.sets, // Store parsed individual sets
                rpe: 7, // Default RPE
                notes: '',
                timestamp: new Date().toISOString()
            };
            
            currentSession.exercises.push(exercise);
            
            // Clear input
            setsRepsInput.value = '';
            
            updateCurrentSessionDisplay();
        }

        function parseSetsInput(input) {
            const sets = [];
            let totalWeight = 0;
            let totalSets = 0;
            
            // Handle different formats:
            // "40x12, 45x10, 50x6" - different weights per set
            // "3x5 @ 40" - same weight for all sets
            // "12, 10, 6" - reps only (no weights specified)
            // "40x12 45x10 50x6" - spaces instead of commas
            
            const cleanInput = input.replace(/\s+/g, ' ').trim();
            
            // Check if it's in "weightxreps" format
            if (cleanInput.includes('x') || cleanInput.includes('√ó')) {
                const parts = cleanInput.split(/[,\s]+/);
                
                for (const part of parts) {
                    if (part.includes('x') || part.includes('√ó')) {
                        const [weight, reps] = part.split(/[x√ó]/);
                        const weightNum = parseFloat(weight);
                        const repsNum = parseInt(reps);
                        
                        if (!isNaN(weightNum) && !isNaN(repsNum)) {
                            sets.push({ weight: weightNum, reps: repsNum });
                            totalWeight += weightNum * repsNum;
                            totalSets += 1;
                        }
                    }
                }
            }
            // Check if it's in "setsxreps @ weight" format
            else if (cleanInput.includes('@')) {
                const parts = cleanInput.split('@');
                if (parts.length === 2) {
                    const setsReps = parts[0].trim();
                    const weight = parseFloat(parts[1].trim());
                    
                    if (setsReps.includes('x') || setsReps.includes('√ó')) {
                        const [setCount, reps] = setsReps.split(/[x√ó]/);
                        const setCountNum = parseInt(setCount);
                        const repsNum = parseInt(reps);
                        
                        if (!isNaN(setCountNum) && !isNaN(repsNum) && !isNaN(weight)) {
                            for (let i = 0; i < setCountNum; i++) {
                                sets.push({ weight: weight, reps: repsNum });
                                totalWeight += weight * repsNum;
                                totalSets += 1;
                            }
                        }
                    }
                }
            }
            // Handle just reps (no weights)
            else {
                const parts = cleanInput.split(/[,\s]+/);
                for (const part of parts) {
                    const reps = parseInt(part);
                    if (!isNaN(reps)) {
                        sets.push({ weight: 0, reps: reps }); // No weight specified
                        totalSets += 1;
                    }
                }
            }
            
            return {
                sets: sets,
                averageWeight: totalSets > 0 ? totalWeight / totalSets : 0
            };
        }

        function addExtraExercise() {
            const exerciseName = document.getElementById('extraExerciseName').value;
            const otherExerciseName = document.getElementById('otherExtraExerciseName').value;
            const setsReps = document.getElementById('extraSetsReps').value.trim();

            if (!setsReps) {
                alert('Please enter your sets and weights');
                return;
            }

            const finalExerciseName = exerciseName === 'Other' ? otherExerciseName : exerciseName;
            
            if (!finalExerciseName) {
                alert('Please enter an exercise name');
                return;
            }

            // Parse the flexible input format
            const parsedSets = parseSetsInput(setsReps);

            const exercise = {
                name: finalExerciseName,
                weight: parsedSets.averageWeight || 0, // Store average weight for sorting/display
                setsReps: setsReps, // Store the full input as entered
                parsedSets: parsedSets.sets, // Store parsed individual sets
                rpe: 7, // Default RPE
                notes: '',
                timestamp: new Date().toISOString()
            };

            currentSession.exercises.push(exercise);
            
            // Clear form
            document.getElementById('extraSetsReps').value = '';
            document.getElementById('otherExtraExerciseName').value = '';
            document.getElementById('otherExtraExerciseGroup').classList.add('hidden');
            
            updateCurrentSessionDisplay();
        }

        function toggleOtherExercise() {
            const exerciseSelect = document.getElementById('extraExerciseName');
            const otherGroup = document.getElementById('otherExtraExerciseGroup');
            
            if (exerciseSelect.value === 'Other') {
                otherGroup.classList.remove('hidden');
            } else {
                otherGroup.classList.add('hidden');
            }
        }

        function toggleClimbingIntensity() {
            const sessionType = document.getElementById('sessionType');
            const climbingIntensityGroup = document.getElementById('climbingIntensityGroup');
            const climbingRoutesGroup = document.getElementById('climbingRoutesGroup');
            const climbingDurationGroup = document.getElementById('climbingDurationGroup');
            
            if (sessionType.value === 'Indoor Climbing' || sessionType.value === 'Outdoor Climbing') {
                climbingIntensityGroup.style.display = 'block';
                climbingRoutesGroup.style.display = 'block';
                climbingDurationGroup.style.display = 'block';
            } else {
                climbingIntensityGroup.style.display = 'none';
                climbingRoutesGroup.style.display = 'none';
                climbingDurationGroup.style.display = 'none';
            }
        }

        function addExercise() {
            const exerciseName = document.getElementById('exerciseName').value;
            const otherExerciseName = document.getElementById('otherExerciseName').value;
            const weight = parseFloat(document.getElementById('weight').value) || 0;
            const setsReps = document.getElementById('setsReps').value;
            const rpe = parseInt(document.getElementById('exerciseRpe').value);
            const notes = document.getElementById('exerciseNotes').value;

            if (!exerciseName || !setsReps) {
                alert('Please fill in exercise name and sets/reps');
                return;
            }

            const finalExerciseName = exerciseName === 'Other' ? otherExerciseName : exerciseName;

            const exercise = {
                name: finalExerciseName,
                weight: weight,
                setsReps: setsReps,
                rpe: rpe,
                notes: notes,
                timestamp: new Date().toISOString()
            };

            currentSession.exercises.push(exercise);
            
            // Clear form
            document.getElementById('weight').value = '';
            document.getElementById('setsReps').value = '';
            document.getElementById('exerciseRpe').value = '7';
            document.getElementById('exerciseRpeValue').textContent = '7';
            document.getElementById('exerciseNotes').value = '';
            
            updateCurrentSessionDisplay();
        }

        function updateCurrentSessionDisplay() {
            const container = document.getElementById('currentExercises');
            const sessionDiv = document.getElementById('currentSession');
            
            if (currentSession.exercises.length === 0) {
                sessionDiv.classList.add('hidden');
                return;
            }
            
            sessionDiv.classList.remove('hidden');
            
            container.innerHTML = '';
            currentSession.exercises.forEach((exercise, index) => {
                const exerciseDiv = document.createElement('div');
                exerciseDiv.className = 'exercise-card';
                // Create detailed set breakdown if parsed sets are available
                let setBreakdown = '';
                if (exercise.parsedSets && exercise.parsedSets.length > 0) {
                    setBreakdown = '<div style="margin-top: 10px; font-size: 14px;"><strong>Set Breakdown:</strong><br>';
                    exercise.parsedSets.forEach((set, setIndex) => {
                        const weightText = set.weight > 0 ? `${set.weight}lbs` : 'BW';
                        setBreakdown += `Set ${setIndex + 1}: ${set.reps} reps @ ${weightText}<br>`;
                    });
                    setBreakdown += '</div>';
                }

                exerciseDiv.innerHTML = `
                    <div class="exercise-header">
                        <span class="exercise-name">${exercise.name}</span>
                        <button onclick="removeExercise(${index})" style="background: none; border: none; color: #fc8181; cursor: pointer;">√ó</button>
                    </div>
                    <div class="exercise-details">
                        <div class="exercise-detail">
                            <div class="exercise-detail-label">Weight</div>
                            <div class="exercise-detail-value">${exercise.weight > 0 ? exercise.weight + ' lbs' : 'Body Weight'}</div>
                        </div>
                        <div class="exercise-detail">
                            <div class="exercise-detail-label">Sets √ó Reps</div>
                            <div class="exercise-detail-value">${exercise.setsReps}</div>
                        </div>
                        <div class="exercise-detail">
                            <div class="exercise-detail-label">RPE</div>
                            <div class="exercise-detail-value">${exercise.rpe}/10</div>
                        </div>
                    </div>
                    ${setBreakdown}
                    ${exercise.notes ? `<div class="exercise-notes">${exercise.notes}</div>` : ''}
                `;
                container.appendChild(exerciseDiv);
            });
        }

        function removeExercise(index) {
            currentSession.exercises.splice(index, 1);
            updateCurrentSessionDisplay();
        }

        function saveSession() {
            // Update session details
            currentSession.date = document.getElementById('sessionDate').value;
            currentSession.startTime = document.getElementById('sessionStartTime').value;
            currentSession.type = document.getElementById('sessionType').value;
            currentSession.notes = document.getElementById('sessionNotes').value;
            
            // Add climbing data if climbing session
            const sessionType = document.getElementById('sessionType').value;
            if (sessionType === 'Indoor Climbing' || sessionType === 'Outdoor Climbing') {
                currentSession.climbingIntensity = parseInt(document.getElementById('climbingIntensity').value);
                currentSession.climbingRoutes = parseInt(document.getElementById('climbingRoutes').value) || 0;
                currentSession.climbingDuration = parseInt(document.getElementById('climbingDuration').value) || 0;
            }
            
            if (!currentSession.date || currentSession.exercises.length === 0) {
                alert('Please fill in date and add at least one exercise');
                return;
            }

            // Save to user-specific storage
            if (!currentUser || !isLoggedIn) {
                alert('Please log in to save workouts');
                return;
            }
            
            const user = users[currentUser];
            if (!user.data.workouts) user.data.workouts = [];
            
            currentSession.id = Date.now();
            user.data.workouts.push({...currentSession});
            localStorage.setItem('ignitefitness_users', JSON.stringify(users));
            
            // Reset current session
            currentSession = {
                date: '',
                type: '',
                energy: 7,
                notes: '',
                exercises: []
            };
            
            // Reset form
            document.getElementById('sessionDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('sessionType').value = 'Upper A';
            document.getElementById('sessionEnergy').value = '7';
            document.getElementById('sessionEnergyValue').textContent = '7';
            document.getElementById('sessionNotes').value = '';
            
            // Reset climbing fields
            document.getElementById('climbingIntensity').value = '5';
            document.getElementById('climbingIntensityValue').textContent = '5';
            document.getElementById('climbingRoutes').value = '';
            document.getElementById('climbingDuration').value = '';
            
            // Hide climbing fields
            toggleClimbingIntensity();
            
            // Show completion message
            const messageDiv = document.getElementById('sessionSavedMessage');
            messageDiv.style.display = 'block';
            
            // Hide message after 3 seconds
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 3000);
            
            updateCurrentSessionDisplay();
            updateHistory();
            updateSummary();
            
            // Scroll to top to show completion message
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function getWorkouts() {
            if (!currentUser || !isLoggedIn) return [];
            const user = users[currentUser];
            return user ? (user.data.workouts || []) : [];
        }

        function updateHistory() {
            const workouts = getWorkouts();
            const container = document.getElementById('workoutHistory');
            
            if (workouts.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #a0aec0; padding: 20px;">No workouts logged yet</p>';
                return;
            }
            
            // Show last 5 workouts
            const recentWorkouts = workouts.slice(-5).reverse();
            
            container.innerHTML = '';
            recentWorkouts.forEach(workout => {
                const workoutDiv = document.createElement('div');
                workoutDiv.className = 'session-card';
                workoutDiv.innerHTML = `
                    <div class="session-header">
                        <span class="session-type">${workout.type}${(workout.type === 'Indoor Climbing' || workout.type === 'Outdoor Climbing') ? ' üßó‚Äç‚ôÇÔ∏è' : ''}</span>
                        <span class="session-date">${new Date(workout.date).toLocaleDateString()}</span>
                    </div>
                    <div class="session-stats">
                        <div class="session-stat">
                            <div class="session-stat-label">Exercises</div>
                            <div class="session-stat-value">${workout.exercises.length}</div>
                        </div>
                        <div class="session-stat">
                            <div class="session-stat-label">Energy</div>
                            <div class="session-stat-value">${workout.energy}/10</div>
                        </div>
                        ${(workout.type === 'Indoor Climbing' || workout.type === 'Outdoor Climbing') ? `
                        ${workout.climbingIntensity ? `
                        <div class="session-stat">
                            <div class="session-stat-label">Intensity</div>
                            <div class="session-stat-value">${workout.climbingIntensity}/10</div>
                        </div>
                        ` : ''}
                        ${workout.climbingRoutes ? `
                        <div class="session-stat">
                            <div class="session-stat-label">Routes</div>
                            <div class="session-stat-value">${workout.climbingRoutes}</div>
                        </div>
                        ` : ''}
                        ${workout.climbingDuration ? `
                        <div class="session-stat">
                            <div class="session-stat-label">Duration</div>
                            <div class="session-stat-value">${workout.climbingDuration}min</div>
                        </div>
                        ` : ''}
                        ` : ''}
                    </div>
                    ${workout.notes ? `<div style="color: #a0aec0; font-size: 14px; margin-bottom: 10px;">${workout.notes}</div>` : ''}
                    <button class="workout-toggle" onclick="toggleWorkoutDetails(${workout.id})">Show/Hide Exercises</button>
                    <div id="workout-${workout.id}" class="workout-exercises hidden">
                        ${workout.exercises.map(exercise => `
                            <div class="exercise-card">
                                <div class="exercise-header">
                                    <span class="exercise-name">${exercise.name}</span>
                                </div>
                                <div class="exercise-details">
                                    <div class="exercise-detail">
                                        <div class="exercise-detail-label">Weight</div>
                                        <div class="exercise-detail-value">${exercise.weight} lbs</div>
                                    </div>
                                    <div class="exercise-detail">
                                        <div class="exercise-detail-label">Sets √ó Reps</div>
                                        <div class="exercise-detail-value">${exercise.setsReps}</div>
                                    </div>
                                    <div class="exercise-detail">
                                        <div class="exercise-detail-label">RPE</div>
                                        <div class="exercise-detail-value">${exercise.rpe}/10</div>
                                    </div>
                                </div>
                                ${exercise.notes ? `<div class="exercise-notes">${exercise.notes}</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
                container.appendChild(workoutDiv);
            });
        }

        function toggleWorkoutDetails(workoutId) {
            const detailsDiv = document.getElementById(`workout-${workoutId}`);
            detailsDiv.classList.toggle('hidden');
        }

        function updateSummary() {
            const workouts = getWorkouts();
            const now = new Date();
            const weekStart = new Date(now.setDate(now.getDate() - now.getDay()));
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            
            const weeklyWorkouts = workouts.filter(workout => {
                const workoutDate = new Date(workout.date);
                return workoutDate >= weekStart && workoutDate <= weekEnd;
            });
            
            // Update weekly stats
            document.getElementById('weeklySessions').textContent = weeklyWorkouts.length;
            
            if (weeklyWorkouts.length > 0) {
                const avgEnergy = Math.round(weeklyWorkouts.reduce((sum, w) => sum + w.energy, 0) / weeklyWorkouts.length);
                document.getElementById('weeklyEnergy').textContent = `${avgEnergy}/10`;
            } else {
                document.getElementById('weeklyEnergy').textContent = '0/10';
            }
            
            // Update progression list
            const progressionList = document.getElementById('progressionList');
            progressionList.innerHTML = '';
            
            const mainLifts = ['Bench Press', 'Squat', 'Deadlift'];
            mainLifts.forEach(lift => {
                const liftWorkouts = weeklyWorkouts.flatMap(w => w.exercises.filter(e => e.name === lift));
                if (liftWorkouts.length > 0) {
                    const latest = liftWorkouts[liftWorkouts.length - 1];
                    const li = document.createElement('li');
                    li.className = 'progression-item';
                    li.innerHTML = `
                        <span class="progression-exercise">${lift}</span>
                        <span class="progression-value">${latest.weight}√ó${latest.setsReps}</span>
                    `;
                    progressionList.appendChild(li);
                }
            });

            // Update 4-week progression targets
            updateProgressionTargets();
            
            // Update recovery metrics
            updateRecoveryMetrics();
            
            // Update soccer metrics
            updateSoccerMetrics();
        }

        function updateProgressionTargets() {
            const container = document.getElementById('progressionTargets');
            container.innerHTML = '';
            
            // Determine current week (simplified - you could make this more sophisticated)
            const currentWeek = Math.min(4, Math.ceil((new Date() - new Date('2024-09-22')) / (7 * 24 * 60 * 60 * 1000)) + 1);
            
            Object.entries(progressionTargets).forEach(([week, targets]) => {
                const weekDiv = document.createElement('div');
                weekDiv.className = 'session-card';
                if (parseInt(week) === currentWeek) {
                    weekDiv.style.borderLeft = '4px solid #68d391';
                }
                weekDiv.innerHTML = `
                    <div class="session-header">
                        <span class="session-type">Week ${week}: ${targets.description}</span>
                        ${parseInt(week) === currentWeek ? '<span style="color: #68d391;">Current</span>' : ''}
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: #a0aec0;">Bench</div>
                            <div style="font-weight: 600;">${targets.bench} lbs</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: #a0aec0;">Squat</div>
                            <div style="font-weight: 600;">${targets.squat} lbs</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: #a0aec0;">Pull-ups</div>
                            <div style="font-weight: 600;">${targets.pullups} assist</div>
                        </div>
                    </div>
                `;
                container.appendChild(weekDiv);
            });
        }

        function updateRecoveryMetrics() {
            const weeklyRecoveryData = recoveryData.filter(recovery => {
                const recoveryDate = new Date(recovery.date);
                const now = new Date();
                const weekStart = new Date(now.setDate(now.getDate() - now.getDay()));
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);
                return recoveryDate >= weekStart && recoveryDate <= weekEnd;
            });
            
            if (weeklyRecoveryData.length > 0) {
                const avgSleep = (weeklyRecoveryData.reduce((sum, r) => sum + r.sleepHours, 0) / weeklyRecoveryData.length).toFixed(1);
                const yogaDays = weeklyRecoveryData.filter(r => r.yogaCompleted === 'Yes').length;
                
                document.getElementById('avgSleep').textContent = `${avgSleep}h`;
                document.getElementById('yogaDays').textContent = `${yogaDays}/7`;
            } else {
                document.getElementById('avgSleep').textContent = '0h';
                document.getElementById('yogaDays').textContent = '0/7';
            }
        }

        function updateSoccerMetrics() {
            const weeklySoccerData = soccerSessions.filter(soccer => {
                const soccerDate = new Date(soccer.date);
                const now = new Date();
                const weekStart = new Date(now.setDate(now.getDate() - now.getDay()));
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);
                return soccerDate >= weekStart && soccerDate <= weekEnd;
            });
            
            if (weeklySoccerData.length > 0) {
                const avgPerformance = Math.round(weeklySoccerData.reduce((sum, s) => sum + s.performance, 0) / weeklySoccerData.length);
                const aclWarmups = weeklySoccerData.filter(s => s.aclWarmupCompleted === 'Yes').length;
                
                document.getElementById('avgSoccerPerformance').textContent = `${avgPerformance}/10`;
                document.getElementById('aclWarmupCompliance').textContent = `${aclWarmups}/${weeklySoccerData.length}`;
            } else {
                document.getElementById('avgSoccerPerformance').textContent = '0/10';
                document.getElementById('aclWarmupCompliance').textContent = '0/0';
            }
        }

        function updateExportPreview() {
            const workouts = getWorkouts();
            const exportText = document.getElementById('exportText');
            
            if (workouts.length === 0 && soccerSessions.length === 0 && recoveryData.length === 0) {
                exportText.value = 'No data to export';
                return;
            }
            
            let formattedText = 'MURPHFITNESS COMPREHENSIVE TRAINING LOG\n';
            formattedText += '=' .repeat(40) + '\n\n';
            
            // Workout sessions
            if (workouts.length > 0) {
                formattedText += 'GYM SESSIONS:\n';
                formattedText += '-' .repeat(20) + '\n';
                workouts.forEach((workout, index) => {
                    formattedText += `Session ${index + 1}: ${workout.type} - ${new Date(workout.date).toLocaleDateString()}`;
                    if (workout.startTime) {
                        formattedText += ` (Started: ${workout.startTime})`;
                    }
                    formattedText += `\nEnergy: ${workout.energy}/10\n`;
                    if (workout.notes) {
                        formattedText += `Notes: ${workout.notes}\n`;
                    }
                    formattedText += 'Exercises:\n';
                    
                    workout.exercises.forEach(exercise => {
                        formattedText += `  ‚Ä¢ ${exercise.name}: ${exercise.weight}lbs √ó ${exercise.setsReps} @ RPE ${exercise.rpe}`;
                        if (exercise.notes) {
                            formattedText += ` (${exercise.notes})`;
                        }
                        formattedText += '\n';
                    });
                    
                    formattedText += '\n';
                });
            }
            
            // Soccer sessions
            if (soccerSessions.length > 0) {
                formattedText += 'SOCCER SESSIONS:\n';
                formattedText += '-' .repeat(20) + '\n';
                soccerSessions.forEach((session, index) => {
                    formattedText += `Soccer ${index + 1}: ${session.type} - ${new Date(session.date).toLocaleDateString()}\n`;
                    formattedText += `Energy: ${session.energy}/10 | Performance: ${session.performance}/10 | Sharpness: ${session.sharpness}/10\n`;
                    if (session.preGameFuel) {
                        formattedText += `Pre-game fuel: ${session.preGameFuel}\n`;
                    }
                    if (session.aclWarmupCompleted === 'Yes') {
                        formattedText += `‚úì ACL warmup completed\n`;
                    }
                    if (session.notes) {
                        formattedText += `Notes: ${session.notes}\n`;
                    }
                    formattedText += '\n';
                });
            }
            
            // Recovery data
            if (recoveryData.length > 0) {
                formattedText += 'RECOVERY DATA:\n';
                formattedText += '-' .repeat(20) + '\n';
                recoveryData.forEach((recovery, index) => {
                    formattedText += `Day ${index + 1}: ${new Date(recovery.date).toLocaleDateString()}\n`;
                    formattedText += `Sleep: ${recovery.sleepHours}h | Energy: ${recovery.overallEnergy}/10 | Soreness: ${recovery.sorenessLevel}/10\n`;
                    formattedText += `Achilles: ${recovery.achillesTightness}/10 | Hip: ${recovery.hipTightness}/10 | Mood: ${recovery.moodLevel}/10\n`;
                    if (recovery.yogaCompleted === 'Yes') formattedText += `‚úì Yoga completed\n`;
                    if (recovery.mobilityWorkCompleted === 'Yes') formattedText += `‚úì Mobility work completed\n`;
                    formattedText += `Hydration: ${recovery.hydrationStatus} | Protein: ${recovery.proteinTargetHit}\n`;
                    if (recovery.notes) {
                        formattedText += `Notes: ${recovery.notes}\n`;
                    }
                    formattedText += '\n';
                });
            }
            
            exportText.value = formattedText;
        }

        function copyFormattedData() {
            const exportText = document.getElementById('exportText');
            exportText.select();
            document.execCommand('copy');
            alert('Formatted data copied to clipboard!');
        }

        function downloadCSV() {
            const workouts = getWorkouts();
            if (workouts.length === 0 && soccerSessions.length === 0 && recoveryData.length === 0) {
                alert('No data to export');
                return;
            }
            
            let csv = 'Data Type,Date,Start Time,Type,Energy,Performance,Sharpness,Sleep Hours,Soreness,Achilles Tightness,Hip Tightness,Mood,Notes\n';
            
            // Workout data
            workouts.forEach(workout => {
                workout.exercises.forEach(exercise => {
                    csv += `"Workout","${workout.date}","${workout.startTime || ''}","${workout.type}","${workout.energy}","","","","","","","","${exercise.name}: ${exercise.weight}lbs √ó ${exercise.setsReps} @ RPE ${exercise.rpe}"\n`;
                });
            });
            
            // Soccer data
            soccerSessions.forEach(session => {
                csv += `"Soccer","${session.date}","","${session.type}","${session.energy}","${session.performance}","${session.sharpness}","","","","","","${session.notes}"\n`;
            });
            
            // Recovery data
            recoveryData.forEach(recovery => {
                csv += `"Recovery","${recovery.date}","","Daily","${recovery.overallEnergy}","","","${recovery.sleepHours}","${recovery.sorenessLevel}","${recovery.achillesTightness}","${recovery.hipTightness}","${recovery.moodLevel}","${recovery.notes}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `murphfitness_complete_data_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function saveSoccerSession() {
            const soccerData = {
                date: document.getElementById('soccerDate').value,
                type: document.getElementById('soccerType').value,
                energy: parseInt(document.getElementById('soccerEnergy').value),
                performance: parseInt(document.getElementById('soccerPerformance').value),
                sharpness: parseInt(document.getElementById('soccerSharpness').value),
                preGameFuel: document.getElementById('preGameFuel').value,
                aclWarmupCompleted: document.getElementById('aclWarmupCompleted').value,
                notes: document.getElementById('soccerNotes').value,
                timestamp: new Date().toISOString()
            };

            if (!soccerData.date) {
                alert('Please select a date');
                return;
            }

            soccerSessions.push(soccerData);
            localStorage.setItem('soccerSessions', JSON.stringify(soccerSessions));
            
            // Clear form
            document.getElementById('soccerDate').value = '';
            document.getElementById('soccerNotes').value = '';
            document.getElementById('preGameFuel').value = '';
            
            updateSoccerHistory();
            alert('Soccer session saved!');
        }

        function saveRecoveryData() {
            const recovery = {
                date: document.getElementById('recoveryDate').value,
                sleepHours: parseFloat(document.getElementById('sleepHours').value) || 0,
                sorenessLevel: parseInt(document.getElementById('sorenessLevel').value),
                achillesTightness: parseInt(document.getElementById('achillesTightness').value),
                hipTightness: parseInt(document.getElementById('hipTightness').value),
                overallEnergy: parseInt(document.getElementById('overallEnergy').value),
                moodLevel: parseInt(document.getElementById('moodLevel').value),
                yogaCompleted: document.getElementById('yogaCompleted').value,
                mobilityWorkCompleted: document.getElementById('mobilityWorkCompleted').value,
                dailyCalories: parseInt(document.getElementById('dailyCalories').value) || 0,
                proteinTargetHit: document.getElementById('proteinTargetHit').value,
                hydrationStatus: document.getElementById('hydrationStatus').value,
                notes: document.getElementById('recoveryNotes').value,
                timestamp: new Date().toISOString()
            };

            if (!recovery.date) {
                alert('Please select a date');
                return;
            }

            recoveryData.push(recovery);
            localStorage.setItem('recoveryData', JSON.stringify(recoveryData));
            
            // Clear form
            document.getElementById('recoveryDate').value = '';
            document.getElementById('recoveryNotes').value = '';
            
            updateRecoveryHistory();
            alert('Recovery data saved!');
        }

        function updateSoccerHistory() {
            const container = document.getElementById('soccerSessionsList');
            
            if (soccerSessions.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #a0aec0; padding: 20px;">No soccer sessions logged yet</p>';
                return;
            }
            
            const recentSessions = soccerSessions.slice(-5).reverse();
            container.innerHTML = '';
            
            recentSessions.forEach(session => {
                const sessionDiv = document.createElement('div');
                sessionDiv.className = 'session-card';
                sessionDiv.innerHTML = `
                    <div class="session-header">
                        <span class="session-type">${session.type}</span>
                        <span class="session-date">${new Date(session.date).toLocaleDateString()}</span>
                    </div>
                    <div class="session-stats">
                        <div class="session-stat">
                            <div class="session-stat-label">Energy</div>
                            <div class="session-stat-value">${session.energy}/10</div>
                        </div>
                        <div class="session-stat">
                            <div class="session-stat-label">Performance</div>
                            <div class="session-stat-value">${session.performance}/10</div>
                        </div>
                        <div class="session-stat">
                            <div class="session-stat-label">Sharpness</div>
                            <div class="session-stat-value">${session.sharpness}/10</div>
                        </div>
                    </div>
                    ${session.preGameFuel ? `<div style="color: #a0aec0; font-size: 14px; margin-bottom: 10px;"><strong>Fuel:</strong> ${session.preGameFuel}</div>` : ''}
                    ${session.aclWarmupCompleted === 'Yes' ? '<div style="color: #68d391; font-size: 14px; margin-bottom: 10px;">‚úì ACL Warmup Completed</div>' : ''}
                    ${session.notes ? `<div style="color: #a0aec0; font-size: 14px; margin-bottom: 10px;">${session.notes}</div>` : ''}
                `;
                container.appendChild(sessionDiv);
            });
        }

        function updateRecoveryHistory() {
            const container = document.getElementById('recoveryDataList');
            
            if (recoveryData.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #a0aec0; padding: 20px;">No recovery data logged yet</p>';
                return;
            }
            
            const recentData = recoveryData.slice(-7).reverse();
            container.innerHTML = '';
            
            recentData.forEach(day => {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'session-card';
                dayDiv.innerHTML = `
                    <div class="session-header">
                        <span class="session-type">Recovery Data</span>
                        <span class="session-date">${new Date(day.date).toLocaleDateString()}</span>
                    </div>
                    <div class="session-stats">
                        <div class="session-stat">
                            <div class="session-stat-label">Sleep</div>
                            <div class="session-stat-value">${day.sleepHours}h</div>
                        </div>
                        <div class="session-stat">
                            <div class="session-stat-label">Energy</div>
                            <div class="session-stat-value">${day.overallEnergy}/10</div>
                        </div>
                        <div class="session-stat">
                            <div class="session-stat-label">Soreness</div>
                            <div class="session-stat-value">${day.sorenessLevel}/10</div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: #a0aec0;">Achilles</div>
                            <div style="font-weight: 600;">${day.achillesTightness}/10</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: #a0aec0;">Hip</div>
                            <div style="font-weight: 600;">${day.hipTightness}/10</div>
                        </div>
                    </div>
                    ${day.yogaCompleted === 'Yes' ? '<div style="color: #68d391; font-size: 14px; margin-bottom: 5px;">‚úì Yoga Completed</div>' : ''}
                    ${day.mobilityWorkCompleted === 'Yes' ? '<div style="color: #68d391; font-size: 14px; margin-bottom: 5px;">‚úì Mobility Work Completed</div>' : ''}
                    <div style="color: #a0aec0; font-size: 14px; margin-bottom: 5px;"><strong>Hydration:</strong> ${day.hydrationStatus}</div>
                    <div style="color: #a0aec0; font-size: 14px; margin-bottom: 5px;"><strong>Protein:</strong> ${day.proteinTargetHit}</div>
                    ${day.notes ? `<div style="color: #a0aec0; font-size: 14px; margin-bottom: 10px;">${day.notes}</div>` : ''}
                `;
                container.appendChild(dayDiv);
            });
        }

        // Strava Integration Functions
        function authenticateStrava() {
            const config = getStravaConfig();
            if (!config.clientId) {
                showConfigError();
                return;
            }
            const authUrl = `https://www.strava.com/oauth/authorize?client_id=${encodeURIComponent(config.clientId)}&redirect_uri=${encodeURIComponent(config.redirectUri)}&response_type=code&scope=${encodeURIComponent(config.scope)}`;
            window.open(authUrl, '_blank');
        }

        async function refreshStravaToken() {
            if (typeof STRAVA_TOKENS === 'undefined') {
                showConfigError();
                throw new Error('Strava token configuration is not loaded.');
            }

            if (!STRAVA_TOKENS.refreshToken || STRAVA_TOKENS.refreshToken === 'your_refresh_token_here') {
                throw new Error('No refresh token available');
            }
            
            const config = getStravaConfig();
            const clientId = STRAVA_TOKENS.clientId || config.clientId;
            const clientSecret = STRAVA_TOKENS.clientSecret;
            
            if (!clientId || !clientSecret) {
                showConfigError();
                throw new Error('Strava client credentials are not configured on this environment.');
            }
            
            // Note: Strava integration is handled server-side via API endpoints
            const response = await fetch('https://www.strava.com/oauth/token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    'client_id': clientId,
                    'client_secret': clientSecret,
                    'refresh_token': STRAVA_TOKENS.refreshToken,
                    'grant_type': 'refresh_token'
                })
            });
            
            if (!response.ok) {
                throw new Error('Failed to refresh token');
            }
            
            const tokenData = await response.json();
            return tokenData.access_token;
        }

        async function fetchStravaData() {
            const statusDiv = document.getElementById('stravaStatus');
            statusDiv.innerHTML = 'üîÑ Fetching Strava data...';
            
            try {
                // Check if config is loaded
                if (typeof configLoader === 'undefined') {
                    statusDiv.innerHTML = '‚ùå Configuration not loaded. Please refresh the page.';
                    return;
                }

                // Get access token from server-side configuration
                // This should be handled via API endpoints, not client-side tokens
                statusDiv.innerHTML = '‚ö†Ô∏è Strava integration requires server-side authentication';
                return;

                // Fetch recent activities
                let response = await fetch('https://www.strava.com/api/v3/athlete/activities?per_page=10', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                // If unauthorized, try to refresh the token
                if (response.status === 401) {
                    statusDiv.innerHTML = 'üîÑ Token expired, refreshing...';
                    try {
                        accessToken = await refreshStravaToken();
                        // Retry with new token
                        response = await fetch('https://www.strava.com/api/v3/athlete/activities?per_page=10', {
                            headers: {
                                'Authorization': `Bearer ${accessToken}`
                            }
                        });
                    } catch (refreshError) {
                        statusDiv.innerHTML = '‚ùå Token refresh failed. Please get new tokens from Strava.';
                        console.error('Token refresh error:', refreshError);
                        return;
                    }
                }

                if (!response.ok) {
                    throw new Error(`Failed to fetch Strava data: ${response.status}`);
                }

                const activities = await response.json();
                stravaData = activities;
                localStorage.setItem('stravaData', JSON.stringify(stravaData));
                
                statusDiv.innerHTML = '‚úÖ Strava data synced successfully!';
                updateAnalysis();
                
            } catch (error) {
                console.error('Error fetching Strava data:', error);
                statusDiv.innerHTML = '‚ùå Error syncing Strava data. Check console for details.';
            }
        }

        // Sleep Data Functions
        function saveSleepData() {
            const sleep = {
                date: document.getElementById('sleepDate').value,
                totalSleep: parseFloat(document.getElementById('totalSleep').value) || 0,
                deepSleep: parseFloat(document.getElementById('deepSleep').value) || 0,
                remSleep: parseFloat(document.getElementById('remSleep').value) || 0,
                lightSleep: parseFloat(document.getElementById('lightSleep').value) || 0,
                sleepScore: parseInt(document.getElementById('sleepScore').value) || 0,
                timestamp: new Date().toISOString()
            };

            if (!sleep.date) {
                alert('Please select a date');
                return;
            }

            sleepData.push(sleep);
            localStorage.setItem('sleepData', JSON.stringify(sleepData));
            
            // Clear form
            document.getElementById('sleepDate').value = '';
            document.getElementById('totalSleep').value = '';
            document.getElementById('deepSleep').value = '';
            document.getElementById('remSleep').value = '';
            document.getElementById('lightSleep').value = '';
            document.getElementById('sleepScore').value = '';
            
            updateSleepHistory();
            alert('Sleep data saved!');
        }

        function updateSleepHistory() {
            const container = document.getElementById('sleepDataList');
            
            if (sleepData.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #a0aec0; padding: 20px;">No sleep data logged yet</p>';
                return;
            }
            
            const recentData = sleepData.slice(-7).reverse();
            container.innerHTML = '';
            
            recentData.forEach(day => {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'session-card';
                dayDiv.innerHTML = `
                    <div class="session-header">
                        <span class="session-type">Sleep Data</span>
                        <span class="session-date">${new Date(day.date).toLocaleDateString()}</span>
                    </div>
                    <div class="session-stats">
                        <div class="session-stat">
                            <div class="session-stat-label">Total Sleep</div>
                            <div class="session-stat-value">${day.totalSleep}h</div>
                        </div>
                        <div class="session-stat">
                            <div class="session-stat-label">Sleep Score</div>
                            <div class="session-stat-value">${day.sleepScore}/100</div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 10px;">
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: #a0aec0;">Deep</div>
                            <div style="font-weight: 600;">${day.deepSleep}h</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: #a0aec0;">REM</div>
                            <div style="font-weight: 600;">${day.remSleep}h</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 12px; color: #a0aec0;">Light</div>
                            <div style="font-weight: 600;">${day.lightSleep}h</div>
                        </div>
                    </div>
                `;
                container.appendChild(dayDiv);
            });
        }

        // Analysis Functions
        function updateAnalysis() {
            const analysisDate = document.getElementById('analysisDate').value || new Date().toISOString().split('T')[0];
            const container = document.getElementById('analysisResults');
            
            // Get workout data for the day
            const dayWorkouts = getWorkouts().filter(workout => workout.date === analysisDate);
            const daySleep = sleepData.find(sleep => sleep.date === analysisDate);
            const dayStrava = stravaData.filter(activity => {
                const activityDate = new Date(activity.start_date).toISOString().split('T')[0];
                return activityDate === analysisDate;
            });
            
            let analysisHtml = '<div class="analysis-section">';
            
            // Workout Analysis
            if (dayWorkouts.length > 0) {
                analysisHtml += '<h5 style="color: #68d391;">üí™ Workout Analysis</h5>';
                dayWorkouts.forEach(workout => {
                    analysisHtml += `
                        <div style="background: #2d3748; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                            <strong>${workout.type}</strong> - Energy: ${workout.energy}/10<br>
                            ${workout.exercises.length} exercises completed
                        </div>
                    `;
                });
            }
            
            // Sleep Analysis
            if (daySleep) {
                analysisHtml += '<h5 style="color: #68d391;">üò¥ Sleep Analysis</h5>';
                const sleepQuality = daySleep.sleepScore >= 80 ? 'Excellent' : 
                                   daySleep.sleepScore >= 60 ? 'Good' : 'Poor';
                analysisHtml += `
                    <div style="background: #2d3748; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                        <strong>Sleep Quality:</strong> ${sleepQuality} (${daySleep.sleepScore}/100)<br>
                        <strong>Total Sleep:</strong> ${daySleep.totalSleep}h<br>
                        <strong>Deep Sleep:</strong> ${daySleep.deepSleep}h (${(daySleep.deepSleep/daySleep.totalSleep*100).toFixed(1)}%)<br>
                        <strong>REM Sleep:</strong> ${daySleep.remSleep}h (${(daySleep.remSleep/daySleep.totalSleep*100).toFixed(1)}%)
                    </div>
                `;
            }
            
            // Strava Analysis
            if (dayStrava.length > 0) {
                analysisHtml += '<h5 style="color: #68d391;">üèÉ Strava Activities</h5>';
                dayStrava.forEach(activity => {
                    const duration = Math.round(activity.moving_time / 60); // minutes
                    analysisHtml += `
                        <div style="background: #2d3748; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                            <strong>${activity.type}</strong> - ${duration} min<br>
                            Distance: ${(activity.distance/1000).toFixed(2)}km<br>
                            Average Heart Rate: ${activity.average_heartrate || 'N/A'} bpm
                        </div>
                    `;
                });
            }
            
            // AI Insights
            if (dayWorkouts.length > 0 || daySleep || dayStrava.length > 0) {
                analysisHtml += '<h5 style="color: #68d391;">ü§ñ AI Insights</h5>';
                analysisHtml += generateAIInsights(dayWorkouts, daySleep, dayStrava);
            }
            
            analysisHtml += '</div>';
            container.innerHTML = analysisHtml;
        }

        function categorizeWorkoutType(sessionType) {
            if (sessionType.includes('Upper')) {
                return 'upper';
            } else if (sessionType.includes('Lower')) {
                return 'lower';
            } else if (sessionType === 'Indoor Climbing' || sessionType === 'Outdoor Climbing') {
                return 'pull-core'; // Climbing is primarily pull movements + core
            } else if (sessionType === 'Soccer') {
                return 'cardio';
            } else if (sessionType === 'Recovery') {
                return 'recovery';
            }
            return 'other';
        }

        function categorizeMovementType(sessionType) {
            if (sessionType.includes('Upper')) {
                return 'mixed'; // Upper A/B includes both push and pull
            } else if (sessionType === 'Indoor Climbing' || sessionType === 'Outdoor Climbing') {
                return 'pull'; // Primarily pulling movements
            } else if (sessionType.includes('Lower')) {
                return 'legs'; // Lower body focused
            }
            return 'other';
        }

        function generateAIInsights(workouts, sleep, stravaActivities) {
            let insights = '<div style="background: #1a1a1a; padding: 15px; border-radius: 5px; border-left: 4px solid #68d391;">';
            
            // Sleep + Workout correlation
            if (sleep && workouts.length > 0) {
                const avgEnergy = workouts.reduce((sum, w) => sum + w.energy, 0) / workouts.length;
                if (sleep.sleepScore >= 80 && avgEnergy >= 7) {
                    insights += '‚úÖ <strong>Great sleep quality</strong> correlates with high workout energy. Keep this sleep routine!<br><br>';
                } else if (sleep.sleepScore < 60 && avgEnergy < 6) {
                    insights += '‚ö†Ô∏è <strong>Poor sleep</strong> may be impacting workout performance. Consider earlier bedtime or sleep optimization.<br><br>';
                }
            }
            
            // Climbing-specific insights
            const climbingSessions = workouts.filter(w => w.type === 'Indoor Climbing' || w.type === 'Outdoor Climbing');
            if (climbingSessions.length > 0) {
                const avgIntensity = climbingSessions.reduce((sum, w) => sum + (w.climbingIntensity || 0), 0) / climbingSessions.length;
                const avgRoutes = climbingSessions.reduce((sum, w) => sum + (w.climbingRoutes || 0), 0) / climbingSessions.length;
                
                if (avgIntensity >= 7) {
                    insights += 'üßó‚Äç‚ôÇÔ∏è <strong>High-intensity climbing</strong> detected. Consider lighter pulling work tomorrow or focus on pushing movements.<br><br>';
                }
                
                if (avgRoutes >= 15) {
                    insights += 'üìà <strong>High route volume</strong> today. Monitor grip fatigue and core fatigue - consider easier pulling exercises tomorrow.<br><br>';
                }
                
                // Pull movement analysis
                const pullWorkouts = workouts.filter(w => categorizeMovementType(w.type) === 'pull');
                const mixedWorkouts = workouts.filter(w => categorizeMovementType(w.type) === 'mixed');
                
                if (pullWorkouts.length > 1) {
                    insights += 'üîÑ <strong>Multiple pull-focused sessions</strong> today. Consider push movements or lower body work tomorrow to balance training.<br><br>';
                }
                
                if (mixedWorkouts.length > 0 && climbingSessions.length > 0) {
                    insights += '‚öñÔ∏è <strong>Mixed upper body + climbing</strong> today. Monitor pulling muscle fatigue and consider rest or lighter pulling work tomorrow.<br><br>';
                }
            }
            
            // Strava + Workout timing
            if (stravaActivities.length > 0 && workouts.length > 0) {
                const hasMorningCardio = stravaActivities.some(activity => {
                    const activityTime = new Date(activity.start_date).getHours();
                    return activityTime < 8; // Before 8 AM
                });
                
                if (hasMorningCardio) {
                    insights += 'üèÉ <strong>Morning cardio detected.</strong> Consider 2+ hour gap between cardio and strength training for optimal performance.<br><br>';
                }
            }
            
            // Recovery recommendations
            if (sleep && sleep.deepSleep < 1.5) {
                insights += 'üí§ <strong>Low deep sleep</strong> detected. Try: cooler room temperature, no screens 1hr before bed, consistent sleep schedule.<br><br>';
            }
            
            // Training load analysis
            if (stravaActivities.length > 0) {
                const totalMinutes = stravaActivities.reduce((sum, activity) => sum + activity.moving_time / 60, 0);
                if (totalMinutes > 120) {
                    insights += '‚ö° <strong>High training load</strong> today. Monitor recovery and consider easier session tomorrow.<br><br>';
                }
            }
            
            insights += '</div>';
            return insights;
        }

        function loadData() {
            // Load existing data from localStorage
            const savedSoccerSessions = localStorage.getItem('soccerSessions');
            if (savedSoccerSessions) {
                soccerSessions = JSON.parse(savedSoccerSessions);
            }
            
            const savedRecoveryData = localStorage.getItem('recoveryData');
            if (savedRecoveryData) {
                recoveryData = JSON.parse(savedRecoveryData);
            }
            
            const savedStravaData = localStorage.getItem('stravaData');
            if (savedStravaData) {
                stravaData = JSON.parse(savedStravaData);
            }
            
            const savedSleepData = localStorage.getItem('sleepData');
            if (savedSleepData) {
                sleepData = JSON.parse(savedSleepData);
            }
            
            // Check Strava token status (with delay to ensure config is loaded)
            setTimeout(checkStravaTokenStatus, 100);
            
            updateCurrentSessionDisplay();
        }

        function checkStravaTokenStatus() {
            const statusElement = document.getElementById('tokenStatus');
            
            if (!statusElement) {
                console.log('Status element not found, retrying...');
                setTimeout(checkStravaTokenStatus, 100);
                return;
            }
            
            console.log('Checking Strava tokens...', typeof STRAVA_TOKENS);
            
            const config = getStravaConfig();
            if (!config.clientId) {
                showConfigError();
                return;
            }
            
            if (typeof STRAVA_TOKENS === 'undefined') {
                statusElement.innerHTML = '‚ùå Config file not loaded';
                statusElement.style.color = '#fc8181';
                console.log('STRAVA_TOKENS is undefined');
                return;
            }

            const accessToken = STRAVA_TOKENS.accessToken;
            console.log('Access token:', accessToken ? 'Found' : 'Not found');
            
            if (!accessToken || accessToken === 'your_access_token_here') {
                statusElement.innerHTML = '‚ö†Ô∏è Strava integration requires server configuration';
                statusElement.style.color = '#fbd38d';
            } else {
                statusElement.innerHTML = '‚úÖ Tokens configured';
                statusElement.style.color = '#68d391';
            }
        }

        // Strava API configuration helpers
        function sanitizeIntegrationValue(value) {
            if (value === null || value === undefined) {return '';}
            const normalized = String(value).trim();
            if (!normalized || normalized.toLowerCase() === 'undefined') {
                return '';
            }
            return normalized;
        }

        function getStravaConfig() {
            let integrations = {};
            try {
                if (typeof window !== 'undefined' && window.configLoader && typeof window.configLoader.get === 'function') {
                    integrations = window.configLoader.get('integrations') || {};
                }
            } catch (error) {
                console.warn('Unable to load integrations from configLoader:', error);
            }
            const stravaSettings = integrations.strava || {};
            const tokenConfig = typeof STRAVA_TOKENS !== 'undefined' ? STRAVA_TOKENS : {};
            const clientId = sanitizeIntegrationValue(stravaSettings.clientId || tokenConfig.clientId);
            const redirectUri = sanitizeIntegrationValue(stravaSettings.redirectUri) || (typeof window !== 'undefined' ? `${window.location.origin}/strava-callback.html` : '');
            const scope = stravaSettings.scope || 'read,activity:read_all,profile:read_all';
            return { clientId, redirectUri, scope };
        }

        function showConfigError(message) {
            const fallbackMessage = message || '‚ö†Ô∏è Strava integration requires configuration. Contact your administrator.';
            const statusDiv = document.getElementById('stravaStatus');
            const tokenStatusDiv = document.getElementById('tokenStatus');
            if (statusDiv) {
                statusDiv.innerHTML = fallbackMessage;
                statusDiv.style.color = '#fbd38d';
            }
            if (tokenStatusDiv) {
                tokenStatusDiv.innerHTML = fallbackMessage;
                tokenStatusDiv.style.color = '#fbd38d';
            }
            console.warn('[IgniteFitness] ' + fallbackMessage);
        }

        function informMissingStravaConfig() {
            showConfigError();
        }
    </script>
</body>
</html>
